var Lt=Object.defineProperty;var vt=h=>{throw TypeError(h)};var Bt=(h,t,e)=>t in h?Lt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var a=(h,t,e)=>Bt(h,typeof t!="symbol"?t+"":t,e),wt=(h,t,e)=>t.has(h)||vt("Cannot "+e);var Q=(h,t,e)=>(wt(h,t,"read from private field"),e?e.call(h):t.get(h)),St=(h,t,e)=>t.has(h)?vt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e),gt=(h,t,e,s)=>(wt(h,t,"write to private field"),s?s.call(h,e):t.set(h,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();const K=class K{constructor(){a(this,"services",new Map)}static getInstance(){return K.instance||(K.instance=new K),K.instance}register(t,e){this.services.set(t,e)}get(t){const e=this.services.get(t);if(!e)throw new Error(`Service '${t}' not found in container`);return e}has(t){return this.services.has(t)}clear(){this.services.clear()}};a(K,"instance");let ut=K;class Dt{constructor(){a(this,"observers",[])}subscribe(t){return this.observers.push(t),()=>{const e=this.observers.indexOf(t);e>-1&&this.observers.splice(e,1)}}notify(t){this.observers.forEach(e=>e(t))}get observerCount(){return this.observers.length}clearObservers(){this.observers=[]}}class Et extends Dt{constructor(e){super();a(this,"_value");this._value=e}get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this.notify(e))}forceUpdate(){this.notify(this._value)}}class w{constructor(t,e){a(this,"x");a(this,"y");this.x=t,this.y=e}}class yt{constructor(t=null,e=1,s=1,o="#000",n="#000"){a(this,"center");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");this.center=t||new w(0,0),this.radius=e,this.strokeWidth=s,this.fillColor=o,this.strokeColor=n}setCenter(t){this.center=t}setRadius(t){this.radius=t}draw(t){t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI),this.fillColor&&(t.fillStyle=this.fillColor,t.fill()),t.strokeStyle=this.strokeColor,t.lineWidth=this.strokeWidth,t.stroke()}}var _;const T=class T{constructor(t=new w(825,445),e="#FFFFFF",s=10){a(this,"isScaled",!1);a(this,"canvasSize");a(this,"backgroundColor");a(this,"imageScaleFactor");a(this,"disablePBC",!1);a(this,"interpolationMode","linear");this.canvasSize=t,this.backgroundColor=e,this.imageScaleFactor=s}static get instance(){return Q(T,_)||gt(T,_,new T),Q(T,_)}static fromJSON(t){return gt(T,_,new T(new w(t.canvasSize.x,t.canvasSize.y),t.backgroundColor,t.imageScaleFactor)),"disablePBC"in t&&(Q(T,_).disablePBC=t.disablePBC),"interpolationMode"in t&&(Q(T,_).interpolationMode=t.interpolationMode),Q(T,_)}};_=new WeakMap,St(T,_);let O=T;class at{constructor(t,e,s=!1,o="#000",n=2,i=6,r=4,c=2){a(this,"from");a(this,"to");a(this,"dashed");a(this,"zigZagged");a(this,"color");a(this,"lineWidth");a(this,"zigzagSpacing");a(this,"oneZigZagLength");a(this,"straightLengthWhenZigZag");a(this,"lineRadians");a(this,"lineLength");this.from=t,this.to=e,this.dashed=!1,this.zigZagged=s,this.color=o,this.lineWidth=n,this.zigzagSpacing=i,this.oneZigZagLength=r,this.straightLengthWhenZigZag=c,this.lineRadians=Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x);const d=this.from.x-this.to.x,l=this.from.y-this.to.y;this.lineLength=Math.sqrt(d*d+l*l)}setFrom(t){this.from=t}setTo(t){this.to=t}getFrom(){return this.from}getTo(){return this.to}draw(t){const e=O.instance;var s=this.to.x-this.from.x,o=this.to.y-this.from.y;const n=Math.abs(o)>.5001*e.canvasSize.y,i=Math.abs(s)>.5001*e.canvasSize.x;if((n||i)&&!e.disablePBC){[new at(new w(this.from.x,this.from.y),new w(this.to.x+e.canvasSize.x*(i?s<0?1:-1:0),this.to.y+e.canvasSize.y*(n?o<0?1:-1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new at(new w(this.to.x,this.to.y),new w(this.from.x+e.canvasSize.x*(i?s<0?-1:1:0),this.from.y+e.canvasSize.y*(n?o<0?-1:1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(r=>r.draw(t));return}this.dashed&&t.setLineDash([4,2]),t.lineCap="round",t.lineWidth=this.lineWidth,t.strokeStyle=this.color,this.zigZagged?this.drawZigZagged(t):(t.beginPath(),t.moveTo(this.from.x,this.from.y),t.lineTo(this.to.x,this.to.y)),t.stroke()}drawZigZagged(t){t.save(),t.beginPath(),t.translate(this.from.x,this.from.y),t.rotate(this.lineRadians),t.moveTo(0,0),t.lineTo(this.straightLengthWhenZigZag,0);let e=this.straightLengthWhenZigZag;for(let s=0;e<this.lineLength-this.straightLengthWhenZigZag;s++){e=(s+1)*this.zigzagSpacing;const o=s%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(e,o)}t.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),t.lineTo(this.lineLength,0),t.restore()}setDashed(t){this.dashed=t}setZigZagged(t){this.zigZagged=t}}class Y extends at{constructor(e,s,o=1,n=!1,i="#000",r=2,c=6,d=4,l=2){super(e,s,n,i,r,c,d,l);a(this,"progress");this.progress=Math.max(0,Math.min(1,o))}setProgress(e){this.progress=Math.max(0,Math.min(1,e))}draw(e){if(this.progress===0)return;if(this.progress===1){super.draw(e);return}const s=O.instance;var o=this.to.x-this.from.x,n=this.to.y-this.from.y;const i=Math.abs(n)>.5001*s.canvasSize.y,r=Math.abs(o)>.5001*s.canvasSize.x;if((i||r)&&!s.disablePBC){[new Y(new w(this.from.x,this.from.y),new w(this.to.x+s.canvasSize.x*(r?o<0?1:-1:0),this.to.y+s.canvasSize.y*(i?n<0?1:-1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new Y(new w(this.to.x,this.to.y),new w(this.from.x+s.canvasSize.x*(r?o<0?-1:1:0),this.from.y+s.canvasSize.y*(i?n<0?-1:1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(d=>d.draw(e));return}const c=new w(this.from.x+(this.to.x-this.from.x)*this.progress,this.from.y+(this.to.y-this.from.y)*this.progress);this.dashed&&e.setLineDash([4,2]),e.lineCap="round",e.lineWidth=this.lineWidth,e.strokeStyle=this.color,this.zigZagged?this.drawPartialZigZagged(e,c):(e.beginPath(),e.moveTo(this.from.x,this.from.y),e.lineTo(c.x,c.y),e.stroke())}drawPartialZigZagged(e,s){const o=this.lineLength*this.progress;if(e.save(),e.beginPath(),e.translate(this.from.x,this.from.y),e.rotate(this.lineRadians),e.moveTo(0,0),o<=this.straightLengthWhenZigZag)e.lineTo(o,0);else if(o>=this.lineLength-this.straightLengthWhenZigZag){e.lineTo(this.straightLengthWhenZigZag,0);let n=this.straightLengthWhenZigZag;for(let i=0;n<this.lineLength-this.straightLengthWhenZigZag;i++){n=(i+1)*this.zigzagSpacing;const r=i%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(n,r)}e.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),e.lineTo(o,0)}else{e.lineTo(this.straightLengthWhenZigZag,0);let n=this.straightLengthWhenZigZag;for(let i=0;n<o;i++){if(n=(i+1)*this.zigzagSpacing,n>=o){const c=i*this.zigzagSpacing,d=(i-1)%2==0?-this.oneZigZagLength:this.oneZigZagLength,l=i%2==0?-this.oneZigZagLength:this.oneZigZagLength,u=(o-c)/this.zigzagSpacing,m=d+(l-d)*u;e.lineTo(o,m);break}const r=i%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(n,r)}}e.stroke(),e.restore()}}class tt{constructor(t,e,s="#000",o=2,n=!1,i=!0,r=0,c=5,d=5){a(this,"from");a(this,"to");a(this,"color");a(this,"lineWidth");a(this,"headAtStart");a(this,"headAtEnd");a(this,"offset");a(this,"headSize");a(this,"nodeRadiusFrom");a(this,"nodeRadiusTo");this.from=t,this.to=e,this.color=s,this.lineWidth=o,this.headAtStart=n,this.headAtEnd=i,this.offset=r,this.headSize=Math.max(8,o*3),this.nodeRadiusFrom=c,this.nodeRadiusTo=d}getAdjustedPoints(){const t=this.to.x-this.from.x,e=this.to.y-this.from.y,s=Math.sqrt(t*t+e*e);if(s===0)return{start:this.from,end:this.to};const o=t/s,n=e/s;let i=0,r=0;this.offset!==0&&(i=-n*this.offset,r=o*this.offset);const c=this.nodeRadiusFrom+(this.headAtStart?this.headSize:0),d=this.nodeRadiusTo+(this.headAtEnd?this.headSize:0),l=new w(this.from.x+o*c+i,this.from.y+n*c+r),u=new w(this.to.x-o*d+i,this.to.y-n*d+r);return{start:l,end:u}}drawArrowHead(t,e,s){const o=this.headSize,n=Math.PI/6;t.save(),t.translate(e.x,e.y),t.rotate(s),t.beginPath(),t.moveTo(0,0),t.lineTo(-o,-o*Math.tan(n)),t.lineTo(-o,o*Math.tan(n)),t.closePath(),t.fillStyle=this.color,t.fill(),t.restore()}draw(t){const e=O.instance,s=this.to.x-this.from.x,o=this.to.y-this.from.y,n=Math.abs(o)>.5001*e.canvasSize.y,i=Math.abs(s)>.5001*e.canvasSize.x;if((n||i)&&!e.disablePBC){[new tt(new w(this.from.x,this.from.y),new w(this.to.x+e.canvasSize.x*(i?s<0?1:-1:0),this.to.y+e.canvasSize.y*(n?o<0?1:-1:0)),this.color,this.lineWidth,this.headAtStart,this.headAtEnd,this.offset,this.nodeRadiusFrom,this.nodeRadiusTo),new tt(new w(this.to.x,this.to.y),new w(this.from.x+e.canvasSize.x*(i?s<0?-1:1:0),this.from.y+e.canvasSize.y*(n?o<0?-1:1:0)),this.color,this.lineWidth,this.headAtEnd,this.headAtStart,this.offset,this.nodeRadiusTo,this.nodeRadiusFrom)].forEach(l=>l.draw(t));return}const{start:r,end:c}=this.getAdjustedPoints(),d=Math.atan2(c.y-r.y,c.x-r.x);t.strokeStyle=this.color,t.lineWidth=this.lineWidth,t.lineCap="round",t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(c.x,c.y),t.stroke(),this.headAtEnd&&this.drawArrowHead(t,c,d),this.headAtStart&&this.drawArrowHead(t,r,d+Math.PI)}}class it{constructor(t=null,e=100,s=100,o=2,n="#000",i=null,r=!1){a(this,"topLeft");a(this,"width");a(this,"height");a(this,"strokeColor");a(this,"lineWidth");a(this,"fillColor");a(this,"dashed");this.topLeft=t||new w(0,0),this.width=e,this.height=s,this.strokeColor=n,this.lineWidth=o,this.fillColor=i,this.dashed=r}draw(t){t.save(),this.dashed&&t.setLineDash([5,5]),t.beginPath(),t.rect(this.topLeft.x,this.topLeft.y,this.width,this.height),this.fillColor?t.fillStyle=this.fillColor:t.fillStyle="transparent",t.fill(),t.lineWidth=this.lineWidth,this.strokeColor&&(t.strokeStyle=this.strokeColor,t.stroke()),t.restore()}}class L extends w{constructor(t,e){t instanceof w?(super(t.x,t.y),this.x=t.x,this.y=t.y):(super(t,e),this.x=t,this.y=e)}add(t){return new L(this.x+t.x,this.y+t.y)}subtract(t){return new L(this.x-t.x,this.y-t.y)}multiply(t){return new L(this.x*t,this.y*t)}toString(){return`(${this.x}, ${this.y})`}}class b{constructor(t,e,s=5,o=1,n="#000",i="#000"){a(this,"id");a(this,"coordinates");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new Error("Invalid `id` parameter. It must be a non-negative integer, got `"+t+"`.");this.id=t,this.coordinates=e,this.radius=s,this.strokeWidth=o,this.fillColor=n,this.strokeColor=i}}class mt{constructor(t,e,s,o=1,n="#000"){a(this,"fromId");a(this,"toId");a(this,"weight");a(this,"color");a(this,"id");this.fromId=t,this.toId=e,this.id=s,this.weight=o,this.color=n}getOtherNodeId(t){return this.fromId===t?this.toId:this.fromId}}class ft{constructor(t,e,s,o="#000",n=2,i=!1,r=!0){a(this,"fromId");a(this,"toId");a(this,"color");a(this,"width");a(this,"id");a(this,"headAtStart");a(this,"headAtEnd");this.fromId=t,this.toId=e,this.id=s,this.color=o,this.width=n,this.headAtStart=i,this.headAtEnd=r}getOtherNodeId(t){return this.fromId===t?this.toId:this.fromId}connectsSameNodes(t){return this.fromId===t.fromId&&this.toId===t.toId||this.fromId===t.toId&&this.toId===t.fromId}}class pt{constructor(){a(this,"nodes");a(this,"edges");a(this,"arrows");a(this,"scalingFactor");a(this,"zigzagSpacing",4);a(this,"zigzagLength",3);a(this,"zigzagEndLengths",1.5);a(this,"maxNodeId",0);this.nodes={},this.edges=[],this.arrows=[],this.scalingFactor=new w(1,1)}clear(){this.nodes={},this.edges=[],this.arrows=[]}setNode(t){this.nodes[t.id]=t,this.maxNodeId=Math.max(this.maxNodeId,t.id)}addEdge(t,e,s="#000",o=1){if(!(t in this.nodes)||!(e in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.edges.push(new mt(t,e,this.edges.length,o,s)),this.edges.length-1}getNode(t){if(!(t in this.nodes))throw new Error(`Node with id "${t}" does not exist.`);return this.nodes[t]}getNrOfNodes(){return Object.keys(this.nodes).length}getNrOfEdges(){return this.edges.length}getAllNodeIds(){return Object.values(this.nodes).map(t=>t.id)}getNextNodeId(){return this.maxNodeId+1}getAllNodes(){return Object.values(this.nodes)}getAllEdges(){return this.edges}getAllArrows(){return this.arrows}getNrOfArrows(){return this.arrows.length}addArrow(t,e,s="#000",o=2,n=!1,i=!0){if(!(t in this.nodes)||!(e in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.arrows.push(new ft(t,e,this.arrows.length,s,o,n,i)),this.arrows.length-1}getArrowsInvolvingNode(t){return this.arrows.filter(e=>e.fromId===t||e.toId===t)}getArrowsInvolvingNodes(t){return this.arrows.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}getArrowsWithBothEndsInNodes(t){return this.arrows.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}deleteArrow(t){if(t instanceof ft&&(t=this.arrows.indexOf(t)),t<0||t>=this.arrows.length)throw new Error("Invalid arrow ID "+t+". Arrow ID must be between 0 and "+(this.arrows.length-1)+".");const e=this.arrows[t];return this.arrows.splice(t,1),e}hasEdgeBetween(t,e){return this.edges.some(s=>s.fromId===t&&s.toId===e||s.fromId===e&&s.toId===t)}getNodesConnectedToNode(t){return this.getEdgesInvolvingNode(t).map(e=>this.nodes[e.fromId===t?e.toId:e.fromId])}deepConnectedTo(t){const e=new Set,s=[],o=[t.id];for(;o.length>0;){const n=o.shift();if(e.has(n))continue;e.add(n),s.push(this.getNode(n));const i=this.getEdgesInvolvingNode(n).map(r=>r.getOtherNodeId(n)).filter(r=>!e.has(r));o.push(...i)}return s}getEdgesInvolvingNode(t){return this.edges.filter(e=>e.fromId===t||e.toId===t)}getEdgesInvolvingNodes(t){return this.edges.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}cleanupEdges(){this.edges=this.edges.filter(t=>t.fromId!==t.toId),this.arrows=this.arrows.filter(t=>t.fromId!==t.toId)}removeDuplicateEdges(){const t=new Set;this.edges=this.edges.filter(e=>{const s=`${Math.min(e.fromId,e.toId)}-${Math.max(e.fromId,e.toId)}`;return t.has(s)?!1:(t.add(s),!0)})}getEdgesWithBothEndsInNodes(t){return this.edges.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}fromJSON(t){this.nodes={},this.edges=[],this.arrows=[];for(const[,e]of Object.entries(t.nodes))this.setNode(new b(e.id,e.coordinates,e.radius,e.strokeWidth,e.fillColor,e.strokeColor));for(const e of t.edges)this.addEdge(e.fromId,e.toId,e.color,e.weight);if(t.arrows)for(const e of t.arrows)this.addArrow(e.fromId,e.toId,e.color,e.width,e.headAtStart,e.headAtEnd);"scalingFactor"in t&&(this.scalingFactor=new w(t.scalingFactor.x,t.scalingFactor.y)),"zigzagSpacing"in t&&(this.zigzagSpacing=t.zigzagSpacing),"zigzagLength"in t&&(this.zigzagLength=t.zigzagLength),this.cleanupEdges()}toDrawables(){const t=[],e=Math.max(this.scalingFactor.x,this.scalingFactor.y);for(const s of this.edges){const o=this.getNode(s.fromId),n=this.getNode(s.toId);if(o&&n){const i=new w(o.coordinates.x*this.scalingFactor.x,o.coordinates.y*this.scalingFactor.y),r=new w(n.coordinates.x*this.scalingFactor.x,n.coordinates.y*this.scalingFactor.y);t.push(new at(i,r,!0,s.color,s.weight*e,this.zigzagSpacing*e,this.zigzagLength*e,this.zigzagEndLengths*e))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of this.arrows){const o=this.getNode(s.fromId),n=this.getNode(s.toId);if(o&&n){const i=new w(o.coordinates.x*this.scalingFactor.x,o.coordinates.y*this.scalingFactor.y),r=new w(n.coordinates.x*this.scalingFactor.x,n.coordinates.y*this.scalingFactor.y),d=this.hasEdgeBetween(s.fromId,s.toId)?10*e:0;t.push(new tt(i,r,s.color,s.width*e,s.headAtStart,s.headAtEnd,d,o.radius*e,n.radius*e))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of Object.values(this.nodes)){const o=new w(s.coordinates.x*this.scalingFactor.x,s.coordinates.y*this.scalingFactor.y);t.push(new yt(o,s.radius*e,s.strokeWidth*e,s.fillColor,s.strokeColor))}return t}findNodesByCoordinates(t,e){let s=[];for(const[,o]of Object.entries(this.nodes))Math.sqrt(Math.pow(o.coordinates.x-t,2)+Math.pow(o.coordinates.y-e,2))<=5&&s.push(o);return s}findNodeByCoordinates(t,e){const s=this.findNodesByCoordinates(t,e);return s.length>0?s[0]:null}deleteNode(t){if(!this.getNode(t))throw new Error("The node does not exist in the graph.");delete this.nodes[t];for(let s=0;s<this.edges.length;s++)(this.edges[s].fromId===t||this.edges[s].toId===t)&&(this.edges.splice(s,1),s--);for(let s=0;s<this.arrows.length;s++)(this.arrows[s].fromId===t||this.arrows[s].toId===t)&&(this.arrows.splice(s,1),s--)}deleteEdge(t){if(t instanceof mt&&(t=this.edges.indexOf(t)),t<0||t>=this.edges.length)throw new Error("Invalid edge ID "+t+". Edge ID must be between 0 and "+(this.edges.length-1)+".");const e=this.edges[t];return this.edges.splice(t,1),e}}const S=new pt;class Tt{constructor(t,e){a(this,"svg");a(this,"lastElement");a(this,"currentGroup",null);a(this,"prevState",null);a(this,"currentXOffset",0);a(this,"currentYOffset",0);a(this,"currentRotationRad",0);a(this,"currentX",0);a(this,"currentY",0);a(this,"canvas");a(this,"globalAlpha",1);a(this,"globalCompositeOperation");a(this,"fillStyle");a(this,"strokeStyle");a(this,"filter");a(this,"imageSmoothingEnabled");a(this,"imageSmoothingQuality");a(this,"lineCap","butt");a(this,"lineDashOffset");a(this,"lineJoin","round");a(this,"lineWidth",0);a(this,"miterLimit");a(this,"shadowBlur");a(this,"shadowColor");a(this,"shadowOffsetX");a(this,"shadowOffsetY");a(this,"direction","ltr");a(this,"font");a(this,"fontKerning");a(this,"fontStretch","normal");a(this,"fontVariantCaps","normal");a(this,"letterSpacing");a(this,"textAlign","left");a(this,"textBaseline");a(this,"textRendering");a(this,"wordSpacing");this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",t.toString()),this.svg.setAttribute("height",e.toString()),this.lastElement=this.svg}addElement(t){this.currentGroup?this.currentGroup.appendChild(t):this.svg.appendChild(t),this.lastElement=t}pointIsOnCanvas(t){const e={width:parseFloat(this.svg.getAttribute("width")),height:parseFloat(this.svg.getAttribute("height"))};return t.x>=0&&t.x<=e.width&&t.y>=0&&t.y<=e.height}rect(t,e,s,o){const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",t.toString()),n.setAttribute("y",e.toString()),n.setAttribute("width",s.toString()),n.setAttribute("height",o.toString()),this.addElement(n)}clearRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style","background-color: white; fill: white;")}fillRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!0,!1)+";stroke:none;")}strokeRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!1,!0)+";fill:none;")}arc(t,e,s,o,n){const i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",t.toString()),i.setAttribute("cy",e.toString()),i.setAttribute("r",s.toString()),i.setAttribute("style",this.stylesToCSS(!0,!0)),this.addElement(i)}moveTo(t,e){this.currentX=t,this.currentY=e}rotate(t){this.currentRotationRad+=t}translate(t,e){this.currentXOffset+=t,this.currentYOffset+=e}lineTo(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg","line"),o=Math.cos(this.currentRotationRad)*this.currentX-Math.sin(this.currentRotationRad)*this.currentY,n=Math.sin(this.currentRotationRad)*this.currentX+Math.cos(this.currentRotationRad)*this.currentY,i=Math.cos(this.currentRotationRad)*t-Math.sin(this.currentRotationRad)*e,r=Math.sin(this.currentRotationRad)*t+Math.cos(this.currentRotationRad)*e,c=new w(o+this.currentXOffset,n+this.currentYOffset),d=new w(i+this.currentXOffset,r+this.currentYOffset);s.setAttribute("x1",c.x.toString()),s.setAttribute("y1",c.y.toString()),s.setAttribute("x2",d.x.toString()),s.setAttribute("y2",d.y.toString()),s.setAttribute("style",this.stylesToCSS(!1,!0)),this.lineCap&&s.setAttribute("stroke-linecap",this.lineCap),(this.pointIsOnCanvas(c)||this.pointIsOnCanvas(d)||c.x<=0&&d.x>=parseFloat(this.svg.getAttribute("width"))||c.y<=0&&d.y>=parseFloat(this.svg.getAttribute("height")))&&this.addElement(s),this.currentX=t,this.currentY=e}stroke(){this.addStyles(this.stylesToCSS(!1,!0))}fill(t,e){if(t||e)throw new Error("Method not implemented.");this.addStyles(this.stylesToCSS(!0,!1))}addStyles(t){if(this.lastElement){const e=this.lastElement.getAttribute("style"),s=this.parseStyles(t);if(e){const o=this.parseStyles(e);for(const[n,i]of Object.entries(o))s[n]||(s[n]=i)}this.lastElement.setAttribute("style",this.styleMapToString(s));for(const[o,n]of Object.entries(s))this.lastElement.setAttribute(o,n)}}parseStyles(t){const e={};return t.split(";").forEach(o=>{const[n,i]=o.trim().split(":");e[n.trim()]=i.trim()}),e}styleMapToString(t){return Object.entries(t).map(([e,s])=>`${e}: ${s}`).join("; ")}restore(){if(this.prevState)this.fillStyle=this.prevState.fillStyle,this.strokeStyle=this.prevState.strokeStyle,this.lineWidth=this.prevState.lineWidth,this.currentX=this.prevState.currentX,this.currentY=this.prevState.currentY,this.lastElement=this.prevState.lastElement,this.currentXOffset=this.prevState.currentXOffset,this.currentYOffset=this.prevState.currentYOffset,this.currentRotationRad=this.prevState.currentRotationRad,this.prevState=null,this.currentGroup=null;else throw new Error("No state to restore.")}save(){if(this.prevState)throw new Error("Only one state can be saved at a time.");this.prevState={fillStyle:this.fillStyle,strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,currentX:this.currentX,currentY:this.currentY,lastElement:this.lastElement,currentXOffset:this.currentXOffset,currentYOffset:this.currentYOffset,currentRotationRad:this.currentRotationRad};const t=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(t),this.lastElement=t,this.currentGroup=t}stylesToCSS(t=!0,e=!0){let s={"stroke-width":this.lineWidth.toString(),"stroke-linecap":this.lineCap||"butt"};return t&&this.fillStyle&&(s.fill=this.fillStyle.toString()),e&&this.strokeStyle&&(s.stroke=this.strokeStyle.toString()),this.styleMapToString(s)}getSVG(){return this.svg}beginPath(){}closePath(){}getContextAttributes(){throw new Error("Method not implemented.")}drawImage(t,e,s,o,n,i,r,c,d){throw new Error("Method not implemented.")}clip(t,e){throw new Error("Method not implemented.")}isPointInPath(t,e,s,o){throw new Error("Method not implemented.")}isPointInStroke(t,e,s){throw new Error("Method not implemented.")}createConicGradient(t,e,s){throw new Error("Method not implemented.")}createLinearGradient(t,e,s,o){throw new Error("Method not implemented.")}createPattern(t,e){throw new Error("Method not implemented.")}createRadialGradient(t,e,s,o,n,i){throw new Error("Method not implemented.")}createImageData(t,e,s){throw new Error("Method not implemented.")}getImageData(t,e,s,o,n){throw new Error("Method not implemented.")}putImageData(t,e,s,o,n,i,r){throw new Error("Method not implemented.")}arcTo(t,e,s,o,n){throw new Error("Method not implemented.")}scale(t,e){throw new Error("Method not implemented.")}bezierCurveTo(t,e,s,o,n,i){throw new Error("Method not implemented.")}ellipse(t,e,s,o,n,i,r,c){throw new Error("Method not implemented.")}quadraticCurveTo(t,e,s,o){throw new Error("Method not implemented.")}roundRect(t,e,s,o,n){throw new Error("Method not implemented.")}getLineDash(){throw new Error("Method not implemented.")}setLineDash(t){throw new Error("Method not implemented.")}isContextLost(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}fillText(t,e,s,o){throw new Error("Method not implemented.")}measureText(t){throw new Error("Method not implemented.")}strokeText(t,e,s,o){throw new Error("Method not implemented.")}getTransform(){throw new Error("Method not implemented.")}resetTransform(){throw new Error("Method not implemented.")}setTransform(t,e,s,o,n,i){throw new Error("Method not implemented.")}transform(t,e,s,o,n,i){throw new Error("Method not implemented.")}drawFocusIfNeeded(t,e){throw new Error("Method not implemented.")}}class Ot{constructor(t){a(this,"container");a(this,"elementsToDraw",new Et([]));a(this,"renderModeInteractive",new Et(!0));this.container=t}initialize(){const t=this.container.get("canvas"),e=this.container.get("settings");t.resize(e.canvasSize.x,e.canvasSize.y),this.render()}render(t={x:1,y:1},e=[]){const s=this.container.get("canvas"),o=this.container.get("graph"),n=this.container.get("selection"),i=this.container.get("ui"),r=s.getScalingService(),c=r.getEffectiveScaling(t),d=r.get1DScalingFactor(t),l=s.canvas;if(this.renderModeInteractive.value){const v=this.container.get("modeFactory").getCurrentMode();if(v&&v.getTemporaryDrawables){const g=v.getTemporaryDrawables();e=[...e,...g]}}const u=i.getInputValue("backgroundColor"),m=i.getInputValue("borderColor"),f=[];f.push(new it({x:0,y:0},l.width,l.height,0,"transparent",u));const p=o.toDrawables();if(e.length>0){const y=[],v=[];for(const g of p)g.constructor.name==="Circle"?v.push(g):y.push(g);f.push(...y),f.push(...e),f.push(...v)}else f.push(...p);f.push(new it({x:0,y:0},l.width,l.height,20*d,u,null)),f.push(new it({x:10*c.x,y:10*c.y},l.width-20*c.x,l.height-20*c.y,4*d,m,null)),this.renderModeInteractive.value&&!n.empty&&n.getItemsOfClass(b).forEach(y=>{f.push(new yt({x:y.coordinates.x,y:y.coordinates.y},y.radius*d*1.5,2*d,"transparent","red"))}),this.elementsToDraw.value=f,s.clear(),s.draw(f),i.updateGraphStats(o.getNrOfNodes(),o.getNrOfEdges(),o.getNrOfArrows())}destroy(){this.elementsToDraw.clearObservers(),this.renderModeInteractive.clearObservers()}}class Wt{constructor(t,e){a(this,"savedState",null);this.canvas=t,this.settings=e}getEffectiveScaling(t={x:1,y:1}){return this.settings.isScaled?{x:this.settings.imageScaleFactor,y:this.settings.imageScaleFactor}:t}get1DScalingFactor(t={x:1,y:1}){const e=this.getEffectiveScaling(t);return Math.max(e.x,e.y)}scaleForExport(t,e){if(this.savedState!==null)throw new Error("Already in scaled state. Call restoreFromScaling() first.");const s=new Map;e.getAllNodes().forEach(i=>{s.set(i.id,{x:i.coordinates.x,y:i.coordinates.y,radius:i.radius,strokeWidth:i.strokeWidth})});const o=new Map;e.getAllEdges().forEach(i=>{const r=`${i.fromId}-${i.toId}`;o.set(r,i.weight)});const n=new Map;e.getAllArrows().forEach(i=>{n.set(i.id,i.width)}),this.savedState={canvasWidth:this.canvas.width,canvasHeight:this.canvas.height,canvasSizeX:this.settings.canvasSize.x,canvasSizeY:this.settings.canvasSize.y,isScaled:this.settings.isScaled,nodeStates:s,edgeWeights:o,arrowWidths:n,zigzagSpacing:e.zigzagSpacing,zigzagLength:e.zigzagLength,zigzagEndLengths:e.zigzagEndLengths},this.canvas.width=this.canvas.width*t,this.canvas.height=this.canvas.height*t,this.settings.canvasSize.x*=t,this.settings.canvasSize.y*=t,this.settings.isScaled=!0,this.scaleGraphElements(e,t)}restoreFromScaling(t){if(this.savedState===null)throw new Error("No saved scaling state to restore.");const e=this.savedState;this.canvas.width=e.canvasWidth,this.canvas.height=e.canvasHeight,this.settings.canvasSize.x=e.canvasSizeX,this.settings.canvasSize.y=e.canvasSizeY,this.settings.isScaled=e.isScaled,t.getAllNodes().forEach(s=>{const o=e.nodeStates.get(s.id);o&&(s.coordinates.x=o.x,s.coordinates.y=o.y,s.radius=o.radius,s.strokeWidth=o.strokeWidth)}),t.getAllEdges().forEach(s=>{const o=`${s.fromId}-${s.toId}`,n=e.edgeWeights.get(o);n!==void 0&&(s.weight=n)}),t.getAllArrows().forEach(s=>{const o=e.arrowWidths.get(s.id);o!==void 0&&(s.width=o)}),t.zigzagSpacing=e.zigzagSpacing,t.zigzagLength=e.zigzagLength,t.zigzagEndLengths=e.zigzagEndLengths,this.savedState=null}isInScaledState(){return this.savedState!==null}scaleGraphElements(t,e){t.getAllNodes().forEach(s=>{s.coordinates.x*=e,s.coordinates.y*=e,s.radius*=e,s.strokeWidth*=e}),t.getAllEdges().forEach(s=>{s.weight*=e}),t.getAllArrows().forEach(s=>{s.width*=e}),t.zigzagSpacing*=e,t.zigzagLength*=e,t.zigzagEndLengths*=e}resizeCanvas(t,e,s,o){const n=this.canvas.width,i=this.canvas.height;this.canvas.width=t,this.canvas.height=e;const r=this.canvas.width/n,c=this.canvas.height/i,d=Math.min(r,c);return o.getAllNodes().forEach(l=>{l.coordinates.x*=r,l.coordinates.y*=c,s&&(l.radius*=d,l.strokeWidth*=d)}),s&&(o.getAllEdges().forEach(l=>{l.weight*=d}),o.getAllArrows().forEach(l=>{l.width*=d}),o.zigzagSpacing*=d,o.zigzagLength*=d,o.zigzagEndLengths*=d),{xScaling:r,yScaling:c}}async withScaling(t,e,s,o,n){o(),this.scaleForExport(e,s);try{const i=await Promise.resolve(t());return this.restoreFromScaling(s),n(),i}catch(i){throw this.restoreFromScaling(s),n(),i}}}class _t{constructor(t,e,s){a(this,"canvas");a(this,"ctx");a(this,"scalingService");this.canvas=t,this.ctx=e,this.scalingService=new Wt(t,s)}resize(t,e){const s=this.canvas.width,o=this.canvas.height;this.canvas.width=t,this.canvas.height=e;const n=this.canvas.width/s,i=this.canvas.height/o;return{xScaling:n,yScaling:i}}resizeWithGraphScaling(t,e,s,o){return this.scalingService.resizeCanvas(t,e,s,o)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t){this.clear(),t.forEach(e=>e.draw(this.ctx))}toDataURL(t="image/png"){return this.canvas.toDataURL(t)}getContext(){return this.ctx}getDimensions(){return{width:this.canvas.width,height:this.canvas.height}}clientToCanvasCoordinates(t,e){return new w(t-this.canvas.offsetLeft+window.scrollX,e-this.canvas.offsetTop+window.scrollY)}withScaledCanvas(t,e,s,o,n){const i=s.renderModeInteractive.value;s.renderModeInteractive.value=!1,this.scalingService.scaleForExport(e,o);try{const r=t();return r instanceof Promise?r.then(c=>(this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=i,s.render(),c)).catch(c=>{throw this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=i,s.render(),c}):(this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=i,s.render(),r)}catch(r){throw this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=i,s.render(),r}}getScalingService(){return this.scalingService}}class Zt{constructor(){a(this,"elements",new Map);this.cacheElements()}cacheElements(){["backgroundColor","borderColor","vertexRadius","vertexStrokeWidth","nodeFillColor","nodeColor","edgeColor","lineWidth","arrowColor","arrowWidth","arrowHeadAtStart","arrowHeadAtEnd","graph-stats","resizeElements","sideChainLength","sideChainProb","sideChainLengthRandomness","sideChainAngleRandomness","edgeAnimationDuration","simulationType","simulationStepCount","simulationStepDuration","adaptiveStepDuration","movieRecordingStatus","recordingEdgeCount","stopMotionFrameDuration","stopMotionIndicator","stopMotionFrameCount"].forEach(e=>{const s=document.getElementById(e);s&&this.elements.set(e,s)})}getElement(t){const e=this.elements.get(t);if(!e){const s=document.getElementById(t);return s?(this.elements.set(t,s),s):null}return e}getInputValue(t){const e=this.getElement(t);return(e==null?void 0:e.value)||""}getInputValueAsNumber(t){const e=this.getElement(t);return(e==null?void 0:e.valueAsNumber)||0}getInputChecked(t){const e=this.getElement(t);return(e==null?void 0:e.checked)||!1}setValue(t,e){const s=this.getElement(t);s&&(s.value=String(e))}updateGraphStats(t,e,s){const o=this.getElement("graph-stats");o&&(s!==void 0&&s>0?o.textContent=`Nodes: ${t}, Edges: ${e}, Arrows: ${s}`:o.textContent=`Nodes: ${t}, Edges: ${e}`)}updateCanvasSizeUI(t,e){this.setValue("canvasWidth",t),this.setValue("canvasHeight",e);const s=document.getElementById("canvas-parent");s&&(s.style.width=t+"px",s.style.height=e+"px");const o=document.getElementById("canvas-size");o&&(o.textContent=`Canvas size: ${t}x${e}`)}updateMovieRecordingStatus(t){const e=this.getElement("movieRecordingStatus");e&&(e.textContent=t)}updateMovieStatus(t){this.updateMovieRecordingStatus(t)}updateRecordingEdgeCount(t){const e=this.getElement("recordingEdgeCount");e&&(e.textContent=String(t))}updateStopMotionIndicator(t,e="black"){const s=this.getElement("stopMotionIndicator");s&&(s.textContent=t,s.style.color=e)}updateStopMotionFrameCount(t){const e=this.getElement("stopMotionFrameCount");e&&(e.textContent=String(t))}setTextContent(t,e){const s=this.getElement(t);s&&(s.textContent=e)}setVisible(t,e){const s=this.getElement(t);s&&(s.style.display=e?"":"none")}addClass(t,e){const s=this.getElement(t);s&&s.classList.add(e)}removeClass(t,e){const s=this.getElement(t);s&&s.classList.remove(e)}toggleClass(t,e){const s=this.getElement(t);s&&s.classList.toggle(e)}}class $t{constructor(t={}){a(this,"sequences",[]);a(this,"currentSequenceIndex",0);a(this,"currentFrameIndex",0);a(this,"isPlaying",!1);a(this,"isPaused",!1);a(this,"animationFrameId",null);a(this,"lastFrameTime",0);a(this,"options");a(this,"subFrameIndex",0);a(this,"animate",()=>{if(!this.isPlaying||this.isPaused)return;if(this.currentSequenceIndex>=this.sequences.length){this.stop();return}const t=this.sequences[this.currentSequenceIndex],e=t.frames[this.currentFrameIndex];if(!e){t.onComplete&&t.onComplete(),this.currentSequenceIndex++,this.currentFrameIndex=0,this.lastFrameTime=performance.now(),this.options.offlineRendering?this.animate():this.animationFrameId=requestAnimationFrame(this.animate);return}if(this.options.offlineRendering){const s=e.duration||t.defaultFrameDuration||16,o=this.options.targetFPS,n=Math.max(1,Math.round(s/1e3*o));this.subFrameIndex===0&&(e.action(),t.onFrame&&t.onFrame(this.currentFrameIndex,t.frames.length)),this.options.onFrameRendered&&this.options.onFrameRendered(),this.subFrameIndex++,this.subFrameIndex>=n&&(this.subFrameIndex=0,this.currentFrameIndex++),this.animate()}else{const s=performance.now(),o=e.duration||t.defaultFrameDuration||16;s-this.lastFrameTime>=o&&(e.action(),t.onFrame&&t.onFrame(this.currentFrameIndex,t.frames.length),this.currentFrameIndex++,this.lastFrameTime=s),this.animationFrameId=requestAnimationFrame(this.animate)}});this.options={targetFPS:t.targetFPS||60,autoPlay:t.autoPlay!==void 0?t.autoPlay:!0,offlineRendering:t.offlineRendering||!1,onFrameRendered:t.onFrameRendered}}addSequence(t){t.defaultFrameDuration||(t.defaultFrameDuration=1e3/this.options.targetFPS),this.sequences.push(t),this.options.autoPlay&&!this.isPlaying&&this.play()}clearSequences(){this.stop(),this.sequences=[],this.currentSequenceIndex=0,this.currentFrameIndex=0}play(){this.isPlaying&&!this.isPaused||(this.isPlaying=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}pause(){this.isPaused=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.isPaused&&(this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}stop(){this.isPlaying=!1,this.isPaused=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentSequenceIndex=0,this.currentFrameIndex=0}getIsPlaying(){return this.isPlaying&&!this.isPaused}getIsPaused(){return this.isPaused}getProgress(){const t=this.sequences[this.currentSequenceIndex];return{sequence:this.currentSequenceIndex,frame:this.currentFrameIndex,total:(t==null?void 0:t.frames.length)||0}}}class Yt{static fromActions(t,e,s=100,o){return{name:t,frames:e.map(n=>({action:n})),defaultFrameDuration:s,onComplete:o}}static repeat(t,e,s,o=100,n){return{name:t,frames:Array(s).fill(null).map(()=>({action:e})),defaultFrameDuration:o,onComplete:n}}static withTiming(t,e,s){return{name:t,frames:e,onComplete:s}}static interpolate(t,e,s,o=1e3,n){const i=o/e,r=[];for(let c=0;c<=e;c++){const d=c/e;r.push({action:()=>s(d),duration:i})}return{name:t,frames:r,onComplete:n}}}class Xt{constructor(t,e={}){a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);a(this,"isRecording",!1);a(this,"canvas");a(this,"options");this.canvas=t,this.options={fps:e.fps||60,videoBitsPerSecond:e.videoBitsPerSecond||25e5,mimeType:e.mimeType||"video/webm;codecs=vp9"}}start(){if(this.isRecording){console.warn("Recording already in progress");return}this.recordedChunks=[],this.stream=this.canvas.captureStream(0);let t=this.options.mimeType;MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, trying vp8`),t="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, using default`),t="video/webm")),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:t,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started")}stop(){return new Promise((t,e)=>{if(!this.isRecording||!this.mediaRecorder){e(new Error("No recording in progress"));return}this.mediaRecorder.onstop=()=>{const s=new Blob(this.recordedChunks,{type:"video/webm"});this.isRecording=!1,this.stream&&this.stream.getTracks().forEach(o=>o.stop()),console.log("Recording stopped, blob size:",s.size),t(s)},this.mediaRecorder.stop()})}requestFrame(){if(this.stream){const t=this.stream.getVideoTracks()[0];t&&"requestFrame"in t&&t.requestFrame()}}getIsRecording(){return this.isRecording}async download(t="polymer-graph-animation.webm"){if(this.isRecording){const e=await this.stop();this.downloadBlob(e,t)}else if(this.recordedChunks.length>0){const e=new Blob(this.recordedChunks,{type:"video/webm"});this.downloadBlob(e,t)}else throw new Error("No recording available to download")}downloadBlob(t,e){const s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},500)}}class qt{constructor(t){a(this,"recorder");a(this,"animator");a(this,"isRecordingMovie",!1);var e;this.recorder=new Xt(t.canvas,t.recorderOptions),this.animator=new $t({targetFPS:((e=t.animatorOptions)==null?void 0:e.targetFPS)||60,autoPlay:!1,offlineRendering:!1,onFrameRendered:()=>this.recorder.requestFrame()})}async startRecording(){if(this.isRecordingMovie)throw new Error("Already recording a movie");this.isRecordingMovie=!0,this.animator.options.offlineRendering=!0,this.recorder.start()}async stopAndDownload(t){if(!this.isRecordingMovie)throw new Error("Not currently recording");this.animator.getIsPlaying()&&this.animator.stop(),this.animator.options.offlineRendering=!1,await this.recorder.download(t),this.isRecordingMovie=!1}addSequence(t){this.animator.addSequence(t)}clearSequences(){this.animator.clearSequences()}play(){this.animator.play()}pause(){this.animator.pause()}resume(){this.animator.resume()}stop(){this.animator.stop()}async recordMovie(t,e){return new Promise((s,o)=>{this.clearSequences(),t.forEach(n=>this.addSequence(n)),this.addSequence({name:"completion",frames:[{action:()=>{setTimeout(async()=>{try{await this.stopAndDownload(e),s()}catch(n){o(n)}},500)}}],defaultFrameDuration:100}),this.startRecording().then(()=>{this.play()}).catch(o)})}getIsRecording(){return this.isRecordingMovie}getIsPlaying(){return this.animator.getIsPlaying()}getProgress(){return this.animator.getProgress()}static get AnimationBuilder(){return Yt}}class Ct{constructor(t){a(this,"options");a(this,"canvas",null);a(this,"ctx",null);a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);this.options={width:t.width,height:t.height,fps:t.fps||30,videoBitsPerSecond:t.videoBitsPerSecond||5e6,mimeType:t.mimeType||"video/webm;codecs=vp9"}}init(){if(this.canvas)return;if(this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height,this.canvas.style.display="none",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!1}),!this.ctx)throw new Error("Failed to get 2D context from canvas");const t=this.canvas.captureStream(0),e=t.getVideoTracks()[0],s=e&&typeof e.requestFrame=="function";t.getTracks().forEach(i=>i.stop());const o=s?this.canvas.captureStream(0):this.canvas.captureStream(this.options.fps);this.stream=o,console.log(`VideoEncoder: Using ${s?"manual":"automatic"} frame capture at ${this.options.fps} fps`);let n=this.options.mimeType;MediaRecorder.isTypeSupported(n)||(console.warn(`${n} not supported, trying vp8`),n="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(n)||(console.warn(`${n} not supported, using default`),n="video/webm")),this.mediaRecorder=new MediaRecorder(o,{mimeType:n,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=i=>{var r;((r=i.data)==null?void 0:r.size)>0&&this.recordedChunks.push(i.data)},this.recordedChunks=[]}async encodeVideo(t,e){return this.init(),new Promise((s,o)=>{if(!this.mediaRecorder||!this.ctx||!this.stream||!this.canvas){o(new Error("Encoder not initialized"));return}const n=1e3/this.options.fps;let i=0,r=0;this.mediaRecorder.onstop=()=>{const m=new Blob(this.recordedChunks,{type:"video/webm"});console.log(`Video encoded: ${m.size} bytes, ${i} video frames from ${r} animation frames`),this.cleanup(),s(m)},this.mediaRecorder.start();const c=this.stream.getVideoTracks()[0],d=c&&typeof c.requestFrame=="function";console.log(`Starting video encoding: ${t.length} frames, ${this.options.fps} fps, requestFrame support: ${d}`);let l=0;const u=async()=>{if(r>=t.length){await new Promise(p=>setTimeout(p,500)),this.mediaRecorder.stop();return}const m=t[r];m.render(this.ctx),l+=m.durationMs;const f=Math.floor(l/n);if(f>=1){if(d){await new Promise(p=>requestAnimationFrame(()=>p(void 0)));for(let p=0;p<f;p++)c.requestFrame(),await new Promise(y=>setTimeout(y,5))}else{const p=f*n;await new Promise(y=>setTimeout(y,p))}i+=f,l-=f*n}(r%100===0||r===t.length-1)&&console.log(`Progress: ${r+1}/${t.length} animation frames â†’ ${i} video frames`),e==null||e(r+1,t.length),r++,u()};u()})}cleanup(){this.stream&&this.stream.getTracks().forEach(t=>t.stop()),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.stream=null,this.mediaRecorder=null,this.ctx=null,this.canvas=null}static createCanvasCopyRenderer(t){return e=>{e.drawImage(t,0,0)}}}function xt(h,t){const e=new L(h.x,h.y);for(;e.x>t.x;)e.x-=t.x*2;for(;e.x<-t.x;)e.x+=t.x*2;for(;e.y>t.y;)e.y-=t.y*2;for(;e.y<-t.y;)e.y+=t.y*2;return e}function ct(h,t){const e=new w(h.x,h.y);for(;e.x<0;)e.x+=t.x;for(;e.x>t.x;)e.x-=t.x;for(;e.y<0;)e.y+=t.y;for(;e.y>t.y;)e.y-=t.y;return e}function H(h,t,e){let s=t.x-h.x,o=t.y-h.y;return Math.abs(s)>e.x/2&&(s>0?s-=e.x:s+=e.x),Math.abs(o)>e.y/2&&(o>0?o-=e.y:o+=e.y),{dx:s,dy:o}}function dt(){return new L(O.instance.canvasSize.x,O.instance.canvasSize.y)}function Ft(){return dt().multiply(.5)}function ht(h,t,e,s){const{dx:o,dy:n}=H(h,t,s),i=new w(h.x+o*e,h.y+n*e);return ct(i,s)}function Vt(h,t,e,s,o,n){if(h===null&&s===null)return ht(t,e,o,n);const i=h?H(h,t,n):{dx:0,dy:0},r=H(t,e,n),c=s?H(e,s,n):{dx:0,dy:0},d=h?(i.dx+r.dx)/2:r.dx,l=h?(i.dy+r.dy)/2:r.dy,u=s?(r.dx+c.dx)/2:r.dx,m=s?(r.dy+c.dy)/2:r.dy,f=o,p=f*f,y=p*f,v=2*y-3*p+1,g=y-2*p+f,E=-2*y+3*p,I=y-p,N=v*0+g*d+E*r.dx+I*u,M=v*0+g*l+E*r.dy+I*m,C=new w(t.x+N,t.y+M);return ct(C,n)}function Ut(h,t,e,s,o,n){if(h===null&&s===null)return ht(t,e,o,n);const i=h?H(h,t,n):{dx:0,dy:0},r=H(t,e,n),c=s?H(e,s,n):{dx:0,dy:0},d=h?{x:-i.dx,y:-i.dy}:{x:-r.dx,y:-r.dy},l={x:0,y:0},u={x:r.dx,y:r.dy},m=s?{x:r.dx+c.dx,y:r.dy+c.dy}:{x:2*r.dx,y:2*r.dy},f=o,p=f*f,y=p*f,v=-y+2*p-f,g=3*y-5*p+2,E=-3*y+4*p+f,I=y-p,N=.5*(v*d.x+g*l.x+E*u.x+I*m.x),M=.5*(v*d.y+g*l.y+E*u.y+I*m.y),C=new w(t.x+N,t.y+M);return ct(C,n)}function Gt(h,t){const e=new Set(h.nodes.keys()),s=new Set(t.nodes.keys()),o=Array.from(e).filter(g=>s.has(g)),n=Array.from(e).filter(g=>!s.has(g)),i=Array.from(s).filter(g=>!e.has(g)),r=(g,E,I)=>`${Math.min(g,E)}-${Math.max(g,E)}-${I}`,c=new Map(h.edges.map(g=>[r(g.fromId,g.toId,g.color),g])),d=new Map(t.edges.map(g=>[r(g.fromId,g.toId,g.color),g])),l=h.edges.filter(g=>!d.has(r(g.fromId,g.toId,g.color))),u=t.edges.filter(g=>!c.has(r(g.fromId,g.toId,g.color))),m=(g,E,I)=>`${g}-${E}-${I}`,f=new Map(h.arrows.map(g=>[m(g.fromId,g.toId,g.color),g])),p=new Map(t.arrows.map(g=>[m(g.fromId,g.toId,g.color),g])),y=h.arrows.filter(g=>!p.has(m(g.fromId,g.toId,g.color))),v=t.arrows.filter(g=>!f.has(m(g.fromId,g.toId,g.color)));return{commonNodes:o,removedNodes:n,addedNodes:i,removedEdges:l,addedEdges:u,removedArrows:y,addedArrows:v}}function It(h,t){h.clear(),t.nodes.forEach((e,s)=>{h.setNode({id:s,coordinates:new w(e.x,e.y),radius:e.radius,strokeWidth:e.strokeWidth,fillColor:e.fillColor,strokeColor:e.strokeColor})}),t.edges.forEach(e=>{h.addEdge(e.fromId,e.toId,e.color,e.weight)}),t.arrows.forEach(e=>{h.addArrow(e.fromId,e.toId,e.color,e.width,e.headAtStart,e.headAtEnd)})}function Kt(h,t,e,s,o,n,i){const r=dt(),c=O.instance;i.forEach(d=>{const l=(t==null?void 0:t.nodes.get(d))||null,u=e.nodes.get(d),m=s.nodes.get(d),f=(o==null?void 0:o.nodes.get(d))||null,p=h.getNode(d);if(u&&m&&p){const y=new w(u.x,u.y),v=new w(m.x,m.y);let g;if(c.interpolationMode==="cubic"){const E=l?new w(l.x,l.y):null,I=f?new w(f.x,f.y):null;g=Vt(E,y,v,I,n,r)}else if(c.interpolationMode==="catmull-rom"){const E=l?new w(l.x,l.y):null,I=f?new w(f.x,f.y):null;g=Ut(E,y,v,I,n,r)}else g=ht(y,v,n,r);p.coordinates.x=g.x,p.coordinates.y=g.y,p.radius=u.radius+(m.radius-u.radius)*n,p.strokeWidth=u.strokeWidth+(m.strokeWidth-u.strokeWidth)*n,n<.5?(p.fillColor=u.fillColor,p.strokeColor=u.strokeColor):(p.fillColor=m.fillColor,p.strokeColor=m.strokeColor)}})}function Ht(h,t,e){const s=[],o=O.instance,n=o.isScaled?{x:o.imageScaleFactor,y:o.imageScaleFactor}:{x:1,y:1},i=Math.max(n.x,n.y);return t.addedEdges.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,u=d.coordinates,m=l.x*n.x,f=l.y*n.y,p=u.x*n.x,y=u.y*n.y,v=Math.max(.01,e),g=new Y({x:m,y:f},{x:p,y},v,!0,r.color,r.weight*i,h.zigzagSpacing*i,h.zigzagLength*i,h.zigzagEndLengths*i);s.push(g)}}catch{}}),t.removedEdges.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,u=d.coordinates,m=l.x*n.x,f=l.y*n.y,p=u.x*n.x,y=u.y*n.y,v=1-e,g=new Y({x:m,y:f},{x:p,y},v,!0,r.color,r.weight*i,h.zigzagSpacing*i,h.zigzagLength*i,h.zigzagEndLengths*i);s.push(g)}}catch{}}),s}function jt(h,t,e){const s=[],o=O.instance,n=o.isScaled?{x:o.imageScaleFactor,y:o.imageScaleFactor}:{x:1,y:1},i=Math.max(n.x,n.y);return t.addedArrows.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,u=d.coordinates,m=u.x-l.x,f=u.y-l.y,p=l.x+m*e,y=l.y+f*e,v=l.x*n.x,g=l.y*n.y,E=p*n.x,I=y*n.y,M=h.hasEdgeBetween(r.fromId,r.toId)?8*i:0,C=e>.9,A=new tt({x:v,y:g},{x:E,y:I},r.color,r.width*i,r.headAtStart&&C,r.headAtEnd&&C,M,c.radius*i,d.radius*i);s.push(A)}}catch{}}),t.removedArrows.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,u=d.coordinates,m=1-e,f=u.x-l.x,p=u.y-l.y,y=l.x+f*m,v=l.y+p*m,g=l.x*n.x,E=l.y*n.y,I=y*n.x,N=v*n.y,C=h.hasEdgeBetween(r.fromId,r.toId)?8*i:0,A=m>.1,z=new tt({x:g,y:E},{x:I,y:N},r.color,r.width*i,r.headAtStart&&A,r.headAtEnd&&A,C,c.radius*i,d.radius*i);s.push(z)}}catch{}}),s}class Jt{constructor(t){a(this,"options");a(this,"ctx");a(this,"cels",[]);a(this,"frameDuration");a(this,"isRecording",!1);a(this,"graphStateProvider",null);a(this,"renderCallback",null);this.options=t,this.frameDuration=t.frameDuration||500,this.renderCallback=t.renderCallback||null;const e=t.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context from canvas");this.ctx=e}setGraphStateProvider(t){this.graphStateProvider=t}setRenderCallback(t){this.renderCallback=t}start(){if(this.isRecording){console.warn("Stop-motion recording already in progress");return}this.cels=[],this.isRecording=!0,console.log("Stop-motion recording started")}captureFrame(t){if(!this.isRecording)throw new Error("Not currently recording. Call start() first.");const e=this.ctx.getImageData(0,0,this.options.canvas.width,this.options.canvas.height),s=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=this.graphStateProvider?this.graphStateProvider():this.getEmptyGraphState();this.cels.push({imageData:s,graphState:o,timestamp:Date.now(),duration:t!==void 0?t:this.frameDuration}),console.log(`Frame ${this.cels.length} captured (duration: ${t!==void 0?t:this.frameDuration}ms)`)}getEmptyGraphState(){return{nodes:new Map,edges:[],arrows:[],zigzagSpacing:4,zigzagLength:3,zigzagEndLengths:1.5}}removeLastFrame(){return this.cels.length===0?!1:(this.cels.pop(),console.log(`Last frame removed. ${this.cels.length} frames remaining`),!0)}stop(){if(!this.isRecording){console.warn("Not currently recording");return}this.isRecording=!1,console.log(`Stop-motion recording stopped. ${this.cels.length} frames captured`)}getFrameCount(){return this.cels.length}getIsRecording(){return this.isRecording}setFrameDuration(t){this.frameDuration=t}getFrameDuration(){return this.frameDuration}clear(){this.cels=[],console.log("All frames cleared")}generateInterpolatedFrames(t){const e=1e3/t,s=[];if(!this.renderCallback)throw new Error("Render callback not set. Call setRenderCallback() before using interpolation.");for(let n=0;n<this.cels.length-1;n++){const i=n>0?this.cels[n-1]:null,r=this.cels[n],c=this.cels[n+1],d=n+2<this.cels.length?this.cels[n+2]:null,l=c.duration,u=Math.max(1,Math.round(l/e)),m=Gt(r.graphState,c.graphState);for(let f=0;f<u;f++){const p=f/u,y=v=>{const g=new pt;r.graphState.zigzagSpacing!==void 0&&(g.zigzagSpacing=r.graphState.zigzagSpacing),r.graphState.zigzagLength!==void 0&&(g.zigzagLength=r.graphState.zigzagLength),r.graphState.zigzagEndLengths!==void 0&&(g.zigzagEndLengths=r.graphState.zigzagEndLengths);const E={nodes:r.graphState.nodes,edges:r.graphState.edges.filter(C=>{const A=(x,W,B)=>`${Math.min(x,W)}-${Math.max(x,W)}-${B}`,z=A(C.fromId,C.toId,C.color),P=m.addedEdges.some(x=>A(x.fromId,x.toId,x.color)===z),k=m.removedEdges.some(x=>A(x.fromId,x.toId,x.color)===z);return!P&&!k}),arrows:r.graphState.arrows.filter(C=>{const A=(x,W,B)=>`${x}-${W}-${B}`,z=A(C.fromId,C.toId,C.color),P=m.addedArrows.some(x=>A(x.fromId,x.toId,x.color)===z),k=m.removedArrows.some(x=>A(x.fromId,x.toId,x.color)===z);return!P&&!k})};It(g,E),Kt(g,i?i.graphState:null,r.graphState,c.graphState,d?d.graphState:null,p,m.commonNodes);const I=Ht(g,m,p),N=jt(g,m,p),M=[...I,...N];this.renderCallback(g,M),v.drawImage(this.options.canvas,0,0)};s.push({render:y,durationMs:e})}}const o=this.cels[this.cels.length-1];return s.push({render:n=>{const i=new pt;o.graphState.zigzagSpacing!==void 0&&(i.zigzagSpacing=o.graphState.zigzagSpacing),o.graphState.zigzagLength!==void 0&&(i.zigzagLength=o.graphState.zigzagLength),o.graphState.zigzagEndLengths!==void 0&&(i.zigzagEndLengths=o.graphState.zigzagEndLengths),It(i,o.graphState),this.renderCallback(i,[]),n.drawImage(this.options.canvas,0,0)},durationMs:o.duration}),s}async encode(t=!1,e){if(this.cels.length===0)throw new Error("No frames to encode. Capture some frames first.");console.log(`Encoding ${this.cels.length} frames (interpolate: ${t})`);const s=30,o=new Ct({width:this.options.canvas.width,height:this.options.canvas.height,fps:s,videoBitsPerSecond:5e6});let n;t?n=this.generateInterpolatedFrames(s):n=this.cels.map(r=>({render:c=>{const d=document.createElement("canvas");d.width=r.imageData.width,d.height=r.imageData.height;const l=d.getContext("2d");l&&(l.putImageData(r.imageData,0,0),c.drawImage(d,0,0))},durationMs:r.duration}));const i=await o.encodeVideo(n,e);return console.log(`Video encoded: ${i.size} bytes`),i}async download(t=!1,e="stop-motion-animation.webm"){const s=await this.encode(t),o=URL.createObjectURL(s),n=document.createElement("a");n.style.display="none",n.href=o,n.download=e,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(o)},500)}getFrames(){return this.cels}}const R=class R{static hex2lab(t){const[e,s,o]=R.hex2rgba(t);return R.rgba2lab(e,s,o,1)}static rgba2lab(t,e,s,o){const[n,i,r]=R.rgb2xyz(t,e,s);return R.xyz2lab(n,i,r)}static lab2rgba(t,e,s){const[o,n,i]=R.lab2xyz(t,e,s);return[...R.xyz2rgba(o,n,i),1]}static hex2rgba(t){const e=t.replace(/^#/,"").toUpperCase();if(!/^[0-9A-F]+$/i.test(e)||![3,4,6,8].includes(e.length))throw new Error(`Invalid HEX format: ${t}`);let o=e;[3,4].includes(e.length)&&(o=e.split("").map(l=>l+l).join(""));const n=parseInt(o,16);let i,r,c,d=1;return o.length===8?(d=(n&255)/255,i=n>>16&255,r=n>>8&255,c=n&255):(i=n>>16&255,r=n>>8&255,c=n&255),[Math.min(255,Math.max(0,i)),Math.min(255,Math.max(0,r)),Math.min(255,Math.max(0,c)),Math.min(1,Math.max(0,d))]}static rgb2xyz(t,e,s){const o=c=>c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92,[n,i,r]=[t/255,e/255,s/255].map(c=>o(c)*100);return[n*.4124564+i*.3575761+r*.1804375,n*.2126729+i*.7151522+r*.072175,n*.0193339+i*.119192+r*.9503041]}static xyz2rgba(t,e,s){const o=d=>(d=d>.0031308?1.055*Math.pow(d,.4166666666666667)-.055:12.92*d,Math.round(Math.min(255,Math.max(0,d*255)))),n=[t/100,e/100,s/100],i=n[0]*3.2404542+n[1]*-1.5371385+n[2]*-.4985314,r=n[0]*-.969266+n[1]*1.8760108+n[2]*.041556,c=n[0]*.0556434+n[1]*-.2040259+n[2]*1.0572252;return[o(i),o(r),o(c)]}static xyz2lab(t,e,s){const o=c=>c>.008856?Math.pow(c,.3333333333333333):7.787*c+.13793103448275862,n=o(t/R.REF_X),i=o(e/R.REF_Y),r=o(s/R.REF_Z);return[116*i-16,500*(n-i),200*(i-r)]}static lab2xyz(t,e,s){const o=(t+16)/116,n=e/500+o,i=o-s/200,r=c=>c>.2068966?Math.pow(c,3):(c-16/116)/7.787;return[r(n)*R.REF_X,r(o)*R.REF_Y,r(i)*R.REF_Z]}static deltaE00(t,e){const[s,o,n]=t,[i,r,c]=e,d=G=>G*180/Math.PI,l=G=>G*Math.PI/180,u=1,m=1,f=1,p=Math.sqrt(o**2+n**2),y=Math.sqrt(r**2+c**2),v=(p+y)/2,g=.5*(1-Math.sqrt(v**7/(v**7+25**7))),E=o*(1+g),I=r*(1+g),N=Math.sqrt(E**2+n**2),M=Math.sqrt(I**2+c**2),C=n===0&&E===0?0:d(Math.atan2(n,E))%360,A=c===0&&I===0?0:d(Math.atan2(c,I))%360,z=i-s,P=M-N;let k=0;N*M!==0&&(k=A-C,k>180?k-=360:k<-180&&(k+=360));const x=2*Math.sqrt(N*M)*Math.sin(l(k)/2),W=(s+i)/2,B=(N+M)/2;let D=(C+A)/2;Math.abs(C-A)>180&&(D+=180);const q=1-.17*Math.cos(l(D-30))+.24*Math.cos(l(2*D))+.32*Math.cos(l(3*D+6))-.2*Math.cos(l(4*D-63)),V=1+.015*(W-50)**2/Math.sqrt(20+(W-50)**2),j=1+.045*B,Z=1+.015*B*q,U=30*Math.exp((-((D-275)/25))**2),et=-(2*Math.sqrt(B**7/(B**7+25**7)))*Math.sin(l(2*U));return Math.sqrt((z/(u*V))**2+(P/(m*j))**2+(x/(f*Z))**2+et*(P/(m*j))*(x/(f*Z)))}static adjustLightness(t,e,s,o,n){const[i,r,c]=R.rgba2lab(t,e,s,o),d=Math.min(100,Math.max(0,i+i*n));return[...R.lab2rgba(d,r,c)]}};a(R,"REF_X",95.047),a(R,"REF_Y",100),a(R,"REF_Z",108.883);let rt=R;class Qt{constructor(t,e){a(this,"movieMaker",null);a(this,"stopMotionRecorder",null);a(this,"recordingEdges",[]);a(this,"isRecordingEdges",!1);this.canvas=t,this.container=e}initialize(){this.movieMaker=new qt({canvas:this.canvas,recorderOptions:{fps:60,videoBitsPerSecond:5e6},animatorOptions:{targetFPS:60}})}getMovieMaker(){return this.movieMaker}get isRecording(){return this.isRecordingEdges}get recordedEdgeCount(){return this.recordingEdges.length}getSerializableAnimationData(){const t={};if(this.stopMotionRecorder){const e=this.stopMotionRecorder.getFrames();e.length>0&&(t.stopMotion={frames:e.map(s=>({graphState:{nodes:Array.from(s.graphState.nodes.entries()).map(([o,n])=>({id:o,x:n.x,y:n.y,radius:n.radius,strokeWidth:n.strokeWidth,fillColor:n.fillColor,strokeColor:n.strokeColor})),edges:s.graphState.edges,arrows:s.graphState.arrows,zigzagSpacing:s.graphState.zigzagSpacing,zigzagLength:s.graphState.zigzagLength,zigzagEndLengths:s.graphState.zigzagEndLengths},duration:s.duration,timestamp:s.timestamp})),frameDuration:this.stopMotionRecorder.getFrameDuration(),isRecording:this.stopMotionRecorder.getIsRecording()})}return(this.recordingEdges.length>0||this.isRecordingEdges)&&(t.recordedEdges={edges:this.recordingEdges.map(e=>({type:e.type,fromNodeId:e.fromNode.id,toNodeId:e.toNode.id,color:e.color,weight:e.weight})),isRecording:this.isRecordingEdges}),Object.keys(t).length>0?t:null}restoreAnimationData(t,e){const s=this.container.get("ui");if(t.stopMotion&&t.stopMotion.frames){const o=this.getStopMotionRecorder();o.clear(),t.stopMotion.frameDuration!==void 0&&o.setFrameDuration(t.stopMotion.frameDuration),t.stopMotion.frames.forEach(i=>{const r=new Map;i.graphState.nodes.forEach(d=>{r.set(d.id,{x:d.x,y:d.y,radius:d.radius,strokeWidth:d.strokeWidth,fillColor:d.fillColor,strokeColor:d.strokeColor})});const c=new ImageData(1,1);o.cels.push({imageData:c,graphState:{nodes:r,edges:i.graphState.edges,arrows:i.graphState.arrows,zigzagSpacing:i.graphState.zigzagSpacing,zigzagLength:i.graphState.zigzagLength,zigzagEndLengths:i.graphState.zigzagEndLengths},duration:i.duration,timestamp:i.timestamp})}),t.stopMotion.isRecording&&(o.isRecording=!0);const n=t.stopMotion.frames.length;console.log(`Restored ${n} stop-motion frames`),t.stopMotion.isRecording?(s.updateStopMotionIndicator(`Recording... (${n} frame${n!==1?"s":""})`,"red"),this.updateStopMotionButtons(!0,n)):n>0&&(s.updateStopMotionIndicator(`${n} frame${n!==1?"s":""} captured`,"green"),this.updateStopMotionButtons(!1,n))}t.recordedEdges&&t.recordedEdges.edges&&(this.recordingEdges=t.recordedEdges.edges.map(o=>{const n=e.getNode(o.fromNodeId),i=e.getNode(o.toNodeId);return{type:o.type,fromNode:n,toNode:i,color:o.color,weight:o.weight}}),this.isRecordingEdges=t.recordedEdges.isRecording||!1,console.log(`Restored ${this.recordingEdges.length} recorded edges`))}downloadBlob(t,e){const s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o),URL.revokeObjectURL(s)},500)}async encodeVideoFrames(t,e){const s=new Ct({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),o=t.map(n=>({render:i=>{n.action(),i.drawImage(this.canvas,0,0)},durationMs:n.duration}));return await s.encodeVideo(o,e)}async createSimulationMovie(t,e,s,o){if(!this.movieMaker)throw new Error("Movie maker not initialized");const n=this.container.get("graph"),i=this.container.get("app"),r=this.container.get("ui"),c=this.container.get("simulations");let d,l;if(t==="force_balance")d=()=>c.doForceBalanceStep(n),l="Force Balance";else if(t==="position_equilibration")d=()=>c.doPositionEquilibrationStep(n),l="Position Equilibration";else throw new Error("Invalid simulation type");const u=new Map;n.getAllNodes().forEach(m=>{u.set(m.id,{x:m.coordinates.x,y:m.coordinates.y})});try{let m=Array(e).fill(s);if(o){const p=u;let y=p;const v=[];for(let I=0;I<e;I++){d();let N=0;n.getAllNodes().forEach(A=>{const z=y.get(A.id);if(z){const P=A.coordinates.x-z.x,k=A.coordinates.y-z.y;N+=Math.sqrt(P*P+k*k)}});const M=N/n.getAllNodes().length;v.push(M);const C=new Map;n.getAllNodes().forEach(A=>{C.set(A.id,{x:A.coordinates.x,y:A.coordinates.y})}),y=C}const g=e*s,E=v.reduce((I,N)=>I+N,0);m=v.map(I=>I>0?Math.min(g,g/E*I):s),n.getAllNodes().forEach(I=>{const N=p.get(I.id);N&&(I.coordinates.x=N.x,I.coordinates.y=N.y)})}const f=[];if(o)for(let p=0;p<e;p++){const y=m[p],v=Math.max(1,Math.ceil(y/s)),g=new Map;n.getAllNodes().forEach(M=>{g.set(M.id,{x:M.coordinates.x,y:M.coordinates.y})}),d();const E=new Map;n.getAllNodes().forEach(M=>{E.set(M.id,{x:M.coordinates.x,y:M.coordinates.y})}),n.getAllNodes().forEach(M=>{const C=g.get(M.id);C&&(M.coordinates.x=C.x,M.coordinates.y=C.y)});const I=v+1,N=y/I;for(let M=0;M<=v;M++){const C=M/v;f.push({action:()=>{const A=dt();n.getAllNodes().forEach(z=>{const P=g.get(z.id),k=E.get(z.id);if(P&&k){const x=ht(P,k,C,A);z.coordinates.x=x.x,z.coordinates.y=x.y}}),i.render()},duration:N})}n.getAllNodes().forEach(M=>{const C=E.get(M.id);C&&(M.coordinates.x=C.x,M.coordinates.y=C.y)})}else for(let p=0;p<e;p++)f.push({action:()=>{d(),i.render()},duration:s});r.updateMovieStatus(`Encoding ${l} simulation (${e} steps${o?" with adaptive duration":""})...`);try{const p=await this.encodeVideoFrames(f,(y,v)=>{r.updateMovieStatus(`Encoding: ${y}/${v} frames (${Math.round(y/v*100)}%)`)});this.downloadBlob(p,`${t}-simulation.webm`),r.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>r.updateMovieStatus(""),3e3)}catch(p){throw console.error("Error creating movie:",p),new Error("Error creating movie: "+p)}}finally{n.getAllNodes().forEach(m=>{const f=u.get(m.id);f&&(m.coordinates.x=f.x,m.coordinates.y=f.y)})}}getStopMotionRecorder(){if(!this.stopMotionRecorder){this.stopMotionRecorder=new Jt({canvas:this.canvas,frameDuration:500,scaleFactor:2});const e=this.container.get("graph"),s=this.container.get("app");this.stopMotionRecorder.setGraphStateProvider(()=>{const n=new Map;e.getAllNodes().forEach(c=>{n.set(c.id,{x:c.coordinates.x,y:c.coordinates.y,radius:c.radius,strokeWidth:c.strokeWidth,fillColor:c.fillColor,strokeColor:c.strokeColor})});const i=e.getAllEdges().map(c=>({fromId:c.fromId,toId:c.toId,color:c.color,weight:c.weight})),r=e.getAllArrows().map(c=>({fromId:c.fromId,toId:c.toId,color:c.color,width:c.width,headAtStart:c.headAtStart,headAtEnd:c.headAtEnd}));return{nodes:n,edges:i,arrows:r,zigzagSpacing:e.zigzagSpacing,zigzagLength:e.zigzagLength,zigzagEndLengths:e.zigzagEndLengths}});let o=1;this.stopMotionRecorder._setExportScaleFactor=n=>{o=n},this.stopMotionRecorder.setRenderCallback((n,i)=>{const r=this.container.get("graph");n.scalingFactor={x:o,y:o},this.container.register("graph",n);try{s.render({x:1,y:1},i||[])}finally{this.container.register("graph",r)}})}return this.stopMotionRecorder}startStopMotionRecording(){this.getStopMotionRecorder().start(),console.log("Stop-motion recording started")}captureStopMotionFrame(t){const e=this.getStopMotionRecorder();return e.captureFrame(t),e.getFrameCount()}removeLastStopMotionFrame(){const t=this.getStopMotionRecorder();return t.removeLastFrame(),t.getFrameCount()}stopStopMotionRecording(){const t=this.getStopMotionRecorder(),e=t.getFrameCount();return t.stop(),console.log(`Stop-motion recording stopped with ${e} frames`),e}getStopMotionFrameCount(){return this.getStopMotionRecorder().getFrameCount()}isStopMotionRecording(){return this.getStopMotionRecorder().getIsRecording()}setStopMotionFrameDuration(t){this.getStopMotionRecorder().setFrameDuration(t)}getStopMotionFrameDuration(){return this.getStopMotionRecorder().getFrameDuration()}clearStopMotionFrames(){this.getStopMotionRecorder().clear()}updateStopMotionButtons(t,e){const s=document.getElementById("startStopMotionBtn"),o=document.getElementById("captureFrameBtn"),n=document.getElementById("removeLastFrameBtn"),i=document.getElementById("stopStopMotionBtn"),r=document.getElementById("clearStopMotionFramesBtn");t?(s&&(s.disabled=!0),o&&(o.disabled=!1),n&&(n.disabled=!1),i&&(i.disabled=!1),r&&(r.disabled=!0)):(s&&(s.disabled=!1),o&&(o.disabled=!0),n&&(n.disabled=e===0),i&&(i.disabled=!0),r&&(r.disabled=e===0))}async createStopMotionMovie(t=!1,e){const s=this.getStopMotionRecorder(),o=this.container.get("ui"),n=this.container.get("canvas"),i=this.container.get("graph"),r=this.container.get("app"),c=this.container.get("settings"),d=s.getFrameCount();if(d===0)throw new Error("No frames captured! Capture some frames first.");o.updateMovieStatus(`Encoding stop-motion animation (${d} frames)...`);try{const l=c.imageScaleFactor;await n.withScaledCanvas(async()=>{r.renderModeInteractive.value=!1,s._setExportScaleFactor(l);try{const u=await s.encode(t,(f,p)=>{o.updateMovieStatus(`Encoding: ${f}/${p} frames (${Math.round(f/p*100)}%)`)}),m=e||"stop-motion-animation.webm";this.downloadBlob(u,m),o.updateMovieStatus("Stop-motion movie saved successfully!"),setTimeout(()=>o.updateMovieStatus(""),3e3)}finally{r.renderModeInteractive.value=!0,s._setExportScaleFactor(1)}},l,r,i,c)}catch(l){throw console.error("Error creating stop-motion movie:",l),o.updateMovieStatus("Error creating movie!"),l}}}class te{constructor(){a(this,"selectedItems",[])}toggleItems(t){t.forEach(e=>{this.hasItem(e)?this.removeItem(e):this.addItem(e)})}addItem(t){this.selectedItems.push(t)}setItem(t){this.selectedItems=[t]}hasItem(t){return this.selectedItems.includes(t)}hasItems(t){return t.every(e=>this.hasItem(e))}setSelectedItems(t){this.selectedItems=t}removeItem(t){this.selectedItems=this.selectedItems.filter(e=>e!==t)}removeLastItem(){this.selectedItems.length>0&&this.selectedItems.pop()}getSelectedItems(){return this.selectedItems}getItemsOfClass(t){return this.selectedItems.filter(e=>e instanceof t)}clearSelection(){this.selectedItems=[]}get empty(){return this.selectedItems.length===0}get length(){return this.selectedItems.length}}const F=new te;function ee(h,t){const e=new L(h.coordinates.x,h.coordinates.y);return new L(t.coordinates.x,t.coordinates.y).subtract(e)}function se(){const h=dt(),t=Ft();F.getItemsOfClass(b).forEach(s=>{const o=S.getNodesConnectedToNode(s.id);let n=new L(0,0);o.forEach(r=>{const c=ee(s,r),d=xt(c,t).multiply(1/o.length);n=n.add(d)});const i=ct(new L(n.x+s.coordinates.x,n.y+s.coordinates.y),h);s.coordinates.x=i.x,s.coordinates.y=i.y})}function oe(h){const t=dt(),e=document.getElementById("randomWalkStepSize").valueAsNumber,s=document.getElementById("randomWalkMaxAngle").valueAsNumber*Math.PI/180,o=document.getElementById("randomWalkSteps").valueAsNumber,n=[],i=[],r=document.getElementById("vertexRadius").valueAsNumber,c=document.getElementById("vertexStrokeWidth").valueAsNumber,d=document.getElementById("nodeFillColor").value,l=document.getElementById("nodeColor").value,u=new b(S.getNextNodeId(),h,r,c,d,l);n.push(u);let m=new w(h.x,h.y),f=Math.random()*2*Math.PI;const p=document.getElementById("edgeColor").value,y=parseFloat(document.getElementById("lineWidth").value);for(let v=0;v<o;v++){const g=(Math.random()*2-1)*s;f+=g;const E=m.x+e*Math.cos(f),I=m.y+e*Math.sin(f);m=new w(E,I),m=ct(m,t);const N=new b(S.getNextNodeId()+v+1,m,r,c,d,l);n.push(N);const M=n[n.length-2],C=new mt(M.id,N.id,-1,y,p);i.push(C)}return{nodes:n,edges:i}}function ne(){const h=F.getItemsOfClass(b);if(console.log("Equilibrating "+h.length+" nodes..."),h.length<1)return;const t=Ft(),e=25;for(const s of h){let o=new L(0,0);for(const i of S.getAllNodes()){if(s.id===i.id)continue;const r=new L(s.coordinates.x,s.coordinates.y);let d=new L(i.coordinates.x,i.coordinates.y).subtract(r);d=xt(d,t);const l=Math.sqrt(d.x*d.x+d.y*d.y);if(l>0){const u=e/(l*l),m=d.multiply(-u);o=o.add(m)}}o.x>s.radius&&(o.x=s.radius),o.x<-s.radius&&(o.x=-s.radius),o.y>s.radius&&(o.y=s.radius),o.y<-s.radius&&(o.y=-s.radius);const n=new L(s.coordinates.x+o.x,s.coordinates.y+o.y);s.coordinates=n}}class ${static serialize(t,e,s){const o={version:this.STORAGE_VERSION,timestamp:new Date().toISOString(),graph:t,settings:e};return s&&Object.keys(s).length>0&&(o.animations=s),o}static deserialize(t,e,s){try{return t.version&&t.version!==this.STORAGE_VERSION&&console.warn(`State version mismatch. Expected ${this.STORAGE_VERSION}, got ${t.version}`),"settings"in t?(t.graph&&e.fromJSON(t.graph),t.settings&&this.applySettings(t.settings,s)):e.fromJSON(t),{success:!0,animations:t.animations}}catch(o){return console.error("Failed to deserialize state:",o),{success:!1}}}static applySettings(t,e){t.canvasSize&&(e.canvasSize.x=t.canvasSize.x,e.canvasSize.y=t.canvasSize.y),t.backgroundColor!==void 0&&(e.backgroundColor=t.backgroundColor),t.imageScaleFactor!==void 0&&(e.imageScaleFactor=t.imageScaleFactor),t.disablePBC!==void 0&&(e.disablePBC=t.disablePBC)}static saveState(t,e,s){try{const o=this.serialize(t,e,s);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(o)),console.log("State saved to localStorage")}catch(o){console.error("Failed to save state to localStorage:",o)}}static loadState(t,e){try{const s=localStorage.getItem(this.STORAGE_KEY);if(!s)return console.log("No saved state found in localStorage"),{success:!1};const o=JSON.parse(s),n=this.deserialize(o,t,e);return n.success&&console.log(`State loaded from localStorage (saved at ${o.timestamp||"unknown time"})`),n}catch(s){return console.error("Failed to load state from localStorage:",s),{success:!1}}}static clearState(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("State cleared from localStorage")}catch(t){console.error("Failed to clear state from localStorage:",t)}}static hasSavedState(){try{return localStorage.getItem(this.STORAGE_KEY)!==null}catch(t){return console.error("Failed to check for saved state:",t),!1}}}a($,"STORAGE_KEY","polymer-graph-sketcher-state"),a($,"STORAGE_VERSION","1.0");function Nt(h,t){if(h===t)return;if(h>t)return Nt(t,h);S.getEdgesInvolvingNode(t).forEach(n=>{n.fromId===t?n.fromId=h:n.toId=h});const s=S.getNode(h),o=S.getNode(t);s.coordinates.x=(s.coordinates.x+o.coordinates.x)/2,s.coordinates.y=(s.coordinates.y+o.coordinates.y)/2,S.deleteNode(t)}function ie(h){let t;do{t=!1;for(const e of S.getAllEdges())if(e.color===h){Nt(e.fromId,e.toId),S.deleteEdge(e),t=!0;break}}while(t);F.clearSelection()}function re(){const h=S.getAllNodes();for(const t of h){const e=S.getEdgesInvolvingNode(t.id);e.length===2&&e[0].color===e[1].color&&e[0].weight===e[1].weight&&(S.deleteEdge(e[0]),S.deleteEdge(e[1]),S.addEdge(e[0].fromId==t.id?e[0].toId:e[0].fromId,e[1].fromId==t.id?e[1].toId:e[1].fromId,e[0].color,e[0].weight),S.deleteNode(t.id))}}class ae{constructor(t){a(this,"container");this.container=t}generateSideChains(t,e,s,o){const n=this.container.get("selection"),i=this.container.get("graph"),r=this.container.get("actionManager"),c=this.container.get("nodeCounter"),d=this.container.get("ui");n.getItemsOfClass(b).forEach(u=>{const m=i.getEdgesInvolvingNode(u.id);if(m.length!==2)return;const f=i.getNode(m[0].getOtherNodeId(u.id)),p=i.getNode(m[1].getOtherNodeId(u.id));if(!f||!p)return;const y=p.coordinates.x-f.coordinates.x,v=p.coordinates.y-f.coordinates.y,g=Math.sqrt(y*y+v*v),E=y/g,I=v/g,N=-I,M=E,C=I,A=-E,z=Math.floor(e),P=e-z,k=z+(Math.random()<P?1:0);let x=Math.random()<.5;const W=this.container.get("AddNodeAction"),B=this.container.get("AddEdgeAction");for(let D=0;D<k;D++){x=!x;const q=x?N:C,V=x?M:A,j=Math.PI*o,Z=(Math.random()*2-1)*j,U=Math.cos(Z),J=Math.sin(Z),et=q*U-V*J,G=q*J+V*U,st=u.coordinates.x+et*t*(1-s*Math.random()),ot=u.coordinates.y+G*t*(1-s*Math.random()),nt=c.value++,lt=new b(nt,{x:st,y:ot},u.radius,u.strokeWidth,u.fillColor,u.strokeColor);r.addAction(new W(nt,{x:st,y:ot},d)),r.addAction(new B(u,[lt],d))}})}removeBifunctionalNodes(){const t=this.container.get("app");re(),t.render()}mergeEdgesByColor(t){const e=this.container.get("app");ie(t),e.render()}removeDuplicateEdges(){const t=this.container.get("graph"),e=this.container.get("app");t.removeDuplicateEdges(),e.render()}removeSelfEdges(){const t=this.container.get("graph"),e=this.container.get("app");t.cleanupEdges(),e.render()}clearGraph(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("modeFactory"),o=this.container.get("app");t.clear(),e.clearSelection(),s.setCurrentMode("vertex"),o.render()}}class ce{constructor(t){a(this,"container");this.container=t}exportGraph(){const t=this.container.get("graph"),e=this.container.get("settings");let s=null;try{const c=this.container.get("movieFacade");c&&(s=c.getSerializableAnimationData())}catch{console.log("MovieFacade not available for animation export")}const o=$.serialize(t,e,s),n=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download="graph.json",r.click(),URL.revokeObjectURL(i)}importGraph(t){const e=this.container.get("graph"),s=this.container.get("settings"),o=this.container.get("ui"),n=this.container.get("canvas"),i=this.container.get("app"),r=new FileReader;r.onload=c=>{var d;if((d=c.target)!=null&&d.result)try{const l=JSON.parse(c.target.result),u=$.deserialize(l,e,s);if(u.success){n.resize(s.canvasSize.x,s.canvasSize.y),o.updateCanvasSizeUI(s.canvasSize.x,s.canvasSize.y);const m=this.container.get("nodeCounter");if(m&&e.getNrOfNodes()>0){const f=e.getAllNodeIds();m.value=Math.max(...f)+1}if(u.animations)try{const f=this.container.get("movieFacade");f&&(f.restoreAnimationData(u.animations,e),console.log("Animation data restored from file"))}catch(f){console.warn("Could not restore animation data:",f)}i.render()}else alert("Failed to import graph. The file may be corrupted or in an incompatible format.")}catch(l){console.error("Error importing graph:",l),alert("Failed to import graph. Please check the file format.")}},r.readAsText(t)}saveCanvasAsImage(t){const e=this.container.get("app"),s=this.container.get("canvas"),o=()=>{e.render();const n=s.toDataURL("image/png"),i=document.createElement("a");i.href=n,i.download="polymer-graph-sketch.png",i.click()};t?t(o):o()}saveGraphAsSvg(){const t=this.container.get("settings"),e=this.container.get("app"),s=new Tt(t.canvasSize.x,t.canvasSize.y);e.elementsToDraw.value.forEach(r=>{r.draw(s)});const o=s.getSVG(),n=new XMLSerializer().serializeToString(o),i=document.createElement("a");i.href="data:image/svg+xml;base64,"+btoa(n),i.download="graph.svg",i.click()}}class de{constructor(t){a(this,"doneStack",[]);a(this,"undoneStack",[]);a(this,"afterActionCallback");this.afterActionCallback=t}addAction(t){this.doneStack.push(t),t.do(),this.undoneStack=[],this.afterActionCallback()}undo(){if(this.doneStack.length){const t=this.doneStack.pop();t.undo(),this.undoneStack.push(t),this.afterActionCallback()}}redo(){if(this.undoneStack.length){const t=this.undoneStack.pop();t.do(),this.doneStack.push(t),this.afterActionCallback()}}}class he{constructor(t,e,s){a(this,"affectedNodes");a(this,"originalValues");a(this,"targetValue");a(this,"property");this.affectedNodes=t,this.originalValues=t.map(o=>o[s]),this.targetValue=e,this.property=s}do(){this.affectedNodes.forEach(t=>{t[this.property]=this.targetValue})}undo(){this.affectedNodes.forEach((t,e)=>{t[this.property]=this.originalValues[e]})}}class le{constructor(t,e,s){a(this,"affectedNodes");a(this,"originalPositions");a(this,"newPositions");this.affectedNodes=t,this.originalPositions=e.map(o=>new w(o.x,o.y)),this.newPositions=s.map(o=>new w(o.x,o.y))}do(){this.affectedNodes.forEach((t,e)=>{t.coordinates.x=this.newPositions[e].x,t.coordinates.y=this.newPositions[e].y})}undo(){this.affectedNodes.forEach((t,e)=>{t.coordinates.x=this.originalPositions[e].x,t.coordinates.y=this.originalPositions[e].y})}}class ge{constructor(t){this.nodes=t}do(){this.nodes.forEach(t=>{S.setNode(new b(t.id,t.coordinates,t.radius,t.strokeWidth,t.fillColor,t.strokeColor))}),F.setSelectedItems(this.nodes.map(t=>S.getNode(t.id)))}undo(){this.nodes.forEach(t=>{S.deleteNode(t.id)})}}class At{constructor(t,e,s){this.nodeId=t,this.position=e,this.uiFacade=s}do(){S.setNode(new b(this.nodeId,this.position,this.uiFacade.getInputValueAsNumber("vertexRadius"),this.uiFacade.getInputValueAsNumber("vertexStrokeWidth"),this.uiFacade.getInputValue("nodeFillColor"),this.uiFacade.getInputValue("nodeColor"))),F.setItem(S.getNode(this.nodeId))}undo(){S.deleteNode(this.nodeId)}}class bt{constructor(t){a(this,"affectedEdges",[]);this.affectedNodes=t}do(){this.affectedNodes.forEach(t=>{S.getEdgesInvolvingNode(t.id).forEach(e=>{this.affectedEdges.push(e)}),F.removeItem(t),S.deleteNode(t.id)})}undo(){this.affectedNodes.forEach(t=>{S.setNode(t),F.addItem(t)}),this.affectedEdges.forEach(t=>{S.addEdge(t.fromId,t.toId,t.color,t.weight)})}}class X{constructor(t,e=!1){a(this,"previousSelectedNodes",F.getSelectedItems());this.affectedNodes=t,this.clearSelection=e}do(){this.clearSelection?F.setSelectedItems(this.affectedNodes):this.affectedNodes.forEach(t=>{F.addItem(t)})}undo(){F.setSelectedItems(this.previousSelectedNodes)}}class ue{constructor(t){a(this,"previousSelectedNodes",F.getSelectedItems());this.affectedNodes=t,this.affectedNodes.forEach(e=>{this.previousSelectedNodes.includes(e)||console.warn("Trying to unselect a node that is not selected")}),console.log("Unselecting nodes:",this.affectedNodes)}do(){F.setSelectedItems(this.previousSelectedNodes.filter(t=>!(t instanceof b&&this.affectedNodes.includes(t))))}undo(){F.setSelectedItems(this.previousSelectedNodes)}}class zt{constructor(t=F.getItemsOfClass(b)){this.previousSelectedNodes=t}do(){F.setSelectedItems(S.getAllNodes())}undo(){F.setSelectedItems(this.previousSelectedNodes)}}class kt{constructor(t=F.getSelectedItems()){this.previousSelectedNodes=t}do(){F.clearSelection()}undo(){F.setSelectedItems(this.previousSelectedNodes)}}class Rt{constructor(t=F.getSelectedItems()){this.previousSelectedNodes=t}do(){F.toggleItems(S.getAllNodes())}undo(){F.setSelectedItems(this.previousSelectedNodes)}}class me{constructor(t,e,s){a(this,"edgeIds",[]);if(this.edgesFrom=t,this.edgesTo=e,this.uiFacade=s,t.length!==e.length)throw new Error("edgesFrom and edgesTo must have the same length")}do(){for(let t=0;t<this.edgesFrom.length;t++)this.edgeIds.push(S.addEdge(this.edgesFrom[t],this.edgesTo[t],this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}undo(){this.edgeIds.slice().reverse().forEach(t=>{S.deleteEdge(t)})}}class Pt{constructor(t,e,s){a(this,"edgeIds",[]);this.fromNode=t,this.affectedNodes=e,this.uiFacade=s}do(){this.affectedNodes.forEach(t=>{this.edgeIds.push(S.addEdge(this.fromNode.id,t.id,this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}),this.affectedNodes.length<=1&&F.setItem(this.fromNode)}undo(){this.edgeIds.slice().reverse().forEach(t=>{S.deleteEdge(t)}),F.setSelectedItems(this.affectedNodes)}}class fe{constructor(t,e){a(this,"edges",[]);this.additionalNode=e,e&&t.push(e),this.edges=S.getEdgesInvolvingNodes(t.map(s=>s.id))}do(){this.edges.forEach(t=>{S.deleteEdge(t)}),this.additionalNode&&F.addItem(this.additionalNode)}undo(){this.edges.forEach(t=>{S.addEdge(t.fromId,t.toId,t.color,t.weight)}),this.additionalNode&&F.removeItem(this.additionalNode)}}class pe{constructor(t,e,s){a(this,"arrowIds",[]);this.fromNode=t,this.affectedNodes=e,this.uiFacade=s}do(){this.affectedNodes.forEach(t=>{this.arrowIds.push(S.addArrow(this.fromNode.id,t.id,this.uiFacade.getInputValue("arrowColor"),this.uiFacade.getInputValueAsNumber("arrowWidth"),this.uiFacade.getInputChecked("arrowHeadAtStart"),this.uiFacade.getInputChecked("arrowHeadAtEnd")))}),this.affectedNodes.length<=1&&F.setItem(this.fromNode)}undo(){this.arrowIds.slice().reverse().forEach(t=>{S.deleteArrow(t)}),F.setSelectedItems(this.affectedNodes)}}class ye{constructor(t){a(this,"deletedArrows",[]);this.arrows=t}do(){this.deletedArrows=this.arrows.map(t=>({arrow:new ft(t.fromId,t.toId,t.id,t.color,t.width,t.headAtStart,t.headAtEnd),index:S.getAllArrows().indexOf(t)})),this.arrows.slice().reverse().forEach(t=>{S.deleteArrow(t)})}undo(){this.deletedArrows.sort((t,e)=>t.index-e.index).forEach(t=>{S.addArrow(t.arrow.fromId,t.arrow.toId,t.arrow.color,t.arrow.width,t.arrow.headAtStart,t.arrow.headAtEnd)})}}class ve{constructor(t){a(this,"container");a(this,"canvas");a(this,"dragStart",null);a(this,"draggedNodes",[]);a(this,"originalNodePositions",[]);a(this,"isDraggingNode",!1);this.container=t,this.canvas=t.get("canvas").canvas}attachEventListeners(){this.canvas.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("mousedown",this.handleMouseDown.bind(this)),window.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleClick(t){if(this.dragStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),n=this.container.get("modeFactory").getCurrentMode(),i=this.container.get("actionManager");n&&n.onCanvasClick(s,i)}handleMouseDown(t){this.dragStart={x:t.clientX,y:t.clientY};const s=this.container.get("modeFactory").getCurrentMode(),n=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),r=this.container.get("graph").findNodeByCoordinates(n.x,n.y);if(s&&s.onMouseDown)if(s.onMouseDown(t),r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(b),this.originalNodePositions=this.draggedNodes.map(d=>new w(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1;else if(r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(b),this.originalNodePositions=this.draggedNodes.map(d=>new w(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1}handleMouseMove(t){const s=this.container.get("modeFactory").getCurrentMode(),o=this.container.get("app");if(s&&s.onMouseMove&&s.onMouseMove(t)&&o.render(),!!this.dragStart&&this.isDraggingNode){const n=t.clientX-this.dragStart.x,i=t.clientY-this.dragStart.y,r=this.container.get("selection"),c=O.instance;r.getItemsOfClass(b).forEach(d=>{d.coordinates.x+=n,d.coordinates.y+=i,d.coordinates.x<0&&(d.coordinates.x+=c.canvasSize.x),d.coordinates.x>=c.canvasSize.x&&(d.coordinates.x-=c.canvasSize.x),d.coordinates.y<0&&(d.coordinates.y+=c.canvasSize.y),d.coordinates.y>=c.canvasSize.y&&(d.coordinates.y-=c.canvasSize.y)}),this.dragStart={x:t.clientX,y:t.clientY},o.render();return}}handleMouseUp(t){const s=this.container.get("modeFactory").getCurrentMode();if(this.dragStart&&this.isDraggingNode&&this.draggedNodes.length>0){const o=this.draggedNodes.map(i=>new w(i.coordinates.x,i.coordinates.y));if(this.originalNodePositions.some((i,r)=>i.x!==o[r].x||i.y!==o[r].y)){const i=this.container.get("actionManager"),r=new le(this.draggedNodes,this.originalNodePositions,o);r.undo(),i.addAction(r)}}else s&&s.onMouseUp&&s.onMouseUp(t);this.dragStart=null,this.draggedNodes=[],this.originalNodePositions=[],this.isDraggingNode=!1}detachEventListeners(){this.canvas.removeEventListener("click",this.handleClick.bind(this)),window.removeEventListener("mousedown",this.handleMouseDown.bind(this)),window.removeEventListener("mousemove",this.handleMouseMove.bind(this)),window.removeEventListener("mouseup",this.handleMouseUp.bind(this))}}class we{constructor(t){a(this,"container");this.container=t}attachListener(t,e,s){const o=document.getElementById(t);o&&o.addEventListener(e,n=>s(o,n))}attachButtonClick(t,e){this.attachListener(t,"click",e)}attachInputChange(t,e){this.attachListener(t,"change",s=>e(s))}attachEventListeners(){this.attachModeSwitch(),this.attachNodePropertyListeners(),this.attachEdgePropertyListeners(),this.attachArrowPropertyListeners(),this.attachCanvasPropertyListeners(),this.attachButtonListeners(),this.attachRedrawListeners()}attachModeSwitch(){const t=document.getElementById("modeSwitch");t&&t.addEventListener("click",()=>{this.container.get("modeFactory").setCurrentMode(t.value)})}attachNodePropertyListeners(){const t=this.container.get("actionManager"),e=this.container.get("selection"),s=(o,n)=>i=>{if(e.empty)return;const r=n(i.value);t.addAction(new he(e.getItemsOfClass(b),r,o))};this.attachInputChange("vertexRadius",s("radius",parseFloat)),this.attachInputChange("vertexStrokeWidth",s("strokeWidth",parseFloat)),this.attachInputChange("nodeFillColor",s("fillColor",o=>o)),this.attachInputChange("nodeColor",s("strokeColor",o=>o)),this.attachInputChange("selectVerticesStroke",o=>{const n=this.container.get("graph");t.addAction(new X(n.getAllNodes().filter(i=>rt.deltaE00(rt.hex2lab(i.strokeColor),rt.hex2lab(o.value))<10),!0))})}attachEdgePropertyListeners(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("app"),o=(n,i)=>r=>{const c=e.getItemsOfClass(b).map(d=>d.id);t.getEdgesWithBothEndsInNodes(c).forEach(d=>{d[n]=i(r.value)}),s.render()};this.attachInputChange("edgeColor",o("color",n=>n)),this.attachInputChange("lineWidth",o("weight",parseFloat))}attachArrowPropertyListeners(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("app"),o=(n,i)=>r=>{const c=e.getItemsOfClass(b).map(d=>d.id);t.getArrowsWithBothEndsInNodes(c).forEach(d=>{d[n]=i(r)}),s.render()};this.attachInputChange("arrowColor",o("color",n=>n.value)),this.attachInputChange("arrowWidth",o("width",n=>parseFloat(n.value))),this.attachInputChange("arrowHeadAtStart",o("headAtStart",n=>n.checked)),this.attachInputChange("arrowHeadAtEnd",o("headAtEnd",n=>n.checked))}attachCanvasPropertyListeners(){const t=this.container.get("actionManager"),e=this.container.get("settings"),s=this.container.get("canvas"),o=this.container.get("app"),n=this.container.get("graph"),i=this.container,r=(c,d)=>{const l=c==="x"?"width":"height",u=e.canvasSize[c],m=f=>{const p=document.getElementById("canvas-parent");p.style[l]=f+"px",e.canvasSize[c]=f;const v=i.get("ui").getInputChecked("resizeElements"),g=s.resizeWithGraphScaling(e.canvasSize.x,e.canvasSize.y,v,n);o.render({x:g.xScaling,y:g.yScaling}),document.getElementById("canvas-size").textContent=`Canvas size: ${e.canvasSize.x}x${e.canvasSize.y}`};return{do:()=>m(d),undo:()=>m(u)}};this.attachInputChange("canvasWidth",c=>{const d=parseFloat(c.value);t.addAction(r("x",d))}),this.attachInputChange("canvasHeight",c=>{const d=parseFloat(c.value);t.addAction(r("y",d))}),this.attachInputChange("disablePBC",c=>{e.disablePBC=c.checked,o.render()})}attachButtonListeners(){const t=this.container.get("actionManager"),e=this.container.get("graphOperations"),s=this.container.get("fileService");this.attachButtonClick("clearSelectionButton",()=>{t.addAction(new kt)}),this.attachButtonClick("selectAllButton",()=>{t.addAction(new zt)}),this.attachButtonClick("invertSelectionButton",()=>{t.addAction(new Rt)}),this.attachButtonClick("clearCanvasButton",()=>{e.clearGraph()}),this.attachButtonClick("clearSavedStateButton",()=>{if(confirm("Are you sure you want to clear the saved state? This action cannot be undone.")){const i=this.container.get("StorageService");i&&(i.clearState(),alert("Saved state has been cleared. The current canvas will be saved when you leave or reload the page."))}}),this.attachButtonClick("exportGraphButton",()=>s.exportGraph()),this.attachButtonClick("saveImageButton",()=>this.saveCanvasAsImage()),this.attachButtonClick("saveSvgButton",()=>s.saveGraphAsSvg()),this.attachInputChange("import",()=>this.importGraph()),this.attachButtonClick("startStopMotionBtn",()=>this.startStopMotionRecording()),this.attachButtonClick("captureFrameBtn",()=>this.captureStopMotionFrame()),this.attachButtonClick("removeLastFrameBtn",()=>this.removeLastStopMotionFrame()),this.attachButtonClick("stopStopMotionBtn",()=>this.stopStopMotionRecording()),this.attachButtonClick("createStopMotionMovieBtn",()=>this.createStopMotionMovie()),this.attachButtonClick("clearStopMotionFramesBtn",()=>this.clearStopMotionFrames()),this.attachButtonClick("removeDuplicateEdges",()=>{e.removeDuplicateEdges()}),this.attachButtonClick("removeSelfEdges",()=>{e.removeSelfEdges()});const o=this.container.get("graph"),n=this.container.get("app");this.attachButtonClick("forceBalanceStep",()=>{const i=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nForceBalanceSteps")||1;for(let d=0;d<c;d++)i.doForceBalanceStep(o);n.render()}),this.attachButtonClick("positionEquilibrationStep",()=>{const i=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nPositionEquilibrationSteps")||1;for(let d=0;d<c;d++)i.doPositionEquilibrationStep(o);n.render()}),this.attachButtonClick("sideChainGenerationButton",()=>this.generateSideChains()),this.attachButtonClick("bifunctionalRemoval",()=>e.removeBifunctionalNodes()),this.attachInputChange("mergeConnectionColor",i=>e.mergeEdgesByColor(i.value))}attachRedrawListeners(){const t=this.container.get("app"),e=document.getElementsByClassName("redraw-onchange");Array.from(e).forEach(s=>{s instanceof HTMLInputElement&&s.addEventListener("change",()=>{t.render()})})}importGraph(){var o;const e=(o=document.getElementById("import").files)==null?void 0:o[0];if(!e)return;this.container.get("fileService").importGraph(e)}saveCanvasAsImage(){const t=this.container.get("fileService"),e=this.container.get("canvas"),s=this.container.get("settings"),o=this.container.get("app"),n=this.container.get("graph");e.withScaledCanvas(()=>t.saveCanvasAsImage(),s.imageScaleFactor,o,n,s)}generateSideChains(){const t=this.container.get("selection"),e=this.container.get("graph"),s=this.container.get("actionManager"),o=this.container.get("nodeCounter"),n=this.container.get("ui"),i=n.getInputValueAsNumber("sideChainLength")||37.5,r=n.getInputValueAsNumber("sideChainProb")||2,c=n.getInputValueAsNumber("sideChainLengthRandomness")||0,d=n.getInputValueAsNumber("sideChainAngleRandomness")||0;t.getItemsOfClass(b).forEach(u=>{const m=e.getEdgesInvolvingNode(u.id);if(m.length!==2)return;const f=e.getNode(m[0].getOtherNodeId(u.id)),p=e.getNode(m[1].getOtherNodeId(u.id));if(!f||!p)return;const y=p.coordinates.x-f.coordinates.x,v=p.coordinates.y-f.coordinates.y,g=Math.sqrt(y*y+v*v),E=y/g,I=v/g,N=-I,M=E,C=I,A=-E,z=Math.floor(r),P=r-z,k=z+(Math.random()<P?1:0);let x=Math.random()<.5;const W=this.container.get("AddNodeAction"),B=this.container.get("AddEdgeAction");for(let D=0;D<k;D++){x=!x;const q=x?N:C,V=x?M:A,j=Math.PI*d,Z=(Math.random()*2-1)*j,U=Math.cos(Z),J=Math.sin(Z),et=q*U-V*J,G=q*J+V*U,st=u.coordinates.x+et*i*(1-c*Math.random()),ot=u.coordinates.y+G*i*(1-c*Math.random()),nt=o.value++,lt=new b(nt,{x:st,y:ot},u.radius,u.strokeWidth,u.fillColor,u.strokeColor);s.addAction(new W(nt,{x:st,y:ot},n)),s.addAction(new B(u,[lt],n))}})}startStopMotionRecording(){const t=this.container.get("movie"),e=this.container.get("ui");t.startStopMotionRecording();const s=document.getElementById("startStopMotionBtn"),o=document.getElementById("captureFrameBtn"),n=document.getElementById("removeLastFrameBtn"),i=document.getElementById("stopStopMotionBtn"),r=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!1),n&&(n.disabled=!1),i&&(i.disabled=!1),r&&(r.disabled=!0),e.updateStopMotionIndicator("Recording... (0 frames)","red"),e.updateMovieStatus("Stop-motion recording started. Capture frames by clicking 'Capture Frame'.")}captureStopMotionFrame(){const t=this.container.get("movie"),e=this.container.get("ui");if(!t.isStopMotionRecording()){alert("Not currently recording. Click 'Start Recording' first.");return}const s=e.getInputValueAsNumber("stopMotionFrameDuration");console.log(`Capturing frame with duration: ${s}ms`);const o=t.captureStopMotionFrame(s);e.updateStopMotionIndicator(`Recording... (${o} frames)`,"red"),e.updateMovieStatus(`Frame ${o} captured with duration: ${s}ms.`)}removeLastStopMotionFrame(){const t=this.container.get("movie"),e=this.container.get("ui"),s=t.removeLastStopMotionFrame();t.isStopMotionRecording()?e.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"):e.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),e.updateMovieStatus(s>0?`Last frame removed. ${s} frames remaining.`:"All frames removed.")}stopStopMotionRecording(){const t=this.container.get("movie"),e=this.container.get("ui"),s=t.stopStopMotionRecording(),o=document.getElementById("startStopMotionBtn"),n=document.getElementById("captureFrameBtn"),i=document.getElementById("removeLastFrameBtn"),r=document.getElementById("stopStopMotionBtn"),c=document.getElementById("clearStopMotionFramesBtn");o&&(o.disabled=!1),n&&(n.disabled=!0),i&&(i.disabled=s===0),r&&(r.disabled=!0),c&&(c.disabled=s===0),e.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),e.updateMovieStatus(`Recording stopped. ${s} frames captured.`)}async createStopMotionMovie(){const t=this.container.get("movie"),e=this.container.get("ui");if(t.getStopMotionFrameCount()===0){alert("No frames captured! Capture some frames first.");return}try{await t.createStopMotionMovie(e.getInputChecked("stopMotionInterpolate"))}catch(o){alert(`Error creating movie: ${o}`)}}clearStopMotionFrames(){const t=this.container.get("movie"),e=this.container.get("ui");if(!confirm("Are you sure you want to clear all captured frames? This cannot be undone."))return;t.clearStopMotionFrames();const s=document.getElementById("removeLastFrameBtn"),o=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!0),e.updateStopMotionIndicator("Not recording","black"),e.updateMovieStatus("All frames cleared.")}}class Se{constructor(t){a(this,"container");this.container=t}attachEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){const e=this.container.get("actionManager"),s=this.container.get("modeFactory"),o=this.container.get("ClearSelectionAction"),n=this.container.get("SelectAllNodesAction"),i=this.container.get("InvertSelectionAction"),r=this.container.get("DeleteNodesAction"),c=this.container.get("selection"),d=this.container.get("Node"),l=this.container.get("ui");if(t.ctrlKey||t.metaKey){if(t.key==="z"&&!t.shiftKey){t.preventDefault(),e.undo();return}if(t.key==="z"&&t.shiftKey||t.key==="y"){t.preventDefault(),e.redo();return}if(t.key==="s"){t.preventDefault();return}return}if(t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){switch(t.key){case"A":s.setCurrentMode("arrow"),this.updateModeUI("arrow");break}return}if(!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey)switch(t.key){case"a":e.addAction(new n);break;case"c":case"Escape":e.addAction(new o);break;case"i":e.addAction(new i);break;case"Backspace":case"Delete":e.addAction(new r(c.getItemsOfClass(d)));break;case"v":s.setCurrentMode("vertex"),this.updateModeUI("vertex");break;case"e":s.setCurrentMode("edge"),this.updateModeUI("edge");break;case"s":s.setCurrentMode("select"),this.updateModeUI("select");break;case"d":s.setCurrentMode("delete_vertex"),this.updateModeUI("delete_vertex");break;case"l":s.setCurrentMode("delete_edge"),this.updateModeUI("delete_edge");break;case"w":s.setCurrentMode("delete_arrow"),this.updateModeUI("delete_arrow");break;case"h":s.setCurrentMode("select_chains"),this.updateModeUI("select_chains");break;case"r":s.setCurrentMode("random_walk"),this.updateModeUI("random_walk");break;case"f":l.getElement("captureFrameBtn").click();break}}updateModeUI(t){const e=document.getElementById("modeSwitch");e&&(e.value=t)}detachEventListeners(){document.removeEventListener("keydown",this.handleKeyDown.bind(this))}}class Ee{constructor(t,e){a(this,"name","vertex");this.nodeCounter=t,this.uiFacade=e}onCanvasClick(t,e){e.addAction(new At(this.nodeCounter.value,t,this.uiFacade)),this.nodeCounter.value+=1}onEnter(){console.log("Entered vertex mode")}}class Ie{constructor(t,e,s,o,n){a(this,"name","edge");a(this,"cursorPosition",null);this.graph=t,this.selection=e,this.uiFacade=s,this.container=o,this.recordingCallback=n}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null)if(this.selection.empty)e.addAction(new X([s]));else{const o=this.selection.getItemsOfClass(b);e.addAction(new Pt(s,o,this.uiFacade)),console.log("EdgeMode: recordingCallback exists:",!!this.recordingCallback),this.recordingCallback&&(console.log("EdgeMode: Recording edges for",o.length,"selected nodes"),o.forEach(n=>{console.log("EdgeMode: Calling recordingCallback for",s.id,"->",n.id),this.recordingCallback(s,n)}))}}setRecordingCallback(t){this.recordingCallback=t}onMouseMove(t){const e=this.container.get("canvas");return this.cursorPosition=e.clientToCanvasCoordinates(t.clientX,t.clientY),!this.selection.empty}onEnter(){this.cursorPosition=null}onExit(){this.cursorPosition=null}getTemporaryDrawables(){if(!this.cursorPosition||this.selection.empty)return[];const t=this.selection.getItemsOfClass(b),e=[];return t.forEach(s=>{e.push(new Y(new w(s.coordinates.x,s.coordinates.y),this.cursorPosition,1,!1,"#888",2))}),e}}class Me{constructor(t,e,s,o){a(this,"name","arrow");a(this,"cursorPosition",null);this.graph=t,this.selection=e,this.uiFacade=s,this.container=o}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null)if(this.selection.empty)e.addAction(new X([s]));else{const o=this.selection.getItemsOfClass(b);e.addAction(new pe(s,o,this.uiFacade))}}onMouseMove(t){const e=this.container.get("canvas");return this.cursorPosition=e.clientToCanvasCoordinates(t.clientX,t.clientY),!this.selection.empty}onEnter(){this.cursorPosition=null}onExit(){this.cursorPosition=null}getTemporaryDrawables(){if(!this.cursorPosition||this.selection.empty)return[];const t=this.selection.getItemsOfClass(b),e=[];return t.forEach(s=>{e.push(new Y(new w(s.coordinates.x,s.coordinates.y),this.cursorPosition,1,!1,"#888",2))}),e}}class Ce{constructor(t,e,s){a(this,"name","select");a(this,"isRectangleSelecting",!1);a(this,"rectangleStart",null);a(this,"currentPoint",null);this.graph=t,this.selection=e,this.container=s}onCanvasClick(t,e){const s=this.graph.findNodesByCoordinates(t.x,t.y);s.length&&(this.selection.hasItems(s)?e.addAction(new ue(s)):e.addAction(new X(s)))}onMouseDown(t){const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY);if(this.graph.findNodeByCoordinates(s.x,s.y)){this.isRectangleSelecting=!1;return}this.isRectangleSelecting=!0,this.rectangleStart=s,this.currentPoint=s}onMouseMove(t){if(!this.isRectangleSelecting||!this.rectangleStart)return!1;const e=this.container.get("canvas");return this.currentPoint=e.clientToCanvasCoordinates(t.clientX,t.clientY),!0}onMouseUp(t){if(!this.isRectangleSelecting||!this.rectangleStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),o=this.container.get("actionManager"),n=Math.min(this.rectangleStart.x,s.x),i=Math.max(this.rectangleStart.x,s.x),r=Math.min(this.rectangleStart.y,s.y),c=Math.max(this.rectangleStart.y,s.y),d=this.graph.getAllNodes().filter(u=>u.coordinates.x>=n&&u.coordinates.x<=i&&u.coordinates.y>=r&&u.coordinates.y<=c);d.length>0&&o.addAction(new X(d)),this.isRectangleSelecting=!1,this.rectangleStart=null,this.currentPoint=null,this.container.get("app").render()}onExit(){this.isRectangleSelecting=!1,this.rectangleStart=null,this.currentPoint=null}getTemporaryDrawables(){if(!this.isRectangleSelecting||!this.rectangleStart||!this.currentPoint)return[];const t=this.currentPoint.x-this.rectangleStart.x,e=this.currentPoint.y-this.rectangleStart.y,s=new w(t>=0?this.rectangleStart.x:this.currentPoint.x,e>=0?this.rectangleStart.y:this.currentPoint.y);return[new it(s,Math.abs(t),Math.abs(e),2,"#0066cc","rgba(0, 102, 204, 0.1)",!0)]}}class xe{constructor(t){a(this,"name","select_chains");this.graph=t}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null){const o=this.graph.deepConnectedTo(s);e.addAction(new X(o,!0))}}}class Fe{constructor(t){a(this,"name","delete_vertex");this.graph=t}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);s!==null&&e.addAction(new bt([s]))}}class Ne{constructor(t,e,s){a(this,"name","delete_edge");this.graph=t,this.selection=e,this.recordingCallback=s}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);s!==null&&!this.selection.empty||this.selection.length>1?(this.recordingCallback&&s!==null&&!this.selection.empty&&this.graph.getEdgesInvolvingNodes([...this.selection.getItemsOfClass(b).map(n=>n.id),s.id]).forEach(n=>{const i=this.graph.getNode(n.fromId),r=this.graph.getNode(n.toId);this.recordingCallback(i,r,!0)}),e.addAction(new fe(this.selection.getItemsOfClass(b),s))):s&&e.addAction(new X([s]))}setRecordingCallback(t){this.recordingCallback=t}}class Ae{constructor(t,e){a(this,"name","delete_arrow");this.graph=t,this.selection=e}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null&&!this.selection.empty||this.selection.length>1){const o=s?this.graph.getArrowsInvolvingNodes([...this.selection.getItemsOfClass(b).map(n=>n.id),s.id]):this.graph.getArrowsWithBothEndsInNodes(this.selection.getItemsOfClass(b).map(n=>n.id));o.length>0&&e.addAction(new ye(o))}else s&&e.addAction(new X([s]))}}class be{constructor(t,e,s){a(this,"name","random_walk");this.nodeCounter=t,this.doRandomWalk=e,this.uiFacade=s}onCanvasClick(t,e){const s=this.doRandomWalk(t);e.addAction(new ge(s.nodes)),e.addAction(new me(s.edges.map(o=>o.fromId),s.edges.map(o=>o.toId),this.uiFacade)),this.nodeCounter.value+=s.nodes.length+1}}class ze{constructor(t,e,s,o,n){a(this,"modes",new Map);a(this,"currentMode",null);const i=n.get("ui");this.modes.set("vertex",new Ee(t,i)),this.modes.set("edge",new Ie(e,s,i,n)),this.modes.set("arrow",new Me(e,s,i,n)),this.modes.set("select",new Ce(e,s,n)),this.modes.set("select_chains",new xe(e)),this.modes.set("delete_vertex",new Fe(e)),this.modes.set("delete_edge",new Ne(e,s)),this.modes.set("delete_arrow",new Ae(e,s)),this.modes.set("random_walk",new be(t,o,i)),this.setCurrentMode("vertex")}getMode(t){return this.modes.get(t)||null}setCurrentMode(t){const e=this.modes.get(t);return e?(this.currentMode&&this.currentMode.onExit&&this.currentMode.onExit(),this.currentMode=e,this.currentMode.onEnter&&this.currentMode.onEnter(),!0):(console.warn(`Mode '${t}' not found`),!1)}getCurrentMode(){return this.currentMode}getAvailableModes(){return Array.from(this.modes.keys())}getModeInstance(t){return this.modes.get(t)||null}}function Mt(){const h=document.getElementById("canvas"),t=h.getContext("2d");if(!h||!t){console.error("Failed to initialize canvas");return}const e=O.instance,s=ut.getInstance(),o={value:0},n=new _t(h,t,e),i=new Zt,r=new Qt(h,s),c=new ae(s),d=new ce(s);s.register("canvas",n),s.register("ui",i),s.register("movie",r),s.register("graphOperations",c),s.register("fileService",d),s.register("settings",e),s.register("graph",S),s.register("selection",F),s.register("Node",b),s.register("nodeCounter",o),s.register("StorageService",$),s.register("Circle",yt),s.register("Rectangle",it),s.register("PartialLine",Y),s.register("simulations",{doForceBalanceStep:se,doPositionEquilibrationStep:ne}),s.register("ClearSelectionAction",kt),s.register("SelectAllNodesAction",zt),s.register("InvertSelectionAction",Rt),s.register("DeleteNodesAction",bt),s.register("AddNodeAction",At),s.register("AddEdgeAction",Pt);const l=new Ot(s);s.register("app",l);const u=new de(()=>l.render());s.register("actionManager",u);const m=new ze(o,S,F,oe,s);s.register("modeFactory",m),m.setCurrentMode("vertex");const f=new ve(s),p=new we(s),y=new Se(s);l.initialize(),f.attachEventListeners(),p.attachEventListeners(),y.attachEventListeners();const v=$.loadState(S,e);if(v.success){if(n.resize(e.canvasSize.x,e.canvasSize.y),i.updateCanvasSizeUI(e.canvasSize.x,e.canvasSize.y),S.getNrOfNodes()>0){const E=S.getAllNodeIds();o.value=Math.max(...E)+1}if(v.animations)try{r.restoreAnimationData(v.animations,S),console.log("Animation data restored from localStorage")}catch(E){console.warn("Could not restore animation data:",E)}console.log("Loaded previous state from localStorage")}else i.updateCanvasSizeUI(e.canvasSize.x,e.canvasSize.y),S.clear(),F.clearSelection();l.render();const g=()=>{try{return r.getSerializableAnimationData()}catch(E){return console.warn("Could not get animation data for saving:",E),null}};window.addEventListener("beforeunload",()=>{$.saveState(S,e,g())}),setInterval(()=>{$.saveState(S,e,g())},3e4),console.log("Application initialized successfully")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Mt):Mt();
