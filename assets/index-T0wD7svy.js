var Fe=Object.defineProperty;var le=h=>{throw TypeError(h)};var Ae=(h,e,t)=>e in h?Fe(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var a=(h,e,t)=>Ae(h,typeof e!="symbol"?e+"":e,t),ge=(h,e,t)=>e.has(h)||le("Cannot "+t);var te=(h,e,t)=>(ge(h,e,"read from private field"),t?t.call(h):e.get(h)),ue=(h,e,t)=>e.has(h)?le("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t),re=(h,e,t,s)=>(ge(h,e,"write to private field"),s?s.call(h,t):e.set(h,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const V=class V{constructor(){a(this,"services",new Map)}static getInstance(){return V.instance||(V.instance=new V),V.instance}register(e,t){this.services.set(e,t)}get(e){const t=this.services.get(e);if(!t)throw new Error(`Service '${e}' not found in container`);return t}has(e){return this.services.has(e)}clear(){this.services.clear()}};a(V,"instance");let ce=V;class Re{constructor(){a(this,"observers",[])}subscribe(e){return this.observers.push(e),()=>{const t=this.observers.indexOf(e);t>-1&&this.observers.splice(t,1)}}notify(e){this.observers.forEach(t=>t(e))}get observerCount(){return this.observers.length}clearObservers(){this.observers=[]}}class me extends Re{constructor(t){super();a(this,"_value");this._value=t}get value(){return this._value}set value(t){this._value!==t&&(this._value=t,this.notify(t))}forceUpdate(){this.notify(this._value)}}class ke{constructor(e){a(this,"container");a(this,"elementsToDraw",new me([]));a(this,"showSelection",new me(!0));this.container=e}initialize(){const e=this.container.get("canvas"),t=this.container.get("settings");e.resize(t.canvasSize.x,t.canvasSize.y),this.render()}render(e={x:1,y:1}){const t=this.container.get("canvas"),s=this.container.get("graph"),i=this.container.get("selection"),n=this.container.get("ui"),o=this.container.get("settings"),r=o.isScaled?{x:o.imageScaleFactor,y:o.imageScaleFactor}:e,c=Math.max(r.x,r.y),d=t.canvas,u=n.getInputValue("backgroundColor"),g=n.getInputValue("borderColor"),l=[],m=this.container.get("Rectangle");if(l.push(new m({x:0,y:0},d.width,d.height,0,"transparent",u)),l.push(...s.toDrawables()),l.push(new m({x:0,y:0},d.width,d.height,20*c,u,null)),l.push(new m({x:10*r.x,y:10*r.y},d.width-20*r.x,d.height-20*r.y,4*c,g,null)),this.showSelection.value&&!i.empty){const f=this.container.get("Circle"),v=this.container.get("Node");i.getItemsOfClass(v).forEach(y=>{l.push(new f({x:y.coordinates.x,y:y.coordinates.y},y.radius*c*1.5,2*c,"transparent","red"))})}this.elementsToDraw.value=l,t.draw(l),n.updateGraphStats(s.getNrOfNodes(),s.getNrOfEdges())}destroy(){this.elementsToDraw.clearObservers(),this.showSelection.clearObservers()}}class E{constructor(e,t){a(this,"x");a(this,"y");this.x=e,this.y=t}}class P extends E{constructor(e,t){e instanceof E?(super(e.x,e.y),this.x=e.x,this.y=e.y):(super(e,t),this.x=e,this.y=t)}add(e){return new P(this.x+e.x,this.y+e.y)}subtract(e){return new P(this.x-e.x,this.y-e.y)}multiply(e){return new P(this.x*e,this.y*e)}toString(){return`(${this.x}, ${this.y})`}}class N{constructor(e,t,s=5,i=1,n="#000",o="#000"){a(this,"id");a(this,"coordinates");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new Error("Invalid `id` parameter. It must be a non-negative integer, got `"+e+"`.");this.id=e,this.coordinates=t,this.radius=s,this.strokeWidth=i,this.fillColor=n,this.strokeColor=o}}class de{constructor(e,t,s,i=1,n="#000"){a(this,"fromId");a(this,"toId");a(this,"weight");a(this,"color");a(this,"id");this.fromId=e,this.toId=t,this.id=s,this.weight=i,this.color=n}getOtherNodeId(e){return this.fromId===e?this.toId:this.fromId}}class ve{constructor(e=null,t=1,s=1,i="#000",n="#000"){a(this,"center");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");this.center=e||new E(0,0),this.radius=t,this.strokeWidth=s,this.fillColor=i,this.strokeColor=n}setCenter(e){this.center=e}setRadius(e){this.radius=e}draw(e){e.beginPath(),e.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI),this.fillColor&&(e.fillStyle=this.fillColor,e.fill()),e.strokeStyle=this.strokeColor,e.lineWidth=this.strokeWidth,e.stroke()}}var D;const T=class T{constructor(e=new E(825,445),t="#FFFFFF",s=10){a(this,"isScaled",!1);a(this,"canvasSize");a(this,"backgroundColor");a(this,"imageScaleFactor");a(this,"disablePBC",!1);this.canvasSize=e,this.backgroundColor=t,this.imageScaleFactor=s}static get instance(){return te(T,D)||re(T,D,new T),te(T,D)}static fromJSON(e){return re(T,D,new T(new E(e.canvasSize.x,e.canvasSize.y),e.backgroundColor,e.imageScaleFactor)),"disablePBC"in e&&(te(T,D).disablePBC=e.disablePBC),te(T,D)}};D=new WeakMap,ue(T,D);let W=T;class ie{constructor(e,t,s=!1,i="#000",n=2,o=6,r=4,c=2){a(this,"from");a(this,"to");a(this,"dashed");a(this,"zigZagged");a(this,"color");a(this,"lineWidth");a(this,"zigzagSpacing");a(this,"oneZigZagLength");a(this,"straightLengthWhenZigZag");a(this,"lineRadians");a(this,"lineLength");this.from=e,this.to=t,this.dashed=!1,this.zigZagged=s,this.color=i,this.lineWidth=n,this.zigzagSpacing=o,this.oneZigZagLength=r,this.straightLengthWhenZigZag=c,this.lineRadians=Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x);const d=this.from.x-this.to.x,u=this.from.y-this.to.y;this.lineLength=Math.sqrt(d*d+u*u)}setFrom(e){this.from=e}setTo(e){this.to=e}getFrom(){return this.from}getTo(){return this.to}draw(e){const t=W.instance;var s=this.to.x-this.from.x,i=this.to.y-this.from.y;const n=Math.abs(i)>.5001*t.canvasSize.y,o=Math.abs(s)>.5001*t.canvasSize.x;if((n||o)&&!t.disablePBC){[new ie(new E(this.from.x,this.from.y),new E(this.to.x+t.canvasSize.x*(o?s<0?1:-1:0),this.to.y+t.canvasSize.y*(n?i<0?1:-1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new ie(new E(this.to.x,this.to.y),new E(this.from.x+t.canvasSize.x*(o?s<0?-1:1:0),this.from.y+t.canvasSize.y*(n?i<0?-1:1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(r=>r.draw(e));return}this.dashed&&e.setLineDash([4,2]),e.lineCap="round",e.lineWidth=this.lineWidth,e.strokeStyle=this.color,this.zigZagged?this.drawZigZagged(e):(e.beginPath(),e.moveTo(this.from.x,this.from.y),e.lineTo(this.to.x,this.to.y)),e.stroke()}drawZigZagged(e){e.save(),e.beginPath(),e.translate(this.from.x,this.from.y),e.rotate(this.lineRadians),e.moveTo(0,0),e.lineTo(this.straightLengthWhenZigZag,0);let t=this.straightLengthWhenZigZag;for(let s=0;t<this.lineLength-this.straightLengthWhenZigZag;s++){t=(s+1)*this.zigzagSpacing;const i=s%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(t,i)}e.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),e.lineTo(this.lineLength,0),e.restore()}setDashed(e){this.dashed=e}setZigZagged(e){this.zigZagged=e}}class ze{constructor(){a(this,"nodes");a(this,"edges");a(this,"scalingFactor");a(this,"zigzagSpacing",4);a(this,"zigzagLength",3);a(this,"zigzagEndLengths",1.5);a(this,"maxNodeId",0);this.nodes={},this.edges=[],this.scalingFactor=new E(1,1)}clear(){this.nodes={},this.edges=[]}setNode(e){this.nodes[e.id]=e,this.maxNodeId=Math.max(this.maxNodeId,e.id)}addEdge(e,t,s="#000",i=1){if(!(e in this.nodes)||!(t in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.edges.push(new de(e,t,this.edges.length,i,s)),this.edges.length-1}getNode(e){if(!(e in this.nodes))throw new Error(`Node with id "${e}" does not exist.`);return this.nodes[e]}getNrOfNodes(){return Object.keys(this.nodes).length}getNrOfEdges(){return this.edges.length}getAllNodeIds(){return Object.values(this.nodes).map(e=>e.id)}getNextNodeId(){return this.maxNodeId+1}getAllNodes(){return Object.values(this.nodes)}getAllEdges(){return this.edges}getNodesConnectedToNode(e){return this.getEdgesInvolvingNode(e).map(t=>this.nodes[t.fromId===e?t.toId:t.fromId])}deepConnectedTo(e){const t=new Set,s=[],i=[e.id];for(;i.length>0;){const n=i.shift();if(t.has(n))continue;t.add(n),s.push(this.getNode(n));const o=this.getEdgesInvolvingNode(n).map(r=>r.getOtherNodeId(n)).filter(r=>!t.has(r));i.push(...o)}return s}getEdgesInvolvingNode(e){return this.edges.filter(t=>t.fromId===e||t.toId===e)}getEdgesInvolvingNodes(e){return this.edges.filter(t=>e.includes(t.fromId)&&e.includes(t.toId))}cleanupEdges(){this.edges=this.edges.filter(e=>e.fromId!==e.toId)}removeDuplicateEdges(){const e=new Set;this.edges=this.edges.filter(t=>{const s=`${Math.min(t.fromId,t.toId)}-${Math.max(t.fromId,t.toId)}`;return e.has(s)?!1:(e.add(s),!0)})}getEdgesWithBothEndsInNodes(e){return this.edges.filter(t=>e.includes(t.fromId)&&e.includes(t.toId))}fromJSON(e){this.nodes={},this.edges=[];for(const[,t]of Object.entries(e.nodes))this.setNode(new N(t.id,t.coordinates,t.radius,t.strokeWidth,t.fillColor,t.strokeColor));for(const t of e.edges)this.addEdge(t.fromId,t.toId,t.color,t.weight);"scalingFactor"in e&&(this.scalingFactor=new E(e.scalingFactor.x,e.scalingFactor.y)),"zigzagSpacing"in e&&(this.zigzagSpacing=e.zigzagSpacing),"zigzagLength"in e&&(this.zigzagLength=e.zigzagLength),this.cleanupEdges()}toDrawables(){const e=[],t=Math.max(this.scalingFactor.x,this.scalingFactor.y);for(const s of this.edges){const i=this.getNode(s.fromId),n=this.getNode(s.toId);if(i&&n){const o=new E(i.coordinates.x*this.scalingFactor.x,i.coordinates.y*this.scalingFactor.y),r=new E(n.coordinates.x*this.scalingFactor.x,n.coordinates.y*this.scalingFactor.y);e.push(new ie(o,r,!0,s.color,s.weight*t,this.zigzagSpacing*t,this.zigzagLength*t,this.zigzagEndLengths*t))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of Object.values(this.nodes)){const i=new E(s.coordinates.x*this.scalingFactor.x,s.coordinates.y*this.scalingFactor.y);e.push(new ve(i,s.radius*t,s.strokeWidth*t,s.fillColor,s.strokeColor))}return e}findNodesByCoordinates(e,t){let s=[];for(const[,i]of Object.entries(this.nodes))Math.sqrt(Math.pow(i.coordinates.x-e,2)+Math.pow(i.coordinates.y-t,2))<=5&&s.push(i);return s}findNodeByCoordinates(e,t){const s=this.findNodesByCoordinates(e,t);return s.length>0?s[0]:null}deleteNode(e){if(!this.getNode(e))throw new Error("The node does not exist in the graph.");delete this.nodes[e];for(let s=0;s<this.edges.length;s++)(this.edges[s].fromId===e||this.edges[s].toId===e)&&(this.edges.splice(s,1),s--)}deleteEdge(e){if(e instanceof de&&(e=this.edges.indexOf(e)),e<0||e>=this.edges.length)throw new Error("Invalid edge ID "+e+". Edge ID must be between 0 and "+(this.edges.length-1)+".");const t=this.edges[e];return this.edges.splice(e,1),t}}const p=new ze;class Pe{constructor(e,t,s){a(this,"canvas");a(this,"ctx");this.canvas=e,this.ctx=t}resize(e,t){const s=this.canvas.width,i=this.canvas.height;this.canvas.width=e,this.canvas.height=t;const n=this.canvas.width/s,o=this.canvas.height/i;return{xScaling:n,yScaling:o}}resizeWithGraphScaling(e,t,s,i){const n=this.resize(e,t),{xScaling:o,yScaling:r}=n,c=Math.min(o,r);return console.log("Resizing canvas",[s,o,r,c]),i.getAllNodes().forEach(u=>{u.coordinates.x*=o,u.coordinates.y*=r,s&&(u.radius*=c,u.strokeWidth*=c)}),s&&(i.getAllEdges().forEach(g=>{g.weight*=c}),i.zigzagLength*=c,i.zigzagSpacing*=c,i.zigzagEndLengths*=c),n}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(e){this.clear(),e.forEach(t=>t.draw(this.ctx))}toDataURL(e="image/png"){return this.canvas.toDataURL(e)}getContext(){return this.ctx}getDimensions(){return{width:this.canvas.width,height:this.canvas.height}}clientToCanvasCoordinates(e,t){return new E(e-this.canvas.offsetLeft+window.scrollX,t-this.canvas.offsetTop+window.scrollY)}withScaledCanvas(e,t,s,i,n){const o=s.showSelection.value,r=n.isScaled,c={x:n.canvasSize.x,y:n.canvasSize.y};s.showSelection.value=!1,n.isScaled=!0,n.canvasSize.x*=t,n.canvasSize.y*=t,this.resizeWithGraphScaling(n.canvasSize.x,n.canvasSize.y,!0,i);const d=()=>{s.showSelection.value=o,n.isScaled=r,n.canvasSize.x=c.x,n.canvasSize.y=c.y,this.resizeWithGraphScaling(n.canvasSize.x,n.canvasSize.y,!0,i),s.render()};try{const u=e();return u instanceof Promise?u.finally(d):(d(),u)}catch(u){throw d(),u}}}class Le{constructor(){a(this,"elements",new Map);this.cacheElements()}cacheElements(){["backgroundColor","borderColor","vertexRadius","vertexStrokeWidth","nodeFillColor","nodeColor","edgeColor","lineWidth","graph-stats","resizeElements","sideChainLength","sideChainProb","sideChainLengthRandomness","sideChainAngleRandomness","edgeAnimationDuration","simulationType","simulationStepCount","simulationStepDuration","adaptiveStepDuration","movieRecordingStatus","recordingEdgeCount"].forEach(t=>{const s=document.getElementById(t);s&&this.elements.set(t,s)})}getElement(e){const t=this.elements.get(e);if(!t){const s=document.getElementById(e);return s?(this.elements.set(e,s),s):null}return t}getInputValue(e){const t=this.getElement(e);return(t==null?void 0:t.value)||""}getInputValueAsNumber(e){const t=this.getElement(e);return(t==null?void 0:t.valueAsNumber)||0}getInputChecked(e){const t=this.getElement(e);return(t==null?void 0:t.checked)||!1}setValue(e,t){const s=this.getElement(e);s&&(s.value=String(t))}updateGraphStats(e,t){const s=this.getElement("graph-stats");s&&(s.textContent=`Nodes: ${e}, Edges: ${t}`)}updateCanvasSizeUI(e,t){this.setValue("canvasWidth",e),this.setValue("canvasHeight",t);const s=document.getElementById("canvas-parent");s&&(s.style.width=e+"px",s.style.height=t+"px");const i=document.getElementById("canvas-size");i&&(i.textContent=`Canvas size: ${e}x${t}`)}updateMovieRecordingStatus(e){const t=this.getElement("movieRecordingStatus");t&&(t.textContent=e)}updateMovieStatus(e){this.updateMovieRecordingStatus(e)}updateRecordingEdgeCount(e){const t=this.getElement("recordingEdgeCount");t&&(t.textContent=String(e))}setTextContent(e,t){const s=this.getElement(e);s&&(s.textContent=t)}setVisible(e,t){const s=this.getElement(e);s&&(s.style.display=t?"":"none")}addClass(e,t){const s=this.getElement(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.getElement(e);s&&s.classList.remove(t)}toggleClass(e,t){const s=this.getElement(e);s&&s.classList.toggle(t)}}class Be{constructor(e={}){a(this,"sequences",[]);a(this,"currentSequenceIndex",0);a(this,"currentFrameIndex",0);a(this,"isPlaying",!1);a(this,"isPaused",!1);a(this,"animationFrameId",null);a(this,"lastFrameTime",0);a(this,"options");a(this,"subFrameIndex",0);a(this,"animate",()=>{if(!this.isPlaying||this.isPaused)return;if(this.currentSequenceIndex>=this.sequences.length){this.stop();return}const e=this.sequences[this.currentSequenceIndex],t=e.frames[this.currentFrameIndex];if(!t){e.onComplete&&e.onComplete(),this.currentSequenceIndex++,this.currentFrameIndex=0,this.lastFrameTime=performance.now(),this.options.offlineRendering?this.animate():this.animationFrameId=requestAnimationFrame(this.animate);return}if(this.options.offlineRendering){const s=t.duration||e.defaultFrameDuration||16,i=this.options.targetFPS,n=Math.max(1,Math.round(s/1e3*i));this.subFrameIndex===0&&(t.action(),e.onFrame&&e.onFrame(this.currentFrameIndex,e.frames.length)),this.options.onFrameRendered&&this.options.onFrameRendered(),this.subFrameIndex++,this.subFrameIndex>=n&&(this.subFrameIndex=0,this.currentFrameIndex++),this.animate()}else{const s=performance.now(),i=t.duration||e.defaultFrameDuration||16;s-this.lastFrameTime>=i&&(t.action(),e.onFrame&&e.onFrame(this.currentFrameIndex,e.frames.length),this.currentFrameIndex++,this.lastFrameTime=s),this.animationFrameId=requestAnimationFrame(this.animate)}});this.options={targetFPS:e.targetFPS||60,autoPlay:e.autoPlay!==void 0?e.autoPlay:!0,offlineRendering:e.offlineRendering||!1,onFrameRendered:e.onFrameRendered}}addSequence(e){e.defaultFrameDuration||(e.defaultFrameDuration=1e3/this.options.targetFPS),this.sequences.push(e),this.options.autoPlay&&!this.isPlaying&&this.play()}clearSequences(){this.stop(),this.sequences=[],this.currentSequenceIndex=0,this.currentFrameIndex=0}play(){this.isPlaying&&!this.isPaused||(this.isPlaying=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}pause(){this.isPaused=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.isPaused&&(this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}stop(){this.isPlaying=!1,this.isPaused=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentSequenceIndex=0,this.currentFrameIndex=0}getIsPlaying(){return this.isPlaying&&!this.isPaused}getIsPaused(){return this.isPaused}getProgress(){const e=this.sequences[this.currentSequenceIndex];return{sequence:this.currentSequenceIndex,frame:this.currentFrameIndex,total:(e==null?void 0:e.frames.length)||0}}}class Te{static fromActions(e,t,s=100,i){return{name:e,frames:t.map(n=>({action:n})),defaultFrameDuration:s,onComplete:i}}static repeat(e,t,s,i=100,n){return{name:e,frames:Array(s).fill(null).map(()=>({action:t})),defaultFrameDuration:i,onComplete:n}}static withTiming(e,t,s){return{name:e,frames:t,onComplete:s}}static interpolate(e,t,s,i=1e3,n){const o=i/t,r=[];for(let c=0;c<=t;c++){const d=c/t;r.push({action:()=>s(d),duration:o})}return{name:e,frames:r,onComplete:n}}}class De{constructor(e,t={}){a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);a(this,"isRecording",!1);a(this,"canvas");a(this,"options");this.canvas=e,this.options={fps:t.fps||60,videoBitsPerSecond:t.videoBitsPerSecond||25e5,mimeType:t.mimeType||"video/webm;codecs=vp9"}}start(){if(this.isRecording){console.warn("Recording already in progress");return}this.recordedChunks=[],this.stream=this.canvas.captureStream(0);let e=this.options.mimeType;MediaRecorder.isTypeSupported(e)||(console.warn(`${e} not supported, trying vp8`),e="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(e)||(console.warn(`${e} not supported, using default`),e="video/webm")),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started")}stop(){return new Promise((e,t)=>{if(!this.isRecording||!this.mediaRecorder){t(new Error("No recording in progress"));return}this.mediaRecorder.onstop=()=>{const s=new Blob(this.recordedChunks,{type:"video/webm"});this.isRecording=!1,this.stream&&this.stream.getTracks().forEach(i=>i.stop()),console.log("Recording stopped, blob size:",s.size),e(s)},this.mediaRecorder.stop()})}requestFrame(){if(this.stream){const e=this.stream.getVideoTracks()[0];e&&"requestFrame"in e&&e.requestFrame()}}getIsRecording(){return this.isRecording}async download(e="polymer-graph-animation.webm"){if(this.isRecording){const t=await this.stop();this.downloadBlob(t,e)}else if(this.recordedChunks.length>0){const t=new Blob(this.recordedChunks,{type:"video/webm"});this.downloadBlob(t,e)}else throw new Error("No recording available to download")}downloadBlob(e,t){const s=URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=s,i.download=t,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(s)},500)}}class Oe{constructor(e){a(this,"recorder");a(this,"animator");a(this,"isRecordingMovie",!1);var t;this.recorder=new De(e.canvas,e.recorderOptions),this.animator=new Be({targetFPS:((t=e.animatorOptions)==null?void 0:t.targetFPS)||60,autoPlay:!1,offlineRendering:!1,onFrameRendered:()=>this.recorder.requestFrame()})}async startRecording(){if(this.isRecordingMovie)throw new Error("Already recording a movie");this.isRecordingMovie=!0,this.animator.options.offlineRendering=!0,this.recorder.start()}async stopAndDownload(e){if(!this.isRecordingMovie)throw new Error("Not currently recording");this.animator.getIsPlaying()&&this.animator.stop(),this.animator.options.offlineRendering=!1,await this.recorder.download(e),this.isRecordingMovie=!1}addSequence(e){this.animator.addSequence(e)}clearSequences(){this.animator.clearSequences()}play(){this.animator.play()}pause(){this.animator.pause()}resume(){this.animator.resume()}stop(){this.animator.stop()}async recordMovie(e,t){return new Promise((s,i)=>{this.clearSequences(),e.forEach(n=>this.addSequence(n)),this.addSequence({name:"completion",frames:[{action:()=>{setTimeout(async()=>{try{await this.stopAndDownload(t),s()}catch(n){i(n)}},500)}}],defaultFrameDuration:100}),this.startRecording().then(()=>{this.play()}).catch(i)})}getIsRecording(){return this.isRecordingMovie}getIsPlaying(){return this.animator.getIsPlaying()}getProgress(){return this.animator.getProgress()}static get AnimationBuilder(){return Te}}class fe{constructor(e){a(this,"options");a(this,"canvas",null);a(this,"ctx",null);a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);this.options={width:e.width,height:e.height,fps:e.fps||30,videoBitsPerSecond:e.videoBitsPerSecond||5e6,mimeType:e.mimeType||"video/webm;codecs=vp9"}}init(){if(this.canvas)return;if(this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height,this.canvas.style.display="none",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!1}),!this.ctx)throw new Error("Failed to get 2D context from canvas");const e=this.canvas.captureStream(0);this.stream=e;let t=this.options.mimeType;MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, trying vp8`),t="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, using default`),t="video/webm")),this.mediaRecorder=new MediaRecorder(e,{mimeType:t,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=s=>{var i;((i=s.data)==null?void 0:i.size)>0&&this.recordedChunks.push(s.data)},this.recordedChunks=[]}async encodeVideo(e,t){return this.init(),new Promise((s,i)=>{if(!this.mediaRecorder||!this.ctx||!this.stream||!this.canvas){i(new Error("Encoder not initialized"));return}const n=1e3/this.options.fps;let o=0,r=0;this.mediaRecorder.onstop=()=>{const l=new Blob(this.recordedChunks,{type:"video/webm"});console.log(`Video encoded: ${l.size} bytes, ${o} video frames from ${r} animation frames`),this.cleanup(),s(l)},this.mediaRecorder.start();const c=this.stream.getVideoTracks()[0],d=c&&typeof c.requestFrame=="function";console.log(`Starting video encoding: ${e.length} frames, ${this.options.fps} fps, requestFrame support: ${d}`);let u=0;const g=async()=>{if(r>=e.length){await new Promise(f=>setTimeout(f,500)),this.mediaRecorder.stop();return}const l=e[r];l.render(this.ctx),u+=l.durationMs;const m=Math.floor(u/n);if(m>=1){if(await new Promise(f=>requestAnimationFrame(()=>f(void 0))),d)for(let f=0;f<m;f++)c.requestFrame(),await new Promise(v=>setTimeout(v,5));else{const f=m*n;await new Promise(v=>setTimeout(v,f))}o+=m,u-=m*n}(r%100===0||r===e.length-1)&&console.log(`Progress: ${r+1}/${e.length} animation frames â†’ ${o} video frames`),t==null||t(r+1,e.length),r++,g()};g()})}cleanup(){this.stream&&this.stream.getTracks().forEach(e=>e.stop()),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.stream=null,this.mediaRecorder=null,this.ctx=null,this.canvas=null}static createCanvasCopyRenderer(e){return t=>{t.drawImage(e,0,0)}}}class ne extends ie{constructor(t,s,i=1,n=!1,o="#000",r=2,c=6,d=4,u=2){super(t,s,n,o,r,c,d,u);a(this,"progress");this.progress=Math.max(0,Math.min(1,i))}setProgress(t){this.progress=Math.max(0,Math.min(1,t))}draw(t){if(this.progress===0)return;if(this.progress===1){super.draw(t);return}const s=W.instance;var i=this.to.x-this.from.x,n=this.to.y-this.from.y;const o=Math.abs(n)>.5001*s.canvasSize.y,r=Math.abs(i)>.5001*s.canvasSize.x;if((o||r)&&!s.disablePBC){[new ne(new E(this.from.x,this.from.y),new E(this.to.x+s.canvasSize.x*(r?i<0?1:-1:0),this.to.y+s.canvasSize.y*(o?n<0?1:-1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new ne(new E(this.to.x,this.to.y),new E(this.from.x+s.canvasSize.x*(r?i<0?-1:1:0),this.from.y+s.canvasSize.y*(o?n<0?-1:1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(d=>d.draw(t));return}const c=new E(this.from.x+(this.to.x-this.from.x)*this.progress,this.from.y+(this.to.y-this.from.y)*this.progress);this.dashed&&t.setLineDash([4,2]),t.lineCap="round",t.lineWidth=this.lineWidth,t.strokeStyle=this.color,this.zigZagged?this.drawPartialZigZagged(t,c):(t.beginPath(),t.moveTo(this.from.x,this.from.y),t.lineTo(c.x,c.y),t.stroke())}drawPartialZigZagged(t,s){const i=this.lineLength*this.progress;if(t.save(),t.beginPath(),t.translate(this.from.x,this.from.y),t.rotate(this.lineRadians),t.moveTo(0,0),i<=this.straightLengthWhenZigZag)t.lineTo(i,0);else if(i>=this.lineLength-this.straightLengthWhenZigZag){t.lineTo(this.straightLengthWhenZigZag,0);let n=this.straightLengthWhenZigZag;for(let o=0;n<this.lineLength-this.straightLengthWhenZigZag;o++){n=(o+1)*this.zigzagSpacing;const r=o%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(n,r)}t.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),t.lineTo(i,0)}else{t.lineTo(this.straightLengthWhenZigZag,0);let n=this.straightLengthWhenZigZag;for(let o=0;n<i;o++){if(n=(o+1)*this.zigzagSpacing,n>=i){const c=o*this.zigzagSpacing,d=(o-1)%2==0?-this.oneZigZagLength:this.oneZigZagLength,u=o%2==0?-this.oneZigZagLength:this.oneZigZagLength,g=(i-c)/this.zigzagSpacing,l=d+(u-d)*g;t.lineTo(i,l);break}const r=o%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(n,r)}}t.stroke(),t.restore()}}const R=class R{static hex2lab(e){const[t,s,i]=R.hex2rgba(e);return R.rgba2lab(t,s,i,1)}static rgba2lab(e,t,s,i){const[n,o,r]=R.rgb2xyz(e,t,s);return R.xyz2lab(n,o,r)}static lab2rgba(e,t,s){const[i,n,o]=R.lab2xyz(e,t,s);return[...R.xyz2rgba(i,n,o),1]}static hex2rgba(e){const t=e.replace(/^#/,"").toUpperCase();if(!/^[0-9A-F]+$/i.test(t)||![3,4,6,8].includes(t.length))throw new Error(`Invalid HEX format: ${e}`);let i=t;[3,4].includes(t.length)&&(i=t.split("").map(u=>u+u).join(""));const n=parseInt(i,16);let o,r,c,d=1;return i.length===8?(d=(n&255)/255,o=n>>16&255,r=n>>8&255,c=n&255):(o=n>>16&255,r=n>>8&255,c=n&255),[Math.min(255,Math.max(0,o)),Math.min(255,Math.max(0,r)),Math.min(255,Math.max(0,c)),Math.min(1,Math.max(0,d))]}static rgb2xyz(e,t,s){const i=c=>c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92,[n,o,r]=[e/255,t/255,s/255].map(c=>i(c)*100);return[n*.4124564+o*.3575761+r*.1804375,n*.2126729+o*.7151522+r*.072175,n*.0193339+o*.119192+r*.9503041]}static xyz2rgba(e,t,s){const i=d=>(d=d>.0031308?1.055*Math.pow(d,.4166666666666667)-.055:12.92*d,Math.round(Math.min(255,Math.max(0,d*255)))),n=[e/100,t/100,s/100],o=n[0]*3.2404542+n[1]*-1.5371385+n[2]*-.4985314,r=n[0]*-.969266+n[1]*1.8760108+n[2]*.041556,c=n[0]*.0556434+n[1]*-.2040259+n[2]*1.0572252;return[i(o),i(r),i(c)]}static xyz2lab(e,t,s){const i=c=>c>.008856?Math.pow(c,.3333333333333333):7.787*c+.13793103448275862,n=i(e/R.REF_X),o=i(t/R.REF_Y),r=i(s/R.REF_Z);return[116*o-16,500*(n-o),200*(o-r)]}static lab2xyz(e,t,s){const i=(e+16)/116,n=t/500+i,o=i-s/200,r=c=>c>.2068966?Math.pow(c,3):(c-16/116)/7.787;return[r(n)*R.REF_X,r(i)*R.REF_Y,r(o)*R.REF_Z]}static deltaE00(e,t){const[s,i,n]=e,[o,r,c]=t,d=X=>X*180/Math.PI,u=X=>X*Math.PI/180,g=1,l=1,m=1,f=Math.sqrt(i**2+n**2),v=Math.sqrt(r**2+c**2),y=(f+v)/2,C=.5*(1-Math.sqrt(y**7/(y**7+25**7))),I=i*(1+C),S=r*(1+C),b=Math.sqrt(I**2+n**2),w=Math.sqrt(S**2+c**2),M=n===0&&I===0?0:d(Math.atan2(n,I))%360,A=c===0&&S===0?0:d(Math.atan2(c,S))%360,F=o-s,L=w-b;let k=0;b*w!==0&&(k=A-M,k>180?k-=360:k<-180&&(k+=360));const z=2*Math.sqrt(b*w)*Math.sin(u(k)/2),U=(s+o)/2,O=(b+w)/2;let B=(M+A)/2;Math.abs(M-A)>180&&(B+=180);const q=1-.17*Math.cos(u(B-30))+.24*Math.cos(u(2*B))+.32*Math.cos(u(3*B+6))-.2*Math.cos(u(4*B-63)),Y=1+.015*(U-50)**2/Math.sqrt(20+(U-50)**2),G=1+.045*O,_=1+.015*O*q,$=30*Math.exp((-((B-275)/25))**2),j=-(2*Math.sqrt(O**7/(O**7+25**7)))*Math.sin(u(2*$));return Math.sqrt((F/(g*Y))**2+(L/(l*G))**2+(z/(m*_))**2+j*(L/(l*G))*(z/(m*_)))}static adjustLightness(e,t,s,i,n){const[o,r,c]=R.rgba2lab(e,t,s,i),d=Math.min(100,Math.max(0,o+o*n));return[...R.lab2rgba(d,r,c)]}};a(R,"REF_X",95.047),a(R,"REF_Y",100),a(R,"REF_Z",108.883);let se=R;function ye(h,e){const t=new P(h.x,h.y);for(;t.x>e.x;)t.x-=e.x*2;for(;t.x<-e.x;)t.x+=e.x*2;for(;t.y>e.y;)t.y-=e.y*2;for(;t.y<-e.y;)t.y+=e.y*2;return t}function he(h,e){const t=new E(h.x,h.y);for(;t.x<0;)t.x+=e.x;for(;t.x>e.x;)t.x-=e.x;for(;t.y<0;)t.y+=e.y;for(;t.y>e.y;)t.y-=e.y;return t}function _e(h,e,t){let s=e.x-h.x,i=e.y-h.y;return Math.abs(s)>t.x/2&&(s>0?s-=t.x:s+=t.x),Math.abs(i)>t.y/2&&(i>0?i-=t.y:i+=t.y),{dx:s,dy:i}}function Ze(h,e,t,s){const{dx:i,dy:n}=_e(h,e,s),o=new E(h.x+i*t,h.y+n*t);return he(o,s)}function oe(){return new P(W.instance.canvasSize.x,W.instance.canvasSize.y)}function we(){return oe().multiply(.5)}class We{constructor(e,t){a(this,"movieMaker",null);a(this,"recordingEdges",[]);a(this,"isRecordingEdges",!1);this.canvas=e,this.container=t}initialize(){this.movieMaker=new Oe({canvas:this.canvas,recorderOptions:{fps:60,videoBitsPerSecond:5e6},animatorOptions:{targetFPS:60}})}getMovieMaker(){return this.movieMaker}startRecordingEdges(){if(this.isRecordingEdges){console.warn("Already recording edges");return}this.isRecordingEdges=!0,this.recordingEdges=[],console.log("Started recording edge additions")}stopRecordingEdges(){if(!this.isRecordingEdges)return console.warn("Not currently recording edges"),0;this.isRecordingEdges=!1;const e=this.recordingEdges.length;return console.log(`Stopped recording. ${e} edges recorded.`),e}recordEdgeAction(e,t,s,i,n){this.isRecordingEdges&&this.recordingEdges.push({type:e,fromNode:t,toNode:s,color:i,weight:n})}getRecordedEdges(){return[...this.recordingEdges]}clearRecordedEdges(){this.recordingEdges=[]}get isRecording(){return this.isRecordingEdges}get recordedEdgeCount(){return this.recordingEdges.length}async createEdgeAdditionMovie(e,t=30){if(this.recordingEdges.length===0)throw new Error("No edges recorded! Use 'Start Recording Edges' first.");const s=this.container.get("graph"),i=this.container.get("app"),n=this.container.get("ui"),o=new Map;this.recordingEdges.forEach(({type:g,fromNode:l,toNode:m,color:f,weight:v})=>{const y=l.id<m.id?`${l.id}-${m.id}`:`${m.id}-${l.id}`;o.set(y,{lastAction:g,fromNode:l,toNode:m,color:f,weight:v})});const r=[];o.forEach(g=>{const m=s.getEdgesInvolvingNodes([g.fromNode.id,g.toNode.id]).find(f=>f.fromId===g.fromNode.id&&f.toId===g.toNode.id||f.fromId===g.toNode.id&&f.toId===g.fromNode.id);g.lastAction==="add"?m&&s.deleteEdge(m):m||s.addEdge(g.fromNode.id,g.toNode.id,g.color,g.weight)}),i.render();const c=[];this.recordingEdges.forEach(({type:g,fromNode:l,toNode:m,color:f,weight:v},y)=>{const C=e/(t+1),I=new ne({x:l.coordinates.x,y:l.coordinates.y},{x:m.coordinates.x,y:m.coordinates.y},g==="add"?0:1,!0,f,v,s.zigzagSpacing,s.zigzagLength,s.zigzagEndLengths);for(let S=0;S<=t;S++){const b=S/t;c.push({action:()=>{if(g==="add")S===0?r[y]=I:S<t?I.setProgress(b):(r[y]=null,s.addEdge(l.id,m.id,f,v));else if(S===0){const A=s.getEdgesInvolvingNodes([l.id,m.id]).find(F=>F.fromId===l.id&&F.toId===m.id||F.fromId===m.id&&F.toId===l.id);A&&s.deleteEdge(A),r[y]=I}else S<t?I.setProgress(1-b):r[y]=null;const w=[...s.toDrawables()];r.forEach(M=>{M&&w.push(M)}),i.elementsToDraw.value=w,i.render()},duration:C})}});const d=this.recordingEdges.filter(g=>g.type==="add").length,u=this.recordingEdges.filter(g=>g.type==="remove").length;n.updateMovieStatus(`Encoding edge animation (${d} additions, ${u} removals)...`);try{const g=new fe({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),l=c.map(f=>({render:v=>{f.action(),v.drawImage(this.canvas,0,0)},durationMs:f.duration})),m=await g.encodeVideo(l,(f,v)=>{n.updateMovieStatus(`Encoding: ${f}/${v} frames (${Math.round(f/v*100)}%)`)});this.downloadBlob(m,"edge-animation.webm"),n.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>n.updateMovieStatus(""),3e3)}catch(g){throw console.error("Error creating movie:",g),new Error("Error creating movie: "+g)}finally{r.length=0}}downloadBlob(e,t){const s=URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=s,i.download=t,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(s)},500)}async createSimulationMovie(e,t,s,i){if(!this.movieMaker)throw new Error("Movie maker not initialized");const n=this.container.get("graph"),o=this.container.get("app"),r=this.container.get("ui"),c=this.container.get("simulations");let d,u;if(e==="force_balance")d=()=>c.doForceBalanceStep(n),u="Force Balance";else if(e==="position_equilibration")d=()=>c.doPositionEquilibrationStep(n),u="Position Equilibration";else throw new Error("Invalid simulation type");const g=new Map;n.getAllNodes().forEach(l=>{g.set(l.id,{x:l.coordinates.x,y:l.coordinates.y})});try{let l=Array(t).fill(s);if(i){const f=g;let v=f;const y=[];for(let S=0;S<t;S++){d();let b=0;n.getAllNodes().forEach(A=>{const F=v.get(A.id);if(F){const L=A.coordinates.x-F.x,k=A.coordinates.y-F.y;b+=Math.sqrt(L*L+k*k)}});const w=b/n.getAllNodes().length;y.push(w);const M=new Map;n.getAllNodes().forEach(A=>{M.set(A.id,{x:A.coordinates.x,y:A.coordinates.y})}),v=M}const C=t*s,I=y.reduce((S,b)=>S+b,0);l=y.map(S=>S>0?Math.min(C,C/I*S):s),n.getAllNodes().forEach(S=>{const b=f.get(S.id);b&&(S.coordinates.x=b.x,S.coordinates.y=b.y)})}const m=[];if(i)for(let f=0;f<t;f++){const v=l[f],y=Math.max(1,Math.ceil(v/s)),C=new Map;n.getAllNodes().forEach(w=>{C.set(w.id,{x:w.coordinates.x,y:w.coordinates.y})}),d();const I=new Map;n.getAllNodes().forEach(w=>{I.set(w.id,{x:w.coordinates.x,y:w.coordinates.y})}),n.getAllNodes().forEach(w=>{const M=C.get(w.id);M&&(w.coordinates.x=M.x,w.coordinates.y=M.y)});const S=y+1,b=v/S;for(let w=0;w<=y;w++){const M=w/y;m.push({action:()=>{const A=oe();n.getAllNodes().forEach(F=>{const L=C.get(F.id),k=I.get(F.id);if(L&&k){const z=Ze(L,k,M,A);F.coordinates.x=z.x,F.coordinates.y=z.y}}),o.render()},duration:b})}n.getAllNodes().forEach(w=>{const M=I.get(w.id);M&&(w.coordinates.x=M.x,w.coordinates.y=M.y)})}else for(let f=0;f<t;f++)m.push({action:()=>{d(),o.render()},duration:s});r.updateMovieStatus(`Encoding ${u} simulation (${t} steps${i?" with adaptive duration":""})...`);try{const f=new fe({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),v=m.map(C=>({render:I=>{C.action(),I.drawImage(this.canvas,0,0)},durationMs:C.duration})),y=await f.encodeVideo(v,(C,I)=>{r.updateMovieStatus(`Encoding: ${C}/${I} frames (${Math.round(C/I*100)}%)`)});this.downloadBlob(y,`${e}-simulation.webm`),r.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>r.updateMovieStatus(""),3e3)}catch(f){throw console.error("Error creating movie:",f),new Error("Error creating movie: "+f)}}finally{n.getAllNodes().forEach(l=>{const m=g.get(l.id);m&&(l.coordinates.x=m.x,l.coordinates.y=m.y)})}}}class qe{constructor(){a(this,"selectedItems",[])}toggleItems(e){e.forEach(t=>{this.hasItem(t)?this.removeItem(t):this.addItem(t)})}addItem(e){this.selectedItems.push(e)}setItem(e){this.selectedItems=[e]}hasItem(e){return this.selectedItems.includes(e)}hasItems(e){return e.every(t=>this.hasItem(t))}setSelectedItems(e){this.selectedItems=e}removeItem(e){this.selectedItems=this.selectedItems.filter(t=>t!==e)}removeLastItem(){this.selectedItems.length>0&&this.selectedItems.pop()}getSelectedItems(){return this.selectedItems}getItemsOfClass(e){return this.selectedItems.filter(t=>t instanceof e)}clearSelection(){this.selectedItems=[]}get empty(){return this.selectedItems.length===0}get length(){return this.selectedItems.length}}const x=new qe;function Ye(h,e){const t=new P(h.coordinates.x,h.coordinates.y);return new P(e.coordinates.x,e.coordinates.y).subtract(t)}function $e(){const h=oe(),e=we();x.getItemsOfClass(N).forEach(s=>{const i=p.getNodesConnectedToNode(s.id);let n=new P(0,0);i.forEach(r=>{const c=Ye(s,r),d=ye(c,e).multiply(1/i.length);n=n.add(d)});const o=he(new P(n.x+s.coordinates.x,n.y+s.coordinates.y),h);s.coordinates.x=o.x,s.coordinates.y=o.y})}function Xe(h){const e=oe(),t=document.getElementById("randomWalkStepSize").valueAsNumber,s=document.getElementById("randomWalkMaxAngle").valueAsNumber*Math.PI/180,i=document.getElementById("randomWalkSteps").valueAsNumber,n=[],o=[],r=document.getElementById("vertexRadius").valueAsNumber,c=document.getElementById("vertexStrokeWidth").valueAsNumber,d=document.getElementById("nodeFillColor").value,u=document.getElementById("nodeColor").value,g=new N(p.getNextNodeId(),h,r,c,d,u);n.push(g);let l=new E(h.x,h.y),m=Math.random()*2*Math.PI;const f=document.getElementById("edgeColor").value,v=parseFloat(document.getElementById("lineWidth").value);for(let y=0;y<i;y++){const C=(Math.random()*2-1)*s;m+=C;const I=l.x+t*Math.cos(m),S=l.y+t*Math.sin(m);l=new E(I,S),l=he(l,e);const b=new N(p.getNextNodeId()+y+1,l,r,c,d,u);n.push(b);const w=n[n.length-2],M=new de(w.id,b.id,-1,v,f);o.push(M)}return{nodes:n,edges:o}}function Ve(){const h=x.getItemsOfClass(N);if(console.log("Equilibrating "+h.length+" nodes..."),h.length<1)return;const e=we(),t=25;for(const s of h){let i=new P(0,0);for(const o of p.getAllNodes()){if(s.id===o.id)continue;const r=new P(s.coordinates.x,s.coordinates.y);let d=new P(o.coordinates.x,o.coordinates.y).subtract(r);d=ye(d,e);const u=Math.sqrt(d.x*d.x+d.y*d.y);if(u>0){const g=t/(u*u),l=d.multiply(-g);i=i.add(l)}}i.x>s.radius&&(i.x=s.radius),i.x<-s.radius&&(i.x=-s.radius),i.y>s.radius&&(i.y=s.radius),i.y<-s.radius&&(i.y=-s.radius);const n=new P(s.coordinates.x+i.x,s.coordinates.y+i.y);s.coordinates=n}}class Z{static serialize(e,t){return{version:this.STORAGE_VERSION,timestamp:new Date().toISOString(),graph:e,settings:t}}static deserialize(e,t,s){try{return e.version&&e.version!==this.STORAGE_VERSION&&console.warn(`State version mismatch. Expected ${this.STORAGE_VERSION}, got ${e.version}`),"settings"in e?(e.graph&&t.fromJSON(e.graph),e.settings&&this.applySettings(e.settings,s)):t.fromJSON(e),!0}catch(i){return console.error("Failed to deserialize state:",i),!1}}static applySettings(e,t){e.canvasSize&&(t.canvasSize.x=e.canvasSize.x,t.canvasSize.y=e.canvasSize.y),e.backgroundColor!==void 0&&(t.backgroundColor=e.backgroundColor),e.imageScaleFactor!==void 0&&(t.imageScaleFactor=e.imageScaleFactor),e.disablePBC!==void 0&&(t.disablePBC=e.disablePBC)}static saveState(e,t){try{const s=this.serialize(e,t);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),console.log("State saved to localStorage")}catch(s){console.error("Failed to save state to localStorage:",s)}}static loadState(e,t){try{const s=localStorage.getItem(this.STORAGE_KEY);if(!s)return console.log("No saved state found in localStorage"),!1;const i=JSON.parse(s),n=this.deserialize(i,e,t);return n&&console.log(`State loaded from localStorage (saved at ${i.timestamp||"unknown time"})`),n}catch(s){return console.error("Failed to load state from localStorage:",s),!1}}static clearState(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("State cleared from localStorage")}catch(e){console.error("Failed to clear state from localStorage:",e)}}static hasSavedState(){try{return localStorage.getItem(this.STORAGE_KEY)!==null}catch(e){return console.error("Failed to check for saved state:",e),!1}}}a(Z,"STORAGE_KEY","polymer-graph-sketcher-state"),a(Z,"STORAGE_VERSION","1.0");function Se(h,e){if(h===e)return;if(h>e)return Se(e,h);p.getEdgesInvolvingNode(e).forEach(n=>{n.fromId===e?n.fromId=h:n.toId=h});const s=p.getNode(h),i=p.getNode(e);s.coordinates.x=(s.coordinates.x+i.coordinates.x)/2,s.coordinates.y=(s.coordinates.y+i.coordinates.y)/2,p.deleteNode(e)}function Ue(h){let e;do{e=!1;for(const t of p.getAllEdges())if(t.color===h){Se(t.fromId,t.toId),p.deleteEdge(t),e=!0;break}}while(e);x.clearSelection()}function Ge(){const h=p.getAllNodes();for(const e of h){const t=p.getEdgesInvolvingNode(e.id);t.length===2&&t[0].color===t[1].color&&t[0].weight===t[1].weight&&(p.deleteEdge(t[0]),p.deleteEdge(t[1]),p.addEdge(t[0].fromId==e.id?t[0].toId:t[0].fromId,t[1].fromId==e.id?t[1].toId:t[1].fromId,t[0].color,t[0].weight),p.deleteNode(e.id))}}class Ke{constructor(e){a(this,"container");this.container=e}generateSideChains(e,t,s,i){const n=this.container.get("selection"),o=this.container.get("graph"),r=this.container.get("actionManager"),c=this.container.get("nodeCounter"),d=this.container.get("ui");n.getItemsOfClass(N).forEach(g=>{const l=o.getEdgesInvolvingNode(g.id);if(l.length!==2)return;const m=o.getNode(l[0].getOtherNodeId(g.id)),f=o.getNode(l[1].getOtherNodeId(g.id));if(!m||!f)return;const v=f.coordinates.x-m.coordinates.x,y=f.coordinates.y-m.coordinates.y,C=Math.sqrt(v*v+y*y),I=v/C,S=y/C,b=-S,w=I,M=S,A=-I,F=Math.floor(t),L=t-F,k=F+(Math.random()<L?1:0);let z=Math.random()<.5;const U=this.container.get("AddNodeAction"),O=this.container.get("AddEdgeAction");for(let B=0;B<k;B++){z=!z;const q=z?b:M,Y=z?w:A,G=Math.PI*i,_=(Math.random()*2-1)*G,$=Math.cos(_),K=Math.sin(_),j=q*$-Y*K,X=q*K+Y*$,H=g.coordinates.x+j*e*(1-s*Math.random()),Q=g.coordinates.y+X*e*(1-s*Math.random()),ee=c.value++,ae=new N(ee,{x:H,y:Q},g.radius,g.strokeWidth,g.fillColor,g.strokeColor);r.addAction(new U(ee,{x:H,y:Q},d)),r.addAction(new O(g,[ae],d))}})}removeBifunctionalNodes(){const e=this.container.get("app");Ge(),e.render()}mergeEdgesByColor(e){const t=this.container.get("app");Ue(e),t.render()}removeDuplicateEdges(){const e=this.container.get("graph"),t=this.container.get("app");e.removeDuplicateEdges(),t.render()}removeSelfEdges(){const e=this.container.get("graph"),t=this.container.get("app");e.cleanupEdges(),t.render()}clearGraph(){const e=this.container.get("graph"),t=this.container.get("selection"),s=this.container.get("modeFactory"),i=this.container.get("app");e.clear(),t.clearSelection(),s.setCurrentMode("vertex"),i.render()}}class Je{constructor(e,t){a(this,"svg");a(this,"lastElement");a(this,"currentGroup",null);a(this,"prevState",null);a(this,"currentXOffset",0);a(this,"currentYOffset",0);a(this,"currentRotationRad",0);a(this,"currentX",0);a(this,"currentY",0);a(this,"canvas");a(this,"globalAlpha",1);a(this,"globalCompositeOperation");a(this,"fillStyle");a(this,"strokeStyle");a(this,"filter");a(this,"imageSmoothingEnabled");a(this,"imageSmoothingQuality");a(this,"lineCap","butt");a(this,"lineDashOffset");a(this,"lineJoin","round");a(this,"lineWidth",0);a(this,"miterLimit");a(this,"shadowBlur");a(this,"shadowColor");a(this,"shadowOffsetX");a(this,"shadowOffsetY");a(this,"direction","ltr");a(this,"font");a(this,"fontKerning");a(this,"fontStretch","normal");a(this,"fontVariantCaps","normal");a(this,"letterSpacing");a(this,"textAlign","left");a(this,"textBaseline");a(this,"textRendering");a(this,"wordSpacing");this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",e.toString()),this.svg.setAttribute("height",t.toString()),this.lastElement=this.svg}addElement(e){this.currentGroup?this.currentGroup.appendChild(e):this.svg.appendChild(e),this.lastElement=e}pointIsOnCanvas(e){const t={width:parseFloat(this.svg.getAttribute("width")),height:parseFloat(this.svg.getAttribute("height"))};return e.x>=0&&e.x<=t.width&&e.y>=0&&e.y<=t.height}rect(e,t,s,i){const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",e.toString()),n.setAttribute("y",t.toString()),n.setAttribute("width",s.toString()),n.setAttribute("height",i.toString()),this.addElement(n)}clearRect(e,t,s,i){this.rect(e,t,s,i),this.lastElement.setAttribute("style","background-color: white; fill: white;")}fillRect(e,t,s,i){this.rect(e,t,s,i),this.lastElement.setAttribute("style",this.stylesToCSS(!0,!1)+";stroke:none;")}strokeRect(e,t,s,i){this.rect(e,t,s,i),this.lastElement.setAttribute("style",this.stylesToCSS(!1,!0)+";fill:none;")}arc(e,t,s,i,n){const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",e.toString()),o.setAttribute("cy",t.toString()),o.setAttribute("r",s.toString()),o.setAttribute("style",this.stylesToCSS(!0,!0)),this.addElement(o)}moveTo(e,t){this.currentX=e,this.currentY=t}rotate(e){this.currentRotationRad+=e}translate(e,t){this.currentXOffset+=e,this.currentYOffset+=t}lineTo(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","line"),i=Math.cos(this.currentRotationRad)*this.currentX-Math.sin(this.currentRotationRad)*this.currentY,n=Math.sin(this.currentRotationRad)*this.currentX+Math.cos(this.currentRotationRad)*this.currentY,o=Math.cos(this.currentRotationRad)*e-Math.sin(this.currentRotationRad)*t,r=Math.sin(this.currentRotationRad)*e+Math.cos(this.currentRotationRad)*t,c=new E(i+this.currentXOffset,n+this.currentYOffset),d=new E(o+this.currentXOffset,r+this.currentYOffset);s.setAttribute("x1",c.x.toString()),s.setAttribute("y1",c.y.toString()),s.setAttribute("x2",d.x.toString()),s.setAttribute("y2",d.y.toString()),s.setAttribute("style",this.stylesToCSS(!1,!0)),this.lineCap&&s.setAttribute("stroke-linecap",this.lineCap),(this.pointIsOnCanvas(c)||this.pointIsOnCanvas(d)||c.x<=0&&d.x>=parseFloat(this.svg.getAttribute("width"))||c.y<=0&&d.y>=parseFloat(this.svg.getAttribute("height")))&&this.addElement(s),this.currentX=e,this.currentY=t}stroke(){this.addStyles(this.stylesToCSS(!1,!0))}fill(e,t){if(e||t)throw new Error("Method not implemented.");this.addStyles(this.stylesToCSS(!0,!1))}addStyles(e){if(this.lastElement){const t=this.lastElement.getAttribute("style"),s=this.parseStyles(e);if(t){const i=this.parseStyles(t);for(const[n,o]of Object.entries(i))s[n]||(s[n]=o)}this.lastElement.setAttribute("style",this.styleMapToString(s));for(const[i,n]of Object.entries(s))this.lastElement.setAttribute(i,n)}}parseStyles(e){const t={};return e.split(";").forEach(i=>{const[n,o]=i.trim().split(":");t[n.trim()]=o.trim()}),t}styleMapToString(e){return Object.entries(e).map(([t,s])=>`${t}: ${s}`).join("; ")}restore(){if(this.prevState)this.fillStyle=this.prevState.fillStyle,this.strokeStyle=this.prevState.strokeStyle,this.lineWidth=this.prevState.lineWidth,this.currentX=this.prevState.currentX,this.currentY=this.prevState.currentY,this.lastElement=this.prevState.lastElement,this.currentXOffset=this.prevState.currentXOffset,this.currentYOffset=this.prevState.currentYOffset,this.currentRotationRad=this.prevState.currentRotationRad,this.prevState=null,this.currentGroup=null;else throw new Error("No state to restore.")}save(){if(this.prevState)throw new Error("Only one state can be saved at a time.");this.prevState={fillStyle:this.fillStyle,strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,currentX:this.currentX,currentY:this.currentY,lastElement:this.lastElement,currentXOffset:this.currentXOffset,currentYOffset:this.currentYOffset,currentRotationRad:this.currentRotationRad};const e=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(e),this.lastElement=e,this.currentGroup=e}stylesToCSS(e=!0,t=!0){let s={"stroke-width":this.lineWidth.toString(),"stroke-linecap":this.lineCap||"butt"};return e&&this.fillStyle&&(s.fill=this.fillStyle.toString()),t&&this.strokeStyle&&(s.stroke=this.strokeStyle.toString()),this.styleMapToString(s)}getSVG(){return this.svg}beginPath(){}closePath(){}getContextAttributes(){throw new Error("Method not implemented.")}drawImage(e,t,s,i,n,o,r,c,d){throw new Error("Method not implemented.")}clip(e,t){throw new Error("Method not implemented.")}isPointInPath(e,t,s,i){throw new Error("Method not implemented.")}isPointInStroke(e,t,s){throw new Error("Method not implemented.")}createConicGradient(e,t,s){throw new Error("Method not implemented.")}createLinearGradient(e,t,s,i){throw new Error("Method not implemented.")}createPattern(e,t){throw new Error("Method not implemented.")}createRadialGradient(e,t,s,i,n,o){throw new Error("Method not implemented.")}createImageData(e,t,s){throw new Error("Method not implemented.")}getImageData(e,t,s,i,n){throw new Error("Method not implemented.")}putImageData(e,t,s,i,n,o,r){throw new Error("Method not implemented.")}arcTo(e,t,s,i,n){throw new Error("Method not implemented.")}scale(e,t){throw new Error("Method not implemented.")}bezierCurveTo(e,t,s,i,n,o){throw new Error("Method not implemented.")}ellipse(e,t,s,i,n,o,r,c){throw new Error("Method not implemented.")}quadraticCurveTo(e,t,s,i){throw new Error("Method not implemented.")}roundRect(e,t,s,i,n){throw new Error("Method not implemented.")}getLineDash(){throw new Error("Method not implemented.")}setLineDash(e){throw new Error("Method not implemented.")}isContextLost(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}fillText(e,t,s,i){throw new Error("Method not implemented.")}measureText(e){throw new Error("Method not implemented.")}strokeText(e,t,s,i){throw new Error("Method not implemented.")}getTransform(){throw new Error("Method not implemented.")}resetTransform(){throw new Error("Method not implemented.")}setTransform(e,t,s,i,n,o){throw new Error("Method not implemented.")}transform(e,t,s,i,n,o){throw new Error("Method not implemented.")}drawFocusIfNeeded(e,t){throw new Error("Method not implemented.")}}class je{constructor(e){a(this,"container");this.container=e}exportGraph(){const e=this.container.get("graph"),t=this.container.get("settings"),s=Z.serialize(e,t),i=new Blob([JSON.stringify(s)],{type:"application/json"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download="graph.json",o.click(),URL.revokeObjectURL(n)}importGraph(e){const t=this.container.get("graph"),s=this.container.get("settings"),i=this.container.get("ui"),n=this.container.get("canvas"),o=this.container.get("app"),r=new FileReader;r.onload=c=>{var d;if((d=c.target)!=null&&d.result)try{const u=JSON.parse(c.target.result);if(Z.deserialize(u,t,s)){n.resize(s.canvasSize.x,s.canvasSize.y),i.updateCanvasSizeUI(s.canvasSize.x,s.canvasSize.y);const l=this.container.get("nodeCounter");if(l&&t.getNrOfNodes()>0){const m=t.getAllNodeIds();l.value=Math.max(...m)+1}o.render()}else alert("Failed to import graph. The file may be corrupted or in an incompatible format.")}catch(u){console.error("Error importing graph:",u),alert("Failed to import graph. Please check the file format.")}},r.readAsText(e)}saveCanvasAsImage(e){const t=this.container.get("app"),s=this.container.get("canvas"),i=()=>{t.render();const n=s.toDataURL("image/png"),o=document.createElement("a");o.href=n,o.download="polymer-graph-sketch.png",o.click()};e?e(i):i()}saveGraphAsSvg(){const e=this.container.get("settings"),t=this.container.get("app"),s=new Je(e.canvasSize.x,e.canvasSize.y);t.elementsToDraw.value.forEach(r=>{r.draw(s)});const i=s.getSVG(),n=new XMLSerializer().serializeToString(i),o=document.createElement("a");o.href="data:image/svg+xml;base64,"+btoa(n),o.download="graph.svg",o.click()}}class He{constructor(e){a(this,"doneStack",[]);a(this,"undoneStack",[]);a(this,"afterActionCallback");this.afterActionCallback=e}addAction(e){this.doneStack.push(e),e.do(),this.undoneStack=[],this.afterActionCallback()}undo(){if(this.doneStack.length){const e=this.doneStack.pop();e.undo(),this.undoneStack.push(e),this.afterActionCallback()}}redo(){if(this.undoneStack.length){const e=this.undoneStack.pop();e.do(),this.doneStack.push(e),this.afterActionCallback()}}}class Qe{constructor(e,t,s){a(this,"affectedNodes");a(this,"originalValues");a(this,"targetValue");a(this,"property");this.affectedNodes=e,this.originalValues=e.map(i=>i[s]),this.targetValue=t,this.property=s}do(){this.affectedNodes.forEach(e=>{e[this.property]=this.targetValue})}undo(){this.affectedNodes.forEach((e,t)=>{e[this.property]=this.originalValues[t]})}}class et{constructor(e,t,s){a(this,"affectedNodes");a(this,"originalPositions");a(this,"newPositions");this.affectedNodes=e,this.originalPositions=t.map(i=>new E(i.x,i.y)),this.newPositions=s.map(i=>new E(i.x,i.y))}do(){this.affectedNodes.forEach((e,t)=>{e.coordinates.x=this.newPositions[t].x,e.coordinates.y=this.newPositions[t].y})}undo(){this.affectedNodes.forEach((e,t)=>{e.coordinates.x=this.originalPositions[t].x,e.coordinates.y=this.originalPositions[t].y})}}class tt{constructor(e){this.nodes=e}do(){this.nodes.forEach(e=>{p.setNode(new N(e.id,e.coordinates,e.radius,e.strokeWidth,e.fillColor,e.strokeColor))}),x.setSelectedItems(this.nodes.map(e=>p.getNode(e.id)))}undo(){this.nodes.forEach(e=>{p.deleteNode(e.id)})}}class Ee{constructor(e,t,s){this.nodeId=e,this.position=t,this.uiFacade=s}do(){p.setNode(new N(this.nodeId,this.position,this.uiFacade.getInputValueAsNumber("vertexRadius"),this.uiFacade.getInputValueAsNumber("vertexStrokeWidth"),this.uiFacade.getInputValue("nodeFillColor"),this.uiFacade.getInputValue("nodeColor"))),x.setItem(p.getNode(this.nodeId))}undo(){p.deleteNode(this.nodeId)}}class Ce{constructor(e){a(this,"affectedEdges",[]);this.affectedNodes=e}do(){this.affectedNodes.forEach(e=>{p.getEdgesInvolvingNode(e.id).forEach(t=>{this.affectedEdges.push(t)}),x.removeItem(e),p.deleteNode(e.id)})}undo(){this.affectedNodes.forEach(e=>{p.setNode(e),x.addItem(e)}),this.affectedEdges.forEach(e=>{p.addEdge(e.fromId,e.toId,e.color,e.weight)})}}class J{constructor(e,t=!1){a(this,"previousSelectedNodes",x.getSelectedItems());this.affectedNodes=e,this.clearSelection=t}do(){this.clearSelection?x.setSelectedItems(this.affectedNodes):this.affectedNodes.forEach(e=>{x.addItem(e)})}undo(){x.setSelectedItems(this.previousSelectedNodes)}}class st{constructor(e){a(this,"previousSelectedNodes",x.getSelectedItems());this.affectedNodes=e,this.affectedNodes.forEach(t=>{this.previousSelectedNodes.includes(t)||console.warn("Trying to unselect a node that is not selected")}),console.log("Unselecting nodes:",this.affectedNodes)}do(){x.setSelectedItems(this.previousSelectedNodes.filter(e=>!(e instanceof N&&this.affectedNodes.includes(e))))}undo(){x.setSelectedItems(this.previousSelectedNodes)}}class xe{constructor(e=x.getItemsOfClass(N)){this.previousSelectedNodes=e}do(){x.setSelectedItems(p.getAllNodes())}undo(){x.setSelectedItems(this.previousSelectedNodes)}}class Ie{constructor(e=x.getSelectedItems()){this.previousSelectedNodes=e}do(){x.clearSelection()}undo(){x.setSelectedItems(this.previousSelectedNodes)}}class Me{constructor(e=x.getSelectedItems()){this.previousSelectedNodes=e}do(){x.toggleItems(p.getAllNodes())}undo(){x.setSelectedItems(this.previousSelectedNodes)}}class it{constructor(e,t,s){a(this,"edgeIds",[]);if(this.edgesFrom=e,this.edgesTo=t,this.uiFacade=s,e.length!==t.length)throw new Error("edgesFrom and edgesTo must have the same length")}do(){for(let e=0;e<this.edgesFrom.length;e++)this.edgeIds.push(p.addEdge(this.edgesFrom[e],this.edgesTo[e],this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}undo(){this.edgeIds.slice().reverse().forEach(e=>{p.deleteEdge(e)})}}class be{constructor(e,t,s){a(this,"edgeIds",[]);this.fromNode=e,this.affectedNodes=t,this.uiFacade=s}do(){this.affectedNodes.forEach(e=>{this.edgeIds.push(p.addEdge(this.fromNode.id,e.id,this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}),this.affectedNodes.length<=1&&x.setItem(this.fromNode)}undo(){this.edgeIds.slice().reverse().forEach(e=>{p.deleteEdge(e)}),x.setSelectedItems(this.affectedNodes)}}class nt{constructor(e,t){a(this,"edges",[]);this.additionalNode=t,t&&e.push(t),this.edges=p.getEdgesInvolvingNodes(e.map(s=>s.id))}do(){this.edges.forEach(e=>{p.deleteEdge(e)}),this.additionalNode&&x.addItem(this.additionalNode)}undo(){this.edges.forEach(e=>{p.addEdge(e.fromId,e.toId,e.color,e.weight)}),this.additionalNode&&x.removeItem(this.additionalNode)}}class ot{constructor(e){a(this,"container");a(this,"canvas");a(this,"dragStart",null);a(this,"draggedNodes",[]);a(this,"originalNodePositions",[]);a(this,"isDraggingNode",!1);this.container=e,this.canvas=e.get("canvas").canvas}attachEventListeners(){this.canvas.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("mousedown",this.handleMouseDown.bind(this)),window.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleClick(e){if(this.dragStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(e.clientX,e.clientY),n=this.container.get("modeFactory").getCurrentMode(),o=this.container.get("actionManager");n&&n.onCanvasClick(s,o)}handleMouseDown(e){this.dragStart={x:e.clientX,y:e.clientY};const s=this.container.get("modeFactory").getCurrentMode(),n=this.container.get("canvas").clientToCanvasCoordinates(e.clientX,e.clientY),r=this.container.get("graph").findNodeByCoordinates(n.x,n.y);if(s&&s.onMouseDown)if(s.onMouseDown(e),r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(N),this.originalNodePositions=this.draggedNodes.map(d=>new E(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1;else if(r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(N),this.originalNodePositions=this.draggedNodes.map(d=>new E(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1}handleMouseMove(e){if(!this.dragStart)return;const s=this.container.get("modeFactory").getCurrentMode();if(this.isDraggingNode){const i=e.clientX-this.dragStart.x,n=e.clientY-this.dragStart.y,o=this.container.get("selection"),r=W.instance,c=this.container.get("app");o.getItemsOfClass(N).forEach(d=>{d.coordinates.x+=i,d.coordinates.y+=n,d.coordinates.x<0&&(d.coordinates.x+=r.canvasSize.x),d.coordinates.x>=r.canvasSize.x&&(d.coordinates.x-=r.canvasSize.x),d.coordinates.y<0&&(d.coordinates.y+=r.canvasSize.y),d.coordinates.y>=r.canvasSize.y&&(d.coordinates.y-=r.canvasSize.y)}),this.dragStart={x:e.clientX,y:e.clientY},c.render();return}if(s&&s.onMouseMove){s.onMouseMove(e);return}}handleMouseUp(e){const s=this.container.get("modeFactory").getCurrentMode();if(this.dragStart&&this.isDraggingNode&&this.draggedNodes.length>0){const i=this.draggedNodes.map(o=>new E(o.coordinates.x,o.coordinates.y));if(this.originalNodePositions.some((o,r)=>o.x!==i[r].x||o.y!==i[r].y)){const o=this.container.get("actionManager"),r=new et(this.draggedNodes,this.originalNodePositions,i);r.undo(),o.addAction(r)}}else s&&s.onMouseUp&&s.onMouseUp(e);this.dragStart=null,this.draggedNodes=[],this.originalNodePositions=[],this.isDraggingNode=!1}detachEventListeners(){this.canvas.removeEventListener("click",this.handleClick.bind(this)),window.removeEventListener("mousedown",this.handleMouseDown.bind(this)),window.removeEventListener("mousemove",this.handleMouseMove.bind(this)),window.removeEventListener("mouseup",this.handleMouseUp.bind(this))}}class at{constructor(e){a(this,"container");this.container=e}attachListener(e,t,s){const i=document.getElementById(e);i&&i.addEventListener(t,n=>s(i,n))}attachButtonClick(e,t){this.attachListener(e,"click",t)}attachInputChange(e,t){this.attachListener(e,"change",s=>t(s))}attachEventListeners(){this.attachModeSwitch(),this.attachNodePropertyListeners(),this.attachEdgePropertyListeners(),this.attachCanvasPropertyListeners(),this.attachButtonListeners(),this.attachRedrawListeners()}attachModeSwitch(){const e=document.getElementById("modeSwitch");e&&e.addEventListener("click",()=>{this.container.get("modeFactory").setCurrentMode(e.value)})}attachNodePropertyListeners(){const e=this.container.get("actionManager"),t=this.container.get("selection"),s=(i,n)=>o=>{if(t.empty)return;const r=n(o.value);e.addAction(new Qe(t.getItemsOfClass(N),r,i))};this.attachInputChange("vertexRadius",s("radius",parseFloat)),this.attachInputChange("vertexStrokeWidth",s("strokeWidth",parseFloat)),this.attachInputChange("nodeFillColor",s("fillColor",i=>i)),this.attachInputChange("nodeColor",s("strokeColor",i=>i)),this.attachInputChange("selectVerticesStroke",i=>{const n=this.container.get("graph");e.addAction(new J(n.getAllNodes().filter(o=>se.deltaE00(se.hex2lab(o.strokeColor),se.hex2lab(i.value))<10),!0))})}attachEdgePropertyListeners(){const e=this.container.get("graph"),t=this.container.get("selection"),s=this.container.get("app"),i=(n,o)=>r=>{const c=t.getItemsOfClass(N).map(d=>d.id);e.getEdgesWithBothEndsInNodes(c).forEach(d=>{d[n]=o(r.value)}),s.render()};this.attachInputChange("edgeColor",i("color",n=>n)),this.attachInputChange("lineWidth",i("weight",parseFloat))}attachCanvasPropertyListeners(){const e=this.container.get("actionManager"),t=this.container.get("settings"),s=this.container.get("canvas"),i=this.container.get("app"),n=this.container.get("graph"),o=this.container,r=(c,d)=>{const u=c==="x"?"width":"height",g=t.canvasSize[c],l=m=>{const f=document.getElementById("canvas-parent");f.style[u]=m+"px",t.canvasSize[c]=m;const y=o.get("ui").getInputChecked("resizeElements"),C=s.resizeWithGraphScaling(t.canvasSize.x,t.canvasSize.y,y,n);i.render({x:C.xScaling,y:C.yScaling}),document.getElementById("canvas-size").textContent=`Canvas size: ${t.canvasSize.x}x${t.canvasSize.y}`};return{do:()=>l(d),undo:()=>l(g)}};this.attachInputChange("canvasWidth",c=>{const d=parseFloat(c.value);e.addAction(r("x",d))}),this.attachInputChange("canvasHeight",c=>{const d=parseFloat(c.value);e.addAction(r("y",d))}),this.attachInputChange("disablePBC",c=>{t.disablePBC=c.checked,i.render()})}attachButtonListeners(){const e=this.container.get("actionManager"),t=this.container.get("graphOperations"),s=this.container.get("fileService");this.attachButtonClick("clearSelectionButton",()=>{e.addAction(new Ie)}),this.attachButtonClick("selectAllButton",()=>{e.addAction(new xe)}),this.attachButtonClick("invertSelectionButton",()=>{e.addAction(new Me)}),this.attachButtonClick("clearCanvasButton",()=>{t.clearGraph()}),this.attachButtonClick("clearSavedStateButton",()=>{if(confirm("Are you sure you want to clear the saved state? This action cannot be undone.")){const o=this.container.get("StorageService");o&&(o.clearState(),alert("Saved state has been cleared. The current canvas will be saved when you leave or reload the page."))}}),this.attachButtonClick("exportGraphButton",()=>s.exportGraph()),this.attachButtonClick("saveImageButton",()=>this.saveCanvasAsImage()),this.attachButtonClick("saveSvgButton",()=>s.saveGraphAsSvg()),this.attachInputChange("import",()=>this.importGraph()),this.attachButtonClick("startRecordingEdgesBtn",()=>this.startEdgeRecording()),this.attachButtonClick("stopRecordingEdgesBtn",()=>this.stopEdgeRecording()),this.attachButtonClick("createEdgeMovieBtn",()=>this.createEdgeAdditionMovie()),this.attachButtonClick("createSimMovieBtn",()=>this.createSimulationMovie()),this.attachButtonClick("removeDuplicateEdges",()=>{t.removeDuplicateEdges()}),this.attachButtonClick("removeSelfEdges",()=>{t.removeSelfEdges()});const i=this.container.get("graph"),n=this.container.get("app");this.attachButtonClick("forceBalanceStep",()=>{const o=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nForceBalanceSteps")||1;for(let d=0;d<c;d++)o.doForceBalanceStep(i);n.render()}),this.attachButtonClick("positionEquilibrationStep",()=>{const o=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nPositionEquilibrationSteps")||1;for(let d=0;d<c;d++)o.doPositionEquilibrationStep(i);n.render()}),this.attachButtonClick("sideChainGenerationButton",()=>this.generateSideChains()),this.attachButtonClick("bifunctionalRemoval",()=>t.removeBifunctionalNodes()),this.attachInputChange("mergeConnectionColor",o=>t.mergeEdgesByColor(o.value))}attachRedrawListeners(){const e=this.container.get("app"),t=document.getElementsByClassName("redraw-onchange");Array.from(t).forEach(s=>{s instanceof HTMLInputElement&&s.addEventListener("change",()=>{e.render()})})}importGraph(){var i;const t=(i=document.getElementById("import").files)==null?void 0:i[0];if(!t)return;this.container.get("fileService").importGraph(t)}saveCanvasAsImage(){const e=this.container.get("fileService"),t=this.container.get("canvas"),s=this.container.get("settings"),i=this.container.get("app"),n=this.container.get("graph");t.withScaledCanvas(()=>e.saveCanvasAsImage(),s.imageScaleFactor,i,n,s)}generateSideChains(){const e=this.container.get("selection"),t=this.container.get("graph"),s=this.container.get("actionManager"),i=this.container.get("nodeCounter"),n=this.container.get("ui"),o=n.getInputValueAsNumber("sideChainLength")||37.5,r=n.getInputValueAsNumber("sideChainProb")||2,c=n.getInputValueAsNumber("sideChainLengthRandomness")||0,d=n.getInputValueAsNumber("sideChainAngleRandomness")||0;e.getItemsOfClass(N).forEach(g=>{const l=t.getEdgesInvolvingNode(g.id);if(l.length!==2)return;const m=t.getNode(l[0].getOtherNodeId(g.id)),f=t.getNode(l[1].getOtherNodeId(g.id));if(!m||!f)return;const v=f.coordinates.x-m.coordinates.x,y=f.coordinates.y-m.coordinates.y,C=Math.sqrt(v*v+y*y),I=v/C,S=y/C,b=-S,w=I,M=S,A=-I,F=Math.floor(r),L=r-F,k=F+(Math.random()<L?1:0);let z=Math.random()<.5;const U=this.container.get("AddNodeAction"),O=this.container.get("AddEdgeAction");for(let B=0;B<k;B++){z=!z;const q=z?b:M,Y=z?w:A,G=Math.PI*d,_=(Math.random()*2-1)*G,$=Math.cos(_),K=Math.sin(_),j=q*$-Y*K,X=q*K+Y*$,H=g.coordinates.x+j*o*(1-c*Math.random()),Q=g.coordinates.y+X*o*(1-c*Math.random()),ee=i.value++,ae=new N(ee,{x:H,y:Q},g.radius,g.strokeWidth,g.fillColor,g.strokeColor);s.addAction(new U(ee,{x:H,y:Q},n)),s.addAction(new O(g,[ae],n))}})}startEdgeRecording(){const e=this.container.get("movie"),t=this.container.get("modeFactory"),s=this.container.get("ui");e.getMovieMaker()||e.initialize(),e.startRecordingEdges();const i=document.getElementById("startRecordingEdgesBtn"),n=document.getElementById("stopRecordingEdgesBtn"),o=document.getElementById("recordingIndicator");i&&(i.disabled=!0),n&&(n.disabled=!1),o&&(o.textContent="Recording... (0 edges)",o.style.color="red");const r=this.container.get("graph"),c=t.getMode("edge");c&&c.setRecordingCallback&&c.setRecordingCallback((d,u)=>{const l=r.getEdgesInvolvingNodes([d.id,u.id]).find(m=>m.fromId===d.id&&m.toId===u.id||m.fromId===u.id&&m.toId===d.id);if(l&&(e.recordEdgeAction("add",d,u,l.color,l.weight),o)){const m=e.getRecordedEdges().length;o.textContent=`Recording... (${m} edges)`}}),s.updateMovieStatus("Recording edge additions...")}stopEdgeRecording(){const e=this.container.get("movie"),t=this.container.get("modeFactory"),s=this.container.get("ui"),i=e.stopRecordingEdges(),n=document.getElementById("startRecordingEdgesBtn"),o=document.getElementById("stopRecordingEdgesBtn"),r=document.getElementById("recordingIndicator");n&&(n.disabled=!1),o&&(o.disabled=!0),r&&(r.textContent=i>0?`Ready (${i} edges recorded)`:"Not recording",r.style.color=i>0?"green":"black");const c=t.getMode("edge");c&&c.setRecordingCallback&&c.setRecordingCallback(void 0),s.updateMovieStatus(`Recording stopped. ${i} edges recorded.`)}async createEdgeAdditionMovie(){const e=this.container.get("movie"),t=this.container.get("canvas"),s=this.container.get("settings"),i=this.container.get("app"),n=this.container.get("graph"),o=this.container.get("ui");if(e.getRecordedEdges().length===0){alert("No edges recorded! Use 'Start Recording Edges' first.");return}e.getMovieMaker()||e.initialize();const c=o.getInputValueAsNumber("edgeAnimationDuration")||1e3,d=30;await t.withScaledCanvas(async()=>{e.initialize();try{await e.createEdgeAdditionMovie(c,d)}catch(u){alert(u)}},s.imageScaleFactor,i,n,s)}async createSimulationMovie(){const e=this.container.get("movie"),t=this.container.get("canvas"),s=this.container.get("settings"),i=this.container.get("app"),n=this.container.get("graph"),o=this.container.get("ui");e.getMovieMaker()||e.initialize();const r=o.getInputValue("simulationType")||"force_balance",c=o.getInputValueAsNumber("simulationStepCount")||10,d=o.getInputValueAsNumber("simulationStepDuration")||300,u=o.getInputChecked("adaptiveStepDuration");await t.withScaledCanvas(async()=>{e.initialize();try{await e.createSimulationMovie(r,c,d,u)}catch(g){alert(g)}},s.imageScaleFactor,i,n,s)}}class rt{constructor(e){a(this,"container");this.container=e}attachEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){const t=this.container.get("actionManager"),s=this.container.get("modeFactory"),i=this.container.get("ClearSelectionAction"),n=this.container.get("SelectAllNodesAction"),o=this.container.get("InvertSelectionAction"),r=this.container.get("DeleteNodesAction"),c=this.container.get("selection"),d=this.container.get("Node");if(e.ctrlKey||e.metaKey){if(e.key==="z"&&!e.shiftKey){e.preventDefault(),t.undo();return}if(e.key==="z"&&e.shiftKey||e.key==="y"){e.preventDefault(),t.redo();return}if(e.key==="s"){e.preventDefault();return}return}if(!e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey)switch(e.key){case"a":t.addAction(new n);break;case"c":case"Escape":t.addAction(new i);break;case"i":t.addAction(new o);break;case"Backspace":case"Delete":t.addAction(new r(c.getItemsOfClass(d)));break;case"v":s.setCurrentMode("vertex"),this.updateModeUI("vertex");break;case"e":s.setCurrentMode("edge"),this.updateModeUI("edge");break;case"s":s.setCurrentMode("select"),this.updateModeUI("select");break;case"d":s.setCurrentMode("delete_vertex"),this.updateModeUI("delete_vertex");break;case"l":s.setCurrentMode("delete_edge"),this.updateModeUI("delete_edge");break;case"h":s.setCurrentMode("select_chains"),this.updateModeUI("select_chains");break;case"r":s.setCurrentMode("random_walk"),this.updateModeUI("random_walk");break}}updateModeUI(e){const t=document.getElementById("modeSwitch");t&&(t.value=e)}detachEventListeners(){document.removeEventListener("keydown",this.handleKeyDown.bind(this))}}class ct{constructor(e,t){a(this,"name","vertex");this.nodeCounter=e,this.uiFacade=t}onCanvasClick(e,t){t.addAction(new Ee(this.nodeCounter.value,e,this.uiFacade)),this.nodeCounter.value+=1}onEnter(){console.log("Entered vertex mode")}}class dt{constructor(e,t,s,i){a(this,"name","edge");this.graph=e,this.selection=t,this.uiFacade=s,this.recordingCallback=i}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);s!==null&&(this.selection.empty?t.addAction(new J([s])):(this.recordingCallback&&this.selection.getItemsOfClass(N).forEach(n=>{this.recordingCallback(n,s)}),t.addAction(new be(s,this.selection.getItemsOfClass(N),this.uiFacade))))}setRecordingCallback(e){this.recordingCallback=e}}class Ne{constructor(e=null,t=100,s=100,i=2,n="#000",o=null){a(this,"topLeft");a(this,"width");a(this,"height");a(this,"strokeColor");a(this,"lineWidth");a(this,"fillColor");this.topLeft=e||new E(0,0),this.width=t,this.height=s,this.strokeColor=n,this.lineWidth=i,this.fillColor=o}draw(e){e.beginPath(),e.rect(this.topLeft.x,this.topLeft.y,this.width,this.height),this.fillColor?e.fillStyle=this.fillColor:e.fillStyle="transparent",e.fill(),e.lineWidth=this.lineWidth,this.strokeColor&&(e.strokeStyle=this.strokeColor,e.stroke())}}class ht{constructor(e,t,s){a(this,"name","select");a(this,"isRectangleSelecting",!1);a(this,"rectangleStart",null);a(this,"selectionRectangle",null);this.graph=e,this.selection=t,this.container=s}onCanvasClick(e,t){const s=this.graph.findNodesByCoordinates(e.x,e.y);s.length&&(this.selection.hasItems(s)?t.addAction(new st(s)):t.addAction(new J(s)))}onMouseDown(e){const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY);if(this.graph.findNodeByCoordinates(s.x,s.y)){this.isRectangleSelecting=!1;return}this.isRectangleSelecting=!0,this.rectangleStart=s,this.selectionRectangle=new Ne(s,0,0,2,"#0066cc","rgba(0, 102, 204, 0.1)"),t.getContext().setLineDash([5,5])}onMouseMove(e){if(!this.isRectangleSelecting||!this.rectangleStart||!this.selectionRectangle)return;const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY),i=s.x-this.rectangleStart.x,n=s.y-this.rectangleStart.y;this.selectionRectangle.topLeft=new E(i>=0?this.rectangleStart.x:s.x,n>=0?this.rectangleStart.y:s.y),this.selectionRectangle.width=Math.abs(i),this.selectionRectangle.height=Math.abs(n),this.container.get("app").render();const r=t.getContext();r.setLineDash([5,5]),this.selectionRectangle.draw(r),r.setLineDash([])}onMouseUp(e){if(!this.isRectangleSelecting||!this.rectangleStart||!this.selectionRectangle)return;const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY),i=this.container.get("actionManager"),n=Math.min(this.rectangleStart.x,s.x),o=Math.max(this.rectangleStart.x,s.x),r=Math.min(this.rectangleStart.y,s.y),c=Math.max(this.rectangleStart.y,s.y),d=this.graph.getAllNodes().filter(l=>l.coordinates.x>=n&&l.coordinates.x<=o&&l.coordinates.y>=r&&l.coordinates.y<=c);d.length>0&&i.addAction(new J(d)),this.isRectangleSelecting=!1,this.rectangleStart=null,this.selectionRectangle=null,t.getContext().setLineDash([]),this.container.get("app").render()}onExit(){this.isRectangleSelecting=!1,this.rectangleStart=null,this.selectionRectangle=null}}class lt{constructor(e){a(this,"name","select_chains");this.graph=e}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);if(s!==null){const i=this.graph.deepConnectedTo(s);t.addAction(new J(i,!0))}}}class gt{constructor(e){a(this,"name","delete_vertex");this.graph=e}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);s!==null&&t.addAction(new Ce([s]))}}class ut{constructor(e,t,s){a(this,"name","delete_edge");this.graph=e,this.selection=t,this.recordingCallback=s}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);s!==null&&!this.selection.empty||this.selection.length>1?(this.recordingCallback&&s!==null&&!this.selection.empty&&this.graph.getEdgesInvolvingNodes([...this.selection.getItemsOfClass(N).map(n=>n.id),s.id]).forEach(n=>{const o=this.graph.getNode(n.fromId),r=this.graph.getNode(n.toId);this.recordingCallback(o,r,!0)}),t.addAction(new nt(this.selection.getItemsOfClass(N),s))):s&&t.addAction(new J([s]))}setRecordingCallback(e){this.recordingCallback=e}}class mt{constructor(e,t,s){a(this,"name","random_walk");this.nodeCounter=e,this.doRandomWalk=t,this.uiFacade=s}onCanvasClick(e,t){const s=this.doRandomWalk(e);t.addAction(new tt(s.nodes)),t.addAction(new it(s.edges.map(i=>i.fromId),s.edges.map(i=>i.toId),this.uiFacade)),this.nodeCounter.value+=s.nodes.length+1}}class ft{constructor(e,t,s,i,n){a(this,"modes",new Map);a(this,"currentMode",null);const o=n.get("ui");this.modes.set("vertex",new ct(e,o)),this.modes.set("edge",new dt(t,s,o)),this.modes.set("select",new ht(t,s,n)),this.modes.set("select_chains",new lt(t)),this.modes.set("delete_vertex",new gt(t)),this.modes.set("delete_edge",new ut(t,s)),this.modes.set("random_walk",new mt(e,i,o)),this.setCurrentMode("vertex")}getMode(e){return this.modes.get(e)||null}setCurrentMode(e){const t=this.modes.get(e);return t?(this.currentMode&&this.currentMode.onExit&&this.currentMode.onExit(),this.currentMode=t,this.currentMode.onEnter&&this.currentMode.onEnter(),!0):(console.warn(`Mode '${e}' not found`),!1)}getCurrentMode(){return this.currentMode}getAvailableModes(){return Array.from(this.modes.keys())}getModeInstance(e){return this.modes.get(e)||null}}function pe(){const h=document.getElementById("canvas"),e=h.getContext("2d");if(!h||!e){console.error("Failed to initialize canvas");return}const t=W.instance,s=ce.getInstance(),i={value:0},n=new Pe(h,e,t),o=new Le,r=new We(h,s),c=new Ke(s),d=new je(s);s.register("canvas",n),s.register("ui",o),s.register("movie",r),s.register("graphOperations",c),s.register("fileService",d),s.register("settings",t),s.register("graph",p),s.register("selection",x),s.register("Node",N),s.register("nodeCounter",i),s.register("StorageService",Z),s.register("Circle",ve),s.register("Rectangle",Ne),s.register("PartialLine",ne),s.register("simulations",{doForceBalanceStep:$e,doPositionEquilibrationStep:Ve}),s.register("ClearSelectionAction",Ie),s.register("SelectAllNodesAction",xe),s.register("InvertSelectionAction",Me),s.register("DeleteNodesAction",Ce),s.register("AddNodeAction",Ee),s.register("AddEdgeAction",be);const u=new ke(s);s.register("app",u);const g=new He(()=>u.render());s.register("actionManager",g);const l=new ft(i,p,x,Xe,s);s.register("modeFactory",l),l.setCurrentMode("vertex");const m=new ot(s),f=new at(s),v=new rt(s);if(u.initialize(),m.attachEventListeners(),f.attachEventListeners(),v.attachEventListeners(),Z.loadState(p,t)){if(n.resize(t.canvasSize.x,t.canvasSize.y),o.updateCanvasSizeUI(t.canvasSize.x,t.canvasSize.y),p.getNrOfNodes()>0){const C=p.getAllNodeIds();i.value=Math.max(...C)+1}console.log("Loaded previous state from localStorage")}else o.updateCanvasSizeUI(t.canvasSize.x,t.canvasSize.y),p.clear(),x.clearSelection();u.render(),window.addEventListener("beforeunload",()=>{Z.saveState(p,t)}),setInterval(()=>{Z.saveState(p,t)},3e4),console.log("Application initialized successfully")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pe):pe();
