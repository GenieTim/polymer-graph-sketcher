var Pt=Object.defineProperty;var pt=h=>{throw TypeError(h)};var Lt=(h,t,e)=>t in h?Pt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var a=(h,t,e)=>Lt(h,typeof t!="symbol"?t+"":t,e),vt=(h,t,e)=>t.has(h)||pt("Cannot "+e);var ot=(h,t,e)=>(vt(h,t,"read from private field"),e?e.call(h):t.get(h)),wt=(h,t,e)=>t.has(h)?pt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,e),dt=(h,t,e,s)=>(vt(h,t,"write to private field"),s?s.call(h,e):t.set(h,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();const K=class K{constructor(){a(this,"services",new Map)}static getInstance(){return K.instance||(K.instance=new K),K.instance}register(t,e){this.services.set(t,e)}get(t){const e=this.services.get(t);if(!e)throw new Error(`Service '${t}' not found in container`);return e}has(t){return this.services.has(t)}clear(){this.services.clear()}};a(K,"instance");let ht=K;class Bt{constructor(){a(this,"observers",[])}subscribe(t){return this.observers.push(t),()=>{const e=this.observers.indexOf(t);e>-1&&this.observers.splice(e,1)}}notify(t){this.observers.forEach(e=>e(t))}get observerCount(){return this.observers.length}clearObservers(){this.observers=[]}}class yt extends Bt{constructor(e){super();a(this,"_value");this._value=e}get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this.notify(e))}forceUpdate(){this.notify(this._value)}}class E{constructor(t,e){a(this,"x");a(this,"y");this.x=t,this.y=e}}class mt{constructor(t=null,e=1,s=1,o="#000",i="#000"){a(this,"center");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");this.center=t||new E(0,0),this.radius=e,this.strokeWidth=s,this.fillColor=o,this.strokeColor=i}setCenter(t){this.center=t}setRadius(t){this.radius=t}draw(t){t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI),this.fillColor&&(t.fillStyle=this.fillColor,t.fill()),t.strokeStyle=this.strokeColor,t.lineWidth=this.strokeWidth,t.stroke()}}var Z;const D=class D{constructor(t=new E(825,445),e="#FFFFFF",s=10){a(this,"isScaled",!1);a(this,"canvasSize");a(this,"backgroundColor");a(this,"imageScaleFactor");a(this,"disablePBC",!1);this.canvasSize=t,this.backgroundColor=e,this.imageScaleFactor=s}static get instance(){return ot(D,Z)||dt(D,Z,new D),ot(D,Z)}static fromJSON(t){return dt(D,Z,new D(new E(t.canvasSize.x,t.canvasSize.y),t.backgroundColor,t.imageScaleFactor)),"disablePBC"in t&&(ot(D,Z).disablePBC=t.disablePBC),ot(D,Z)}};Z=new WeakMap,wt(D,Z);let O=D;class rt{constructor(t,e,s=!1,o="#000",i=2,n=6,r=4,c=2){a(this,"from");a(this,"to");a(this,"dashed");a(this,"zigZagged");a(this,"color");a(this,"lineWidth");a(this,"zigzagSpacing");a(this,"oneZigZagLength");a(this,"straightLengthWhenZigZag");a(this,"lineRadians");a(this,"lineLength");this.from=t,this.to=e,this.dashed=!1,this.zigZagged=s,this.color=o,this.lineWidth=i,this.zigzagSpacing=n,this.oneZigZagLength=r,this.straightLengthWhenZigZag=c,this.lineRadians=Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x);const d=this.from.x-this.to.x,l=this.from.y-this.to.y;this.lineLength=Math.sqrt(d*d+l*l)}setFrom(t){this.from=t}setTo(t){this.to=t}getFrom(){return this.from}getTo(){return this.to}draw(t){const e=O.instance;var s=this.to.x-this.from.x,o=this.to.y-this.from.y;const i=Math.abs(o)>.5001*e.canvasSize.y,n=Math.abs(s)>.5001*e.canvasSize.x;if((i||n)&&!e.disablePBC){[new rt(new E(this.from.x,this.from.y),new E(this.to.x+e.canvasSize.x*(n?s<0?1:-1:0),this.to.y+e.canvasSize.y*(i?o<0?1:-1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new rt(new E(this.to.x,this.to.y),new E(this.from.x+e.canvasSize.x*(n?s<0?-1:1:0),this.from.y+e.canvasSize.y*(i?o<0?-1:1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(r=>r.draw(t));return}this.dashed&&t.setLineDash([4,2]),t.lineCap="round",t.lineWidth=this.lineWidth,t.strokeStyle=this.color,this.zigZagged?this.drawZigZagged(t):(t.beginPath(),t.moveTo(this.from.x,this.from.y),t.lineTo(this.to.x,this.to.y)),t.stroke()}drawZigZagged(t){t.save(),t.beginPath(),t.translate(this.from.x,this.from.y),t.rotate(this.lineRadians),t.moveTo(0,0),t.lineTo(this.straightLengthWhenZigZag,0);let e=this.straightLengthWhenZigZag;for(let s=0;e<this.lineLength-this.straightLengthWhenZigZag;s++){e=(s+1)*this.zigzagSpacing;const o=s%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(e,o)}t.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),t.lineTo(this.lineLength,0),t.restore()}setDashed(t){this.dashed=t}setZigZagged(t){this.zigZagged=t}}class Y extends rt{constructor(e,s,o=1,i=!1,n="#000",r=2,c=6,d=4,l=2){super(e,s,i,n,r,c,d,l);a(this,"progress");this.progress=Math.max(0,Math.min(1,o))}setProgress(e){this.progress=Math.max(0,Math.min(1,e))}draw(e){if(this.progress===0)return;if(this.progress===1){super.draw(e);return}const s=O.instance;var o=this.to.x-this.from.x,i=this.to.y-this.from.y;const n=Math.abs(i)>.5001*s.canvasSize.y,r=Math.abs(o)>.5001*s.canvasSize.x;if((n||r)&&!s.disablePBC){[new Y(new E(this.from.x,this.from.y),new E(this.to.x+s.canvasSize.x*(r?o<0?1:-1:0),this.to.y+s.canvasSize.y*(n?i<0?1:-1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new Y(new E(this.to.x,this.to.y),new E(this.from.x+s.canvasSize.x*(r?o<0?-1:1:0),this.from.y+s.canvasSize.y*(n?i<0?-1:1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(d=>d.draw(e));return}const c=new E(this.from.x+(this.to.x-this.from.x)*this.progress,this.from.y+(this.to.y-this.from.y)*this.progress);this.dashed&&e.setLineDash([4,2]),e.lineCap="round",e.lineWidth=this.lineWidth,e.strokeStyle=this.color,this.zigZagged?this.drawPartialZigZagged(e,c):(e.beginPath(),e.moveTo(this.from.x,this.from.y),e.lineTo(c.x,c.y),e.stroke())}drawPartialZigZagged(e,s){const o=this.lineLength*this.progress;if(e.save(),e.beginPath(),e.translate(this.from.x,this.from.y),e.rotate(this.lineRadians),e.moveTo(0,0),o<=this.straightLengthWhenZigZag)e.lineTo(o,0);else if(o>=this.lineLength-this.straightLengthWhenZigZag){e.lineTo(this.straightLengthWhenZigZag,0);let i=this.straightLengthWhenZigZag;for(let n=0;i<this.lineLength-this.straightLengthWhenZigZag;n++){i=(n+1)*this.zigzagSpacing;const r=n%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(i,r)}e.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),e.lineTo(o,0)}else{e.lineTo(this.straightLengthWhenZigZag,0);let i=this.straightLengthWhenZigZag;for(let n=0;i<o;n++){if(i=(n+1)*this.zigzagSpacing,i>=o){const c=n*this.zigzagSpacing,d=(n-1)%2==0?-this.oneZigZagLength:this.oneZigZagLength,l=n%2==0?-this.oneZigZagLength:this.oneZigZagLength,m=(o-c)/this.zigzagSpacing,f=d+(l-d)*m;e.lineTo(o,f);break}const r=n%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(i,r)}}e.stroke(),e.restore()}}class J{constructor(t,e,s="#000",o=2,i=!1,n=!0,r=0,c=5,d=5){a(this,"from");a(this,"to");a(this,"color");a(this,"lineWidth");a(this,"headAtStart");a(this,"headAtEnd");a(this,"offset");a(this,"headSize");a(this,"nodeRadiusFrom");a(this,"nodeRadiusTo");this.from=t,this.to=e,this.color=s,this.lineWidth=o,this.headAtStart=i,this.headAtEnd=n,this.offset=r,this.headSize=Math.max(8,o*3),this.nodeRadiusFrom=c,this.nodeRadiusTo=d}getAdjustedPoints(){const t=this.to.x-this.from.x,e=this.to.y-this.from.y,s=Math.sqrt(t*t+e*e);if(s===0)return{start:this.from,end:this.to};const o=t/s,i=e/s;let n=0,r=0;this.offset!==0&&(n=-i*this.offset,r=o*this.offset);const c=this.nodeRadiusFrom+(this.headAtStart?this.headSize:0),d=this.nodeRadiusTo+(this.headAtEnd?this.headSize:0),l=new E(this.from.x+o*c+n,this.from.y+i*c+r),m=new E(this.to.x-o*d+n,this.to.y-i*d+r);return{start:l,end:m}}drawArrowHead(t,e,s){const o=this.headSize,i=Math.PI/6;t.save(),t.translate(e.x,e.y),t.rotate(s),t.beginPath(),t.moveTo(0,0),t.lineTo(-o,-o*Math.tan(i)),t.lineTo(-o,o*Math.tan(i)),t.closePath(),t.fillStyle=this.color,t.fill(),t.restore()}draw(t){const e=O.instance,s=this.to.x-this.from.x,o=this.to.y-this.from.y,i=Math.abs(o)>.5001*e.canvasSize.y,n=Math.abs(s)>.5001*e.canvasSize.x;if((i||n)&&!e.disablePBC){[new J(new E(this.from.x,this.from.y),new E(this.to.x+e.canvasSize.x*(n?s<0?1:-1:0),this.to.y+e.canvasSize.y*(i?o<0?1:-1:0)),this.color,this.lineWidth,this.headAtStart,this.headAtEnd,this.offset,this.nodeRadiusFrom,this.nodeRadiusTo),new J(new E(this.to.x,this.to.y),new E(this.from.x+e.canvasSize.x*(n?s<0?-1:1:0),this.from.y+e.canvasSize.y*(i?o<0?-1:1:0)),this.color,this.lineWidth,this.headAtEnd,this.headAtStart,this.offset,this.nodeRadiusTo,this.nodeRadiusFrom)].forEach(l=>l.draw(t));return}const{start:r,end:c}=this.getAdjustedPoints(),d=Math.atan2(c.y-r.y,c.x-r.x);t.strokeStyle=this.color,t.lineWidth=this.lineWidth,t.lineCap="round",t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(c.x,c.y),t.stroke(),this.headAtEnd&&this.drawArrowHead(t,c,d),this.headAtStart&&this.drawArrowHead(t,r,d+Math.PI)}}class it{constructor(t=null,e=100,s=100,o=2,i="#000",n=null,r=!1){a(this,"topLeft");a(this,"width");a(this,"height");a(this,"strokeColor");a(this,"lineWidth");a(this,"fillColor");a(this,"dashed");this.topLeft=t||new E(0,0),this.width=e,this.height=s,this.strokeColor=i,this.lineWidth=o,this.fillColor=n,this.dashed=r}draw(t){t.save(),this.dashed&&t.setLineDash([5,5]),t.beginPath(),t.rect(this.topLeft.x,this.topLeft.y,this.width,this.height),this.fillColor?t.fillStyle=this.fillColor:t.fillStyle="transparent",t.fill(),t.lineWidth=this.lineWidth,this.strokeColor&&(t.strokeStyle=this.strokeColor,t.stroke()),t.restore()}}class B extends E{constructor(t,e){t instanceof E?(super(t.x,t.y),this.x=t.x,this.y=t.y):(super(t,e),this.x=t,this.y=e)}add(t){return new B(this.x+t.x,this.y+t.y)}subtract(t){return new B(this.x-t.x,this.y-t.y)}multiply(t){return new B(this.x*t,this.y*t)}toString(){return`(${this.x}, ${this.y})`}}class b{constructor(t,e,s=5,o=1,i="#000",n="#000"){a(this,"id");a(this,"coordinates");a(this,"radius");a(this,"strokeWidth");a(this,"fillColor");a(this,"strokeColor");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new Error("Invalid `id` parameter. It must be a non-negative integer, got `"+t+"`.");this.id=t,this.coordinates=e,this.radius=s,this.strokeWidth=o,this.fillColor=i,this.strokeColor=n}}class lt{constructor(t,e,s,o=1,i="#000"){a(this,"fromId");a(this,"toId");a(this,"weight");a(this,"color");a(this,"id");this.fromId=t,this.toId=e,this.id=s,this.weight=o,this.color=i}getOtherNodeId(t){return this.fromId===t?this.toId:this.fromId}}class gt{constructor(t,e,s,o="#000",i=2,n=!1,r=!0){a(this,"fromId");a(this,"toId");a(this,"color");a(this,"width");a(this,"id");a(this,"headAtStart");a(this,"headAtEnd");this.fromId=t,this.toId=e,this.id=s,this.color=o,this.width=i,this.headAtStart=n,this.headAtEnd=r}getOtherNodeId(t){return this.fromId===t?this.toId:this.fromId}connectsSameNodes(t){return this.fromId===t.fromId&&this.toId===t.toId||this.fromId===t.toId&&this.toId===t.fromId}}class ut{constructor(){a(this,"nodes");a(this,"edges");a(this,"arrows");a(this,"scalingFactor");a(this,"zigzagSpacing",4);a(this,"zigzagLength",3);a(this,"zigzagEndLengths",1.5);a(this,"maxNodeId",0);this.nodes={},this.edges=[],this.arrows=[],this.scalingFactor=new E(1,1)}clear(){this.nodes={},this.edges=[],this.arrows=[]}setNode(t){this.nodes[t.id]=t,this.maxNodeId=Math.max(this.maxNodeId,t.id)}addEdge(t,e,s="#000",o=1){if(!(t in this.nodes)||!(e in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.edges.push(new lt(t,e,this.edges.length,o,s)),this.edges.length-1}getNode(t){if(!(t in this.nodes))throw new Error(`Node with id "${t}" does not exist.`);return this.nodes[t]}getNrOfNodes(){return Object.keys(this.nodes).length}getNrOfEdges(){return this.edges.length}getAllNodeIds(){return Object.values(this.nodes).map(t=>t.id)}getNextNodeId(){return this.maxNodeId+1}getAllNodes(){return Object.values(this.nodes)}getAllEdges(){return this.edges}getAllArrows(){return this.arrows}getNrOfArrows(){return this.arrows.length}addArrow(t,e,s="#000",o=2,i=!1,n=!0){if(!(t in this.nodes)||!(e in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.arrows.push(new gt(t,e,this.arrows.length,s,o,i,n)),this.arrows.length-1}getArrowsInvolvingNode(t){return this.arrows.filter(e=>e.fromId===t||e.toId===t)}getArrowsInvolvingNodes(t){return this.arrows.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}getArrowsWithBothEndsInNodes(t){return this.arrows.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}deleteArrow(t){if(t instanceof gt&&(t=this.arrows.indexOf(t)),t<0||t>=this.arrows.length)throw new Error("Invalid arrow ID "+t+". Arrow ID must be between 0 and "+(this.arrows.length-1)+".");const e=this.arrows[t];return this.arrows.splice(t,1),e}hasEdgeBetween(t,e){return this.edges.some(s=>s.fromId===t&&s.toId===e||s.fromId===e&&s.toId===t)}getNodesConnectedToNode(t){return this.getEdgesInvolvingNode(t).map(e=>this.nodes[e.fromId===t?e.toId:e.fromId])}deepConnectedTo(t){const e=new Set,s=[],o=[t.id];for(;o.length>0;){const i=o.shift();if(e.has(i))continue;e.add(i),s.push(this.getNode(i));const n=this.getEdgesInvolvingNode(i).map(r=>r.getOtherNodeId(i)).filter(r=>!e.has(r));o.push(...n)}return s}getEdgesInvolvingNode(t){return this.edges.filter(e=>e.fromId===t||e.toId===t)}getEdgesInvolvingNodes(t){return this.edges.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}cleanupEdges(){this.edges=this.edges.filter(t=>t.fromId!==t.toId),this.arrows=this.arrows.filter(t=>t.fromId!==t.toId)}removeDuplicateEdges(){const t=new Set;this.edges=this.edges.filter(e=>{const s=`${Math.min(e.fromId,e.toId)}-${Math.max(e.fromId,e.toId)}`;return t.has(s)?!1:(t.add(s),!0)})}getEdgesWithBothEndsInNodes(t){return this.edges.filter(e=>t.includes(e.fromId)&&t.includes(e.toId))}fromJSON(t){this.nodes={},this.edges=[],this.arrows=[];for(const[,e]of Object.entries(t.nodes))this.setNode(new b(e.id,e.coordinates,e.radius,e.strokeWidth,e.fillColor,e.strokeColor));for(const e of t.edges)this.addEdge(e.fromId,e.toId,e.color,e.weight);if(t.arrows)for(const e of t.arrows)this.addArrow(e.fromId,e.toId,e.color,e.width,e.headAtStart,e.headAtEnd);"scalingFactor"in t&&(this.scalingFactor=new E(t.scalingFactor.x,t.scalingFactor.y)),"zigzagSpacing"in t&&(this.zigzagSpacing=t.zigzagSpacing),"zigzagLength"in t&&(this.zigzagLength=t.zigzagLength),this.cleanupEdges()}toDrawables(){const t=[],e=Math.max(this.scalingFactor.x,this.scalingFactor.y);for(const s of this.edges){const o=this.getNode(s.fromId),i=this.getNode(s.toId);if(o&&i){const n=new E(o.coordinates.x*this.scalingFactor.x,o.coordinates.y*this.scalingFactor.y),r=new E(i.coordinates.x*this.scalingFactor.x,i.coordinates.y*this.scalingFactor.y);t.push(new rt(n,r,!0,s.color,s.weight*e,this.zigzagSpacing*e,this.zigzagLength*e,this.zigzagEndLengths*e))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of this.arrows){const o=this.getNode(s.fromId),i=this.getNode(s.toId);if(o&&i){const n=new E(o.coordinates.x*this.scalingFactor.x,o.coordinates.y*this.scalingFactor.y),r=new E(i.coordinates.x*this.scalingFactor.x,i.coordinates.y*this.scalingFactor.y),d=this.hasEdgeBetween(s.fromId,s.toId)?10*e:0;t.push(new J(n,r,s.color,s.width*e,s.headAtStart,s.headAtEnd,d,o.radius*e,i.radius*e))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of Object.values(this.nodes)){const o=new E(s.coordinates.x*this.scalingFactor.x,s.coordinates.y*this.scalingFactor.y);t.push(new mt(o,s.radius*e,s.strokeWidth*e,s.fillColor,s.strokeColor))}return t}findNodesByCoordinates(t,e){let s=[];for(const[,o]of Object.entries(this.nodes))Math.sqrt(Math.pow(o.coordinates.x-t,2)+Math.pow(o.coordinates.y-e,2))<=5&&s.push(o);return s}findNodeByCoordinates(t,e){const s=this.findNodesByCoordinates(t,e);return s.length>0?s[0]:null}deleteNode(t){if(!this.getNode(t))throw new Error("The node does not exist in the graph.");delete this.nodes[t];for(let s=0;s<this.edges.length;s++)(this.edges[s].fromId===t||this.edges[s].toId===t)&&(this.edges.splice(s,1),s--);for(let s=0;s<this.arrows.length;s++)(this.arrows[s].fromId===t||this.arrows[s].toId===t)&&(this.arrows.splice(s,1),s--)}deleteEdge(t){if(t instanceof lt&&(t=this.edges.indexOf(t)),t<0||t>=this.edges.length)throw new Error("Invalid edge ID "+t+". Edge ID must be between 0 and "+(this.edges.length-1)+".");const e=this.edges[t];return this.edges.splice(t,1),e}}const y=new ut;class Tt{constructor(t,e){a(this,"svg");a(this,"lastElement");a(this,"currentGroup",null);a(this,"prevState",null);a(this,"currentXOffset",0);a(this,"currentYOffset",0);a(this,"currentRotationRad",0);a(this,"currentX",0);a(this,"currentY",0);a(this,"canvas");a(this,"globalAlpha",1);a(this,"globalCompositeOperation");a(this,"fillStyle");a(this,"strokeStyle");a(this,"filter");a(this,"imageSmoothingEnabled");a(this,"imageSmoothingQuality");a(this,"lineCap","butt");a(this,"lineDashOffset");a(this,"lineJoin","round");a(this,"lineWidth",0);a(this,"miterLimit");a(this,"shadowBlur");a(this,"shadowColor");a(this,"shadowOffsetX");a(this,"shadowOffsetY");a(this,"direction","ltr");a(this,"font");a(this,"fontKerning");a(this,"fontStretch","normal");a(this,"fontVariantCaps","normal");a(this,"letterSpacing");a(this,"textAlign","left");a(this,"textBaseline");a(this,"textRendering");a(this,"wordSpacing");this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",t.toString()),this.svg.setAttribute("height",e.toString()),this.lastElement=this.svg}addElement(t){this.currentGroup?this.currentGroup.appendChild(t):this.svg.appendChild(t),this.lastElement=t}pointIsOnCanvas(t){const e={width:parseFloat(this.svg.getAttribute("width")),height:parseFloat(this.svg.getAttribute("height"))};return t.x>=0&&t.x<=e.width&&t.y>=0&&t.y<=e.height}rect(t,e,s,o){const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",t.toString()),i.setAttribute("y",e.toString()),i.setAttribute("width",s.toString()),i.setAttribute("height",o.toString()),this.addElement(i)}clearRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style","background-color: white; fill: white;")}fillRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!0,!1)+";stroke:none;")}strokeRect(t,e,s,o){this.rect(t,e,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!1,!0)+";fill:none;")}arc(t,e,s,o,i){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx",t.toString()),n.setAttribute("cy",e.toString()),n.setAttribute("r",s.toString()),n.setAttribute("style",this.stylesToCSS(!0,!0)),this.addElement(n)}moveTo(t,e){this.currentX=t,this.currentY=e}rotate(t){this.currentRotationRad+=t}translate(t,e){this.currentXOffset+=t,this.currentYOffset+=e}lineTo(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg","line"),o=Math.cos(this.currentRotationRad)*this.currentX-Math.sin(this.currentRotationRad)*this.currentY,i=Math.sin(this.currentRotationRad)*this.currentX+Math.cos(this.currentRotationRad)*this.currentY,n=Math.cos(this.currentRotationRad)*t-Math.sin(this.currentRotationRad)*e,r=Math.sin(this.currentRotationRad)*t+Math.cos(this.currentRotationRad)*e,c=new E(o+this.currentXOffset,i+this.currentYOffset),d=new E(n+this.currentXOffset,r+this.currentYOffset);s.setAttribute("x1",c.x.toString()),s.setAttribute("y1",c.y.toString()),s.setAttribute("x2",d.x.toString()),s.setAttribute("y2",d.y.toString()),s.setAttribute("style",this.stylesToCSS(!1,!0)),this.lineCap&&s.setAttribute("stroke-linecap",this.lineCap),(this.pointIsOnCanvas(c)||this.pointIsOnCanvas(d)||c.x<=0&&d.x>=parseFloat(this.svg.getAttribute("width"))||c.y<=0&&d.y>=parseFloat(this.svg.getAttribute("height")))&&this.addElement(s),this.currentX=t,this.currentY=e}stroke(){this.addStyles(this.stylesToCSS(!1,!0))}fill(t,e){if(t||e)throw new Error("Method not implemented.");this.addStyles(this.stylesToCSS(!0,!1))}addStyles(t){if(this.lastElement){const e=this.lastElement.getAttribute("style"),s=this.parseStyles(t);if(e){const o=this.parseStyles(e);for(const[i,n]of Object.entries(o))s[i]||(s[i]=n)}this.lastElement.setAttribute("style",this.styleMapToString(s));for(const[o,i]of Object.entries(s))this.lastElement.setAttribute(o,i)}}parseStyles(t){const e={};return t.split(";").forEach(o=>{const[i,n]=o.trim().split(":");e[i.trim()]=n.trim()}),e}styleMapToString(t){return Object.entries(t).map(([e,s])=>`${e}: ${s}`).join("; ")}restore(){if(this.prevState)this.fillStyle=this.prevState.fillStyle,this.strokeStyle=this.prevState.strokeStyle,this.lineWidth=this.prevState.lineWidth,this.currentX=this.prevState.currentX,this.currentY=this.prevState.currentY,this.lastElement=this.prevState.lastElement,this.currentXOffset=this.prevState.currentXOffset,this.currentYOffset=this.prevState.currentYOffset,this.currentRotationRad=this.prevState.currentRotationRad,this.prevState=null,this.currentGroup=null;else throw new Error("No state to restore.")}save(){if(this.prevState)throw new Error("Only one state can be saved at a time.");this.prevState={fillStyle:this.fillStyle,strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,currentX:this.currentX,currentY:this.currentY,lastElement:this.lastElement,currentXOffset:this.currentXOffset,currentYOffset:this.currentYOffset,currentRotationRad:this.currentRotationRad};const t=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(t),this.lastElement=t,this.currentGroup=t}stylesToCSS(t=!0,e=!0){let s={"stroke-width":this.lineWidth.toString(),"stroke-linecap":this.lineCap||"butt"};return t&&this.fillStyle&&(s.fill=this.fillStyle.toString()),e&&this.strokeStyle&&(s.stroke=this.strokeStyle.toString()),this.styleMapToString(s)}getSVG(){return this.svg}beginPath(){}closePath(){}getContextAttributes(){throw new Error("Method not implemented.")}drawImage(t,e,s,o,i,n,r,c,d){throw new Error("Method not implemented.")}clip(t,e){throw new Error("Method not implemented.")}isPointInPath(t,e,s,o){throw new Error("Method not implemented.")}isPointInStroke(t,e,s){throw new Error("Method not implemented.")}createConicGradient(t,e,s){throw new Error("Method not implemented.")}createLinearGradient(t,e,s,o){throw new Error("Method not implemented.")}createPattern(t,e){throw new Error("Method not implemented.")}createRadialGradient(t,e,s,o,i,n){throw new Error("Method not implemented.")}createImageData(t,e,s){throw new Error("Method not implemented.")}getImageData(t,e,s,o,i){throw new Error("Method not implemented.")}putImageData(t,e,s,o,i,n,r){throw new Error("Method not implemented.")}arcTo(t,e,s,o,i){throw new Error("Method not implemented.")}scale(t,e){throw new Error("Method not implemented.")}bezierCurveTo(t,e,s,o,i,n){throw new Error("Method not implemented.")}ellipse(t,e,s,o,i,n,r,c){throw new Error("Method not implemented.")}quadraticCurveTo(t,e,s,o){throw new Error("Method not implemented.")}roundRect(t,e,s,o,i){throw new Error("Method not implemented.")}getLineDash(){throw new Error("Method not implemented.")}setLineDash(t){throw new Error("Method not implemented.")}isContextLost(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}fillText(t,e,s,o){throw new Error("Method not implemented.")}measureText(t){throw new Error("Method not implemented.")}strokeText(t,e,s,o){throw new Error("Method not implemented.")}getTransform(){throw new Error("Method not implemented.")}resetTransform(){throw new Error("Method not implemented.")}setTransform(t,e,s,o,i,n){throw new Error("Method not implemented.")}transform(t,e,s,o,i,n){throw new Error("Method not implemented.")}drawFocusIfNeeded(t,e){throw new Error("Method not implemented.")}}class Dt{constructor(t){a(this,"container");a(this,"elementsToDraw",new yt([]));a(this,"renderModeInteractive",new yt(!0));this.container=t}initialize(){const t=this.container.get("canvas"),e=this.container.get("settings");t.resize(e.canvasSize.x,e.canvasSize.y),this.render()}render(t={x:1,y:1},e=[]){const s=this.container.get("canvas"),o=this.container.get("graph"),i=this.container.get("selection"),n=this.container.get("ui"),r=s.getScalingService(),c=r.getEffectiveScaling(t),d=r.get1DScalingFactor(t),l=s.canvas;if(this.renderModeInteractive.value){const w=this.container.get("modeFactory").getCurrentMode();if(w&&w.getTemporaryDrawables){const g=w.getTemporaryDrawables();e=[...e,...g]}}const m=n.getInputValue("backgroundColor"),f=n.getInputValue("borderColor"),u=[];u.push(new it({x:0,y:0},l.width,l.height,0,"transparent",m));const p=o.toDrawables();if(e.length>0){const v=[],w=[];for(const g of p)g.constructor.name==="Circle"?w.push(g):v.push(g);u.push(...v),u.push(...e),u.push(...w)}else u.push(...p);u.push(new it({x:0,y:0},l.width,l.height,20*d,m,null)),u.push(new it({x:10*c.x,y:10*c.y},l.width-20*c.x,l.height-20*c.y,4*d,f,null)),this.renderModeInteractive.value&&!i.empty&&i.getItemsOfClass(b).forEach(v=>{u.push(new mt({x:v.coordinates.x,y:v.coordinates.y},v.radius*d*1.5,2*d,"transparent","red"))}),this.elementsToDraw.value=u,s.clear(),s.draw(u),n.updateGraphStats(o.getNrOfNodes(),o.getNrOfEdges(),o.getNrOfArrows())}destroy(){this.elementsToDraw.clearObservers(),this.renderModeInteractive.clearObservers()}}class Ot{constructor(t,e){a(this,"savedState",null);this.canvas=t,this.settings=e}getEffectiveScaling(t={x:1,y:1}){return this.settings.isScaled?{x:this.settings.imageScaleFactor,y:this.settings.imageScaleFactor}:t}get1DScalingFactor(t={x:1,y:1}){const e=this.getEffectiveScaling(t);return Math.max(e.x,e.y)}scaleForExport(t,e){if(this.savedState!==null)throw new Error("Already in scaled state. Call restoreFromScaling() first.");const s=new Map;e.getAllNodes().forEach(n=>{s.set(n.id,{x:n.coordinates.x,y:n.coordinates.y,radius:n.radius,strokeWidth:n.strokeWidth})});const o=new Map;e.getAllEdges().forEach(n=>{const r=`${n.fromId}-${n.toId}`;o.set(r,n.weight)});const i=new Map;e.getAllArrows().forEach(n=>{i.set(n.id,n.width)}),this.savedState={canvasWidth:this.canvas.width,canvasHeight:this.canvas.height,canvasSizeX:this.settings.canvasSize.x,canvasSizeY:this.settings.canvasSize.y,isScaled:this.settings.isScaled,nodeStates:s,edgeWeights:o,arrowWidths:i,zigzagSpacing:e.zigzagSpacing,zigzagLength:e.zigzagLength,zigzagEndLengths:e.zigzagEndLengths},this.canvas.width=this.canvas.width*t,this.canvas.height=this.canvas.height*t,this.settings.canvasSize.x*=t,this.settings.canvasSize.y*=t,this.settings.isScaled=!0,this.scaleGraphElements(e,t)}restoreFromScaling(t){if(this.savedState===null)throw new Error("No saved scaling state to restore.");const e=this.savedState;this.canvas.width=e.canvasWidth,this.canvas.height=e.canvasHeight,this.settings.canvasSize.x=e.canvasSizeX,this.settings.canvasSize.y=e.canvasSizeY,this.settings.isScaled=e.isScaled,t.getAllNodes().forEach(s=>{const o=e.nodeStates.get(s.id);o&&(s.coordinates.x=o.x,s.coordinates.y=o.y,s.radius=o.radius,s.strokeWidth=o.strokeWidth)}),t.getAllEdges().forEach(s=>{const o=`${s.fromId}-${s.toId}`,i=e.edgeWeights.get(o);i!==void 0&&(s.weight=i)}),t.getAllArrows().forEach(s=>{const o=e.arrowWidths.get(s.id);o!==void 0&&(s.width=o)}),t.zigzagSpacing=e.zigzagSpacing,t.zigzagLength=e.zigzagLength,t.zigzagEndLengths=e.zigzagEndLengths,this.savedState=null}isInScaledState(){return this.savedState!==null}scaleGraphElements(t,e){t.getAllNodes().forEach(s=>{s.coordinates.x*=e,s.coordinates.y*=e,s.radius*=e,s.strokeWidth*=e}),t.getAllEdges().forEach(s=>{s.weight*=e}),t.getAllArrows().forEach(s=>{s.width*=e}),t.zigzagSpacing*=e,t.zigzagLength*=e,t.zigzagEndLengths*=e}resizeCanvas(t,e,s,o){const i=this.canvas.width,n=this.canvas.height;this.canvas.width=t,this.canvas.height=e;const r=this.canvas.width/i,c=this.canvas.height/n,d=Math.min(r,c);return o.getAllNodes().forEach(l=>{l.coordinates.x*=r,l.coordinates.y*=c,s&&(l.radius*=d,l.strokeWidth*=d)}),s&&(o.getAllEdges().forEach(l=>{l.weight*=d}),o.getAllArrows().forEach(l=>{l.width*=d}),o.zigzagSpacing*=d,o.zigzagLength*=d,o.zigzagEndLengths*=d),{xScaling:r,yScaling:c}}async withScaling(t,e,s,o,i){o(),this.scaleForExport(e,s);try{const n=await Promise.resolve(t());return this.restoreFromScaling(s),i(),n}catch(n){throw this.restoreFromScaling(s),i(),n}}}class _t{constructor(t,e,s){a(this,"canvas");a(this,"ctx");a(this,"scalingService");this.canvas=t,this.ctx=e,this.scalingService=new Ot(t,s)}resize(t,e){const s=this.canvas.width,o=this.canvas.height;this.canvas.width=t,this.canvas.height=e;const i=this.canvas.width/s,n=this.canvas.height/o;return{xScaling:i,yScaling:n}}resizeWithGraphScaling(t,e,s,o){return this.scalingService.resizeCanvas(t,e,s,o)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t){this.clear(),t.forEach(e=>e.draw(this.ctx))}toDataURL(t="image/png"){return this.canvas.toDataURL(t)}getContext(){return this.ctx}getDimensions(){return{width:this.canvas.width,height:this.canvas.height}}clientToCanvasCoordinates(t,e){return new E(t-this.canvas.offsetLeft+window.scrollX,e-this.canvas.offsetTop+window.scrollY)}withScaledCanvas(t,e,s,o,i){const n=s.renderModeInteractive.value;s.renderModeInteractive.value=!1,this.scalingService.scaleForExport(e,o);try{const r=t();return r instanceof Promise?r.then(c=>(this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=n,s.render(),c)).catch(c=>{throw this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=n,s.render(),c}):(this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=n,s.render(),r)}catch(r){throw this.scalingService.restoreFromScaling(o),s.renderModeInteractive.value=n,s.render(),r}}getScalingService(){return this.scalingService}}class Wt{constructor(){a(this,"elements",new Map);this.cacheElements()}cacheElements(){["backgroundColor","borderColor","vertexRadius","vertexStrokeWidth","nodeFillColor","nodeColor","edgeColor","lineWidth","arrowColor","arrowWidth","arrowHeadAtStart","arrowHeadAtEnd","graph-stats","resizeElements","sideChainLength","sideChainProb","sideChainLengthRandomness","sideChainAngleRandomness","edgeAnimationDuration","simulationType","simulationStepCount","simulationStepDuration","adaptiveStepDuration","movieRecordingStatus","recordingEdgeCount","stopMotionFrameDuration","stopMotionIndicator","stopMotionFrameCount"].forEach(e=>{const s=document.getElementById(e);s&&this.elements.set(e,s)})}getElement(t){const e=this.elements.get(t);if(!e){const s=document.getElementById(t);return s?(this.elements.set(t,s),s):null}return e}getInputValue(t){const e=this.getElement(t);return(e==null?void 0:e.value)||""}getInputValueAsNumber(t){const e=this.getElement(t);return(e==null?void 0:e.valueAsNumber)||0}getInputChecked(t){const e=this.getElement(t);return(e==null?void 0:e.checked)||!1}setValue(t,e){const s=this.getElement(t);s&&(s.value=String(e))}updateGraphStats(t,e,s){const o=this.getElement("graph-stats");o&&(s!==void 0&&s>0?o.textContent=`Nodes: ${t}, Edges: ${e}, Arrows: ${s}`:o.textContent=`Nodes: ${t}, Edges: ${e}`)}updateCanvasSizeUI(t,e){this.setValue("canvasWidth",t),this.setValue("canvasHeight",e);const s=document.getElementById("canvas-parent");s&&(s.style.width=t+"px",s.style.height=e+"px");const o=document.getElementById("canvas-size");o&&(o.textContent=`Canvas size: ${t}x${e}`)}updateMovieRecordingStatus(t){const e=this.getElement("movieRecordingStatus");e&&(e.textContent=t)}updateMovieStatus(t){this.updateMovieRecordingStatus(t)}updateRecordingEdgeCount(t){const e=this.getElement("recordingEdgeCount");e&&(e.textContent=String(t))}updateStopMotionIndicator(t,e="black"){const s=this.getElement("stopMotionIndicator");s&&(s.textContent=t,s.style.color=e)}updateStopMotionFrameCount(t){const e=this.getElement("stopMotionFrameCount");e&&(e.textContent=String(t))}setTextContent(t,e){const s=this.getElement(t);s&&(s.textContent=e)}setVisible(t,e){const s=this.getElement(t);s&&(s.style.display=e?"":"none")}addClass(t,e){const s=this.getElement(t);s&&s.classList.add(e)}removeClass(t,e){const s=this.getElement(t);s&&s.classList.remove(e)}toggleClass(t,e){const s=this.getElement(t);s&&s.classList.toggle(e)}}class $t{constructor(t={}){a(this,"sequences",[]);a(this,"currentSequenceIndex",0);a(this,"currentFrameIndex",0);a(this,"isPlaying",!1);a(this,"isPaused",!1);a(this,"animationFrameId",null);a(this,"lastFrameTime",0);a(this,"options");a(this,"subFrameIndex",0);a(this,"animate",()=>{if(!this.isPlaying||this.isPaused)return;if(this.currentSequenceIndex>=this.sequences.length){this.stop();return}const t=this.sequences[this.currentSequenceIndex],e=t.frames[this.currentFrameIndex];if(!e){t.onComplete&&t.onComplete(),this.currentSequenceIndex++,this.currentFrameIndex=0,this.lastFrameTime=performance.now(),this.options.offlineRendering?this.animate():this.animationFrameId=requestAnimationFrame(this.animate);return}if(this.options.offlineRendering){const s=e.duration||t.defaultFrameDuration||16,o=this.options.targetFPS,i=Math.max(1,Math.round(s/1e3*o));this.subFrameIndex===0&&(e.action(),t.onFrame&&t.onFrame(this.currentFrameIndex,t.frames.length)),this.options.onFrameRendered&&this.options.onFrameRendered(),this.subFrameIndex++,this.subFrameIndex>=i&&(this.subFrameIndex=0,this.currentFrameIndex++),this.animate()}else{const s=performance.now(),o=e.duration||t.defaultFrameDuration||16;s-this.lastFrameTime>=o&&(e.action(),t.onFrame&&t.onFrame(this.currentFrameIndex,t.frames.length),this.currentFrameIndex++,this.lastFrameTime=s),this.animationFrameId=requestAnimationFrame(this.animate)}});this.options={targetFPS:t.targetFPS||60,autoPlay:t.autoPlay!==void 0?t.autoPlay:!0,offlineRendering:t.offlineRendering||!1,onFrameRendered:t.onFrameRendered}}addSequence(t){t.defaultFrameDuration||(t.defaultFrameDuration=1e3/this.options.targetFPS),this.sequences.push(t),this.options.autoPlay&&!this.isPlaying&&this.play()}clearSequences(){this.stop(),this.sequences=[],this.currentSequenceIndex=0,this.currentFrameIndex=0}play(){this.isPlaying&&!this.isPaused||(this.isPlaying=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}pause(){this.isPaused=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.isPaused&&(this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}stop(){this.isPlaying=!1,this.isPaused=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentSequenceIndex=0,this.currentFrameIndex=0}getIsPlaying(){return this.isPlaying&&!this.isPaused}getIsPaused(){return this.isPaused}getProgress(){const t=this.sequences[this.currentSequenceIndex];return{sequence:this.currentSequenceIndex,frame:this.currentFrameIndex,total:(t==null?void 0:t.frames.length)||0}}}class Zt{static fromActions(t,e,s=100,o){return{name:t,frames:e.map(i=>({action:i})),defaultFrameDuration:s,onComplete:o}}static repeat(t,e,s,o=100,i){return{name:t,frames:Array(s).fill(null).map(()=>({action:e})),defaultFrameDuration:o,onComplete:i}}static withTiming(t,e,s){return{name:t,frames:e,onComplete:s}}static interpolate(t,e,s,o=1e3,i){const n=o/e,r=[];for(let c=0;c<=e;c++){const d=c/e;r.push({action:()=>s(d),duration:n})}return{name:t,frames:r,onComplete:i}}}class Yt{constructor(t,e={}){a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);a(this,"isRecording",!1);a(this,"canvas");a(this,"options");this.canvas=t,this.options={fps:e.fps||60,videoBitsPerSecond:e.videoBitsPerSecond||25e5,mimeType:e.mimeType||"video/webm;codecs=vp9"}}start(){if(this.isRecording){console.warn("Recording already in progress");return}this.recordedChunks=[],this.stream=this.canvas.captureStream(0);let t=this.options.mimeType;MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, trying vp8`),t="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(t)||(console.warn(`${t} not supported, using default`),t="video/webm")),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:t,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started")}stop(){return new Promise((t,e)=>{if(!this.isRecording||!this.mediaRecorder){e(new Error("No recording in progress"));return}this.mediaRecorder.onstop=()=>{const s=new Blob(this.recordedChunks,{type:"video/webm"});this.isRecording=!1,this.stream&&this.stream.getTracks().forEach(o=>o.stop()),console.log("Recording stopped, blob size:",s.size),t(s)},this.mediaRecorder.stop()})}requestFrame(){if(this.stream){const t=this.stream.getVideoTracks()[0];t&&"requestFrame"in t&&t.requestFrame()}}getIsRecording(){return this.isRecording}async download(t="polymer-graph-animation.webm"){if(this.isRecording){const e=await this.stop();this.downloadBlob(e,t)}else if(this.recordedChunks.length>0){const e=new Blob(this.recordedChunks,{type:"video/webm"});this.downloadBlob(e,t)}else throw new Error("No recording available to download")}downloadBlob(t,e){const s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},500)}}class Xt{constructor(t){a(this,"recorder");a(this,"animator");a(this,"isRecordingMovie",!1);var e;this.recorder=new Yt(t.canvas,t.recorderOptions),this.animator=new $t({targetFPS:((e=t.animatorOptions)==null?void 0:e.targetFPS)||60,autoPlay:!1,offlineRendering:!1,onFrameRendered:()=>this.recorder.requestFrame()})}async startRecording(){if(this.isRecordingMovie)throw new Error("Already recording a movie");this.isRecordingMovie=!0,this.animator.options.offlineRendering=!0,this.recorder.start()}async stopAndDownload(t){if(!this.isRecordingMovie)throw new Error("Not currently recording");this.animator.getIsPlaying()&&this.animator.stop(),this.animator.options.offlineRendering=!1,await this.recorder.download(t),this.isRecordingMovie=!1}addSequence(t){this.animator.addSequence(t)}clearSequences(){this.animator.clearSequences()}play(){this.animator.play()}pause(){this.animator.pause()}resume(){this.animator.resume()}stop(){this.animator.stop()}async recordMovie(t,e){return new Promise((s,o)=>{this.clearSequences(),t.forEach(i=>this.addSequence(i)),this.addSequence({name:"completion",frames:[{action:()=>{setTimeout(async()=>{try{await this.stopAndDownload(e),s()}catch(i){o(i)}},500)}}],defaultFrameDuration:100}),this.startRecording().then(()=>{this.play()}).catch(o)})}getIsRecording(){return this.isRecordingMovie}getIsPlaying(){return this.animator.getIsPlaying()}getProgress(){return this.animator.getProgress()}static get AnimationBuilder(){return Zt}}class It{constructor(t){a(this,"options");a(this,"canvas",null);a(this,"ctx",null);a(this,"mediaRecorder",null);a(this,"recordedChunks",[]);a(this,"stream",null);this.options={width:t.width,height:t.height,fps:t.fps||30,videoBitsPerSecond:t.videoBitsPerSecond||5e6,mimeType:t.mimeType||"video/webm;codecs=vp9"}}init(){if(this.canvas)return;if(this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height,this.canvas.style.display="none",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!1}),!this.ctx)throw new Error("Failed to get 2D context from canvas");const t=this.canvas.captureStream(0),e=t.getVideoTracks()[0],s=e&&typeof e.requestFrame=="function";t.getTracks().forEach(n=>n.stop());const o=s?this.canvas.captureStream(0):this.canvas.captureStream(this.options.fps);this.stream=o,console.log(`VideoEncoder: Using ${s?"manual":"automatic"} frame capture at ${this.options.fps} fps`);let i=this.options.mimeType;MediaRecorder.isTypeSupported(i)||(console.warn(`${i} not supported, trying vp8`),i="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(i)||(console.warn(`${i} not supported, using default`),i="video/webm")),this.mediaRecorder=new MediaRecorder(o,{mimeType:i,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=n=>{var r;((r=n.data)==null?void 0:r.size)>0&&this.recordedChunks.push(n.data)},this.recordedChunks=[]}async encodeVideo(t,e){return this.init(),new Promise((s,o)=>{if(!this.mediaRecorder||!this.ctx||!this.stream||!this.canvas){o(new Error("Encoder not initialized"));return}const i=1e3/this.options.fps;let n=0,r=0;this.mediaRecorder.onstop=()=>{const f=new Blob(this.recordedChunks,{type:"video/webm"});console.log(`Video encoded: ${f.size} bytes, ${n} video frames from ${r} animation frames`),this.cleanup(),s(f)},this.mediaRecorder.start();const c=this.stream.getVideoTracks()[0],d=c&&typeof c.requestFrame=="function";console.log(`Starting video encoding: ${t.length} frames, ${this.options.fps} fps, requestFrame support: ${d}`);let l=0;const m=async()=>{if(r>=t.length){await new Promise(p=>setTimeout(p,500)),this.mediaRecorder.stop();return}const f=t[r];f.render(this.ctx),l+=f.durationMs;const u=Math.floor(l/i);if(u>=1){if(d){await new Promise(p=>requestAnimationFrame(()=>p(void 0)));for(let p=0;p<u;p++)c.requestFrame(),await new Promise(v=>setTimeout(v,5))}else{const p=u*i;await new Promise(v=>setTimeout(v,p))}n+=u,l-=u*i}(r%100===0||r===t.length-1)&&console.log(`Progress: ${r+1}/${t.length} animation frames â†’ ${n} video frames`),e==null||e(r+1,t.length),r++,m()};m()})}cleanup(){this.stream&&this.stream.getTracks().forEach(t=>t.stop()),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.stream=null,this.mediaRecorder=null,this.ctx=null,this.canvas=null}static createCanvasCopyRenderer(t){return e=>{e.drawImage(t,0,0)}}}function Mt(h,t){const e=new B(h.x,h.y);for(;e.x>t.x;)e.x-=t.x*2;for(;e.x<-t.x;)e.x+=t.x*2;for(;e.y>t.y;)e.y-=t.y*2;for(;e.y<-t.y;)e.y+=t.y*2;return e}function ft(h,t){const e=new E(h.x,h.y);for(;e.x<0;)e.x+=t.x;for(;e.x>t.x;)e.x-=t.x;for(;e.y<0;)e.y+=t.y;for(;e.y>t.y;)e.y-=t.y;return e}function qt(h,t,e){let s=t.x-h.x,o=t.y-h.y;return Math.abs(s)>e.x/2&&(s>0?s-=e.x:s+=e.x),Math.abs(o)>e.y/2&&(o>0?o-=e.y:o+=e.y),{dx:s,dy:o}}function Ct(h,t,e,s){const{dx:o,dy:i}=qt(h,t,s),n=new E(h.x+o*e,h.y+i*e);return ft(n,s)}function at(){return new B(O.instance.canvasSize.x,O.instance.canvasSize.y)}function xt(){return at().multiply(.5)}function Vt(h,t){const e=new Set(h.nodes.keys()),s=new Set(t.nodes.keys()),o=Array.from(e).filter(g=>s.has(g)),i=Array.from(e).filter(g=>!s.has(g)),n=Array.from(s).filter(g=>!e.has(g)),r=(g,C,M)=>`${Math.min(g,C)}-${Math.max(g,C)}-${M}`,c=new Map(h.edges.map(g=>[r(g.fromId,g.toId,g.color),g])),d=new Map(t.edges.map(g=>[r(g.fromId,g.toId,g.color),g])),l=h.edges.filter(g=>!d.has(r(g.fromId,g.toId,g.color))),m=t.edges.filter(g=>!c.has(r(g.fromId,g.toId,g.color))),f=(g,C,M)=>`${g}-${C}-${M}`,u=new Map(h.arrows.map(g=>[f(g.fromId,g.toId,g.color),g])),p=new Map(t.arrows.map(g=>[f(g.fromId,g.toId,g.color),g])),v=h.arrows.filter(g=>!p.has(f(g.fromId,g.toId,g.color))),w=t.arrows.filter(g=>!u.has(f(g.fromId,g.toId,g.color)));return{commonNodes:o,removedNodes:i,addedNodes:n,removedEdges:l,addedEdges:m,removedArrows:v,addedArrows:w}}function St(h,t){h.clear(),t.nodes.forEach((e,s)=>{h.setNode({id:s,coordinates:new E(e.x,e.y),radius:e.radius,strokeWidth:e.strokeWidth,fillColor:e.fillColor,strokeColor:e.strokeColor})}),t.edges.forEach(e=>{h.addEdge(e.fromId,e.toId,e.color,e.weight)}),t.arrows.forEach(e=>{h.addArrow(e.fromId,e.toId,e.color,e.width,e.headAtStart,e.headAtEnd)})}function Ut(h,t,e,s,o){const i=at();o.forEach(n=>{const r=t.nodes.get(n),c=e.nodes.get(n),d=h.getNode(n);if(r&&c&&d){const l=new E(r.x,r.y),m=new E(c.x,c.y),f=Ct(l,m,s,i);d.coordinates.x=f.x,d.coordinates.y=f.y,d.radius=r.radius+(c.radius-r.radius)*s,d.strokeWidth=r.strokeWidth+(c.strokeWidth-r.strokeWidth)*s,s<.5?(d.fillColor=r.fillColor,d.strokeColor=r.strokeColor):(d.fillColor=c.fillColor,d.strokeColor=c.strokeColor)}})}function Gt(h,t,e){const s=[],o=O.instance,i=o.isScaled?{x:o.imageScaleFactor,y:o.imageScaleFactor}:{x:1,y:1},n=Math.max(i.x,i.y);return t.addedEdges.forEach(r=>{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,m=d.coordinates,f=l.x*i.x,u=l.y*i.y,p=m.x*i.x,v=m.y*i.y,w=Math.max(.01,e),g=new Y({x:f,y:u},{x:p,y:v},w,!0,r.color,r.weight*n,h.zigzagSpacing*n,h.zigzagLength*n,h.zigzagEndLengths*n);s.push(g)}}),t.removedEdges.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,m=d.coordinates,f=l.x*i.x,u=l.y*i.y,p=m.x*i.x,v=m.y*i.y,w=1-e,g=new Y({x:f,y:u},{x:p,y:v},w,!0,r.color,r.weight*n,h.zigzagSpacing*n,h.zigzagLength*n,h.zigzagEndLengths*n);s.push(g)}}catch{}}),s}function Kt(h,t,e){const s=[],o=O.instance,i=o.isScaled?{x:o.imageScaleFactor,y:o.imageScaleFactor}:{x:1,y:1},n=Math.max(i.x,i.y);return t.addedArrows.forEach(r=>{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,m=d.coordinates,f=m.x-l.x,u=m.y-l.y,p=l.x+f*e,v=l.y+u*e,w=l.x*i.x,g=l.y*i.y,C=p*i.x,M=v*i.y,S=h.hasEdgeBetween(r.fromId,r.toId)?8*n:0,F=e>.9,A=new J({x:w,y:g},{x:C,y:M},r.color,r.width*n,r.headAtStart&&F,r.headAtEnd&&F,S,c.radius*n,d.radius*n);s.push(A)}}),t.removedArrows.forEach(r=>{try{const c=h.getNode(r.fromId),d=h.getNode(r.toId);if(c&&d){const l=c.coordinates,m=d.coordinates,f=1-e,u=m.x-l.x,p=m.y-l.y,v=l.x+u*f,w=l.y+p*f,g=l.x*i.x,C=l.y*i.y,M=v*i.x,x=w*i.y,F=h.hasEdgeBetween(r.fromId,r.toId)?8*n:0,A=f>.1,k=new J({x:g,y:C},{x:M,y:x},r.color,r.width*n,r.headAtStart&&A,r.headAtEnd&&A,F,c.radius*n,d.radius*n);s.push(k)}}catch{}}),s}class Ht{constructor(t){a(this,"options");a(this,"ctx");a(this,"cels",[]);a(this,"frameDuration");a(this,"isRecording",!1);a(this,"graphStateProvider",null);a(this,"renderCallback",null);this.options=t,this.frameDuration=t.frameDuration||500,this.renderCallback=t.renderCallback||null;const e=t.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context from canvas");this.ctx=e}setGraphStateProvider(t){this.graphStateProvider=t}setRenderCallback(t){this.renderCallback=t}start(){if(this.isRecording){console.warn("Stop-motion recording already in progress");return}this.cels=[],this.isRecording=!0,console.log("Stop-motion recording started")}captureFrame(t){if(!this.isRecording)throw new Error("Not currently recording. Call start() first.");const e=this.ctx.getImageData(0,0,this.options.canvas.width,this.options.canvas.height),s=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),o=this.graphStateProvider?this.graphStateProvider():this.getEmptyGraphState();this.cels.push({imageData:s,graphState:o,timestamp:Date.now(),duration:t!==void 0?t:this.frameDuration}),console.log(`Frame ${this.cels.length} captured (duration: ${t!==void 0?t:this.frameDuration}ms)`)}getEmptyGraphState(){return{nodes:new Map,edges:[],arrows:[],zigzagSpacing:4,zigzagLength:3,zigzagEndLengths:1.5}}removeLastFrame(){return this.cels.length===0?!1:(this.cels.pop(),console.log(`Last frame removed. ${this.cels.length} frames remaining`),!0)}stop(){if(!this.isRecording){console.warn("Not currently recording");return}this.isRecording=!1,console.log(`Stop-motion recording stopped. ${this.cels.length} frames captured`)}getFrameCount(){return this.cels.length}getIsRecording(){return this.isRecording}setFrameDuration(t){this.frameDuration=t}getFrameDuration(){return this.frameDuration}clear(){this.cels=[],console.log("All frames cleared")}generateInterpolatedFrames(t){const e=1e3/t,s=[];if(!this.renderCallback)throw new Error("Render callback not set. Call setRenderCallback() before using interpolation.");for(let i=0;i<this.cels.length-1;i++){const n=this.cels[i],r=this.cels[i+1],c=r.duration,d=Math.max(1,Math.round(c/e)),l=Vt(n.graphState,r.graphState);for(let m=0;m<d;m++){const f=m/d,u=p=>{const v=new ut;n.graphState.zigzagSpacing!==void 0&&(v.zigzagSpacing=n.graphState.zigzagSpacing),n.graphState.zigzagLength!==void 0&&(v.zigzagLength=n.graphState.zigzagLength),n.graphState.zigzagEndLengths!==void 0&&(v.zigzagEndLengths=n.graphState.zigzagEndLengths);const w={nodes:n.graphState.nodes,edges:n.graphState.edges.filter(x=>{const S=(I,z,R)=>`${Math.min(I,z)}-${Math.max(I,z)}-${R}`,F=S(x.fromId,x.toId,x.color),A=l.addedEdges.some(I=>S(I.fromId,I.toId,I.color)===F),k=l.removedEdges.some(I=>S(I.fromId,I.toId,I.color)===F);return!A&&!k}),arrows:n.graphState.arrows.filter(x=>{const S=(I,z,R)=>`${I}-${z}-${R}`,F=S(x.fromId,x.toId,x.color),A=l.addedArrows.some(I=>S(I.fromId,I.toId,I.color)===F),k=l.removedArrows.some(I=>S(I.fromId,I.toId,I.color)===F);return!A&&!k})};St(v,w),Ut(v,n.graphState,r.graphState,f,l.commonNodes);const g=Gt(v,l,f),C=Kt(v,l,f),M=[...g,...C];this.renderCallback(v,M),p.drawImage(this.options.canvas,0,0)};s.push({render:u,durationMs:e})}}const o=this.cels[this.cels.length-1];return s.push({render:i=>{const n=new ut;o.graphState.zigzagSpacing!==void 0&&(n.zigzagSpacing=o.graphState.zigzagSpacing),o.graphState.zigzagLength!==void 0&&(n.zigzagLength=o.graphState.zigzagLength),o.graphState.zigzagEndLengths!==void 0&&(n.zigzagEndLengths=o.graphState.zigzagEndLengths),St(n,o.graphState),this.renderCallback(n,[]),i.drawImage(this.options.canvas,0,0)},durationMs:o.duration}),s}async encode(t=!1,e){if(this.cels.length===0)throw new Error("No frames to encode. Capture some frames first.");console.log(`Encoding ${this.cels.length} frames (interpolate: ${t})`);const s=30,o=new It({width:this.options.canvas.width,height:this.options.canvas.height,fps:s,videoBitsPerSecond:5e6});let i;t?i=this.generateInterpolatedFrames(s):i=this.cels.map(r=>({render:c=>{const d=document.createElement("canvas");d.width=r.imageData.width,d.height=r.imageData.height;const l=d.getContext("2d");l&&(l.putImageData(r.imageData,0,0),c.drawImage(d,0,0))},durationMs:r.duration}));const n=await o.encodeVideo(i,e);return console.log(`Video encoded: ${n.size} bytes`),n}async download(t=!1,e="stop-motion-animation.webm"){const s=await this.encode(t),o=URL.createObjectURL(s),i=document.createElement("a");i.style.display="none",i.href=o,i.download=e,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(o)},500)}getFrames(){return this.cels}}const P=class P{static hex2lab(t){const[e,s,o]=P.hex2rgba(t);return P.rgba2lab(e,s,o,1)}static rgba2lab(t,e,s,o){const[i,n,r]=P.rgb2xyz(t,e,s);return P.xyz2lab(i,n,r)}static lab2rgba(t,e,s){const[o,i,n]=P.lab2xyz(t,e,s);return[...P.xyz2rgba(o,i,n),1]}static hex2rgba(t){const e=t.replace(/^#/,"").toUpperCase();if(!/^[0-9A-F]+$/i.test(e)||![3,4,6,8].includes(e.length))throw new Error(`Invalid HEX format: ${t}`);let o=e;[3,4].includes(e.length)&&(o=e.split("").map(l=>l+l).join(""));const i=parseInt(o,16);let n,r,c,d=1;return o.length===8?(d=(i&255)/255,n=i>>16&255,r=i>>8&255,c=i&255):(n=i>>16&255,r=i>>8&255,c=i&255),[Math.min(255,Math.max(0,n)),Math.min(255,Math.max(0,r)),Math.min(255,Math.max(0,c)),Math.min(1,Math.max(0,d))]}static rgb2xyz(t,e,s){const o=c=>c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92,[i,n,r]=[t/255,e/255,s/255].map(c=>o(c)*100);return[i*.4124564+n*.3575761+r*.1804375,i*.2126729+n*.7151522+r*.072175,i*.0193339+n*.119192+r*.9503041]}static xyz2rgba(t,e,s){const o=d=>(d=d>.0031308?1.055*Math.pow(d,.4166666666666667)-.055:12.92*d,Math.round(Math.min(255,Math.max(0,d*255)))),i=[t/100,e/100,s/100],n=i[0]*3.2404542+i[1]*-1.5371385+i[2]*-.4985314,r=i[0]*-.969266+i[1]*1.8760108+i[2]*.041556,c=i[0]*.0556434+i[1]*-.2040259+i[2]*1.0572252;return[o(n),o(r),o(c)]}static xyz2lab(t,e,s){const o=c=>c>.008856?Math.pow(c,.3333333333333333):7.787*c+.13793103448275862,i=o(t/P.REF_X),n=o(e/P.REF_Y),r=o(s/P.REF_Z);return[116*n-16,500*(i-n),200*(n-r)]}static lab2xyz(t,e,s){const o=(t+16)/116,i=e/500+o,n=o-s/200,r=c=>c>.2068966?Math.pow(c,3):(c-16/116)/7.787;return[r(i)*P.REF_X,r(o)*P.REF_Y,r(n)*P.REF_Z]}static deltaE00(t,e){const[s,o,i]=t,[n,r,c]=e,d=G=>G*180/Math.PI,l=G=>G*Math.PI/180,m=1,f=1,u=1,p=Math.sqrt(o**2+i**2),v=Math.sqrt(r**2+c**2),w=(p+v)/2,g=.5*(1-Math.sqrt(w**7/(w**7+25**7))),C=o*(1+g),M=r*(1+g),x=Math.sqrt(C**2+i**2),S=Math.sqrt(M**2+c**2),F=i===0&&C===0?0:d(Math.atan2(i,C))%360,A=c===0&&M===0?0:d(Math.atan2(c,M))%360,k=n-s,I=S-x;let z=0;x*S!==0&&(z=A-F,z>180?z-=360:z<-180&&(z+=360));const R=2*Math.sqrt(x*S)*Math.sin(l(z)/2),$=(s+n)/2,_=(x+S)/2;let L=(F+A)/2;Math.abs(F-A)>180&&(L+=180);const W=1-.17*Math.cos(l(L-30))+.24*Math.cos(l(2*L))+.32*Math.cos(l(3*L+6))-.2*Math.cos(l(4*L-63)),T=1+.015*($-50)**2/Math.sqrt(20+($-50)**2),H=1+.045*_,X=1+.015*_*W,U=30*Math.exp((-((L-275)/25))**2),Q=-(2*Math.sqrt(_**7/(_**7+25**7)))*Math.sin(l(2*U));return Math.sqrt((k/(m*T))**2+(I/(f*H))**2+(R/(u*X))**2+Q*(I/(f*H))*(R/(u*X)))}static adjustLightness(t,e,s,o,i){const[n,r,c]=P.rgba2lab(t,e,s,o),d=Math.min(100,Math.max(0,n+n*i));return[...P.lab2rgba(d,r,c)]}};a(P,"REF_X",95.047),a(P,"REF_Y",100),a(P,"REF_Z",108.883);let nt=P;class jt{constructor(t,e){a(this,"movieMaker",null);a(this,"stopMotionRecorder",null);a(this,"recordingEdges",[]);a(this,"isRecordingEdges",!1);this.canvas=t,this.container=e}initialize(){this.movieMaker=new Xt({canvas:this.canvas,recorderOptions:{fps:60,videoBitsPerSecond:5e6},animatorOptions:{targetFPS:60}})}getMovieMaker(){return this.movieMaker}startRecordingEdges(){if(this.isRecordingEdges){console.warn("Already recording edges");return}this.isRecordingEdges=!0,this.recordingEdges=[],console.log("Started recording edge additions")}stopRecordingEdges(){if(!this.isRecordingEdges)return console.warn("Not currently recording edges"),0;this.isRecordingEdges=!1;const t=this.recordingEdges.length;return console.log(`Stopped recording. ${t} edges recorded.`),t}recordEdgeAction(t,e,s,o,i){this.isRecordingEdges&&this.recordingEdges.push({type:t,fromNode:e,toNode:s,color:o,weight:i})}getRecordedEdges(){return[...this.recordingEdges]}clearRecordedEdges(){this.recordingEdges=[]}get isRecording(){return this.isRecordingEdges}get recordedEdgeCount(){return this.recordingEdges.length}async createEdgeAdditionMovie(t,e=30){if(this.recordingEdges.length===0)throw new Error("No edges recorded! Use 'Start Recording Edges' first.");const s=this.container.get("graph"),o=this.container.get("app"),i=this.container.get("ui"),n=this.container.get("settings"),r=n.isScaled?n.imageScaleFactor:1,c=new Map;this.recordingEdges.forEach(({type:u,fromNode:p,toNode:v,color:w,weight:g})=>{const C=p.id<v.id?`${p.id}-${v.id}`:`${v.id}-${p.id}`;c.set(C,{lastAction:u,fromNode:p,toNode:v,color:w,weight:g})});const d=[];c.forEach(u=>{const v=s.getEdgesInvolvingNodes([u.fromNode.id,u.toNode.id]).find(w=>w.fromId===u.fromNode.id&&w.toId===u.toNode.id||w.fromId===u.toNode.id&&w.toId===u.fromNode.id);u.lastAction==="add"?v&&s.deleteEdge(v):v||s.addEdge(u.fromNode.id,u.toNode.id,u.color,u.weight)}),o.render();const l=[];this.recordingEdges.forEach(({type:u,fromNode:p,toNode:v,color:w,weight:g},C)=>{const M=t/(e+1),x=s.getNode(p.id),S=s.getNode(v.id),F=x?x.coordinates:p.coordinates,A=S?S.coordinates:v.coordinates,k=g*r,I=new Y({x:F.x,y:F.y},{x:A.x,y:A.y},u==="add"?0:1,!0,w,k,s.zigzagSpacing,s.zigzagLength,s.zigzagEndLengths);for(let z=0;z<=e;z++){const R=z,$=z/e;l.push({action:()=>{if(u==="add")if(R<e){const L=Math.max(.01,$);I.setProgress(L),d[C]=I}else d[C]=null,s.addEdge(p.id,v.id,w,k);else if(R===0){const W=s.getEdgesInvolvingNodes([p.id,v.id]).find(T=>T.fromId===p.id&&T.toId===v.id||T.fromId===v.id&&T.toId===p.id);W&&s.deleteEdge(W),I.setProgress(1),d[C]=I}else R<e?I.setProgress(1-$):d[C]=null;const _=d.filter(L=>L!==null);o.render({x:1,y:1},_)},duration:M})}});const m=this.recordingEdges.filter(u=>u.type==="add").length,f=this.recordingEdges.filter(u=>u.type==="remove").length;i.updateMovieStatus(`Encoding edge animation (${m} additions, ${f} removals)...`);try{const u=await this.encodeVideoFrames(l,(p,v)=>{i.updateMovieStatus(`Encoding: ${p}/${v} frames (${Math.round(p/v*100)}%)`)});this.downloadBlob(u,"edge-animation.webm"),i.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>i.updateMovieStatus(""),3e3)}catch(u){throw console.error("Error creating movie:",u),new Error("Error creating movie: "+u)}finally{d.length=0}}downloadBlob(t,e){const s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o),URL.revokeObjectURL(s)},500)}async encodeVideoFrames(t,e){const s=new It({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),o=t.map(i=>({render:n=>{i.action(),n.drawImage(this.canvas,0,0)},durationMs:i.duration}));return await s.encodeVideo(o,e)}async createSimulationMovie(t,e,s,o){if(!this.movieMaker)throw new Error("Movie maker not initialized");const i=this.container.get("graph"),n=this.container.get("app"),r=this.container.get("ui"),c=this.container.get("simulations");let d,l;if(t==="force_balance")d=()=>c.doForceBalanceStep(i),l="Force Balance";else if(t==="position_equilibration")d=()=>c.doPositionEquilibrationStep(i),l="Position Equilibration";else throw new Error("Invalid simulation type");const m=new Map;i.getAllNodes().forEach(f=>{m.set(f.id,{x:f.coordinates.x,y:f.coordinates.y})});try{let f=Array(e).fill(s);if(o){const p=m;let v=p;const w=[];for(let M=0;M<e;M++){d();let x=0;i.getAllNodes().forEach(A=>{const k=v.get(A.id);if(k){const I=A.coordinates.x-k.x,z=A.coordinates.y-k.y;x+=Math.sqrt(I*I+z*z)}});const S=x/i.getAllNodes().length;w.push(S);const F=new Map;i.getAllNodes().forEach(A=>{F.set(A.id,{x:A.coordinates.x,y:A.coordinates.y})}),v=F}const g=e*s,C=w.reduce((M,x)=>M+x,0);f=w.map(M=>M>0?Math.min(g,g/C*M):s),i.getAllNodes().forEach(M=>{const x=p.get(M.id);x&&(M.coordinates.x=x.x,M.coordinates.y=x.y)})}const u=[];if(o)for(let p=0;p<e;p++){const v=f[p],w=Math.max(1,Math.ceil(v/s)),g=new Map;i.getAllNodes().forEach(S=>{g.set(S.id,{x:S.coordinates.x,y:S.coordinates.y})}),d();const C=new Map;i.getAllNodes().forEach(S=>{C.set(S.id,{x:S.coordinates.x,y:S.coordinates.y})}),i.getAllNodes().forEach(S=>{const F=g.get(S.id);F&&(S.coordinates.x=F.x,S.coordinates.y=F.y)});const M=w+1,x=v/M;for(let S=0;S<=w;S++){const F=S/w;u.push({action:()=>{const A=at();i.getAllNodes().forEach(k=>{const I=g.get(k.id),z=C.get(k.id);if(I&&z){const R=Ct(I,z,F,A);k.coordinates.x=R.x,k.coordinates.y=R.y}}),n.render()},duration:x})}i.getAllNodes().forEach(S=>{const F=C.get(S.id);F&&(S.coordinates.x=F.x,S.coordinates.y=F.y)})}else for(let p=0;p<e;p++)u.push({action:()=>{d(),n.render()},duration:s});r.updateMovieStatus(`Encoding ${l} simulation (${e} steps${o?" with adaptive duration":""})...`);try{const p=await this.encodeVideoFrames(u,(v,w)=>{r.updateMovieStatus(`Encoding: ${v}/${w} frames (${Math.round(v/w*100)}%)`)});this.downloadBlob(p,`${t}-simulation.webm`),r.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>r.updateMovieStatus(""),3e3)}catch(p){throw console.error("Error creating movie:",p),new Error("Error creating movie: "+p)}}finally{i.getAllNodes().forEach(f=>{const u=m.get(f.id);u&&(f.coordinates.x=u.x,f.coordinates.y=u.y)})}}getStopMotionRecorder(){if(!this.stopMotionRecorder){this.stopMotionRecorder=new Ht({canvas:this.canvas,frameDuration:500,scaleFactor:2});const e=this.container.get("graph"),s=this.container.get("app");this.stopMotionRecorder.setGraphStateProvider(()=>{const i=new Map;e.getAllNodes().forEach(c=>{i.set(c.id,{x:c.coordinates.x,y:c.coordinates.y,radius:c.radius,strokeWidth:c.strokeWidth,fillColor:c.fillColor,strokeColor:c.strokeColor})});const n=e.getAllEdges().map(c=>({fromId:c.fromId,toId:c.toId,color:c.color,weight:c.weight})),r=e.getAllArrows().map(c=>({fromId:c.fromId,toId:c.toId,color:c.color,width:c.width,headAtStart:c.headAtStart,headAtEnd:c.headAtEnd}));return{nodes:i,edges:n,arrows:r,zigzagSpacing:e.zigzagSpacing,zigzagLength:e.zigzagLength,zigzagEndLengths:e.zigzagEndLengths}});let o=1;this.stopMotionRecorder._setExportScaleFactor=i=>{o=i},this.stopMotionRecorder.setRenderCallback((i,n)=>{const r=this.container.get("graph");i.scalingFactor={x:o,y:o},this.container.register("graph",i);try{s.render({x:1,y:1},n||[])}finally{this.container.register("graph",r)}})}return this.stopMotionRecorder}startStopMotionRecording(){this.getStopMotionRecorder().start(),console.log("Stop-motion recording started")}captureStopMotionFrame(t){const e=this.getStopMotionRecorder();return e.captureFrame(t),e.getFrameCount()}removeLastStopMotionFrame(){const t=this.getStopMotionRecorder();return t.removeLastFrame(),t.getFrameCount()}stopStopMotionRecording(){const t=this.getStopMotionRecorder(),e=t.getFrameCount();return t.stop(),console.log(`Stop-motion recording stopped with ${e} frames`),e}getStopMotionFrameCount(){return this.getStopMotionRecorder().getFrameCount()}isStopMotionRecording(){return this.getStopMotionRecorder().getIsRecording()}setStopMotionFrameDuration(t){this.getStopMotionRecorder().setFrameDuration(t)}getStopMotionFrameDuration(){return this.getStopMotionRecorder().getFrameDuration()}clearStopMotionFrames(){this.getStopMotionRecorder().clear()}async createStopMotionMovie(t=!1,e){const s=this.getStopMotionRecorder(),o=this.container.get("ui"),i=this.container.get("canvas"),n=this.container.get("graph"),r=this.container.get("app"),c=this.container.get("settings"),d=s.getFrameCount();if(d===0)throw new Error("No frames captured! Capture some frames first.");o.updateMovieStatus(`Encoding stop-motion animation (${d} frames)...`);try{const l=c.imageScaleFactor;await i.withScaledCanvas(async()=>{r.renderModeInteractive.value=!1,s._setExportScaleFactor(l);try{const m=await s.encode(t,(u,p)=>{o.updateMovieStatus(`Encoding: ${u}/${p} frames (${Math.round(u/p*100)}%)`)}),f=e||"stop-motion-animation.webm";this.downloadBlob(m,f),o.updateMovieStatus("Stop-motion movie saved successfully!"),setTimeout(()=>o.updateMovieStatus(""),3e3)}finally{r.renderModeInteractive.value=!0,s._setExportScaleFactor(1)}},l,r,n,c)}catch(l){throw console.error("Error creating stop-motion movie:",l),o.updateMovieStatus("Error creating movie!"),l}}}class Jt{constructor(){a(this,"selectedItems",[])}toggleItems(t){t.forEach(e=>{this.hasItem(e)?this.removeItem(e):this.addItem(e)})}addItem(t){this.selectedItems.push(t)}setItem(t){this.selectedItems=[t]}hasItem(t){return this.selectedItems.includes(t)}hasItems(t){return t.every(e=>this.hasItem(e))}setSelectedItems(t){this.selectedItems=t}removeItem(t){this.selectedItems=this.selectedItems.filter(e=>e!==t)}removeLastItem(){this.selectedItems.length>0&&this.selectedItems.pop()}getSelectedItems(){return this.selectedItems}getItemsOfClass(t){return this.selectedItems.filter(e=>e instanceof t)}clearSelection(){this.selectedItems=[]}get empty(){return this.selectedItems.length===0}get length(){return this.selectedItems.length}}const N=new Jt;function Qt(h,t){const e=new B(h.coordinates.x,h.coordinates.y);return new B(t.coordinates.x,t.coordinates.y).subtract(e)}function te(){const h=at(),t=xt();N.getItemsOfClass(b).forEach(s=>{const o=y.getNodesConnectedToNode(s.id);let i=new B(0,0);o.forEach(r=>{const c=Qt(s,r),d=Mt(c,t).multiply(1/o.length);i=i.add(d)});const n=ft(new B(i.x+s.coordinates.x,i.y+s.coordinates.y),h);s.coordinates.x=n.x,s.coordinates.y=n.y})}function ee(h){const t=at(),e=document.getElementById("randomWalkStepSize").valueAsNumber,s=document.getElementById("randomWalkMaxAngle").valueAsNumber*Math.PI/180,o=document.getElementById("randomWalkSteps").valueAsNumber,i=[],n=[],r=document.getElementById("vertexRadius").valueAsNumber,c=document.getElementById("vertexStrokeWidth").valueAsNumber,d=document.getElementById("nodeFillColor").value,l=document.getElementById("nodeColor").value,m=new b(y.getNextNodeId(),h,r,c,d,l);i.push(m);let f=new E(h.x,h.y),u=Math.random()*2*Math.PI;const p=document.getElementById("edgeColor").value,v=parseFloat(document.getElementById("lineWidth").value);for(let w=0;w<o;w++){const g=(Math.random()*2-1)*s;u+=g;const C=f.x+e*Math.cos(u),M=f.y+e*Math.sin(u);f=new E(C,M),f=ft(f,t);const x=new b(y.getNextNodeId()+w+1,f,r,c,d,l);i.push(x);const S=i[i.length-2],F=new lt(S.id,x.id,-1,v,p);n.push(F)}return{nodes:i,edges:n}}function se(){const h=N.getItemsOfClass(b);if(console.log("Equilibrating "+h.length+" nodes..."),h.length<1)return;const t=xt(),e=25;for(const s of h){let o=new B(0,0);for(const n of y.getAllNodes()){if(s.id===n.id)continue;const r=new B(s.coordinates.x,s.coordinates.y);let d=new B(n.coordinates.x,n.coordinates.y).subtract(r);d=Mt(d,t);const l=Math.sqrt(d.x*d.x+d.y*d.y);if(l>0){const m=e/(l*l),f=d.multiply(-m);o=o.add(f)}}o.x>s.radius&&(o.x=s.radius),o.x<-s.radius&&(o.x=-s.radius),o.y>s.radius&&(o.y=s.radius),o.y<-s.radius&&(o.y=-s.radius);const i=new B(s.coordinates.x+o.x,s.coordinates.y+o.y);s.coordinates=i}}class q{static serialize(t,e){return{version:this.STORAGE_VERSION,timestamp:new Date().toISOString(),graph:t,settings:e}}static deserialize(t,e,s){try{return t.version&&t.version!==this.STORAGE_VERSION&&console.warn(`State version mismatch. Expected ${this.STORAGE_VERSION}, got ${t.version}`),"settings"in t?(t.graph&&e.fromJSON(t.graph),t.settings&&this.applySettings(t.settings,s)):e.fromJSON(t),!0}catch(o){return console.error("Failed to deserialize state:",o),!1}}static applySettings(t,e){t.canvasSize&&(e.canvasSize.x=t.canvasSize.x,e.canvasSize.y=t.canvasSize.y),t.backgroundColor!==void 0&&(e.backgroundColor=t.backgroundColor),t.imageScaleFactor!==void 0&&(e.imageScaleFactor=t.imageScaleFactor),t.disablePBC!==void 0&&(e.disablePBC=t.disablePBC)}static saveState(t,e){try{const s=this.serialize(t,e);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),console.log("State saved to localStorage")}catch(s){console.error("Failed to save state to localStorage:",s)}}static loadState(t,e){try{const s=localStorage.getItem(this.STORAGE_KEY);if(!s)return console.log("No saved state found in localStorage"),!1;const o=JSON.parse(s),i=this.deserialize(o,t,e);return i&&console.log(`State loaded from localStorage (saved at ${o.timestamp||"unknown time"})`),i}catch(s){return console.error("Failed to load state from localStorage:",s),!1}}static clearState(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("State cleared from localStorage")}catch(t){console.error("Failed to clear state from localStorage:",t)}}static hasSavedState(){try{return localStorage.getItem(this.STORAGE_KEY)!==null}catch(t){return console.error("Failed to check for saved state:",t),!1}}}a(q,"STORAGE_KEY","polymer-graph-sketcher-state"),a(q,"STORAGE_VERSION","1.0");function Ft(h,t){if(h===t)return;if(h>t)return Ft(t,h);y.getEdgesInvolvingNode(t).forEach(i=>{i.fromId===t?i.fromId=h:i.toId=h});const s=y.getNode(h),o=y.getNode(t);s.coordinates.x=(s.coordinates.x+o.coordinates.x)/2,s.coordinates.y=(s.coordinates.y+o.coordinates.y)/2,y.deleteNode(t)}function oe(h){let t;do{t=!1;for(const e of y.getAllEdges())if(e.color===h){Ft(e.fromId,e.toId),y.deleteEdge(e),t=!0;break}}while(t);N.clearSelection()}function ie(){const h=y.getAllNodes();for(const t of h){const e=y.getEdgesInvolvingNode(t.id);e.length===2&&e[0].color===e[1].color&&e[0].weight===e[1].weight&&(y.deleteEdge(e[0]),y.deleteEdge(e[1]),y.addEdge(e[0].fromId==t.id?e[0].toId:e[0].fromId,e[1].fromId==t.id?e[1].toId:e[1].fromId,e[0].color,e[0].weight),y.deleteNode(t.id))}}class ne{constructor(t){a(this,"container");this.container=t}generateSideChains(t,e,s,o){const i=this.container.get("selection"),n=this.container.get("graph"),r=this.container.get("actionManager"),c=this.container.get("nodeCounter"),d=this.container.get("ui");i.getItemsOfClass(b).forEach(m=>{const f=n.getEdgesInvolvingNode(m.id);if(f.length!==2)return;const u=n.getNode(f[0].getOtherNodeId(m.id)),p=n.getNode(f[1].getOtherNodeId(m.id));if(!u||!p)return;const v=p.coordinates.x-u.coordinates.x,w=p.coordinates.y-u.coordinates.y,g=Math.sqrt(v*v+w*w),C=v/g,M=w/g,x=-M,S=C,F=M,A=-C,k=Math.floor(e),I=e-k,z=k+(Math.random()<I?1:0);let R=Math.random()<.5;const $=this.container.get("AddNodeAction"),_=this.container.get("AddEdgeAction");for(let L=0;L<z;L++){R=!R;const W=R?x:F,T=R?S:A,H=Math.PI*o,X=(Math.random()*2-1)*H,U=Math.cos(X),j=Math.sin(X),Q=W*U-T*j,G=W*j+T*U,tt=m.coordinates.x+Q*t*(1-s*Math.random()),et=m.coordinates.y+G*t*(1-s*Math.random()),st=c.value++,ct=new b(st,{x:tt,y:et},m.radius,m.strokeWidth,m.fillColor,m.strokeColor);r.addAction(new $(st,{x:tt,y:et},d)),r.addAction(new _(m,[ct],d))}})}removeBifunctionalNodes(){const t=this.container.get("app");ie(),t.render()}mergeEdgesByColor(t){const e=this.container.get("app");oe(t),e.render()}removeDuplicateEdges(){const t=this.container.get("graph"),e=this.container.get("app");t.removeDuplicateEdges(),e.render()}removeSelfEdges(){const t=this.container.get("graph"),e=this.container.get("app");t.cleanupEdges(),e.render()}clearGraph(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("modeFactory"),o=this.container.get("app");t.clear(),e.clearSelection(),s.setCurrentMode("vertex"),o.render()}}class re{constructor(t){a(this,"container");this.container=t}exportGraph(){const t=this.container.get("graph"),e=this.container.get("settings"),s=q.serialize(t,e),o=new Blob([JSON.stringify(s)],{type:"application/json"}),i=URL.createObjectURL(o),n=document.createElement("a");n.href=i,n.download="graph.json",n.click(),URL.revokeObjectURL(i)}importGraph(t){const e=this.container.get("graph"),s=this.container.get("settings"),o=this.container.get("ui"),i=this.container.get("canvas"),n=this.container.get("app"),r=new FileReader;r.onload=c=>{var d;if((d=c.target)!=null&&d.result)try{const l=JSON.parse(c.target.result);if(q.deserialize(l,e,s)){i.resize(s.canvasSize.x,s.canvasSize.y),o.updateCanvasSizeUI(s.canvasSize.x,s.canvasSize.y);const f=this.container.get("nodeCounter");if(f&&e.getNrOfNodes()>0){const u=e.getAllNodeIds();f.value=Math.max(...u)+1}n.render()}else alert("Failed to import graph. The file may be corrupted or in an incompatible format.")}catch(l){console.error("Error importing graph:",l),alert("Failed to import graph. Please check the file format.")}},r.readAsText(t)}saveCanvasAsImage(t){const e=this.container.get("app"),s=this.container.get("canvas"),o=()=>{e.render();const i=s.toDataURL("image/png"),n=document.createElement("a");n.href=i,n.download="polymer-graph-sketch.png",n.click()};t?t(o):o()}saveGraphAsSvg(){const t=this.container.get("settings"),e=this.container.get("app"),s=new Tt(t.canvasSize.x,t.canvasSize.y);e.elementsToDraw.value.forEach(r=>{r.draw(s)});const o=s.getSVG(),i=new XMLSerializer().serializeToString(o),n=document.createElement("a");n.href="data:image/svg+xml;base64,"+btoa(i),n.download="graph.svg",n.click()}}class ae{constructor(t){a(this,"doneStack",[]);a(this,"undoneStack",[]);a(this,"afterActionCallback");this.afterActionCallback=t}addAction(t){this.doneStack.push(t),t.do(),this.undoneStack=[],this.afterActionCallback()}undo(){if(this.doneStack.length){const t=this.doneStack.pop();t.undo(),this.undoneStack.push(t),this.afterActionCallback()}}redo(){if(this.undoneStack.length){const t=this.undoneStack.pop();t.do(),this.doneStack.push(t),this.afterActionCallback()}}}class ce{constructor(t,e,s){a(this,"affectedNodes");a(this,"originalValues");a(this,"targetValue");a(this,"property");this.affectedNodes=t,this.originalValues=t.map(o=>o[s]),this.targetValue=e,this.property=s}do(){this.affectedNodes.forEach(t=>{t[this.property]=this.targetValue})}undo(){this.affectedNodes.forEach((t,e)=>{t[this.property]=this.originalValues[e]})}}class de{constructor(t,e,s){a(this,"affectedNodes");a(this,"originalPositions");a(this,"newPositions");this.affectedNodes=t,this.originalPositions=e.map(o=>new E(o.x,o.y)),this.newPositions=s.map(o=>new E(o.x,o.y))}do(){this.affectedNodes.forEach((t,e)=>{t.coordinates.x=this.newPositions[e].x,t.coordinates.y=this.newPositions[e].y})}undo(){this.affectedNodes.forEach((t,e)=>{t.coordinates.x=this.originalPositions[e].x,t.coordinates.y=this.originalPositions[e].y})}}class he{constructor(t){this.nodes=t}do(){this.nodes.forEach(t=>{y.setNode(new b(t.id,t.coordinates,t.radius,t.strokeWidth,t.fillColor,t.strokeColor))}),N.setSelectedItems(this.nodes.map(t=>y.getNode(t.id)))}undo(){this.nodes.forEach(t=>{y.deleteNode(t.id)})}}class Nt{constructor(t,e,s){this.nodeId=t,this.position=e,this.uiFacade=s}do(){y.setNode(new b(this.nodeId,this.position,this.uiFacade.getInputValueAsNumber("vertexRadius"),this.uiFacade.getInputValueAsNumber("vertexStrokeWidth"),this.uiFacade.getInputValue("nodeFillColor"),this.uiFacade.getInputValue("nodeColor"))),N.setItem(y.getNode(this.nodeId))}undo(){y.deleteNode(this.nodeId)}}class At{constructor(t){a(this,"affectedEdges",[]);this.affectedNodes=t}do(){this.affectedNodes.forEach(t=>{y.getEdgesInvolvingNode(t.id).forEach(e=>{this.affectedEdges.push(e)}),N.removeItem(t),y.deleteNode(t.id)})}undo(){this.affectedNodes.forEach(t=>{y.setNode(t),N.addItem(t)}),this.affectedEdges.forEach(t=>{y.addEdge(t.fromId,t.toId,t.color,t.weight)})}}class V{constructor(t,e=!1){a(this,"previousSelectedNodes",N.getSelectedItems());this.affectedNodes=t,this.clearSelection=e}do(){this.clearSelection?N.setSelectedItems(this.affectedNodes):this.affectedNodes.forEach(t=>{N.addItem(t)})}undo(){N.setSelectedItems(this.previousSelectedNodes)}}class le{constructor(t){a(this,"previousSelectedNodes",N.getSelectedItems());this.affectedNodes=t,this.affectedNodes.forEach(e=>{this.previousSelectedNodes.includes(e)||console.warn("Trying to unselect a node that is not selected")}),console.log("Unselecting nodes:",this.affectedNodes)}do(){N.setSelectedItems(this.previousSelectedNodes.filter(t=>!(t instanceof b&&this.affectedNodes.includes(t))))}undo(){N.setSelectedItems(this.previousSelectedNodes)}}class bt{constructor(t=N.getItemsOfClass(b)){this.previousSelectedNodes=t}do(){N.setSelectedItems(y.getAllNodes())}undo(){N.setSelectedItems(this.previousSelectedNodes)}}class zt{constructor(t=N.getSelectedItems()){this.previousSelectedNodes=t}do(){N.clearSelection()}undo(){N.setSelectedItems(this.previousSelectedNodes)}}class kt{constructor(t=N.getSelectedItems()){this.previousSelectedNodes=t}do(){N.toggleItems(y.getAllNodes())}undo(){N.setSelectedItems(this.previousSelectedNodes)}}class ge{constructor(t,e,s){a(this,"edgeIds",[]);if(this.edgesFrom=t,this.edgesTo=e,this.uiFacade=s,t.length!==e.length)throw new Error("edgesFrom and edgesTo must have the same length")}do(){for(let t=0;t<this.edgesFrom.length;t++)this.edgeIds.push(y.addEdge(this.edgesFrom[t],this.edgesTo[t],this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}undo(){this.edgeIds.slice().reverse().forEach(t=>{y.deleteEdge(t)})}}class Rt{constructor(t,e,s){a(this,"edgeIds",[]);this.fromNode=t,this.affectedNodes=e,this.uiFacade=s}do(){this.affectedNodes.forEach(t=>{this.edgeIds.push(y.addEdge(this.fromNode.id,t.id,this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}),this.affectedNodes.length<=1&&N.setItem(this.fromNode)}undo(){this.edgeIds.slice().reverse().forEach(t=>{y.deleteEdge(t)}),N.setSelectedItems(this.affectedNodes)}}class ue{constructor(t,e){a(this,"edges",[]);this.additionalNode=e,e&&t.push(e),this.edges=y.getEdgesInvolvingNodes(t.map(s=>s.id))}do(){this.edges.forEach(t=>{y.deleteEdge(t)}),this.additionalNode&&N.addItem(this.additionalNode)}undo(){this.edges.forEach(t=>{y.addEdge(t.fromId,t.toId,t.color,t.weight)}),this.additionalNode&&N.removeItem(this.additionalNode)}}class me{constructor(t,e,s){a(this,"arrowIds",[]);this.fromNode=t,this.affectedNodes=e,this.uiFacade=s}do(){this.affectedNodes.forEach(t=>{this.arrowIds.push(y.addArrow(this.fromNode.id,t.id,this.uiFacade.getInputValue("arrowColor"),this.uiFacade.getInputValueAsNumber("arrowWidth"),this.uiFacade.getInputChecked("arrowHeadAtStart"),this.uiFacade.getInputChecked("arrowHeadAtEnd")))}),this.affectedNodes.length<=1&&N.setItem(this.fromNode)}undo(){this.arrowIds.slice().reverse().forEach(t=>{y.deleteArrow(t)}),N.setSelectedItems(this.affectedNodes)}}class fe{constructor(t){a(this,"deletedArrows",[]);this.arrows=t}do(){this.deletedArrows=this.arrows.map(t=>({arrow:new gt(t.fromId,t.toId,t.id,t.color,t.width,t.headAtStart,t.headAtEnd),index:y.getAllArrows().indexOf(t)})),this.arrows.slice().reverse().forEach(t=>{y.deleteArrow(t)})}undo(){this.deletedArrows.sort((t,e)=>t.index-e.index).forEach(t=>{y.addArrow(t.arrow.fromId,t.arrow.toId,t.arrow.color,t.arrow.width,t.arrow.headAtStart,t.arrow.headAtEnd)})}}class pe{constructor(t){a(this,"container");a(this,"canvas");a(this,"dragStart",null);a(this,"draggedNodes",[]);a(this,"originalNodePositions",[]);a(this,"isDraggingNode",!1);this.container=t,this.canvas=t.get("canvas").canvas}attachEventListeners(){this.canvas.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("mousedown",this.handleMouseDown.bind(this)),window.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleClick(t){if(this.dragStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),i=this.container.get("modeFactory").getCurrentMode(),n=this.container.get("actionManager");i&&i.onCanvasClick(s,n)}handleMouseDown(t){this.dragStart={x:t.clientX,y:t.clientY};const s=this.container.get("modeFactory").getCurrentMode(),i=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),r=this.container.get("graph").findNodeByCoordinates(i.x,i.y);if(s&&s.onMouseDown)if(s.onMouseDown(t),r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(b),this.originalNodePositions=this.draggedNodes.map(d=>new E(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1;else if(r){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(b),this.originalNodePositions=this.draggedNodes.map(d=>new E(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1}handleMouseMove(t){const s=this.container.get("modeFactory").getCurrentMode(),o=this.container.get("app");if(s&&s.onMouseMove&&s.onMouseMove(t)&&o.render(),!!this.dragStart&&this.isDraggingNode){const i=t.clientX-this.dragStart.x,n=t.clientY-this.dragStart.y,r=this.container.get("selection"),c=O.instance;r.getItemsOfClass(b).forEach(d=>{d.coordinates.x+=i,d.coordinates.y+=n,d.coordinates.x<0&&(d.coordinates.x+=c.canvasSize.x),d.coordinates.x>=c.canvasSize.x&&(d.coordinates.x-=c.canvasSize.x),d.coordinates.y<0&&(d.coordinates.y+=c.canvasSize.y),d.coordinates.y>=c.canvasSize.y&&(d.coordinates.y-=c.canvasSize.y)}),this.dragStart={x:t.clientX,y:t.clientY},o.render();return}}handleMouseUp(t){const s=this.container.get("modeFactory").getCurrentMode();if(this.dragStart&&this.isDraggingNode&&this.draggedNodes.length>0){const o=this.draggedNodes.map(n=>new E(n.coordinates.x,n.coordinates.y));if(this.originalNodePositions.some((n,r)=>n.x!==o[r].x||n.y!==o[r].y)){const n=this.container.get("actionManager"),r=new de(this.draggedNodes,this.originalNodePositions,o);r.undo(),n.addAction(r)}}else s&&s.onMouseUp&&s.onMouseUp(t);this.dragStart=null,this.draggedNodes=[],this.originalNodePositions=[],this.isDraggingNode=!1}detachEventListeners(){this.canvas.removeEventListener("click",this.handleClick.bind(this)),window.removeEventListener("mousedown",this.handleMouseDown.bind(this)),window.removeEventListener("mousemove",this.handleMouseMove.bind(this)),window.removeEventListener("mouseup",this.handleMouseUp.bind(this))}}class ve{constructor(t){a(this,"container");this.container=t}attachListener(t,e,s){const o=document.getElementById(t);o&&o.addEventListener(e,i=>s(o,i))}attachButtonClick(t,e){this.attachListener(t,"click",e)}attachInputChange(t,e){this.attachListener(t,"change",s=>e(s))}attachEventListeners(){this.attachModeSwitch(),this.attachNodePropertyListeners(),this.attachEdgePropertyListeners(),this.attachArrowPropertyListeners(),this.attachCanvasPropertyListeners(),this.attachButtonListeners(),this.attachRedrawListeners()}attachModeSwitch(){const t=document.getElementById("modeSwitch");t&&t.addEventListener("click",()=>{this.container.get("modeFactory").setCurrentMode(t.value)})}attachNodePropertyListeners(){const t=this.container.get("actionManager"),e=this.container.get("selection"),s=(o,i)=>n=>{if(e.empty)return;const r=i(n.value);t.addAction(new ce(e.getItemsOfClass(b),r,o))};this.attachInputChange("vertexRadius",s("radius",parseFloat)),this.attachInputChange("vertexStrokeWidth",s("strokeWidth",parseFloat)),this.attachInputChange("nodeFillColor",s("fillColor",o=>o)),this.attachInputChange("nodeColor",s("strokeColor",o=>o)),this.attachInputChange("selectVerticesStroke",o=>{const i=this.container.get("graph");t.addAction(new V(i.getAllNodes().filter(n=>nt.deltaE00(nt.hex2lab(n.strokeColor),nt.hex2lab(o.value))<10),!0))})}attachEdgePropertyListeners(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("app"),o=(i,n)=>r=>{const c=e.getItemsOfClass(b).map(d=>d.id);t.getEdgesWithBothEndsInNodes(c).forEach(d=>{d[i]=n(r.value)}),s.render()};this.attachInputChange("edgeColor",o("color",i=>i)),this.attachInputChange("lineWidth",o("weight",parseFloat))}attachArrowPropertyListeners(){const t=this.container.get("graph"),e=this.container.get("selection"),s=this.container.get("app"),o=(i,n)=>r=>{const c=e.getItemsOfClass(b).map(d=>d.id);t.getArrowsWithBothEndsInNodes(c).forEach(d=>{d[i]=n(r)}),s.render()};this.attachInputChange("arrowColor",o("color",i=>i.value)),this.attachInputChange("arrowWidth",o("width",i=>parseFloat(i.value))),this.attachInputChange("arrowHeadAtStart",o("headAtStart",i=>i.checked)),this.attachInputChange("arrowHeadAtEnd",o("headAtEnd",i=>i.checked))}attachCanvasPropertyListeners(){const t=this.container.get("actionManager"),e=this.container.get("settings"),s=this.container.get("canvas"),o=this.container.get("app"),i=this.container.get("graph"),n=this.container,r=(c,d)=>{const l=c==="x"?"width":"height",m=e.canvasSize[c],f=u=>{const p=document.getElementById("canvas-parent");p.style[l]=u+"px",e.canvasSize[c]=u;const w=n.get("ui").getInputChecked("resizeElements"),g=s.resizeWithGraphScaling(e.canvasSize.x,e.canvasSize.y,w,i);o.render({x:g.xScaling,y:g.yScaling}),document.getElementById("canvas-size").textContent=`Canvas size: ${e.canvasSize.x}x${e.canvasSize.y}`};return{do:()=>f(d),undo:()=>f(m)}};this.attachInputChange("canvasWidth",c=>{const d=parseFloat(c.value);t.addAction(r("x",d))}),this.attachInputChange("canvasHeight",c=>{const d=parseFloat(c.value);t.addAction(r("y",d))}),this.attachInputChange("disablePBC",c=>{e.disablePBC=c.checked,o.render()})}attachButtonListeners(){const t=this.container.get("actionManager"),e=this.container.get("graphOperations"),s=this.container.get("fileService");this.attachButtonClick("clearSelectionButton",()=>{t.addAction(new zt)}),this.attachButtonClick("selectAllButton",()=>{t.addAction(new bt)}),this.attachButtonClick("invertSelectionButton",()=>{t.addAction(new kt)}),this.attachButtonClick("clearCanvasButton",()=>{e.clearGraph()}),this.attachButtonClick("clearSavedStateButton",()=>{if(confirm("Are you sure you want to clear the saved state? This action cannot be undone.")){const n=this.container.get("StorageService");n&&(n.clearState(),alert("Saved state has been cleared. The current canvas will be saved when you leave or reload the page."))}}),this.attachButtonClick("exportGraphButton",()=>s.exportGraph()),this.attachButtonClick("saveImageButton",()=>this.saveCanvasAsImage()),this.attachButtonClick("saveSvgButton",()=>s.saveGraphAsSvg()),this.attachInputChange("import",()=>this.importGraph()),this.attachButtonClick("startStopMotionBtn",()=>this.startStopMotionRecording()),this.attachButtonClick("captureFrameBtn",()=>this.captureStopMotionFrame()),this.attachButtonClick("removeLastFrameBtn",()=>this.removeLastStopMotionFrame()),this.attachButtonClick("stopStopMotionBtn",()=>this.stopStopMotionRecording()),this.attachButtonClick("createStopMotionMovieBtn",()=>this.createStopMotionMovie()),this.attachButtonClick("clearStopMotionFramesBtn",()=>this.clearStopMotionFrames()),this.attachButtonClick("removeDuplicateEdges",()=>{e.removeDuplicateEdges()}),this.attachButtonClick("removeSelfEdges",()=>{e.removeSelfEdges()});const o=this.container.get("graph"),i=this.container.get("app");this.attachButtonClick("forceBalanceStep",()=>{const n=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nForceBalanceSteps")||1;for(let d=0;d<c;d++)n.doForceBalanceStep(o);i.render()}),this.attachButtonClick("positionEquilibrationStep",()=>{const n=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nPositionEquilibrationSteps")||1;for(let d=0;d<c;d++)n.doPositionEquilibrationStep(o);i.render()}),this.attachButtonClick("sideChainGenerationButton",()=>this.generateSideChains()),this.attachButtonClick("bifunctionalRemoval",()=>e.removeBifunctionalNodes()),this.attachInputChange("mergeConnectionColor",n=>e.mergeEdgesByColor(n.value))}attachRedrawListeners(){const t=this.container.get("app"),e=document.getElementsByClassName("redraw-onchange");Array.from(e).forEach(s=>{s instanceof HTMLInputElement&&s.addEventListener("change",()=>{t.render()})})}importGraph(){var o;const e=(o=document.getElementById("import").files)==null?void 0:o[0];if(!e)return;this.container.get("fileService").importGraph(e)}saveCanvasAsImage(){const t=this.container.get("fileService"),e=this.container.get("canvas"),s=this.container.get("settings"),o=this.container.get("app"),i=this.container.get("graph");e.withScaledCanvas(()=>t.saveCanvasAsImage(),s.imageScaleFactor,o,i,s)}generateSideChains(){const t=this.container.get("selection"),e=this.container.get("graph"),s=this.container.get("actionManager"),o=this.container.get("nodeCounter"),i=this.container.get("ui"),n=i.getInputValueAsNumber("sideChainLength")||37.5,r=i.getInputValueAsNumber("sideChainProb")||2,c=i.getInputValueAsNumber("sideChainLengthRandomness")||0,d=i.getInputValueAsNumber("sideChainAngleRandomness")||0;t.getItemsOfClass(b).forEach(m=>{const f=e.getEdgesInvolvingNode(m.id);if(f.length!==2)return;const u=e.getNode(f[0].getOtherNodeId(m.id)),p=e.getNode(f[1].getOtherNodeId(m.id));if(!u||!p)return;const v=p.coordinates.x-u.coordinates.x,w=p.coordinates.y-u.coordinates.y,g=Math.sqrt(v*v+w*w),C=v/g,M=w/g,x=-M,S=C,F=M,A=-C,k=Math.floor(r),I=r-k,z=k+(Math.random()<I?1:0);let R=Math.random()<.5;const $=this.container.get("AddNodeAction"),_=this.container.get("AddEdgeAction");for(let L=0;L<z;L++){R=!R;const W=R?x:F,T=R?S:A,H=Math.PI*d,X=(Math.random()*2-1)*H,U=Math.cos(X),j=Math.sin(X),Q=W*U-T*j,G=W*j+T*U,tt=m.coordinates.x+Q*n*(1-c*Math.random()),et=m.coordinates.y+G*n*(1-c*Math.random()),st=o.value++,ct=new b(st,{x:tt,y:et},m.radius,m.strokeWidth,m.fillColor,m.strokeColor);s.addAction(new $(st,{x:tt,y:et},i)),s.addAction(new _(m,[ct],i))}})}startStopMotionRecording(){const t=this.container.get("movie"),e=this.container.get("ui");t.startStopMotionRecording();const s=document.getElementById("startStopMotionBtn"),o=document.getElementById("captureFrameBtn"),i=document.getElementById("removeLastFrameBtn"),n=document.getElementById("stopStopMotionBtn"),r=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!1),i&&(i.disabled=!1),n&&(n.disabled=!1),r&&(r.disabled=!0),e.updateStopMotionIndicator("Recording... (0 frames)","red"),e.updateMovieStatus("Stop-motion recording started. Capture frames by clicking 'Capture Frame'.")}captureStopMotionFrame(){const t=this.container.get("movie"),e=this.container.get("ui");if(!t.isStopMotionRecording()){alert("Not currently recording. Click 'Start Recording' first.");return}const s=e.getInputValueAsNumber("stopMotionFrameDuration")||500,o=t.captureStopMotionFrame(s);e.updateStopMotionIndicator(`Recording... (${o} frames)`,"red"),e.updateMovieStatus(`Frame ${o} captured (duration: ${s}ms)!`)}removeLastStopMotionFrame(){const t=this.container.get("movie"),e=this.container.get("ui"),s=t.removeLastStopMotionFrame();t.isStopMotionRecording()?e.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"):e.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),e.updateMovieStatus(s>0?`Last frame removed. ${s} frames remaining.`:"All frames removed.")}stopStopMotionRecording(){const t=this.container.get("movie"),e=this.container.get("ui"),s=t.stopStopMotionRecording(),o=document.getElementById("startStopMotionBtn"),i=document.getElementById("captureFrameBtn"),n=document.getElementById("removeLastFrameBtn"),r=document.getElementById("stopStopMotionBtn"),c=document.getElementById("clearStopMotionFramesBtn");o&&(o.disabled=!1),i&&(i.disabled=!0),n&&(n.disabled=s===0),r&&(r.disabled=!0),c&&(c.disabled=s===0),e.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),e.updateMovieStatus(`Recording stopped. ${s} frames captured.`)}async createStopMotionMovie(){const t=this.container.get("movie"),e=this.container.get("ui");if(t.getStopMotionFrameCount()===0){alert("No frames captured! Capture some frames first.");return}try{await t.createStopMotionMovie(e.getInputChecked("stopMotionInterpolate"))}catch(o){alert(`Error creating movie: ${o}`)}}clearStopMotionFrames(){const t=this.container.get("movie"),e=this.container.get("ui");if(!confirm("Are you sure you want to clear all captured frames? This cannot be undone."))return;t.clearStopMotionFrames();const s=document.getElementById("removeLastFrameBtn"),o=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!0),e.updateStopMotionIndicator("Not recording","black"),e.updateMovieStatus("All frames cleared.")}}class we{constructor(t){a(this,"container");this.container=t}attachEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){const e=this.container.get("actionManager"),s=this.container.get("modeFactory"),o=this.container.get("ClearSelectionAction"),i=this.container.get("SelectAllNodesAction"),n=this.container.get("InvertSelectionAction"),r=this.container.get("DeleteNodesAction"),c=this.container.get("selection"),d=this.container.get("Node"),l=this.container.get("movie");if(t.ctrlKey||t.metaKey){if(t.key==="z"&&!t.shiftKey){t.preventDefault(),e.undo();return}if(t.key==="z"&&t.shiftKey||t.key==="y"){t.preventDefault(),e.redo();return}if(t.key==="s"){t.preventDefault();return}return}if(t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){switch(t.key){case"A":s.setCurrentMode("arrow"),this.updateModeUI("arrow");break}return}if(!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey)switch(t.key){case"a":e.addAction(new i);break;case"c":case"Escape":e.addAction(new o);break;case"i":e.addAction(new n);break;case"Backspace":case"Delete":e.addAction(new r(c.getItemsOfClass(d)));break;case"v":s.setCurrentMode("vertex"),this.updateModeUI("vertex");break;case"e":s.setCurrentMode("edge"),this.updateModeUI("edge");break;case"s":s.setCurrentMode("select"),this.updateModeUI("select");break;case"d":s.setCurrentMode("delete_vertex"),this.updateModeUI("delete_vertex");break;case"l":s.setCurrentMode("delete_edge"),this.updateModeUI("delete_edge");break;case"w":s.setCurrentMode("delete_arrow"),this.updateModeUI("delete_arrow");break;case"h":s.setCurrentMode("select_chains"),this.updateModeUI("select_chains");break;case"r":s.setCurrentMode("random_walk"),this.updateModeUI("random_walk");break;case"f":l&&l.isStopMotionRecording()&&this.captureStopMotionFrame();break}}updateModeUI(t){const e=document.getElementById("modeSwitch");e&&(e.value=t)}captureStopMotionFrame(){const t=this.container.get("movie"),e=this.container.get("ui");if(!t||!t.isStopMotionRecording())return;const s=t.captureStopMotionFrame();e.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"),e.updateMovieStatus(`Frame ${s} captured!`)}detachEventListeners(){document.removeEventListener("keydown",this.handleKeyDown.bind(this))}}class ye{constructor(t,e){a(this,"name","vertex");this.nodeCounter=t,this.uiFacade=e}onCanvasClick(t,e){e.addAction(new Nt(this.nodeCounter.value,t,this.uiFacade)),this.nodeCounter.value+=1}onEnter(){console.log("Entered vertex mode")}}class Se{constructor(t,e,s,o,i){a(this,"name","edge");a(this,"cursorPosition",null);this.graph=t,this.selection=e,this.uiFacade=s,this.container=o,this.recordingCallback=i}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null)if(this.selection.empty)e.addAction(new V([s]));else{const o=this.selection.getItemsOfClass(b);e.addAction(new Rt(s,o,this.uiFacade)),console.log("EdgeMode: recordingCallback exists:",!!this.recordingCallback),this.recordingCallback&&(console.log("EdgeMode: Recording edges for",o.length,"selected nodes"),o.forEach(i=>{console.log("EdgeMode: Calling recordingCallback for",s.id,"->",i.id),this.recordingCallback(s,i)}))}}setRecordingCallback(t){this.recordingCallback=t}onMouseMove(t){const e=this.container.get("canvas");return this.cursorPosition=e.clientToCanvasCoordinates(t.clientX,t.clientY),!this.selection.empty}onEnter(){this.cursorPosition=null}onExit(){this.cursorPosition=null}getTemporaryDrawables(){if(!this.cursorPosition||this.selection.empty)return[];const t=this.selection.getItemsOfClass(b),e=[];return t.forEach(s=>{e.push(new Y(new E(s.coordinates.x,s.coordinates.y),this.cursorPosition,1,!1,"#888",2))}),e}}class Ee{constructor(t,e,s,o){a(this,"name","arrow");a(this,"cursorPosition",null);this.graph=t,this.selection=e,this.uiFacade=s,this.container=o}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null)if(this.selection.empty)e.addAction(new V([s]));else{const o=this.selection.getItemsOfClass(b);e.addAction(new me(s,o,this.uiFacade))}}onMouseMove(t){const e=this.container.get("canvas");return this.cursorPosition=e.clientToCanvasCoordinates(t.clientX,t.clientY),!this.selection.empty}onEnter(){this.cursorPosition=null}onExit(){this.cursorPosition=null}getTemporaryDrawables(){if(!this.cursorPosition||this.selection.empty)return[];const t=this.selection.getItemsOfClass(b),e=[];return t.forEach(s=>{e.push(new Y(new E(s.coordinates.x,s.coordinates.y),this.cursorPosition,1,!1,"#888",2))}),e}}class Ie{constructor(t,e,s){a(this,"name","select");a(this,"isRectangleSelecting",!1);a(this,"rectangleStart",null);a(this,"currentPoint",null);this.graph=t,this.selection=e,this.container=s}onCanvasClick(t,e){const s=this.graph.findNodesByCoordinates(t.x,t.y);s.length&&(this.selection.hasItems(s)?e.addAction(new le(s)):e.addAction(new V(s)))}onMouseDown(t){const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY);if(this.graph.findNodeByCoordinates(s.x,s.y)){this.isRectangleSelecting=!1;return}this.isRectangleSelecting=!0,this.rectangleStart=s,this.currentPoint=s}onMouseMove(t){if(!this.isRectangleSelecting||!this.rectangleStart)return!1;const e=this.container.get("canvas");return this.currentPoint=e.clientToCanvasCoordinates(t.clientX,t.clientY),!0}onMouseUp(t){if(!this.isRectangleSelecting||!this.rectangleStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(t.clientX,t.clientY),o=this.container.get("actionManager"),i=Math.min(this.rectangleStart.x,s.x),n=Math.max(this.rectangleStart.x,s.x),r=Math.min(this.rectangleStart.y,s.y),c=Math.max(this.rectangleStart.y,s.y),d=this.graph.getAllNodes().filter(m=>m.coordinates.x>=i&&m.coordinates.x<=n&&m.coordinates.y>=r&&m.coordinates.y<=c);d.length>0&&o.addAction(new V(d)),this.isRectangleSelecting=!1,this.rectangleStart=null,this.currentPoint=null,this.container.get("app").render()}onExit(){this.isRectangleSelecting=!1,this.rectangleStart=null,this.currentPoint=null}getTemporaryDrawables(){if(!this.isRectangleSelecting||!this.rectangleStart||!this.currentPoint)return[];const t=this.currentPoint.x-this.rectangleStart.x,e=this.currentPoint.y-this.rectangleStart.y,s=new E(t>=0?this.rectangleStart.x:this.currentPoint.x,e>=0?this.rectangleStart.y:this.currentPoint.y);return[new it(s,Math.abs(t),Math.abs(e),2,"#0066cc","rgba(0, 102, 204, 0.1)",!0)]}}class Me{constructor(t){a(this,"name","select_chains");this.graph=t}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null){const o=this.graph.deepConnectedTo(s);e.addAction(new V(o,!0))}}}class Ce{constructor(t){a(this,"name","delete_vertex");this.graph=t}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);s!==null&&e.addAction(new At([s]))}}class xe{constructor(t,e,s){a(this,"name","delete_edge");this.graph=t,this.selection=e,this.recordingCallback=s}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);s!==null&&!this.selection.empty||this.selection.length>1?(this.recordingCallback&&s!==null&&!this.selection.empty&&this.graph.getEdgesInvolvingNodes([...this.selection.getItemsOfClass(b).map(i=>i.id),s.id]).forEach(i=>{const n=this.graph.getNode(i.fromId),r=this.graph.getNode(i.toId);this.recordingCallback(n,r,!0)}),e.addAction(new ue(this.selection.getItemsOfClass(b),s))):s&&e.addAction(new V([s]))}setRecordingCallback(t){this.recordingCallback=t}}class Fe{constructor(t,e){a(this,"name","delete_arrow");this.graph=t,this.selection=e}onCanvasClick(t,e){const s=this.graph.findNodeByCoordinates(t.x,t.y);if(s!==null&&!this.selection.empty||this.selection.length>1){const o=s?this.graph.getArrowsInvolvingNodes([...this.selection.getItemsOfClass(b).map(i=>i.id),s.id]):this.graph.getArrowsWithBothEndsInNodes(this.selection.getItemsOfClass(b).map(i=>i.id));o.length>0&&e.addAction(new fe(o))}else s&&e.addAction(new V([s]))}}class Ne{constructor(t,e,s){a(this,"name","random_walk");this.nodeCounter=t,this.doRandomWalk=e,this.uiFacade=s}onCanvasClick(t,e){const s=this.doRandomWalk(t);e.addAction(new he(s.nodes)),e.addAction(new ge(s.edges.map(o=>o.fromId),s.edges.map(o=>o.toId),this.uiFacade)),this.nodeCounter.value+=s.nodes.length+1}}class Ae{constructor(t,e,s,o,i){a(this,"modes",new Map);a(this,"currentMode",null);const n=i.get("ui");this.modes.set("vertex",new ye(t,n)),this.modes.set("edge",new Se(e,s,n,i)),this.modes.set("arrow",new Ee(e,s,n,i)),this.modes.set("select",new Ie(e,s,i)),this.modes.set("select_chains",new Me(e)),this.modes.set("delete_vertex",new Ce(e)),this.modes.set("delete_edge",new xe(e,s)),this.modes.set("delete_arrow",new Fe(e,s)),this.modes.set("random_walk",new Ne(t,o,n)),this.setCurrentMode("vertex")}getMode(t){return this.modes.get(t)||null}setCurrentMode(t){const e=this.modes.get(t);return e?(this.currentMode&&this.currentMode.onExit&&this.currentMode.onExit(),this.currentMode=e,this.currentMode.onEnter&&this.currentMode.onEnter(),!0):(console.warn(`Mode '${t}' not found`),!1)}getCurrentMode(){return this.currentMode}getAvailableModes(){return Array.from(this.modes.keys())}getModeInstance(t){return this.modes.get(t)||null}}function Et(){const h=document.getElementById("canvas"),t=h.getContext("2d");if(!h||!t){console.error("Failed to initialize canvas");return}const e=O.instance,s=ht.getInstance(),o={value:0},i=new _t(h,t,e),n=new Wt,r=new jt(h,s),c=new ne(s),d=new re(s);s.register("canvas",i),s.register("ui",n),s.register("movie",r),s.register("graphOperations",c),s.register("fileService",d),s.register("settings",e),s.register("graph",y),s.register("selection",N),s.register("Node",b),s.register("nodeCounter",o),s.register("StorageService",q),s.register("Circle",mt),s.register("Rectangle",it),s.register("PartialLine",Y),s.register("simulations",{doForceBalanceStep:te,doPositionEquilibrationStep:se}),s.register("ClearSelectionAction",zt),s.register("SelectAllNodesAction",bt),s.register("InvertSelectionAction",kt),s.register("DeleteNodesAction",At),s.register("AddNodeAction",Nt),s.register("AddEdgeAction",Rt);const l=new Dt(s);s.register("app",l);const m=new ae(()=>l.render());s.register("actionManager",m);const f=new Ae(o,y,N,ee,s);s.register("modeFactory",f),f.setCurrentMode("vertex");const u=new pe(s),p=new ve(s),v=new we(s);if(l.initialize(),u.attachEventListeners(),p.attachEventListeners(),v.attachEventListeners(),q.loadState(y,e)){if(i.resize(e.canvasSize.x,e.canvasSize.y),n.updateCanvasSizeUI(e.canvasSize.x,e.canvasSize.y),y.getNrOfNodes()>0){const g=y.getAllNodeIds();o.value=Math.max(...g)+1}console.log("Loaded previous state from localStorage")}else n.updateCanvasSizeUI(e.canvasSize.x,e.canvasSize.y),y.clear(),N.clearSelection();l.render(),window.addEventListener("beforeunload",()=>{q.saveState(y,e)}),setInterval(()=>{q.saveState(y,e)},3e4),console.log("Application initialized successfully")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Et):Et();
