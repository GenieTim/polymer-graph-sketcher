var Ne=Object.defineProperty;var ge=h=>{throw TypeError(h)};var Re=(h,e,t)=>e in h?Ne(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var r=(h,e,t)=>Re(h,typeof e!="symbol"?e+"":e,t),ue=(h,e,t)=>e.has(h)||ge("Cannot "+t);var te=(h,e,t)=>(ue(h,e,"read from private field"),t?t.call(h):e.get(h)),me=(h,e,t)=>e.has(h)?ge("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t),ae=(h,e,t,s)=>(ue(h,e,"write to private field"),s?s.call(h,t):e.set(h,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const U=class U{constructor(){r(this,"services",new Map)}static getInstance(){return U.instance||(U.instance=new U),U.instance}register(e,t){this.services.set(e,t)}get(e){const t=this.services.get(e);if(!t)throw new Error(`Service '${e}' not found in container`);return t}has(e){return this.services.has(e)}clear(){this.services.clear()}};r(U,"instance");let ce=U;class Ae{constructor(){r(this,"observers",[])}subscribe(e){return this.observers.push(e),()=>{const t=this.observers.indexOf(e);t>-1&&this.observers.splice(t,1)}}notify(e){this.observers.forEach(t=>t(e))}get observerCount(){return this.observers.length}clearObservers(){this.observers=[]}}class pe extends Ae{constructor(t){super();r(this,"_value");this._value=t}get value(){return this._value}set value(t){this._value!==t&&(this._value=t,this.notify(t))}forceUpdate(){this.notify(this._value)}}class ke{constructor(e){r(this,"container");r(this,"elementsToDraw",new pe([]));r(this,"showSelection",new pe(!0));this.container=e}initialize(){const e=this.container.get("canvas"),t=this.container.get("settings");e.resize(t.canvasSize.x,t.canvasSize.y),this.render()}render(e={x:1,y:1},t=[]){const s=this.container.get("canvas"),o=this.container.get("graph"),i=this.container.get("selection"),n=this.container.get("ui"),a=this.container.get("settings"),c=a.isScaled?{x:a.imageScaleFactor,y:a.imageScaleFactor}:e,d=Math.max(c.x,c.y),l=s.canvas,p=n.getInputValue("backgroundColor"),m=n.getInputValue("borderColor"),g=[],u=this.container.get("Rectangle");g.push(new u({x:0,y:0},l.width,l.height,0,"transparent",p));const v=o.toDrawables();if(t.length>0){const f=[],S=[];for(const w of v)w.constructor.name==="Circle"?S.push(w):f.push(w);g.push(...f),g.push(...t),g.push(...S)}else g.push(...v);if(g.push(new u({x:0,y:0},l.width,l.height,20*d,p,null)),g.push(new u({x:10*c.x,y:10*c.y},l.width-20*c.x,l.height-20*c.y,4*d,m,null)),this.showSelection.value&&!i.empty){const f=this.container.get("Circle"),S=this.container.get("Node");i.getItemsOfClass(S).forEach(w=>{g.push(new f({x:w.coordinates.x,y:w.coordinates.y},w.radius*d*1.5,2*d,"transparent","red"))})}this.elementsToDraw.value=g,s.draw(g),n.updateGraphStats(o.getNrOfNodes(),o.getNrOfEdges())}destroy(){this.elementsToDraw.clearObservers(),this.showSelection.clearObservers()}}class M{constructor(e,t){r(this,"x");r(this,"y");this.x=e,this.y=t}}class P extends M{constructor(e,t){e instanceof M?(super(e.x,e.y),this.x=e.x,this.y=e.y):(super(e,t),this.x=e,this.y=t)}add(e){return new P(this.x+e.x,this.y+e.y)}subtract(e){return new P(this.x-e.x,this.y-e.y)}multiply(e){return new P(this.x*e,this.y*e)}toString(){return`(${this.x}, ${this.y})`}}class F{constructor(e,t,s=5,o=1,i="#000",n="#000"){r(this,"id");r(this,"coordinates");r(this,"radius");r(this,"strokeWidth");r(this,"fillColor");r(this,"strokeColor");if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new Error("Invalid `id` parameter. It must be a non-negative integer, got `"+e+"`.");this.id=e,this.coordinates=t,this.radius=s,this.strokeWidth=o,this.fillColor=i,this.strokeColor=n}}class de{constructor(e,t,s,o=1,i="#000"){r(this,"fromId");r(this,"toId");r(this,"weight");r(this,"color");r(this,"id");this.fromId=e,this.toId=t,this.id=s,this.weight=o,this.color=i}getOtherNodeId(e){return this.fromId===e?this.toId:this.fromId}}class ve{constructor(e=null,t=1,s=1,o="#000",i="#000"){r(this,"center");r(this,"radius");r(this,"strokeWidth");r(this,"fillColor");r(this,"strokeColor");this.center=e||new M(0,0),this.radius=t,this.strokeWidth=s,this.fillColor=o,this.strokeColor=i}setCenter(e){this.center=e}setRadius(e){this.radius=e}draw(e){e.beginPath(),e.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI),this.fillColor&&(e.fillStyle=this.fillColor,e.fill()),e.strokeStyle=this.strokeColor,e.lineWidth=this.strokeWidth,e.stroke()}}var W;const T=class T{constructor(e=new M(825,445),t="#FFFFFF",s=10){r(this,"isScaled",!1);r(this,"canvasSize");r(this,"backgroundColor");r(this,"imageScaleFactor");r(this,"disablePBC",!1);this.canvasSize=e,this.backgroundColor=t,this.imageScaleFactor=s}static get instance(){return te(T,W)||ae(T,W,new T),te(T,W)}static fromJSON(e){return ae(T,W,new T(new M(e.canvasSize.x,e.canvasSize.y),e.backgroundColor,e.imageScaleFactor)),"disablePBC"in e&&(te(T,W).disablePBC=e.disablePBC),te(T,W)}};W=new WeakMap,me(T,W);let V=T;class oe{constructor(e,t,s=!1,o="#000",i=2,n=6,a=4,c=2){r(this,"from");r(this,"to");r(this,"dashed");r(this,"zigZagged");r(this,"color");r(this,"lineWidth");r(this,"zigzagSpacing");r(this,"oneZigZagLength");r(this,"straightLengthWhenZigZag");r(this,"lineRadians");r(this,"lineLength");this.from=e,this.to=t,this.dashed=!1,this.zigZagged=s,this.color=o,this.lineWidth=i,this.zigzagSpacing=n,this.oneZigZagLength=a,this.straightLengthWhenZigZag=c,this.lineRadians=Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x);const d=this.from.x-this.to.x,l=this.from.y-this.to.y;this.lineLength=Math.sqrt(d*d+l*l)}setFrom(e){this.from=e}setTo(e){this.to=e}getFrom(){return this.from}getTo(){return this.to}draw(e){const t=V.instance;var s=this.to.x-this.from.x,o=this.to.y-this.from.y;const i=Math.abs(o)>.5001*t.canvasSize.y,n=Math.abs(s)>.5001*t.canvasSize.x;if((i||n)&&!t.disablePBC){[new oe(new M(this.from.x,this.from.y),new M(this.to.x+t.canvasSize.x*(n?s<0?1:-1:0),this.to.y+t.canvasSize.y*(i?o<0?1:-1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new oe(new M(this.to.x,this.to.y),new M(this.from.x+t.canvasSize.x*(n?s<0?-1:1:0),this.from.y+t.canvasSize.y*(i?o<0?-1:1:0)),this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(a=>a.draw(e));return}this.dashed&&e.setLineDash([4,2]),e.lineCap="round",e.lineWidth=this.lineWidth,e.strokeStyle=this.color,this.zigZagged?this.drawZigZagged(e):(e.beginPath(),e.moveTo(this.from.x,this.from.y),e.lineTo(this.to.x,this.to.y)),e.stroke()}drawZigZagged(e){e.save(),e.beginPath(),e.translate(this.from.x,this.from.y),e.rotate(this.lineRadians),e.moveTo(0,0),e.lineTo(this.straightLengthWhenZigZag,0);let t=this.straightLengthWhenZigZag;for(let s=0;t<this.lineLength-this.straightLengthWhenZigZag;s++){t=(s+1)*this.zigzagSpacing;const o=s%2==0?-this.oneZigZagLength:this.oneZigZagLength;e.lineTo(t,o)}e.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),e.lineTo(this.lineLength,0),e.restore()}setDashed(e){this.dashed=e}setZigZagged(e){this.zigZagged=e}}class ze{constructor(){r(this,"nodes");r(this,"edges");r(this,"scalingFactor");r(this,"zigzagSpacing",4);r(this,"zigzagLength",3);r(this,"zigzagEndLengths",1.5);r(this,"maxNodeId",0);this.nodes={},this.edges=[],this.scalingFactor=new M(1,1)}clear(){this.nodes={},this.edges=[]}setNode(e){this.nodes[e.id]=e,this.maxNodeId=Math.max(this.maxNodeId,e.id)}addEdge(e,t,s="#000",o=1){if(!(e in this.nodes)||!(t in this.nodes))throw new Error("One or both nodes do not exist in the graph.");return this.edges.push(new de(e,t,this.edges.length,o,s)),this.edges.length-1}getNode(e){if(!(e in this.nodes))throw new Error(`Node with id "${e}" does not exist.`);return this.nodes[e]}getNrOfNodes(){return Object.keys(this.nodes).length}getNrOfEdges(){return this.edges.length}getAllNodeIds(){return Object.values(this.nodes).map(e=>e.id)}getNextNodeId(){return this.maxNodeId+1}getAllNodes(){return Object.values(this.nodes)}getAllEdges(){return this.edges}getNodesConnectedToNode(e){return this.getEdgesInvolvingNode(e).map(t=>this.nodes[t.fromId===e?t.toId:t.fromId])}deepConnectedTo(e){const t=new Set,s=[],o=[e.id];for(;o.length>0;){const i=o.shift();if(t.has(i))continue;t.add(i),s.push(this.getNode(i));const n=this.getEdgesInvolvingNode(i).map(a=>a.getOtherNodeId(i)).filter(a=>!t.has(a));o.push(...n)}return s}getEdgesInvolvingNode(e){return this.edges.filter(t=>t.fromId===e||t.toId===e)}getEdgesInvolvingNodes(e){return this.edges.filter(t=>e.includes(t.fromId)&&e.includes(t.toId))}cleanupEdges(){this.edges=this.edges.filter(e=>e.fromId!==e.toId)}removeDuplicateEdges(){const e=new Set;this.edges=this.edges.filter(t=>{const s=`${Math.min(t.fromId,t.toId)}-${Math.max(t.fromId,t.toId)}`;return e.has(s)?!1:(e.add(s),!0)})}getEdgesWithBothEndsInNodes(e){return this.edges.filter(t=>e.includes(t.fromId)&&e.includes(t.toId))}fromJSON(e){this.nodes={},this.edges=[];for(const[,t]of Object.entries(e.nodes))this.setNode(new F(t.id,t.coordinates,t.radius,t.strokeWidth,t.fillColor,t.strokeColor));for(const t of e.edges)this.addEdge(t.fromId,t.toId,t.color,t.weight);"scalingFactor"in e&&(this.scalingFactor=new M(e.scalingFactor.x,e.scalingFactor.y)),"zigzagSpacing"in e&&(this.zigzagSpacing=e.zigzagSpacing),"zigzagLength"in e&&(this.zigzagLength=e.zigzagLength),this.cleanupEdges()}toDrawables(){const e=[],t=Math.max(this.scalingFactor.x,this.scalingFactor.y);for(const s of this.edges){const o=this.getNode(s.fromId),i=this.getNode(s.toId);if(o&&i){const n=new M(o.coordinates.x*this.scalingFactor.x,o.coordinates.y*this.scalingFactor.y),a=new M(i.coordinates.x*this.scalingFactor.x,i.coordinates.y*this.scalingFactor.y);e.push(new oe(n,a,!0,s.color,s.weight*t,this.zigzagSpacing*t,this.zigzagLength*t,this.zigzagEndLengths*t))}else throw new Error(`Node with id ${s.fromId} or ${s.toId} does not exist in the graph.`)}for(const s of Object.values(this.nodes)){const o=new M(s.coordinates.x*this.scalingFactor.x,s.coordinates.y*this.scalingFactor.y);e.push(new ve(o,s.radius*t,s.strokeWidth*t,s.fillColor,s.strokeColor))}return e}findNodesByCoordinates(e,t){let s=[];for(const[,o]of Object.entries(this.nodes))Math.sqrt(Math.pow(o.coordinates.x-e,2)+Math.pow(o.coordinates.y-t,2))<=5&&s.push(o);return s}findNodeByCoordinates(e,t){const s=this.findNodesByCoordinates(e,t);return s.length>0?s[0]:null}deleteNode(e){if(!this.getNode(e))throw new Error("The node does not exist in the graph.");delete this.nodes[e];for(let s=0;s<this.edges.length;s++)(this.edges[s].fromId===e||this.edges[s].toId===e)&&(this.edges.splice(s,1),s--)}deleteEdge(e){if(e instanceof de&&(e=this.edges.indexOf(e)),e<0||e>=this.edges.length)throw new Error("Invalid edge ID "+e+". Edge ID must be between 0 and "+(this.edges.length-1)+".");const t=this.edges[e];return this.edges.splice(e,1),t}}const y=new ze;class Be{constructor(e,t,s){r(this,"canvas");r(this,"ctx");this.canvas=e,this.ctx=t}resize(e,t){const s=this.canvas.width,o=this.canvas.height;this.canvas.width=e,this.canvas.height=t;const i=this.canvas.width/s,n=this.canvas.height/o;return{xScaling:i,yScaling:n}}resizeWithGraphScaling(e,t,s,o){const i=this.resize(e,t),{xScaling:n,yScaling:a}=i,c=Math.min(n,a);return console.log("Resizing canvas",[s,n,a,c]),o.getAllNodes().forEach(l=>{l.coordinates.x*=n,l.coordinates.y*=a,s&&(l.radius*=c,l.strokeWidth*=c)}),s&&(o.getAllEdges().forEach(p=>{p.weight*=c}),o.zigzagLength*=c,o.zigzagSpacing*=c,o.zigzagEndLengths*=c),i}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(e){this.clear(),e.forEach(t=>t.draw(this.ctx))}toDataURL(e="image/png"){return this.canvas.toDataURL(e)}getContext(){return this.ctx}getDimensions(){return{width:this.canvas.width,height:this.canvas.height}}clientToCanvasCoordinates(e,t){return new M(e-this.canvas.offsetLeft+window.scrollX,t-this.canvas.offsetTop+window.scrollY)}withScaledCanvas(e,t,s,o,i){const n=s.showSelection.value,a=i.isScaled,c={x:i.canvasSize.x,y:i.canvasSize.y};s.showSelection.value=!1,i.isScaled=!0,i.canvasSize.x*=t,i.canvasSize.y*=t,this.resizeWithGraphScaling(i.canvasSize.x,i.canvasSize.y,!0,o);const d=()=>{s.showSelection.value=n,i.isScaled=a,i.canvasSize.x=c.x,i.canvasSize.y=c.y,this.resizeWithGraphScaling(i.canvasSize.x,i.canvasSize.y,!0,o),s.render()};try{const l=e();return l instanceof Promise?l.finally(d):(d(),l)}catch(l){throw d(),l}}}class Le{constructor(){r(this,"elements",new Map);this.cacheElements()}cacheElements(){["backgroundColor","borderColor","vertexRadius","vertexStrokeWidth","nodeFillColor","nodeColor","edgeColor","lineWidth","graph-stats","resizeElements","sideChainLength","sideChainProb","sideChainLengthRandomness","sideChainAngleRandomness","edgeAnimationDuration","simulationType","simulationStepCount","simulationStepDuration","adaptiveStepDuration","movieRecordingStatus","recordingEdgeCount","stopMotionFrameDuration","stopMotionIndicator","stopMotionFrameCount"].forEach(t=>{const s=document.getElementById(t);s&&this.elements.set(t,s)})}getElement(e){const t=this.elements.get(e);if(!t){const s=document.getElementById(e);return s?(this.elements.set(e,s),s):null}return t}getInputValue(e){const t=this.getElement(e);return(t==null?void 0:t.value)||""}getInputValueAsNumber(e){const t=this.getElement(e);return(t==null?void 0:t.valueAsNumber)||0}getInputChecked(e){const t=this.getElement(e);return(t==null?void 0:t.checked)||!1}setValue(e,t){const s=this.getElement(e);s&&(s.value=String(t))}updateGraphStats(e,t){const s=this.getElement("graph-stats");s&&(s.textContent=`Nodes: ${e}, Edges: ${t}`)}updateCanvasSizeUI(e,t){this.setValue("canvasWidth",e),this.setValue("canvasHeight",t);const s=document.getElementById("canvas-parent");s&&(s.style.width=e+"px",s.style.height=t+"px");const o=document.getElementById("canvas-size");o&&(o.textContent=`Canvas size: ${e}x${t}`)}updateMovieRecordingStatus(e){const t=this.getElement("movieRecordingStatus");t&&(t.textContent=e)}updateMovieStatus(e){this.updateMovieRecordingStatus(e)}updateRecordingEdgeCount(e){const t=this.getElement("recordingEdgeCount");t&&(t.textContent=String(e))}updateStopMotionIndicator(e,t="black"){const s=this.getElement("stopMotionIndicator");s&&(s.textContent=e,s.style.color=t)}updateStopMotionFrameCount(e){const t=this.getElement("stopMotionFrameCount");t&&(t.textContent=String(e))}setTextContent(e,t){const s=this.getElement(e);s&&(s.textContent=t)}setVisible(e,t){const s=this.getElement(e);s&&(s.style.display=t?"":"none")}addClass(e,t){const s=this.getElement(e);s&&s.classList.add(t)}removeClass(e,t){const s=this.getElement(e);s&&s.classList.remove(t)}toggleClass(e,t){const s=this.getElement(e);s&&s.classList.toggle(t)}}class Pe{constructor(e={}){r(this,"sequences",[]);r(this,"currentSequenceIndex",0);r(this,"currentFrameIndex",0);r(this,"isPlaying",!1);r(this,"isPaused",!1);r(this,"animationFrameId",null);r(this,"lastFrameTime",0);r(this,"options");r(this,"subFrameIndex",0);r(this,"animate",()=>{if(!this.isPlaying||this.isPaused)return;if(this.currentSequenceIndex>=this.sequences.length){this.stop();return}const e=this.sequences[this.currentSequenceIndex],t=e.frames[this.currentFrameIndex];if(!t){e.onComplete&&e.onComplete(),this.currentSequenceIndex++,this.currentFrameIndex=0,this.lastFrameTime=performance.now(),this.options.offlineRendering?this.animate():this.animationFrameId=requestAnimationFrame(this.animate);return}if(this.options.offlineRendering){const s=t.duration||e.defaultFrameDuration||16,o=this.options.targetFPS,i=Math.max(1,Math.round(s/1e3*o));this.subFrameIndex===0&&(t.action(),e.onFrame&&e.onFrame(this.currentFrameIndex,e.frames.length)),this.options.onFrameRendered&&this.options.onFrameRendered(),this.subFrameIndex++,this.subFrameIndex>=i&&(this.subFrameIndex=0,this.currentFrameIndex++),this.animate()}else{const s=performance.now(),o=t.duration||e.defaultFrameDuration||16;s-this.lastFrameTime>=o&&(t.action(),e.onFrame&&e.onFrame(this.currentFrameIndex,e.frames.length),this.currentFrameIndex++,this.lastFrameTime=s),this.animationFrameId=requestAnimationFrame(this.animate)}});this.options={targetFPS:e.targetFPS||60,autoPlay:e.autoPlay!==void 0?e.autoPlay:!0,offlineRendering:e.offlineRendering||!1,onFrameRendered:e.onFrameRendered}}addSequence(e){e.defaultFrameDuration||(e.defaultFrameDuration=1e3/this.options.targetFPS),this.sequences.push(e),this.options.autoPlay&&!this.isPlaying&&this.play()}clearSequences(){this.stop(),this.sequences=[],this.currentSequenceIndex=0,this.currentFrameIndex=0}play(){this.isPlaying&&!this.isPaused||(this.isPlaying=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}pause(){this.isPaused=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.isPaused&&(this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate())}stop(){this.isPlaying=!1,this.isPaused=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentSequenceIndex=0,this.currentFrameIndex=0}getIsPlaying(){return this.isPlaying&&!this.isPaused}getIsPaused(){return this.isPaused}getProgress(){const e=this.sequences[this.currentSequenceIndex];return{sequence:this.currentSequenceIndex,frame:this.currentFrameIndex,total:(e==null?void 0:e.frames.length)||0}}}class De{static fromActions(e,t,s=100,o){return{name:e,frames:t.map(i=>({action:i})),defaultFrameDuration:s,onComplete:o}}static repeat(e,t,s,o=100,i){return{name:e,frames:Array(s).fill(null).map(()=>({action:t})),defaultFrameDuration:o,onComplete:i}}static withTiming(e,t,s){return{name:e,frames:t,onComplete:s}}static interpolate(e,t,s,o=1e3,i){const n=o/t,a=[];for(let c=0;c<=t;c++){const d=c/t;a.push({action:()=>s(d),duration:n})}return{name:e,frames:a,onComplete:i}}}class Te{constructor(e,t={}){r(this,"mediaRecorder",null);r(this,"recordedChunks",[]);r(this,"stream",null);r(this,"isRecording",!1);r(this,"canvas");r(this,"options");this.canvas=e,this.options={fps:t.fps||60,videoBitsPerSecond:t.videoBitsPerSecond||25e5,mimeType:t.mimeType||"video/webm;codecs=vp9"}}start(){if(this.isRecording){console.warn("Recording already in progress");return}this.recordedChunks=[],this.stream=this.canvas.captureStream(0);let e=this.options.mimeType;MediaRecorder.isTypeSupported(e)||(console.warn(`${e} not supported, trying vp8`),e="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(e)||(console.warn(`${e} not supported, using default`),e="video/webm")),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=t=>{t.data&&t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.start(),this.isRecording=!0,console.log("Recording started")}stop(){return new Promise((e,t)=>{if(!this.isRecording||!this.mediaRecorder){t(new Error("No recording in progress"));return}this.mediaRecorder.onstop=()=>{const s=new Blob(this.recordedChunks,{type:"video/webm"});this.isRecording=!1,this.stream&&this.stream.getTracks().forEach(o=>o.stop()),console.log("Recording stopped, blob size:",s.size),e(s)},this.mediaRecorder.stop()})}requestFrame(){if(this.stream){const e=this.stream.getVideoTracks()[0];e&&"requestFrame"in e&&e.requestFrame()}}getIsRecording(){return this.isRecording}async download(e="polymer-graph-animation.webm"){if(this.isRecording){const t=await this.stop();this.downloadBlob(t,e)}else if(this.recordedChunks.length>0){const t=new Blob(this.recordedChunks,{type:"video/webm"});this.downloadBlob(t,e)}else throw new Error("No recording available to download")}downloadBlob(e,t){const s=URL.createObjectURL(e),o=document.createElement("a");o.style.display="none",o.href=s,o.download=t,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},500)}}class Oe{constructor(e){r(this,"recorder");r(this,"animator");r(this,"isRecordingMovie",!1);var t;this.recorder=new Te(e.canvas,e.recorderOptions),this.animator=new Pe({targetFPS:((t=e.animatorOptions)==null?void 0:t.targetFPS)||60,autoPlay:!1,offlineRendering:!1,onFrameRendered:()=>this.recorder.requestFrame()})}async startRecording(){if(this.isRecordingMovie)throw new Error("Already recording a movie");this.isRecordingMovie=!0,this.animator.options.offlineRendering=!0,this.recorder.start()}async stopAndDownload(e){if(!this.isRecordingMovie)throw new Error("Not currently recording");this.animator.getIsPlaying()&&this.animator.stop(),this.animator.options.offlineRendering=!1,await this.recorder.download(e),this.isRecordingMovie=!1}addSequence(e){this.animator.addSequence(e)}clearSequences(){this.animator.clearSequences()}play(){this.animator.play()}pause(){this.animator.pause()}resume(){this.animator.resume()}stop(){this.animator.stop()}async recordMovie(e,t){return new Promise((s,o)=>{this.clearSequences(),e.forEach(i=>this.addSequence(i)),this.addSequence({name:"completion",frames:[{action:()=>{setTimeout(async()=>{try{await this.stopAndDownload(t),s()}catch(i){o(i)}},500)}}],defaultFrameDuration:100}),this.startRecording().then(()=>{this.play()}).catch(o)})}getIsRecording(){return this.isRecordingMovie}getIsPlaying(){return this.animator.getIsPlaying()}getProgress(){return this.animator.getProgress()}static get AnimationBuilder(){return De}}class he{constructor(e){r(this,"options");r(this,"canvas",null);r(this,"ctx",null);r(this,"mediaRecorder",null);r(this,"recordedChunks",[]);r(this,"stream",null);this.options={width:e.width,height:e.height,fps:e.fps||30,videoBitsPerSecond:e.videoBitsPerSecond||5e6,mimeType:e.mimeType||"video/webm;codecs=vp9"}}init(){if(this.canvas)return;if(this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height,this.canvas.style.display="none",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!1}),!this.ctx)throw new Error("Failed to get 2D context from canvas");const e=this.canvas.captureStream(0),t=e.getVideoTracks()[0],s=t&&typeof t.requestFrame=="function";e.getTracks().forEach(n=>n.stop());const o=s?this.canvas.captureStream(0):this.canvas.captureStream(this.options.fps);this.stream=o,console.log(`VideoEncoder: Using ${s?"manual":"automatic"} frame capture at ${this.options.fps} fps`);let i=this.options.mimeType;MediaRecorder.isTypeSupported(i)||(console.warn(`${i} not supported, trying vp8`),i="video/webm;codecs=vp8",MediaRecorder.isTypeSupported(i)||(console.warn(`${i} not supported, using default`),i="video/webm")),this.mediaRecorder=new MediaRecorder(o,{mimeType:i,videoBitsPerSecond:this.options.videoBitsPerSecond}),this.mediaRecorder.ondataavailable=n=>{var a;((a=n.data)==null?void 0:a.size)>0&&this.recordedChunks.push(n.data)},this.recordedChunks=[]}async encodeVideo(e,t){return this.init(),new Promise((s,o)=>{if(!this.mediaRecorder||!this.ctx||!this.stream||!this.canvas){o(new Error("Encoder not initialized"));return}const i=1e3/this.options.fps;let n=0,a=0;this.mediaRecorder.onstop=()=>{const m=new Blob(this.recordedChunks,{type:"video/webm"});console.log(`Video encoded: ${m.size} bytes, ${n} video frames from ${a} animation frames`),this.cleanup(),s(m)},this.mediaRecorder.start();const c=this.stream.getVideoTracks()[0],d=c&&typeof c.requestFrame=="function";console.log(`Starting video encoding: ${e.length} frames, ${this.options.fps} fps, requestFrame support: ${d}`);let l=0;const p=async()=>{if(a>=e.length){await new Promise(u=>setTimeout(u,500)),this.mediaRecorder.stop();return}const m=e[a];m.render(this.ctx),l+=m.durationMs;const g=Math.floor(l/i);if(g>=1){if(d){await new Promise(u=>requestAnimationFrame(()=>u(void 0)));for(let u=0;u<g;u++)c.requestFrame(),await new Promise(v=>setTimeout(v,5))}else{const u=g*i;await new Promise(v=>setTimeout(v,u))}n+=g,l-=g*i}(a%100===0||a===e.length-1)&&console.log(`Progress: ${a+1}/${e.length} animation frames â†’ ${n} video frames`),t==null||t(a+1,e.length),a++,p()};p()})}cleanup(){this.stream&&this.stream.getTracks().forEach(e=>e.stop()),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.stream=null,this.mediaRecorder=null,this.ctx=null,this.canvas=null}static createCanvasCopyRenderer(e){return t=>{t.drawImage(e,0,0)}}}class _e{constructor(e){r(this,"canvas");r(this,"ctx");r(this,"frames",[]);r(this,"frameDuration");r(this,"isRecording",!1);this.canvas=e.canvas,this.frameDuration=e.frameDuration||500;const t=this.canvas.getContext("2d");if(!t)throw new Error("Failed to get 2D context from canvas");this.ctx=t}start(){if(this.isRecording){console.warn("Stop-motion recording already in progress");return}this.frames=[],this.isRecording=!0,console.log("Stop-motion recording started")}captureFrame(){if(!this.isRecording)throw new Error("Not currently recording. Call start() first.");const e=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),t=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);this.frames.push({imageData:t,timestamp:Date.now()}),console.log(`Frame ${this.frames.length} captured`)}removeLastFrame(){return this.frames.length===0?!1:(this.frames.pop(),console.log(`Last frame removed. ${this.frames.length} frames remaining`),!0)}stop(){if(!this.isRecording){console.warn("Not currently recording");return}this.isRecording=!1,console.log(`Stop-motion recording stopped. ${this.frames.length} frames captured`)}getFrameCount(){return this.frames.length}getIsRecording(){return this.isRecording}setFrameDuration(e){this.frameDuration=e}getFrameDuration(){return this.frameDuration}clear(){this.frames=[],console.log("All frames cleared")}async encode(e){if(this.frames.length===0)throw new Error("No frames to encode. Capture some frames first.");console.log(`Encoding ${this.frames.length} frames at ${this.frameDuration}ms per frame`);const t=new he({width:this.canvas.width,height:this.canvas.height,fps:30,videoBitsPerSecond:5e6}),s=this.frames.map(i=>({render:n=>{const a=document.createElement("canvas");a.width=i.imageData.width,a.height=i.imageData.height;const c=a.getContext("2d");c&&(c.putImageData(i.imageData,0,0),n.drawImage(a,0,0))},durationMs:this.frameDuration})),o=await t.encodeVideo(s,e);return console.log(`Video encoded: ${o.size} bytes`),o}async download(e="stop-motion-animation.webm"){const t=await this.encode(),s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},500)}}class ie extends oe{constructor(t,s,o=1,i=!1,n="#000",a=2,c=6,d=4,l=2){super(t,s,i,n,a,c,d,l);r(this,"progress");this.progress=Math.max(0,Math.min(1,o))}setProgress(t){this.progress=Math.max(0,Math.min(1,t))}draw(t){if(this.progress===0)return;if(this.progress===1){super.draw(t);return}const s=V.instance;var o=this.to.x-this.from.x,i=this.to.y-this.from.y;const n=Math.abs(i)>.5001*s.canvasSize.y,a=Math.abs(o)>.5001*s.canvasSize.x;if((n||a)&&!s.disablePBC){[new ie(new M(this.from.x,this.from.y),new M(this.to.x+s.canvasSize.x*(a?o<0?1:-1:0),this.to.y+s.canvasSize.y*(n?i<0?1:-1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag),new ie(new M(this.to.x,this.to.y),new M(this.from.x+s.canvasSize.x*(a?o<0?-1:1:0),this.from.y+s.canvasSize.y*(n?i<0?-1:1:0)),this.progress,this.zigZagged,this.color,this.lineWidth,this.zigzagSpacing,this.oneZigZagLength,this.straightLengthWhenZigZag)].forEach(d=>d.draw(t));return}const c=new M(this.from.x+(this.to.x-this.from.x)*this.progress,this.from.y+(this.to.y-this.from.y)*this.progress);this.dashed&&t.setLineDash([4,2]),t.lineCap="round",t.lineWidth=this.lineWidth,t.strokeStyle=this.color,this.zigZagged?this.drawPartialZigZagged(t,c):(t.beginPath(),t.moveTo(this.from.x,this.from.y),t.lineTo(c.x,c.y),t.stroke())}drawPartialZigZagged(t,s){const o=this.lineLength*this.progress;if(t.save(),t.beginPath(),t.translate(this.from.x,this.from.y),t.rotate(this.lineRadians),t.moveTo(0,0),o<=this.straightLengthWhenZigZag)t.lineTo(o,0);else if(o>=this.lineLength-this.straightLengthWhenZigZag){t.lineTo(this.straightLengthWhenZigZag,0);let i=this.straightLengthWhenZigZag;for(let n=0;i<this.lineLength-this.straightLengthWhenZigZag;n++){i=(n+1)*this.zigzagSpacing;const a=n%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(i,a)}t.lineTo(this.lineLength-this.straightLengthWhenZigZag,0),t.lineTo(o,0)}else{t.lineTo(this.straightLengthWhenZigZag,0);let i=this.straightLengthWhenZigZag;for(let n=0;i<o;n++){if(i=(n+1)*this.zigzagSpacing,i>=o){const c=n*this.zigzagSpacing,d=(n-1)%2==0?-this.oneZigZagLength:this.oneZigZagLength,l=n%2==0?-this.oneZigZagLength:this.oneZigZagLength,p=(o-c)/this.zigzagSpacing,m=d+(l-d)*p;t.lineTo(o,m);break}const a=n%2==0?-this.oneZigZagLength:this.oneZigZagLength;t.lineTo(i,a)}}t.stroke(),t.restore()}}const z=class z{static hex2lab(e){const[t,s,o]=z.hex2rgba(e);return z.rgba2lab(t,s,o,1)}static rgba2lab(e,t,s,o){const[i,n,a]=z.rgb2xyz(e,t,s);return z.xyz2lab(i,n,a)}static lab2rgba(e,t,s){const[o,i,n]=z.lab2xyz(e,t,s);return[...z.xyz2rgba(o,i,n),1]}static hex2rgba(e){const t=e.replace(/^#/,"").toUpperCase();if(!/^[0-9A-F]+$/i.test(t)||![3,4,6,8].includes(t.length))throw new Error(`Invalid HEX format: ${e}`);let o=t;[3,4].includes(t.length)&&(o=t.split("").map(l=>l+l).join(""));const i=parseInt(o,16);let n,a,c,d=1;return o.length===8?(d=(i&255)/255,n=i>>16&255,a=i>>8&255,c=i&255):(n=i>>16&255,a=i>>8&255,c=i&255),[Math.min(255,Math.max(0,n)),Math.min(255,Math.max(0,a)),Math.min(255,Math.max(0,c)),Math.min(1,Math.max(0,d))]}static rgb2xyz(e,t,s){const o=c=>c>.04045?Math.pow((c+.055)/1.055,2.4):c/12.92,[i,n,a]=[e/255,t/255,s/255].map(c=>o(c)*100);return[i*.4124564+n*.3575761+a*.1804375,i*.2126729+n*.7151522+a*.072175,i*.0193339+n*.119192+a*.9503041]}static xyz2rgba(e,t,s){const o=d=>(d=d>.0031308?1.055*Math.pow(d,.4166666666666667)-.055:12.92*d,Math.round(Math.min(255,Math.max(0,d*255)))),i=[e/100,t/100,s/100],n=i[0]*3.2404542+i[1]*-1.5371385+i[2]*-.4985314,a=i[0]*-.969266+i[1]*1.8760108+i[2]*.041556,c=i[0]*.0556434+i[1]*-.2040259+i[2]*1.0572252;return[o(n),o(a),o(c)]}static xyz2lab(e,t,s){const o=c=>c>.008856?Math.pow(c,.3333333333333333):7.787*c+.13793103448275862,i=o(e/z.REF_X),n=o(t/z.REF_Y),a=o(s/z.REF_Z);return[116*n-16,500*(i-n),200*(n-a)]}static lab2xyz(e,t,s){const o=(e+16)/116,i=t/500+o,n=o-s/200,a=c=>c>.2068966?Math.pow(c,3):(c-16/116)/7.787;return[a(i)*z.REF_X,a(o)*z.REF_Y,a(n)*z.REF_Z]}static deltaE00(e,t){const[s,o,i]=e,[n,a,c]=t,d=X=>X*180/Math.PI,l=X=>X*Math.PI/180,p=1,m=1,g=1,u=Math.sqrt(o**2+i**2),v=Math.sqrt(a**2+c**2),f=(u+v)/2,S=.5*(1-Math.sqrt(f**7/(f**7+25**7))),w=o*(1+S),I=a*(1+S),x=Math.sqrt(w**2+i**2),E=Math.sqrt(I**2+c**2),b=i===0&&w===0?0:d(Math.atan2(i,w))%360,R=c===0&&I===0?0:d(Math.atan2(c,I))%360,A=n-s,B=E-x;let N=0;x*E!==0&&(N=R-b,N>180?N-=360:N<-180&&(N+=360));const k=2*Math.sqrt(x*E)*Math.sin(l(N)/2),Z=(s+n)/2,O=(x+E)/2;let L=(b+R)/2;Math.abs(b-R)>180&&(L+=180);const _=1-.17*Math.cos(l(L-30))+.24*Math.cos(l(2*L))+.32*Math.cos(l(3*L+6))-.2*Math.cos(l(4*L-63)),D=1+.015*(Z-50)**2/Math.sqrt(20+(Z-50)**2),G=1+.045*O,$=1+.015*O*_,Y=30*Math.exp((-((L-275)/25))**2),J=-(2*Math.sqrt(O**7/(O**7+25**7)))*Math.sin(l(2*Y));return Math.sqrt((A/(p*D))**2+(B/(m*G))**2+(k/(g*$))**2+J*(B/(m*G))*(k/(g*$)))}static adjustLightness(e,t,s,o,i){const[n,a,c]=z.rgba2lab(e,t,s,o),d=Math.min(100,Math.max(0,n+n*i));return[...z.lab2rgba(d,a,c)]}};r(z,"REF_X",95.047),r(z,"REF_Y",100),r(z,"REF_Z",108.883);let se=z;function ye(h,e){const t=new P(h.x,h.y);for(;t.x>e.x;)t.x-=e.x*2;for(;t.x<-e.x;)t.x+=e.x*2;for(;t.y>e.y;)t.y-=e.y*2;for(;t.y<-e.y;)t.y+=e.y*2;return t}function le(h,e){const t=new M(h.x,h.y);for(;t.x<0;)t.x+=e.x;for(;t.x>e.x;)t.x-=e.x;for(;t.y<0;)t.y+=e.y;for(;t.y>e.y;)t.y-=e.y;return t}function Ze(h,e,t){let s=e.x-h.x,o=e.y-h.y;return Math.abs(s)>t.x/2&&(s>0?s-=t.x:s+=t.x),Math.abs(o)>t.y/2&&(o>0?o-=t.y:o+=t.y),{dx:s,dy:o}}function We(h,e,t,s){const{dx:o,dy:i}=Ze(h,e,s),n=new M(h.x+o*t,h.y+i*t);return le(n,s)}function ne(){return new P(V.instance.canvasSize.x,V.instance.canvasSize.y)}function Se(){return ne().multiply(.5)}class $e{constructor(e,t){r(this,"movieMaker",null);r(this,"stopMotionRecorder",null);r(this,"recordingEdges",[]);r(this,"isRecordingEdges",!1);this.canvas=e,this.container=t}initialize(){this.movieMaker=new Oe({canvas:this.canvas,recorderOptions:{fps:60,videoBitsPerSecond:5e6},animatorOptions:{targetFPS:60}})}getMovieMaker(){return this.movieMaker}startRecordingEdges(){if(this.isRecordingEdges){console.warn("Already recording edges");return}this.isRecordingEdges=!0,this.recordingEdges=[],console.log("Started recording edge additions")}stopRecordingEdges(){if(!this.isRecordingEdges)return console.warn("Not currently recording edges"),0;this.isRecordingEdges=!1;const e=this.recordingEdges.length;return console.log(`Stopped recording. ${e} edges recorded.`),e}recordEdgeAction(e,t,s,o,i){this.isRecordingEdges&&this.recordingEdges.push({type:e,fromNode:t,toNode:s,color:o,weight:i})}getRecordedEdges(){return[...this.recordingEdges]}clearRecordedEdges(){this.recordingEdges=[]}get isRecording(){return this.isRecordingEdges}get recordedEdgeCount(){return this.recordingEdges.length}async createEdgeAdditionMovie(e,t=30){if(this.recordingEdges.length===0)throw new Error("No edges recorded! Use 'Start Recording Edges' first.");const s=this.container.get("graph"),o=this.container.get("app"),i=this.container.get("ui"),n=this.container.get("settings"),a=n.isScaled?n.imageScaleFactor:1,c=new Map;this.recordingEdges.forEach(({type:g,fromNode:u,toNode:v,color:f,weight:S})=>{const w=u.id<v.id?`${u.id}-${v.id}`:`${v.id}-${u.id}`;c.set(w,{lastAction:g,fromNode:u,toNode:v,color:f,weight:S})});const d=[];c.forEach(g=>{const v=s.getEdgesInvolvingNodes([g.fromNode.id,g.toNode.id]).find(f=>f.fromId===g.fromNode.id&&f.toId===g.toNode.id||f.fromId===g.toNode.id&&f.toId===g.fromNode.id);g.lastAction==="add"?v&&s.deleteEdge(v):v||s.addEdge(g.fromNode.id,g.toNode.id,g.color,g.weight)}),o.render();const l=[];this.recordingEdges.forEach(({type:g,fromNode:u,toNode:v,color:f,weight:S},w)=>{const I=e/(t+1),x=s.getNode(u.id),E=s.getNode(v.id),b=x?x.coordinates:u.coordinates,R=E?E.coordinates:v.coordinates,A=S*a,B=new ie({x:b.x,y:b.y},{x:R.x,y:R.y},g==="add"?0:1,!0,f,A,s.zigzagSpacing,s.zigzagLength,s.zigzagEndLengths);for(let N=0;N<=t;N++){const k=N,Z=N/t;l.push({action:()=>{if(g==="add")if(k<t){const L=Math.max(.01,Z);B.setProgress(L),d[w]=B}else d[w]=null,s.addEdge(u.id,v.id,f,A);else if(k===0){const _=s.getEdgesInvolvingNodes([u.id,v.id]).find(D=>D.fromId===u.id&&D.toId===v.id||D.fromId===v.id&&D.toId===u.id);_&&s.deleteEdge(_),B.setProgress(1),d[w]=B}else k<t?B.setProgress(1-Z):d[w]=null;const O=d.filter(L=>L!==null);o.render({x:1,y:1},O)},duration:I})}});const p=this.recordingEdges.filter(g=>g.type==="add").length,m=this.recordingEdges.filter(g=>g.type==="remove").length;i.updateMovieStatus(`Encoding edge animation (${p} additions, ${m} removals)...`);try{const g=new he({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),u=l.map(f=>({render:S=>{f.action(),S.drawImage(this.canvas,0,0)},durationMs:f.duration})),v=await g.encodeVideo(u,(f,S)=>{i.updateMovieStatus(`Encoding: ${f}/${S} frames (${Math.round(f/S*100)}%)`)});this.downloadBlob(v,"edge-animation.webm"),i.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>i.updateMovieStatus(""),3e3)}catch(g){throw console.error("Error creating movie:",g),new Error("Error creating movie: "+g)}finally{d.length=0}}downloadBlob(e,t){const s=URL.createObjectURL(e),o=document.createElement("a");o.style.display="none",o.href=s,o.download=t,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(s)},500)}async createSimulationMovie(e,t,s,o){if(!this.movieMaker)throw new Error("Movie maker not initialized");const i=this.container.get("graph"),n=this.container.get("app"),a=this.container.get("ui"),c=this.container.get("simulations");let d,l;if(e==="force_balance")d=()=>c.doForceBalanceStep(i),l="Force Balance";else if(e==="position_equilibration")d=()=>c.doPositionEquilibrationStep(i),l="Position Equilibration";else throw new Error("Invalid simulation type");const p=new Map;i.getAllNodes().forEach(m=>{p.set(m.id,{x:m.coordinates.x,y:m.coordinates.y})});try{let m=Array(t).fill(s);if(o){const u=p;let v=u;const f=[];for(let I=0;I<t;I++){d();let x=0;i.getAllNodes().forEach(R=>{const A=v.get(R.id);if(A){const B=R.coordinates.x-A.x,N=R.coordinates.y-A.y;x+=Math.sqrt(B*B+N*N)}});const E=x/i.getAllNodes().length;f.push(E);const b=new Map;i.getAllNodes().forEach(R=>{b.set(R.id,{x:R.coordinates.x,y:R.coordinates.y})}),v=b}const S=t*s,w=f.reduce((I,x)=>I+x,0);m=f.map(I=>I>0?Math.min(S,S/w*I):s),i.getAllNodes().forEach(I=>{const x=u.get(I.id);x&&(I.coordinates.x=x.x,I.coordinates.y=x.y)})}const g=[];if(o)for(let u=0;u<t;u++){const v=m[u],f=Math.max(1,Math.ceil(v/s)),S=new Map;i.getAllNodes().forEach(E=>{S.set(E.id,{x:E.coordinates.x,y:E.coordinates.y})}),d();const w=new Map;i.getAllNodes().forEach(E=>{w.set(E.id,{x:E.coordinates.x,y:E.coordinates.y})}),i.getAllNodes().forEach(E=>{const b=S.get(E.id);b&&(E.coordinates.x=b.x,E.coordinates.y=b.y)});const I=f+1,x=v/I;for(let E=0;E<=f;E++){const b=E/f;g.push({action:()=>{const R=ne();i.getAllNodes().forEach(A=>{const B=S.get(A.id),N=w.get(A.id);if(B&&N){const k=We(B,N,b,R);A.coordinates.x=k.x,A.coordinates.y=k.y}}),n.render()},duration:x})}i.getAllNodes().forEach(E=>{const b=w.get(E.id);b&&(E.coordinates.x=b.x,E.coordinates.y=b.y)})}else for(let u=0;u<t;u++)g.push({action:()=>{d(),n.render()},duration:s});a.updateMovieStatus(`Encoding ${l} simulation (${t} steps${o?" with adaptive duration":""})...`);try{const u=new he({width:this.canvas.width,height:this.canvas.height,fps:60,videoBitsPerSecond:5e6}),v=g.map(S=>({render:w=>{S.action(),w.drawImage(this.canvas,0,0)},durationMs:S.duration})),f=await u.encodeVideo(v,(S,w)=>{a.updateMovieStatus(`Encoding: ${S}/${w} frames (${Math.round(S/w*100)}%)`)});this.downloadBlob(f,`${e}-simulation.webm`),a.updateMovieStatus("Movie saved successfully!"),setTimeout(()=>a.updateMovieStatus(""),3e3)}catch(u){throw console.error("Error creating movie:",u),new Error("Error creating movie: "+u)}}finally{i.getAllNodes().forEach(m=>{const g=p.get(m.id);g&&(m.coordinates.x=g.x,m.coordinates.y=g.y)})}}getStopMotionRecorder(){return this.stopMotionRecorder||(this.stopMotionRecorder=new _e({canvas:this.canvas,frameDuration:500})),this.stopMotionRecorder}startStopMotionRecording(){this.getStopMotionRecorder().start(),console.log("Stop-motion recording started")}captureStopMotionFrame(){const e=this.getStopMotionRecorder();return e.captureFrame(),e.getFrameCount()}removeLastStopMotionFrame(){const e=this.getStopMotionRecorder();return e.removeLastFrame(),e.getFrameCount()}stopStopMotionRecording(){const e=this.getStopMotionRecorder(),t=e.getFrameCount();return e.stop(),console.log(`Stop-motion recording stopped with ${t} frames`),t}getStopMotionFrameCount(){return this.getStopMotionRecorder().getFrameCount()}isStopMotionRecording(){return this.getStopMotionRecorder().getIsRecording()}setStopMotionFrameDuration(e){this.getStopMotionRecorder().setFrameDuration(e)}getStopMotionFrameDuration(){return this.getStopMotionRecorder().getFrameDuration()}clearStopMotionFrames(){this.getStopMotionRecorder().clear()}async createStopMotionMovie(e){const t=this.getStopMotionRecorder(),s=this.container.get("ui"),o=t.getFrameCount();if(o===0)throw new Error("No frames captured! Capture some frames first.");s.updateMovieStatus(`Encoding stop-motion animation (${o} frames)...`);try{const i=await t.encode((a,c)=>{s.updateMovieStatus(`Encoding: ${a}/${c} frames (${Math.round(a/c*100)}%)`)}),n=e||"stop-motion-animation.webm";this.downloadBlob(i,n),s.updateMovieStatus("Stop-motion movie saved successfully!"),setTimeout(()=>s.updateMovieStatus(""),3e3)}catch(i){throw console.error("Error creating stop-motion movie:",i),s.updateMovieStatus("Error creating movie!"),i}}}class qe{constructor(){r(this,"selectedItems",[])}toggleItems(e){e.forEach(t=>{this.hasItem(t)?this.removeItem(t):this.addItem(t)})}addItem(e){this.selectedItems.push(e)}setItem(e){this.selectedItems=[e]}hasItem(e){return this.selectedItems.includes(e)}hasItems(e){return e.every(t=>this.hasItem(t))}setSelectedItems(e){this.selectedItems=e}removeItem(e){this.selectedItems=this.selectedItems.filter(t=>t!==e)}removeLastItem(){this.selectedItems.length>0&&this.selectedItems.pop()}getSelectedItems(){return this.selectedItems}getItemsOfClass(e){return this.selectedItems.filter(t=>t instanceof e)}clearSelection(){this.selectedItems=[]}get empty(){return this.selectedItems.length===0}get length(){return this.selectedItems.length}}const C=new qe;function Ve(h,e){const t=new P(h.coordinates.x,h.coordinates.y);return new P(e.coordinates.x,e.coordinates.y).subtract(t)}function Ye(){const h=ne(),e=Se();C.getItemsOfClass(F).forEach(s=>{const o=y.getNodesConnectedToNode(s.id);let i=new P(0,0);o.forEach(a=>{const c=Ve(s,a),d=ye(c,e).multiply(1/o.length);i=i.add(d)});const n=le(new P(i.x+s.coordinates.x,i.y+s.coordinates.y),h);s.coordinates.x=n.x,s.coordinates.y=n.y})}function Xe(h){const e=ne(),t=document.getElementById("randomWalkStepSize").valueAsNumber,s=document.getElementById("randomWalkMaxAngle").valueAsNumber*Math.PI/180,o=document.getElementById("randomWalkSteps").valueAsNumber,i=[],n=[],a=document.getElementById("vertexRadius").valueAsNumber,c=document.getElementById("vertexStrokeWidth").valueAsNumber,d=document.getElementById("nodeFillColor").value,l=document.getElementById("nodeColor").value,p=new F(y.getNextNodeId(),h,a,c,d,l);i.push(p);let m=new M(h.x,h.y),g=Math.random()*2*Math.PI;const u=document.getElementById("edgeColor").value,v=parseFloat(document.getElementById("lineWidth").value);for(let f=0;f<o;f++){const S=(Math.random()*2-1)*s;g+=S;const w=m.x+t*Math.cos(g),I=m.y+t*Math.sin(g);m=new M(w,I),m=le(m,e);const x=new F(y.getNextNodeId()+f+1,m,a,c,d,l);i.push(x);const E=i[i.length-2],b=new de(E.id,x.id,-1,v,u);n.push(b)}return{nodes:i,edges:n}}function Ue(){const h=C.getItemsOfClass(F);if(console.log("Equilibrating "+h.length+" nodes..."),h.length<1)return;const e=Se(),t=25;for(const s of h){let o=new P(0,0);for(const n of y.getAllNodes()){if(s.id===n.id)continue;const a=new P(s.coordinates.x,s.coordinates.y);let d=new P(n.coordinates.x,n.coordinates.y).subtract(a);d=ye(d,e);const l=Math.sqrt(d.x*d.x+d.y*d.y);if(l>0){const p=t/(l*l),m=d.multiply(-p);o=o.add(m)}}o.x>s.radius&&(o.x=s.radius),o.x<-s.radius&&(o.x=-s.radius),o.y>s.radius&&(o.y=s.radius),o.y<-s.radius&&(o.y=-s.radius);const i=new P(s.coordinates.x+o.x,s.coordinates.y+o.y);s.coordinates=i}}class q{static serialize(e,t){return{version:this.STORAGE_VERSION,timestamp:new Date().toISOString(),graph:e,settings:t}}static deserialize(e,t,s){try{return e.version&&e.version!==this.STORAGE_VERSION&&console.warn(`State version mismatch. Expected ${this.STORAGE_VERSION}, got ${e.version}`),"settings"in e?(e.graph&&t.fromJSON(e.graph),e.settings&&this.applySettings(e.settings,s)):t.fromJSON(e),!0}catch(o){return console.error("Failed to deserialize state:",o),!1}}static applySettings(e,t){e.canvasSize&&(t.canvasSize.x=e.canvasSize.x,t.canvasSize.y=e.canvasSize.y),e.backgroundColor!==void 0&&(t.backgroundColor=e.backgroundColor),e.imageScaleFactor!==void 0&&(t.imageScaleFactor=e.imageScaleFactor),e.disablePBC!==void 0&&(t.disablePBC=e.disablePBC)}static saveState(e,t){try{const s=this.serialize(e,t);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),console.log("State saved to localStorage")}catch(s){console.error("Failed to save state to localStorage:",s)}}static loadState(e,t){try{const s=localStorage.getItem(this.STORAGE_KEY);if(!s)return console.log("No saved state found in localStorage"),!1;const o=JSON.parse(s),i=this.deserialize(o,e,t);return i&&console.log(`State loaded from localStorage (saved at ${o.timestamp||"unknown time"})`),i}catch(s){return console.error("Failed to load state from localStorage:",s),!1}}static clearState(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("State cleared from localStorage")}catch(e){console.error("Failed to clear state from localStorage:",e)}}static hasSavedState(){try{return localStorage.getItem(this.STORAGE_KEY)!==null}catch(e){return console.error("Failed to check for saved state:",e),!1}}}r(q,"STORAGE_KEY","polymer-graph-sketcher-state"),r(q,"STORAGE_VERSION","1.0");function we(h,e){if(h===e)return;if(h>e)return we(e,h);y.getEdgesInvolvingNode(e).forEach(i=>{i.fromId===e?i.fromId=h:i.toId=h});const s=y.getNode(h),o=y.getNode(e);s.coordinates.x=(s.coordinates.x+o.coordinates.x)/2,s.coordinates.y=(s.coordinates.y+o.coordinates.y)/2,y.deleteNode(e)}function Ge(h){let e;do{e=!1;for(const t of y.getAllEdges())if(t.color===h){we(t.fromId,t.toId),y.deleteEdge(t),e=!0;break}}while(e);C.clearSelection()}function Ke(){const h=y.getAllNodes();for(const e of h){const t=y.getEdgesInvolvingNode(e.id);t.length===2&&t[0].color===t[1].color&&t[0].weight===t[1].weight&&(y.deleteEdge(t[0]),y.deleteEdge(t[1]),y.addEdge(t[0].fromId==e.id?t[0].toId:t[0].fromId,t[1].fromId==e.id?t[1].toId:t[1].fromId,t[0].color,t[0].weight),y.deleteNode(e.id))}}class je{constructor(e){r(this,"container");this.container=e}generateSideChains(e,t,s,o){const i=this.container.get("selection"),n=this.container.get("graph"),a=this.container.get("actionManager"),c=this.container.get("nodeCounter"),d=this.container.get("ui");i.getItemsOfClass(F).forEach(p=>{const m=n.getEdgesInvolvingNode(p.id);if(m.length!==2)return;const g=n.getNode(m[0].getOtherNodeId(p.id)),u=n.getNode(m[1].getOtherNodeId(p.id));if(!g||!u)return;const v=u.coordinates.x-g.coordinates.x,f=u.coordinates.y-g.coordinates.y,S=Math.sqrt(v*v+f*f),w=v/S,I=f/S,x=-I,E=w,b=I,R=-w,A=Math.floor(t),B=t-A,N=A+(Math.random()<B?1:0);let k=Math.random()<.5;const Z=this.container.get("AddNodeAction"),O=this.container.get("AddEdgeAction");for(let L=0;L<N;L++){k=!k;const _=k?x:b,D=k?E:R,G=Math.PI*o,$=(Math.random()*2-1)*G,Y=Math.cos($),K=Math.sin($),J=_*Y-D*K,X=_*K+D*Y,H=p.coordinates.x+J*e*(1-s*Math.random()),Q=p.coordinates.y+X*e*(1-s*Math.random()),ee=c.value++,re=new F(ee,{x:H,y:Q},p.radius,p.strokeWidth,p.fillColor,p.strokeColor);a.addAction(new Z(ee,{x:H,y:Q},d)),a.addAction(new O(p,[re],d))}})}removeBifunctionalNodes(){const e=this.container.get("app");Ke(),e.render()}mergeEdgesByColor(e){const t=this.container.get("app");Ge(e),t.render()}removeDuplicateEdges(){const e=this.container.get("graph"),t=this.container.get("app");e.removeDuplicateEdges(),t.render()}removeSelfEdges(){const e=this.container.get("graph"),t=this.container.get("app");e.cleanupEdges(),t.render()}clearGraph(){const e=this.container.get("graph"),t=this.container.get("selection"),s=this.container.get("modeFactory"),o=this.container.get("app");e.clear(),t.clearSelection(),s.setCurrentMode("vertex"),o.render()}}class Je{constructor(e,t){r(this,"svg");r(this,"lastElement");r(this,"currentGroup",null);r(this,"prevState",null);r(this,"currentXOffset",0);r(this,"currentYOffset",0);r(this,"currentRotationRad",0);r(this,"currentX",0);r(this,"currentY",0);r(this,"canvas");r(this,"globalAlpha",1);r(this,"globalCompositeOperation");r(this,"fillStyle");r(this,"strokeStyle");r(this,"filter");r(this,"imageSmoothingEnabled");r(this,"imageSmoothingQuality");r(this,"lineCap","butt");r(this,"lineDashOffset");r(this,"lineJoin","round");r(this,"lineWidth",0);r(this,"miterLimit");r(this,"shadowBlur");r(this,"shadowColor");r(this,"shadowOffsetX");r(this,"shadowOffsetY");r(this,"direction","ltr");r(this,"font");r(this,"fontKerning");r(this,"fontStretch","normal");r(this,"fontVariantCaps","normal");r(this,"letterSpacing");r(this,"textAlign","left");r(this,"textBaseline");r(this,"textRendering");r(this,"wordSpacing");this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",e.toString()),this.svg.setAttribute("height",t.toString()),this.lastElement=this.svg}addElement(e){this.currentGroup?this.currentGroup.appendChild(e):this.svg.appendChild(e),this.lastElement=e}pointIsOnCanvas(e){const t={width:parseFloat(this.svg.getAttribute("width")),height:parseFloat(this.svg.getAttribute("height"))};return e.x>=0&&e.x<=t.width&&e.y>=0&&e.y<=t.height}rect(e,t,s,o){const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",e.toString()),i.setAttribute("y",t.toString()),i.setAttribute("width",s.toString()),i.setAttribute("height",o.toString()),this.addElement(i)}clearRect(e,t,s,o){this.rect(e,t,s,o),this.lastElement.setAttribute("style","background-color: white; fill: white;")}fillRect(e,t,s,o){this.rect(e,t,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!0,!1)+";stroke:none;")}strokeRect(e,t,s,o){this.rect(e,t,s,o),this.lastElement.setAttribute("style",this.stylesToCSS(!1,!0)+";fill:none;")}arc(e,t,s,o,i){const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx",e.toString()),n.setAttribute("cy",t.toString()),n.setAttribute("r",s.toString()),n.setAttribute("style",this.stylesToCSS(!0,!0)),this.addElement(n)}moveTo(e,t){this.currentX=e,this.currentY=t}rotate(e){this.currentRotationRad+=e}translate(e,t){this.currentXOffset+=e,this.currentYOffset+=t}lineTo(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","line"),o=Math.cos(this.currentRotationRad)*this.currentX-Math.sin(this.currentRotationRad)*this.currentY,i=Math.sin(this.currentRotationRad)*this.currentX+Math.cos(this.currentRotationRad)*this.currentY,n=Math.cos(this.currentRotationRad)*e-Math.sin(this.currentRotationRad)*t,a=Math.sin(this.currentRotationRad)*e+Math.cos(this.currentRotationRad)*t,c=new M(o+this.currentXOffset,i+this.currentYOffset),d=new M(n+this.currentXOffset,a+this.currentYOffset);s.setAttribute("x1",c.x.toString()),s.setAttribute("y1",c.y.toString()),s.setAttribute("x2",d.x.toString()),s.setAttribute("y2",d.y.toString()),s.setAttribute("style",this.stylesToCSS(!1,!0)),this.lineCap&&s.setAttribute("stroke-linecap",this.lineCap),(this.pointIsOnCanvas(c)||this.pointIsOnCanvas(d)||c.x<=0&&d.x>=parseFloat(this.svg.getAttribute("width"))||c.y<=0&&d.y>=parseFloat(this.svg.getAttribute("height")))&&this.addElement(s),this.currentX=e,this.currentY=t}stroke(){this.addStyles(this.stylesToCSS(!1,!0))}fill(e,t){if(e||t)throw new Error("Method not implemented.");this.addStyles(this.stylesToCSS(!0,!1))}addStyles(e){if(this.lastElement){const t=this.lastElement.getAttribute("style"),s=this.parseStyles(e);if(t){const o=this.parseStyles(t);for(const[i,n]of Object.entries(o))s[i]||(s[i]=n)}this.lastElement.setAttribute("style",this.styleMapToString(s));for(const[o,i]of Object.entries(s))this.lastElement.setAttribute(o,i)}}parseStyles(e){const t={};return e.split(";").forEach(o=>{const[i,n]=o.trim().split(":");t[i.trim()]=n.trim()}),t}styleMapToString(e){return Object.entries(e).map(([t,s])=>`${t}: ${s}`).join("; ")}restore(){if(this.prevState)this.fillStyle=this.prevState.fillStyle,this.strokeStyle=this.prevState.strokeStyle,this.lineWidth=this.prevState.lineWidth,this.currentX=this.prevState.currentX,this.currentY=this.prevState.currentY,this.lastElement=this.prevState.lastElement,this.currentXOffset=this.prevState.currentXOffset,this.currentYOffset=this.prevState.currentYOffset,this.currentRotationRad=this.prevState.currentRotationRad,this.prevState=null,this.currentGroup=null;else throw new Error("No state to restore.")}save(){if(this.prevState)throw new Error("Only one state can be saved at a time.");this.prevState={fillStyle:this.fillStyle,strokeStyle:this.strokeStyle,lineWidth:this.lineWidth,currentX:this.currentX,currentY:this.currentY,lastElement:this.lastElement,currentXOffset:this.currentXOffset,currentYOffset:this.currentYOffset,currentRotationRad:this.currentRotationRad};const e=document.createElementNS("http://www.w3.org/2000/svg","g");this.svg.appendChild(e),this.lastElement=e,this.currentGroup=e}stylesToCSS(e=!0,t=!0){let s={"stroke-width":this.lineWidth.toString(),"stroke-linecap":this.lineCap||"butt"};return e&&this.fillStyle&&(s.fill=this.fillStyle.toString()),t&&this.strokeStyle&&(s.stroke=this.strokeStyle.toString()),this.styleMapToString(s)}getSVG(){return this.svg}beginPath(){}closePath(){}getContextAttributes(){throw new Error("Method not implemented.")}drawImage(e,t,s,o,i,n,a,c,d){throw new Error("Method not implemented.")}clip(e,t){throw new Error("Method not implemented.")}isPointInPath(e,t,s,o){throw new Error("Method not implemented.")}isPointInStroke(e,t,s){throw new Error("Method not implemented.")}createConicGradient(e,t,s){throw new Error("Method not implemented.")}createLinearGradient(e,t,s,o){throw new Error("Method not implemented.")}createPattern(e,t){throw new Error("Method not implemented.")}createRadialGradient(e,t,s,o,i,n){throw new Error("Method not implemented.")}createImageData(e,t,s){throw new Error("Method not implemented.")}getImageData(e,t,s,o,i){throw new Error("Method not implemented.")}putImageData(e,t,s,o,i,n,a){throw new Error("Method not implemented.")}arcTo(e,t,s,o,i){throw new Error("Method not implemented.")}scale(e,t){throw new Error("Method not implemented.")}bezierCurveTo(e,t,s,o,i,n){throw new Error("Method not implemented.")}ellipse(e,t,s,o,i,n,a,c){throw new Error("Method not implemented.")}quadraticCurveTo(e,t,s,o){throw new Error("Method not implemented.")}roundRect(e,t,s,o,i){throw new Error("Method not implemented.")}getLineDash(){throw new Error("Method not implemented.")}setLineDash(e){throw new Error("Method not implemented.")}isContextLost(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}fillText(e,t,s,o){throw new Error("Method not implemented.")}measureText(e){throw new Error("Method not implemented.")}strokeText(e,t,s,o){throw new Error("Method not implemented.")}getTransform(){throw new Error("Method not implemented.")}resetTransform(){throw new Error("Method not implemented.")}setTransform(e,t,s,o,i,n){throw new Error("Method not implemented.")}transform(e,t,s,o,i,n){throw new Error("Method not implemented.")}drawFocusIfNeeded(e,t){throw new Error("Method not implemented.")}}class He{constructor(e){r(this,"container");this.container=e}exportGraph(){const e=this.container.get("graph"),t=this.container.get("settings"),s=q.serialize(e,t),o=new Blob([JSON.stringify(s)],{type:"application/json"}),i=URL.createObjectURL(o),n=document.createElement("a");n.href=i,n.download="graph.json",n.click(),URL.revokeObjectURL(i)}importGraph(e){const t=this.container.get("graph"),s=this.container.get("settings"),o=this.container.get("ui"),i=this.container.get("canvas"),n=this.container.get("app"),a=new FileReader;a.onload=c=>{var d;if((d=c.target)!=null&&d.result)try{const l=JSON.parse(c.target.result);if(q.deserialize(l,t,s)){i.resize(s.canvasSize.x,s.canvasSize.y),o.updateCanvasSizeUI(s.canvasSize.x,s.canvasSize.y);const m=this.container.get("nodeCounter");if(m&&t.getNrOfNodes()>0){const g=t.getAllNodeIds();m.value=Math.max(...g)+1}n.render()}else alert("Failed to import graph. The file may be corrupted or in an incompatible format.")}catch(l){console.error("Error importing graph:",l),alert("Failed to import graph. Please check the file format.")}},a.readAsText(e)}saveCanvasAsImage(e){const t=this.container.get("app"),s=this.container.get("canvas"),o=()=>{t.render();const i=s.toDataURL("image/png"),n=document.createElement("a");n.href=i,n.download="polymer-graph-sketch.png",n.click()};e?e(o):o()}saveGraphAsSvg(){const e=this.container.get("settings"),t=this.container.get("app"),s=new Je(e.canvasSize.x,e.canvasSize.y);t.elementsToDraw.value.forEach(a=>{a.draw(s)});const o=s.getSVG(),i=new XMLSerializer().serializeToString(o),n=document.createElement("a");n.href="data:image/svg+xml;base64,"+btoa(i),n.download="graph.svg",n.click()}}class Qe{constructor(e){r(this,"doneStack",[]);r(this,"undoneStack",[]);r(this,"afterActionCallback");this.afterActionCallback=e}addAction(e){this.doneStack.push(e),e.do(),this.undoneStack=[],this.afterActionCallback()}undo(){if(this.doneStack.length){const e=this.doneStack.pop();e.undo(),this.undoneStack.push(e),this.afterActionCallback()}}redo(){if(this.undoneStack.length){const e=this.undoneStack.pop();e.do(),this.doneStack.push(e),this.afterActionCallback()}}}class et{constructor(e,t,s){r(this,"affectedNodes");r(this,"originalValues");r(this,"targetValue");r(this,"property");this.affectedNodes=e,this.originalValues=e.map(o=>o[s]),this.targetValue=t,this.property=s}do(){this.affectedNodes.forEach(e=>{e[this.property]=this.targetValue})}undo(){this.affectedNodes.forEach((e,t)=>{e[this.property]=this.originalValues[t]})}}class tt{constructor(e,t,s){r(this,"affectedNodes");r(this,"originalPositions");r(this,"newPositions");this.affectedNodes=e,this.originalPositions=t.map(o=>new M(o.x,o.y)),this.newPositions=s.map(o=>new M(o.x,o.y))}do(){this.affectedNodes.forEach((e,t)=>{e.coordinates.x=this.newPositions[t].x,e.coordinates.y=this.newPositions[t].y})}undo(){this.affectedNodes.forEach((e,t)=>{e.coordinates.x=this.originalPositions[t].x,e.coordinates.y=this.originalPositions[t].y})}}class st{constructor(e){this.nodes=e}do(){this.nodes.forEach(e=>{y.setNode(new F(e.id,e.coordinates,e.radius,e.strokeWidth,e.fillColor,e.strokeColor))}),C.setSelectedItems(this.nodes.map(e=>y.getNode(e.id)))}undo(){this.nodes.forEach(e=>{y.deleteNode(e.id)})}}class Ee{constructor(e,t,s){this.nodeId=e,this.position=t,this.uiFacade=s}do(){y.setNode(new F(this.nodeId,this.position,this.uiFacade.getInputValueAsNumber("vertexRadius"),this.uiFacade.getInputValueAsNumber("vertexStrokeWidth"),this.uiFacade.getInputValue("nodeFillColor"),this.uiFacade.getInputValue("nodeColor"))),C.setItem(y.getNode(this.nodeId))}undo(){y.deleteNode(this.nodeId)}}class Me{constructor(e){r(this,"affectedEdges",[]);this.affectedNodes=e}do(){this.affectedNodes.forEach(e=>{y.getEdgesInvolvingNode(e.id).forEach(t=>{this.affectedEdges.push(t)}),C.removeItem(e),y.deleteNode(e.id)})}undo(){this.affectedNodes.forEach(e=>{y.setNode(e),C.addItem(e)}),this.affectedEdges.forEach(e=>{y.addEdge(e.fromId,e.toId,e.color,e.weight)})}}class j{constructor(e,t=!1){r(this,"previousSelectedNodes",C.getSelectedItems());this.affectedNodes=e,this.clearSelection=t}do(){this.clearSelection?C.setSelectedItems(this.affectedNodes):this.affectedNodes.forEach(e=>{C.addItem(e)})}undo(){C.setSelectedItems(this.previousSelectedNodes)}}class ot{constructor(e){r(this,"previousSelectedNodes",C.getSelectedItems());this.affectedNodes=e,this.affectedNodes.forEach(t=>{this.previousSelectedNodes.includes(t)||console.warn("Trying to unselect a node that is not selected")}),console.log("Unselecting nodes:",this.affectedNodes)}do(){C.setSelectedItems(this.previousSelectedNodes.filter(e=>!(e instanceof F&&this.affectedNodes.includes(e))))}undo(){C.setSelectedItems(this.previousSelectedNodes)}}class Ce{constructor(e=C.getItemsOfClass(F)){this.previousSelectedNodes=e}do(){C.setSelectedItems(y.getAllNodes())}undo(){C.setSelectedItems(this.previousSelectedNodes)}}class Ie{constructor(e=C.getSelectedItems()){this.previousSelectedNodes=e}do(){C.clearSelection()}undo(){C.setSelectedItems(this.previousSelectedNodes)}}class xe{constructor(e=C.getSelectedItems()){this.previousSelectedNodes=e}do(){C.toggleItems(y.getAllNodes())}undo(){C.setSelectedItems(this.previousSelectedNodes)}}class it{constructor(e,t,s){r(this,"edgeIds",[]);if(this.edgesFrom=e,this.edgesTo=t,this.uiFacade=s,e.length!==t.length)throw new Error("edgesFrom and edgesTo must have the same length")}do(){for(let e=0;e<this.edgesFrom.length;e++)this.edgeIds.push(y.addEdge(this.edgesFrom[e],this.edgesTo[e],this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}undo(){this.edgeIds.slice().reverse().forEach(e=>{y.deleteEdge(e)})}}class be{constructor(e,t,s){r(this,"edgeIds",[]);this.fromNode=e,this.affectedNodes=t,this.uiFacade=s}do(){this.affectedNodes.forEach(e=>{this.edgeIds.push(y.addEdge(this.fromNode.id,e.id,this.uiFacade.getInputValue("edgeColor"),this.uiFacade.getInputValueAsNumber("lineWidth")))}),this.affectedNodes.length<=1&&C.setItem(this.fromNode)}undo(){this.edgeIds.slice().reverse().forEach(e=>{y.deleteEdge(e)}),C.setSelectedItems(this.affectedNodes)}}class nt{constructor(e,t){r(this,"edges",[]);this.additionalNode=t,t&&e.push(t),this.edges=y.getEdgesInvolvingNodes(e.map(s=>s.id))}do(){this.edges.forEach(e=>{y.deleteEdge(e)}),this.additionalNode&&C.addItem(this.additionalNode)}undo(){this.edges.forEach(e=>{y.addEdge(e.fromId,e.toId,e.color,e.weight)}),this.additionalNode&&C.removeItem(this.additionalNode)}}class rt{constructor(e){r(this,"container");r(this,"canvas");r(this,"dragStart",null);r(this,"draggedNodes",[]);r(this,"originalNodePositions",[]);r(this,"isDraggingNode",!1);this.container=e,this.canvas=e.get("canvas").canvas}attachEventListeners(){this.canvas.addEventListener("click",this.handleClick.bind(this)),window.addEventListener("mousedown",this.handleMouseDown.bind(this)),window.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleClick(e){if(this.dragStart)return;const s=this.container.get("canvas").clientToCanvasCoordinates(e.clientX,e.clientY),i=this.container.get("modeFactory").getCurrentMode(),n=this.container.get("actionManager");i&&i.onCanvasClick(s,n)}handleMouseDown(e){this.dragStart={x:e.clientX,y:e.clientY};const s=this.container.get("modeFactory").getCurrentMode(),i=this.container.get("canvas").clientToCanvasCoordinates(e.clientX,e.clientY),a=this.container.get("graph").findNodeByCoordinates(i.x,i.y);if(s&&s.onMouseDown)if(s.onMouseDown(e),a){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(F),this.originalNodePositions=this.draggedNodes.map(d=>new M(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1;else if(a){const c=this.container.get("selection");this.draggedNodes=c.getItemsOfClass(F),this.originalNodePositions=this.draggedNodes.map(d=>new M(d.coordinates.x,d.coordinates.y)),this.isDraggingNode=!0}else this.isDraggingNode=!1}handleMouseMove(e){if(!this.dragStart)return;const s=this.container.get("modeFactory").getCurrentMode();if(this.isDraggingNode){const o=e.clientX-this.dragStart.x,i=e.clientY-this.dragStart.y,n=this.container.get("selection"),a=V.instance,c=this.container.get("app");n.getItemsOfClass(F).forEach(d=>{d.coordinates.x+=o,d.coordinates.y+=i,d.coordinates.x<0&&(d.coordinates.x+=a.canvasSize.x),d.coordinates.x>=a.canvasSize.x&&(d.coordinates.x-=a.canvasSize.x),d.coordinates.y<0&&(d.coordinates.y+=a.canvasSize.y),d.coordinates.y>=a.canvasSize.y&&(d.coordinates.y-=a.canvasSize.y)}),this.dragStart={x:e.clientX,y:e.clientY},c.render();return}if(s&&s.onMouseMove){s.onMouseMove(e);return}}handleMouseUp(e){const s=this.container.get("modeFactory").getCurrentMode();if(this.dragStart&&this.isDraggingNode&&this.draggedNodes.length>0){const o=this.draggedNodes.map(n=>new M(n.coordinates.x,n.coordinates.y));if(this.originalNodePositions.some((n,a)=>n.x!==o[a].x||n.y!==o[a].y)){const n=this.container.get("actionManager"),a=new tt(this.draggedNodes,this.originalNodePositions,o);a.undo(),n.addAction(a)}}else s&&s.onMouseUp&&s.onMouseUp(e);this.dragStart=null,this.draggedNodes=[],this.originalNodePositions=[],this.isDraggingNode=!1}detachEventListeners(){this.canvas.removeEventListener("click",this.handleClick.bind(this)),window.removeEventListener("mousedown",this.handleMouseDown.bind(this)),window.removeEventListener("mousemove",this.handleMouseMove.bind(this)),window.removeEventListener("mouseup",this.handleMouseUp.bind(this))}}class at{constructor(e){r(this,"container");this.container=e}attachListener(e,t,s){const o=document.getElementById(e);o&&o.addEventListener(t,i=>s(o,i))}attachButtonClick(e,t){this.attachListener(e,"click",t)}attachInputChange(e,t){this.attachListener(e,"change",s=>t(s))}attachEventListeners(){this.attachModeSwitch(),this.attachNodePropertyListeners(),this.attachEdgePropertyListeners(),this.attachCanvasPropertyListeners(),this.attachButtonListeners(),this.attachRedrawListeners()}attachModeSwitch(){const e=document.getElementById("modeSwitch");e&&e.addEventListener("click",()=>{this.container.get("modeFactory").setCurrentMode(e.value)})}attachNodePropertyListeners(){const e=this.container.get("actionManager"),t=this.container.get("selection"),s=(o,i)=>n=>{if(t.empty)return;const a=i(n.value);e.addAction(new et(t.getItemsOfClass(F),a,o))};this.attachInputChange("vertexRadius",s("radius",parseFloat)),this.attachInputChange("vertexStrokeWidth",s("strokeWidth",parseFloat)),this.attachInputChange("nodeFillColor",s("fillColor",o=>o)),this.attachInputChange("nodeColor",s("strokeColor",o=>o)),this.attachInputChange("selectVerticesStroke",o=>{const i=this.container.get("graph");e.addAction(new j(i.getAllNodes().filter(n=>se.deltaE00(se.hex2lab(n.strokeColor),se.hex2lab(o.value))<10),!0))})}attachEdgePropertyListeners(){const e=this.container.get("graph"),t=this.container.get("selection"),s=this.container.get("app"),o=(i,n)=>a=>{const c=t.getItemsOfClass(F).map(d=>d.id);e.getEdgesWithBothEndsInNodes(c).forEach(d=>{d[i]=n(a.value)}),s.render()};this.attachInputChange("edgeColor",o("color",i=>i)),this.attachInputChange("lineWidth",o("weight",parseFloat))}attachCanvasPropertyListeners(){const e=this.container.get("actionManager"),t=this.container.get("settings"),s=this.container.get("canvas"),o=this.container.get("app"),i=this.container.get("graph"),n=this.container,a=(c,d)=>{const l=c==="x"?"width":"height",p=t.canvasSize[c],m=g=>{const u=document.getElementById("canvas-parent");u.style[l]=g+"px",t.canvasSize[c]=g;const f=n.get("ui").getInputChecked("resizeElements"),S=s.resizeWithGraphScaling(t.canvasSize.x,t.canvasSize.y,f,i);o.render({x:S.xScaling,y:S.yScaling}),document.getElementById("canvas-size").textContent=`Canvas size: ${t.canvasSize.x}x${t.canvasSize.y}`};return{do:()=>m(d),undo:()=>m(p)}};this.attachInputChange("canvasWidth",c=>{const d=parseFloat(c.value);e.addAction(a("x",d))}),this.attachInputChange("canvasHeight",c=>{const d=parseFloat(c.value);e.addAction(a("y",d))}),this.attachInputChange("disablePBC",c=>{t.disablePBC=c.checked,o.render()})}attachButtonListeners(){const e=this.container.get("actionManager"),t=this.container.get("graphOperations"),s=this.container.get("fileService");this.attachButtonClick("clearSelectionButton",()=>{e.addAction(new Ie)}),this.attachButtonClick("selectAllButton",()=>{e.addAction(new Ce)}),this.attachButtonClick("invertSelectionButton",()=>{e.addAction(new xe)}),this.attachButtonClick("clearCanvasButton",()=>{t.clearGraph()}),this.attachButtonClick("clearSavedStateButton",()=>{if(confirm("Are you sure you want to clear the saved state? This action cannot be undone.")){const n=this.container.get("StorageService");n&&(n.clearState(),alert("Saved state has been cleared. The current canvas will be saved when you leave or reload the page."))}}),this.attachButtonClick("exportGraphButton",()=>s.exportGraph()),this.attachButtonClick("saveImageButton",()=>this.saveCanvasAsImage()),this.attachButtonClick("saveSvgButton",()=>s.saveGraphAsSvg()),this.attachInputChange("import",()=>this.importGraph()),this.attachButtonClick("startRecordingEdgesBtn",()=>this.startEdgeRecording()),this.attachButtonClick("stopRecordingEdgesBtn",()=>this.stopEdgeRecording()),this.attachButtonClick("createEdgeMovieBtn",()=>this.createEdgeAdditionMovie()),this.attachButtonClick("createSimMovieBtn",()=>this.createSimulationMovie()),this.attachButtonClick("startStopMotionBtn",()=>this.startStopMotionRecording()),this.attachButtonClick("captureFrameBtn",()=>this.captureStopMotionFrame()),this.attachButtonClick("removeLastFrameBtn",()=>this.removeLastStopMotionFrame()),this.attachButtonClick("stopStopMotionBtn",()=>this.stopStopMotionRecording()),this.attachButtonClick("createStopMotionMovieBtn",()=>this.createStopMotionMovie()),this.attachButtonClick("clearStopMotionFramesBtn",()=>this.clearStopMotionFrames()),this.attachButtonClick("removeDuplicateEdges",()=>{t.removeDuplicateEdges()}),this.attachButtonClick("removeSelfEdges",()=>{t.removeSelfEdges()});const o=this.container.get("graph"),i=this.container.get("app");this.attachButtonClick("forceBalanceStep",()=>{const n=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nForceBalanceSteps")||1;for(let d=0;d<c;d++)n.doForceBalanceStep(o);i.render()}),this.attachButtonClick("positionEquilibrationStep",()=>{const n=this.container.get("simulations"),c=this.container.get("ui").getInputValueAsNumber("nPositionEquilibrationSteps")||1;for(let d=0;d<c;d++)n.doPositionEquilibrationStep(o);i.render()}),this.attachButtonClick("sideChainGenerationButton",()=>this.generateSideChains()),this.attachButtonClick("bifunctionalRemoval",()=>t.removeBifunctionalNodes()),this.attachInputChange("mergeConnectionColor",n=>t.mergeEdgesByColor(n.value))}attachRedrawListeners(){const e=this.container.get("app"),t=document.getElementsByClassName("redraw-onchange");Array.from(t).forEach(s=>{s instanceof HTMLInputElement&&s.addEventListener("change",()=>{e.render()})})}importGraph(){var o;const t=(o=document.getElementById("import").files)==null?void 0:o[0];if(!t)return;this.container.get("fileService").importGraph(t)}saveCanvasAsImage(){const e=this.container.get("fileService"),t=this.container.get("canvas"),s=this.container.get("settings"),o=this.container.get("app"),i=this.container.get("graph");t.withScaledCanvas(()=>e.saveCanvasAsImage(),s.imageScaleFactor,o,i,s)}generateSideChains(){const e=this.container.get("selection"),t=this.container.get("graph"),s=this.container.get("actionManager"),o=this.container.get("nodeCounter"),i=this.container.get("ui"),n=i.getInputValueAsNumber("sideChainLength")||37.5,a=i.getInputValueAsNumber("sideChainProb")||2,c=i.getInputValueAsNumber("sideChainLengthRandomness")||0,d=i.getInputValueAsNumber("sideChainAngleRandomness")||0;e.getItemsOfClass(F).forEach(p=>{const m=t.getEdgesInvolvingNode(p.id);if(m.length!==2)return;const g=t.getNode(m[0].getOtherNodeId(p.id)),u=t.getNode(m[1].getOtherNodeId(p.id));if(!g||!u)return;const v=u.coordinates.x-g.coordinates.x,f=u.coordinates.y-g.coordinates.y,S=Math.sqrt(v*v+f*f),w=v/S,I=f/S,x=-I,E=w,b=I,R=-w,A=Math.floor(a),B=a-A,N=A+(Math.random()<B?1:0);let k=Math.random()<.5;const Z=this.container.get("AddNodeAction"),O=this.container.get("AddEdgeAction");for(let L=0;L<N;L++){k=!k;const _=k?x:b,D=k?E:R,G=Math.PI*d,$=(Math.random()*2-1)*G,Y=Math.cos($),K=Math.sin($),J=_*Y-D*K,X=_*K+D*Y,H=p.coordinates.x+J*n*(1-c*Math.random()),Q=p.coordinates.y+X*n*(1-c*Math.random()),ee=o.value++,re=new F(ee,{x:H,y:Q},p.radius,p.strokeWidth,p.fillColor,p.strokeColor);s.addAction(new Z(ee,{x:H,y:Q},i)),s.addAction(new O(p,[re],i))}})}startEdgeRecording(){const e=this.container.get("movie"),t=this.container.get("modeFactory"),s=this.container.get("ui");e.getMovieMaker()||e.initialize(),t.setCurrentMode("edge");const o=document.getElementById("mode-switch");o&&(o.value="edge"),e.startRecordingEdges();const i=document.getElementById("startRecordingEdgesBtn"),n=document.getElementById("stopRecordingEdgesBtn"),a=document.getElementById("recordingIndicator");i&&(i.disabled=!0),n&&(n.disabled=!1),a&&(a.textContent="Recording... (0 edges)",a.style.color="red");const c=this.container.get("graph"),d=t.getMode("edge");d&&d.setRecordingCallback&&d.setRecordingCallback((l,p)=>{const g=c.getEdgesInvolvingNodes([l.id,p.id]).find(u=>u.fromId===l.id&&u.toId===p.id||u.fromId===p.id&&u.toId===l.id);if(g&&(e.recordEdgeAction("add",l,p,g.color,g.weight),a)){const u=e.getRecordedEdges().length;a.textContent=`Recording... (${u} edges)`}}),s.updateMovieStatus("Recording edge additions...")}stopEdgeRecording(){const e=this.container.get("movie"),t=this.container.get("modeFactory"),s=this.container.get("ui"),o=e.stopRecordingEdges(),i=document.getElementById("startRecordingEdgesBtn"),n=document.getElementById("stopRecordingEdgesBtn"),a=document.getElementById("recordingIndicator");i&&(i.disabled=!1),n&&(n.disabled=!0),a&&(a.textContent=o>0?`Ready (${o} edges recorded)`:"Not recording",a.style.color=o>0?"green":"black");const c=t.getMode("edge");c&&c.setRecordingCallback&&c.setRecordingCallback(void 0),s.updateMovieStatus(`Recording stopped. ${o} edges recorded.`)}async createEdgeAdditionMovie(){const e=this.container.get("movie"),t=this.container.get("canvas"),s=this.container.get("settings"),o=this.container.get("app"),i=this.container.get("graph"),n=this.container.get("ui");if(e.getRecordedEdges().length===0){alert("No edges recorded! Use 'Start Recording Edges' first.");return}e.getMovieMaker()||e.initialize();const c=n.getInputValueAsNumber("edgeAnimationDuration")||1e3,d=30;await t.withScaledCanvas(async()=>{e.initialize();try{await e.createEdgeAdditionMovie(c,d)}catch(l){alert(l)}},s.imageScaleFactor,o,i,s)}async createSimulationMovie(){const e=this.container.get("movie"),t=this.container.get("canvas"),s=this.container.get("settings"),o=this.container.get("app"),i=this.container.get("graph"),n=this.container.get("ui");e.getMovieMaker()||e.initialize();const a=n.getInputValue("simulationType")||"force_balance",c=n.getInputValueAsNumber("simulationStepCount")||10,d=n.getInputValueAsNumber("simulationStepDuration")||300,l=n.getInputChecked("adaptiveStepDuration");await t.withScaledCanvas(async()=>{e.initialize();try{await e.createSimulationMovie(a,c,d,l)}catch(p){alert(p)}},s.imageScaleFactor,o,i,s)}startStopMotionRecording(){const e=this.container.get("movie"),t=this.container.get("ui");e.startStopMotionRecording();const s=document.getElementById("startStopMotionBtn"),o=document.getElementById("captureFrameBtn"),i=document.getElementById("removeLastFrameBtn"),n=document.getElementById("stopStopMotionBtn"),a=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!1),i&&(i.disabled=!1),n&&(n.disabled=!1),a&&(a.disabled=!0),t.updateStopMotionIndicator("Recording... (0 frames)","red"),t.updateMovieStatus("Stop-motion recording started. Capture frames by clicking 'Capture Frame'.")}captureStopMotionFrame(){const e=this.container.get("movie"),t=this.container.get("ui");if(!e.isStopMotionRecording()){alert("Not currently recording. Click 'Start Recording' first.");return}const s=e.captureStopMotionFrame();t.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"),t.updateMovieStatus(`Frame ${s} captured!`)}removeLastStopMotionFrame(){const e=this.container.get("movie"),t=this.container.get("ui"),s=e.removeLastStopMotionFrame();e.isStopMotionRecording()?t.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"):t.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),t.updateMovieStatus(s>0?`Last frame removed. ${s} frames remaining.`:"All frames removed.")}stopStopMotionRecording(){const e=this.container.get("movie"),t=this.container.get("ui"),s=e.stopStopMotionRecording(),o=document.getElementById("startStopMotionBtn"),i=document.getElementById("captureFrameBtn"),n=document.getElementById("removeLastFrameBtn"),a=document.getElementById("stopStopMotionBtn"),c=document.getElementById("clearStopMotionFramesBtn");o&&(o.disabled=!1),i&&(i.disabled=!0),n&&(n.disabled=s===0),a&&(a.disabled=!0),c&&(c.disabled=s===0),t.updateStopMotionIndicator(s>0?`Ready (${s} frames)`:"Not recording",s>0?"green":"black"),t.updateMovieStatus(`Recording stopped. ${s} frames captured.`)}async createStopMotionMovie(){const e=this.container.get("movie"),t=this.container.get("ui");if(e.getStopMotionFrameCount()===0){alert("No frames captured! Capture some frames first.");return}const o=t.getInputValueAsNumber("stopMotionFrameDuration")||500;e.setStopMotionFrameDuration(o);try{await e.createStopMotionMovie()}catch(i){alert(`Error creating movie: ${i}`)}}clearStopMotionFrames(){const e=this.container.get("movie"),t=this.container.get("ui");if(!confirm("Are you sure you want to clear all captured frames? This cannot be undone."))return;e.clearStopMotionFrames();const s=document.getElementById("removeLastFrameBtn"),o=document.getElementById("clearStopMotionFramesBtn");s&&(s.disabled=!0),o&&(o.disabled=!0),t.updateStopMotionIndicator("Not recording","black"),t.updateMovieStatus("All frames cleared.")}}class ct{constructor(e){r(this,"container");this.container=e}attachEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){const t=this.container.get("actionManager"),s=this.container.get("modeFactory"),o=this.container.get("ClearSelectionAction"),i=this.container.get("SelectAllNodesAction"),n=this.container.get("InvertSelectionAction"),a=this.container.get("DeleteNodesAction"),c=this.container.get("selection"),d=this.container.get("Node"),l=this.container.get("movie");if(e.ctrlKey||e.metaKey){if(e.key==="z"&&!e.shiftKey){e.preventDefault(),t.undo();return}if(e.key==="z"&&e.shiftKey||e.key==="y"){e.preventDefault(),t.redo();return}if(e.key==="s"){e.preventDefault();return}return}if(!e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey)switch(e.key){case"a":t.addAction(new i);break;case"c":case"Escape":t.addAction(new o);break;case"i":t.addAction(new n);break;case"Backspace":case"Delete":t.addAction(new a(c.getItemsOfClass(d)));break;case"v":s.setCurrentMode("vertex"),this.updateModeUI("vertex");break;case"e":s.setCurrentMode("edge"),this.updateModeUI("edge");break;case"s":s.setCurrentMode("select"),this.updateModeUI("select");break;case"d":s.setCurrentMode("delete_vertex"),this.updateModeUI("delete_vertex");break;case"l":s.setCurrentMode("delete_edge"),this.updateModeUI("delete_edge");break;case"h":s.setCurrentMode("select_chains"),this.updateModeUI("select_chains");break;case"r":s.setCurrentMode("random_walk"),this.updateModeUI("random_walk");break;case"f":l&&l.isStopMotionRecording()&&this.captureStopMotionFrame();break}}updateModeUI(e){const t=document.getElementById("modeSwitch");t&&(t.value=e)}captureStopMotionFrame(){const e=this.container.get("movie"),t=this.container.get("ui");if(!e||!e.isStopMotionRecording())return;const s=e.captureStopMotionFrame();t.updateStopMotionIndicator(`Recording... (${s} frames)`,"red"),t.updateMovieStatus(`Frame ${s} captured!`)}detachEventListeners(){document.removeEventListener("keydown",this.handleKeyDown.bind(this))}}class dt{constructor(e,t){r(this,"name","vertex");this.nodeCounter=e,this.uiFacade=t}onCanvasClick(e,t){t.addAction(new Ee(this.nodeCounter.value,e,this.uiFacade)),this.nodeCounter.value+=1}onEnter(){console.log("Entered vertex mode")}}class ht{constructor(e,t,s,o){r(this,"name","edge");this.graph=e,this.selection=t,this.uiFacade=s,this.recordingCallback=o}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);if(s!==null)if(this.selection.empty)t.addAction(new j([s]));else{const o=this.selection.getItemsOfClass(F);t.addAction(new be(s,o,this.uiFacade)),console.log("EdgeMode: recordingCallback exists:",!!this.recordingCallback),this.recordingCallback&&(console.log("EdgeMode: Recording edges for",o.length,"selected nodes"),o.forEach(i=>{console.log("EdgeMode: Calling recordingCallback for",s.id,"->",i.id),this.recordingCallback(s,i)}))}}setRecordingCallback(e){this.recordingCallback=e}}class Fe{constructor(e=null,t=100,s=100,o=2,i="#000",n=null){r(this,"topLeft");r(this,"width");r(this,"height");r(this,"strokeColor");r(this,"lineWidth");r(this,"fillColor");this.topLeft=e||new M(0,0),this.width=t,this.height=s,this.strokeColor=i,this.lineWidth=o,this.fillColor=n}draw(e){e.beginPath(),e.rect(this.topLeft.x,this.topLeft.y,this.width,this.height),this.fillColor?e.fillStyle=this.fillColor:e.fillStyle="transparent",e.fill(),e.lineWidth=this.lineWidth,this.strokeColor&&(e.strokeStyle=this.strokeColor,e.stroke())}}class lt{constructor(e,t,s){r(this,"name","select");r(this,"isRectangleSelecting",!1);r(this,"rectangleStart",null);r(this,"selectionRectangle",null);this.graph=e,this.selection=t,this.container=s}onCanvasClick(e,t){const s=this.graph.findNodesByCoordinates(e.x,e.y);s.length&&(this.selection.hasItems(s)?t.addAction(new ot(s)):t.addAction(new j(s)))}onMouseDown(e){const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY);if(this.graph.findNodeByCoordinates(s.x,s.y)){this.isRectangleSelecting=!1;return}this.isRectangleSelecting=!0,this.rectangleStart=s,this.selectionRectangle=new Fe(s,0,0,2,"#0066cc","rgba(0, 102, 204, 0.1)"),t.getContext().setLineDash([5,5])}onMouseMove(e){if(!this.isRectangleSelecting||!this.rectangleStart||!this.selectionRectangle)return;const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY),o=s.x-this.rectangleStart.x,i=s.y-this.rectangleStart.y;this.selectionRectangle.topLeft=new M(o>=0?this.rectangleStart.x:s.x,i>=0?this.rectangleStart.y:s.y),this.selectionRectangle.width=Math.abs(o),this.selectionRectangle.height=Math.abs(i),this.container.get("app").render();const a=t.getContext();a.setLineDash([5,5]),this.selectionRectangle.draw(a),a.setLineDash([])}onMouseUp(e){if(!this.isRectangleSelecting||!this.rectangleStart||!this.selectionRectangle)return;const t=this.container.get("canvas"),s=t.clientToCanvasCoordinates(e.clientX,e.clientY),o=this.container.get("actionManager"),i=Math.min(this.rectangleStart.x,s.x),n=Math.max(this.rectangleStart.x,s.x),a=Math.min(this.rectangleStart.y,s.y),c=Math.max(this.rectangleStart.y,s.y),d=this.graph.getAllNodes().filter(m=>m.coordinates.x>=i&&m.coordinates.x<=n&&m.coordinates.y>=a&&m.coordinates.y<=c);d.length>0&&o.addAction(new j(d)),this.isRectangleSelecting=!1,this.rectangleStart=null,this.selectionRectangle=null,t.getContext().setLineDash([]),this.container.get("app").render()}onExit(){this.isRectangleSelecting=!1,this.rectangleStart=null,this.selectionRectangle=null}}class gt{constructor(e){r(this,"name","select_chains");this.graph=e}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);if(s!==null){const o=this.graph.deepConnectedTo(s);t.addAction(new j(o,!0))}}}class ut{constructor(e){r(this,"name","delete_vertex");this.graph=e}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);s!==null&&t.addAction(new Me([s]))}}class mt{constructor(e,t,s){r(this,"name","delete_edge");this.graph=e,this.selection=t,this.recordingCallback=s}onCanvasClick(e,t){const s=this.graph.findNodeByCoordinates(e.x,e.y);s!==null&&!this.selection.empty||this.selection.length>1?(this.recordingCallback&&s!==null&&!this.selection.empty&&this.graph.getEdgesInvolvingNodes([...this.selection.getItemsOfClass(F).map(i=>i.id),s.id]).forEach(i=>{const n=this.graph.getNode(i.fromId),a=this.graph.getNode(i.toId);this.recordingCallback(n,a,!0)}),t.addAction(new nt(this.selection.getItemsOfClass(F),s))):s&&t.addAction(new j([s]))}setRecordingCallback(e){this.recordingCallback=e}}class pt{constructor(e,t,s){r(this,"name","random_walk");this.nodeCounter=e,this.doRandomWalk=t,this.uiFacade=s}onCanvasClick(e,t){const s=this.doRandomWalk(e);t.addAction(new st(s.nodes)),t.addAction(new it(s.edges.map(o=>o.fromId),s.edges.map(o=>o.toId),this.uiFacade)),this.nodeCounter.value+=s.nodes.length+1}}class ft{constructor(e,t,s,o,i){r(this,"modes",new Map);r(this,"currentMode",null);const n=i.get("ui");this.modes.set("vertex",new dt(e,n)),this.modes.set("edge",new ht(t,s,n)),this.modes.set("select",new lt(t,s,i)),this.modes.set("select_chains",new gt(t)),this.modes.set("delete_vertex",new ut(t)),this.modes.set("delete_edge",new mt(t,s)),this.modes.set("random_walk",new pt(e,o,n)),this.setCurrentMode("vertex")}getMode(e){return this.modes.get(e)||null}setCurrentMode(e){const t=this.modes.get(e);return t?(this.currentMode&&this.currentMode.onExit&&this.currentMode.onExit(),this.currentMode=t,this.currentMode.onEnter&&this.currentMode.onEnter(),!0):(console.warn(`Mode '${e}' not found`),!1)}getCurrentMode(){return this.currentMode}getAvailableModes(){return Array.from(this.modes.keys())}getModeInstance(e){return this.modes.get(e)||null}}function fe(){const h=document.getElementById("canvas"),e=h.getContext("2d");if(!h||!e){console.error("Failed to initialize canvas");return}const t=V.instance,s=ce.getInstance(),o={value:0},i=new Be(h,e,t),n=new Le,a=new $e(h,s),c=new je(s),d=new He(s);s.register("canvas",i),s.register("ui",n),s.register("movie",a),s.register("graphOperations",c),s.register("fileService",d),s.register("settings",t),s.register("graph",y),s.register("selection",C),s.register("Node",F),s.register("nodeCounter",o),s.register("StorageService",q),s.register("Circle",ve),s.register("Rectangle",Fe),s.register("PartialLine",ie),s.register("simulations",{doForceBalanceStep:Ye,doPositionEquilibrationStep:Ue}),s.register("ClearSelectionAction",Ie),s.register("SelectAllNodesAction",Ce),s.register("InvertSelectionAction",xe),s.register("DeleteNodesAction",Me),s.register("AddNodeAction",Ee),s.register("AddEdgeAction",be);const l=new ke(s);s.register("app",l);const p=new Qe(()=>l.render());s.register("actionManager",p);const m=new ft(o,y,C,Xe,s);s.register("modeFactory",m),m.setCurrentMode("vertex");const g=new rt(s),u=new at(s),v=new ct(s);if(l.initialize(),g.attachEventListeners(),u.attachEventListeners(),v.attachEventListeners(),q.loadState(y,t)){if(i.resize(t.canvasSize.x,t.canvasSize.y),n.updateCanvasSizeUI(t.canvasSize.x,t.canvasSize.y),y.getNrOfNodes()>0){const S=y.getAllNodeIds();o.value=Math.max(...S)+1}console.log("Loaded previous state from localStorage")}else n.updateCanvasSizeUI(t.canvasSize.x,t.canvasSize.y),y.clear(),C.clearSelection();l.render(),window.addEventListener("beforeunload",()=>{q.saveState(y,t)}),setInterval(()=>{q.saveState(y,t)},3e4),console.log("Application initialized successfully")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",fe):fe();
